<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Убийство в особняке Роузвуд — Мобильная и ПК версии</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#060607;
  --bg-2:#141214;
  --panel:#1c1818;
  --accent:#b08a5c;
  --accent-2:#7a4e2f;
  --muted:#cfcfcf;
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
  --gap:14px;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:"Raleway",system-ui,Arial; -webkit-font-smoothing:antialiased;}
body{
  color:#efeae4;
  background:
    radial-gradient(800px 400px at 8% 8%, rgba(176,138,92,0.03), transparent),
    linear-gradient(180deg,var(--bg-1), var(--bg-2));
  -webkit-font-smoothing:antialiased;
  padding-bottom:80px;
}

/* Header */
.header{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  padding:18px 16px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.title h1{ margin:0; font-family:'Cinzel', serif; font-size:1.2rem; letter-spacing:1px;}
.title p{ margin:2px 0 0 0; color:var(--muted); font-size:0.88rem;}

/* Layout */
.container{
  max-width:1200px;
  margin:18px auto;
  display:grid;
  grid-template-columns:320px 1fr 320px;
  gap:var(--gap);
  padding:0 16px;
}
@media (max-width:1000px){
  .container{ grid-template-columns:1fr; }
}

/* Panels */
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:12px;
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,0.02);
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
}

/* Suspects */
.suspect{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; margin-top:10px; background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent); }
.avatar{ width:56px; height:56px; border-radius:8px; overflow:hidden; flex:0 0 56px; display:grid; place-items:center; background:linear-gradient(180deg,#2b2420,#211817); border:2px solid rgba(255,255,255,0.03); }
.suspect .meta{ flex:1; }
.suspect .name{ font-weight:700; }
.dropzone{ min-width:44px; min-height:44px; border-radius:8px; background:var(--glass); display:grid; place-items:center; color:var(--muted); font-weight:700; }

/* Map & hotspots */
.map{ position:relative; border-radius:var(--radius); overflow:hidden; padding:10px; min-height:260px; }
#mapSvg{ width:100%; height:auto; display:block; border-radius:8px; filter:contrast(0.9) saturate(0.9); }
.hotspot{ position:absolute; transform:translate(-50%,-50%); background:linear-gradient(180deg, rgba(176,138,92,0.14), rgba(176,138,92,0.08)); padding:8px 10px; border-radius:999px; font-weight:700; color:#120b06; cursor:pointer; border:1px solid rgba(176,138,92,0.12); box-shadow:0 8px 22px rgba(0,0,0,0.6); user-select:none; }
.hotspot:active{ transform:translate(-50%,-50%) scale(0.98); }

/* Clues */
.clues{ display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:10px; margin-top:10px; }
.clue{ background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); cursor:pointer; user-select:none; display:flex; gap:10px; align-items:flex-start; }
.thumb{ width:56px; height:56px; border-radius:8px; flex:0 0 56px; display:grid; place-items:center; background:linear-gradient(180deg,#211815,#1a1412); }
.clue h4{ margin:0; font-size:0.95rem; }
.clue p{ margin:6px 0 0 0; color:var(--muted); font-size:0.86rem; }
.clue.locked{ opacity:0.8; filter:grayscale(0.1); }

/* Tools right */
.tools .row{ display:flex; gap:8px; margin-top:8px; }
.input{ width:100%; padding:8px; border-radius:8px; background:#0e0e0e; color:#efeae4; border:1px solid rgba(255,255,255,0.03); }

/* Modals */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); }
.card{ width:520px; max-width:94%; background:linear-gradient(180deg,#151414,#0f0f0f); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }

/* mobile footer toolbar */
.footerToolbar{ display:none; position:fixed; left:0; right:0; bottom:0; background:linear-gradient(90deg, rgba(0,0,0,0.55), rgba(0,0,0,0.35)); padding:8px 12px; gap:10px; justify-content:space-between; align-items:center; z-index:9999; }
.footerToolbar .btn{ padding:8px 12px; border-radius:10px; }
@media (max-width:1000px){
  .footerToolbar{ display:flex; }
  .header{ padding:12px; }
  .title h1{ font-size:1.05rem; }
  .map{ min-height:200px; }
}

/* debug */
#debug{ position:fixed; right:12px; bottom:86px; width:300px; max-height:260px; overflow:auto; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(8,8,8,0.85)); color:#fff; border-radius:8px; padding:10px; border:1px solid rgba(255,255,255,0.03); font-size:12px; z-index:99999; }

/* subtle vignette */
.vignette{ position:fixed; inset:0; pointer-events:none; background:radial-gradient(ellipse at center, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0.7) 70%); z-index:0; }
</style>
</head>
<body>
  <header class="header">
    <div class="title">
      <h1>Убийство в особняке Роузвуд</h1>
      <p>Адаптировано для ПК и мобильных устройств — детали и мини‑игры</p>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div id="progressText" style="color:var(--muted)">Прогресс: <strong id="progressPct">0%</strong></div>
      <button id="audioToggle" class="btn" style="background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted)">Звук: выкл</button>
    </div>
  </header>

  <main class="container" role="main">
    <!-- LEFT: suspects -->
    <aside class="panel" aria-label="Подозреваемые">
      <div class="case-title" style="font-family:'Cinzel', serif; font-size:1.05rem;">Дело: Роузвуд</div>
      <div style="color:var(--muted); margin-top:6px;">Перетащите улику на карточку подозреваемого или нажмите на улице для подробностей. На мобильных — удерживайте улику, затем выберите подозреваемого.</div>

      <div id="suspectsArea" style="margin-top:12px"></div>

      <div style="margin-top:12px; color:var(--muted)">
        <div>Связи: <span id="linksSummary">нет</span></div>
      </div>
    </aside>

    <!-- CENTER: map + clues -->
    <section class="panel" aria-label="Карта и улики">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-family:'Cinzel', serif; font-size:1.02rem;">Карта особняка</div>
        <div style="color:var(--muted); font-size:0.9rem">Нажмите на область, чтобы осмотреть</div>
      </div>

      <div class="map" style="margin-top:10px;">
        <!-- simple generated SVG map -->
        <svg id="mapSvg" viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Схематичная карта особняка">
          <defs>
            <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#2b2320"/><stop offset="1" stop-color="#191414"/></linearGradient>
            <filter id="grain"><feTurbulence baseFrequency="0.8" numOctaves="1" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/></filter>
          </defs>
          <rect width="100%" height="100%" fill="url(#g1)"/>
          <!-- rooms (simple boxes) -->
          <rect x="40" y="40" width="300" height="200" rx="12" fill="#2b1f18" stroke="#3a2a22"/>
          <text x="190" y="150" fill="#cfc0a8" font-size="22" font-family="Cinzel" text-anchor="middle">Библиотека</text>

          <rect x="380" y="40" width="260" height="180" rx="10" fill="#2b1f18" stroke="#3a2a22"/>
          <text x="510" y="120" fill="#cfc0a8" font-size="20" font-family="Cinzel" text-anchor="middle">Музыкальная</text>

          <rect x="660" y="40" width="280" height="180" rx="10" fill="#2b1f18" stroke="#3a2a22"/>
          <text x="800" y="120" fill="#cfc0a8" font-size="20" font-family="Cinzel" text-anchor="middle">Кабинет</text>

          <rect x="40" y="270" width="380" height="300" rx="10" fill="#231a17" stroke="#33231f"/>
          <text x="230" y="420" fill="#cfc0a8" font-size="20" font-family="Cinzel" text-anchor="middle">Библиотека / Склад</text>

          <rect x="440" y="270" width="500" height="300" rx="10" fill="#231a17" stroke="#33231f"/>
          <text x="690" y="420" fill="#cfc0a8" font-size="20" font-family="Cinzel" text-anchor="middle">Главный этаж / Подвал</text>
        </svg>

        <!-- hotspots (positioned in percents) -->
        <div class="hotspot" data-room="library" style="left:18%; top:22%;">Библиотека</div>
        <div class="hotspot" data-room="music" style="left:49%; top:16%;">Музыка</div>
        <div class="hotspot" data-room="office" style="left:78%; top:20%;">Кабинет</div>
        <div class="hotspot" data-room="garden" style="left:26%; top:62%;">Сад</div>
        <div class="hotspot" data-room="basement" style="left:76%; top:76%;">Подвал</div>
        <div class="hotspot" data-room="attic" style="left:56%; top:62%;">Чердак</div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
        <div style="font-weight:700">Улики</div>
        <div style="color:var(--muted)">Держите и перетаскивайте на подозреваемого</div>
      </div>

      <div id="cluesGrid" class="clues" aria-live="polite"></div>
    </section>

    <!-- RIGHT: tools -->
    <aside class="panel tools" aria-label="Инструменты">
      <div>
        <h3 style="margin:0; font-family:'Cinzel', serif;">Инструменты</h3>
        <div style="color:var(--muted); margin-top:6px;">Блокнот, таймлайн, шифры и мини‑игры</div>
        <div class="row" style="margin-top:10px;">
          <button id="openNotebook" class="btn">Блокнот</button>
          <button id="openTimeline" class="btn secondary">Таймлайн</button>
          <button id="openCipher" class="btn">Цезарь</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <h3 style="margin:0; font-family:'Cinzel', serif;">Обвинение</h3>
        <div style="color:var(--muted); margin-top:6px;">Выберите и предъявите доказательства</div>
        <select id="accuseSelect" class="input" style="margin-top:8px;">
          <option value="">— Выберите —</option>
        </select>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="accuseBtn" class="btn">Обвинить</button>
          <button id="reviewBtn" class="btn secondary">Проверить</button>
        </div>
        <div id="accuseResult" style="margin-top:8px; font-weight:700;"></div>
      </div>
    </aside>
  </main>

  <!-- mobile toolbar -->
  <div class="footerToolbar" aria-hidden="false">
    <div style="display:flex; gap:8px;">
      <button id="quickNotebook" class="btn secondary">Блокнот</button>
      <button id="quickTimeline" class="btn secondary">Таймлайн</button>
    </div>
    <div style="display:flex; gap:8px;">
      <button id="quickCipher" class="btn">Заметка</button>
      <button id="quickMatch" class="btn secondary">Эмблемы</button>
    </div>
  </div>

  <!-- modals -->
  <div id="modalCipher" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Расшифровать записку — Цезарь</h3>
      <div style="margin-top:6px; color:var(--muted)">Вводите сдвиг 1–25</div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <input id="cipherShift" type="number" min="1" max="25" value="3" class="input" />
        <button id="cipherTry" class="btn">Попробовать</button>
        <button id="cipherClose" class="btn secondary">Закрыть</button>
      </div>
      <textarea id="cipherOutput" rows="4" class="input" style="margin-top:10px" readonly></textarea>
    </div>
  </div>

  <div id="modalMatch" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Мини‑игра: Эмблемы</h3>
      <div style="margin-top:8px; color:var(--muted)">Выберите эмблему, совпадающую с символом</div>
      <div id="matchArea" style="display:flex; gap:10px; margin-top:12px; justify-content:space-around"></div>
      <div style="display:flex; justify-content:flex-end; margin-top:12px;">
        <button id="matchClose" class="btn secondary">Закрыть</button>
      </div>
    </div>
  </div>

  <div id="modalNotebook" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Блокнот</h3>
      <textarea id="notebookText" class="input" rows="8" placeholder="Ваши заметки..."></textarea>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button id="nbSave" class="btn">Сохранить</button>
        <button id="nbClose" class="btn secondary">Закрыть</button>
      </div>
    </div>
  </div>

  <div id="debug" aria-hidden="false"><strong>DEBUG</strong><div id="debugLog" style="white-space:pre-wrap; margin-top:8px; font-family:monospace; color:#cfcfcf">init...</div></div>
  <div class="vignette"></div>

<script>
/*
  Улучшенный, стабильный JS:
  - адаптивный интерфейс (ПК + мобильные)
  - drag & drop для ПК, touch support для мобильных (симулированная перетаскивание)
  - встроенные SVG картинки (аватары, эмблемы, мини‑карта)
  - дополнительные улики и мини‑игры
  - debug панель для ошибок
*/

(function(){
  const debugEl = id('debugLog');
  function debug(...a){ try{ if(debugEl) debugEl.textContent += '\\n' + a.join(' '); console.log(...a); }catch(e){} }

  window.onerror = function(msg, src, line, col, err){
    debug('ERROR:', msg, src + ':' + line + ':' + col, err && err.stack ? err.stack.split('\\n')[0] : '');
  };

  document.addEventListener('DOMContentLoaded', init);

  // данные
  const suspects = [
    { id:'adrian', name:'Эдриан Роузвуд', role:'Наследник', color:'#9b6b49' },
    { id:'beatrice', name:'Беатрис Хейвуд', role:'Домработница', color:'#6b7f49' },
    { id:'prof', name:'Профессор Морден', role:'Архивариус', color:'#406b7f' },
    { id:'victoria', name:'Виктория Роузвуд', role:'Жена', color:'#7f4b6b' }
  ];

  const clues = [
    { id:'cl1', title:'Тайная записка (зашифрована)', room:'office', text:'Vkr ghqv wrfkh', locked:true, type:'cipher' },
    { id:'cl2', title:'След обуви', room:'garden', text:'Подошва с логотипом B7', locked:false, type:'foot' },
    { id:'cl3', title:'Разорванный лист', room:'library', text:'Вырвано имя, пометка: 12/11', locked:false, type:'paper' },
    { id:'cl4', title:'Символ на стене', room:'music', text:'Неизвестный символ', locked:false, type:'symbol' },
    { id:'cl5', title:'Пепел на перилах', room:'dining', text:'Следы поджога и масла', locked:false, type:'ash' },
    { id:'cl6', title:'Карта (фрагмент)', room:'basement', text:'Фрагмент карты с отметкой', locked:true, type:'photo' },
    { id:'cl7', title:'Флакон с эфиром', room:'attic', text:'Реактив: запах редкого эфира', locked:false, type:'vial' },
    { id:'cl8', title:'Записка в книге', room:'library', text:'"Власть — через тайну" — подпись В.', locked:false, type:'note' },
    { id:'cl9', title:'Запечатанный конверт', room:'office', text:'Печать семьи', locked:true, type:'seal' },
    { id:'cl10', title:'След перьевой ручки', room:'office', text:'Чернильные брызги: Wyn', locked:false, type:'ink' }
  ];

  // state
  let state = { opened: {}, links: {}, timeline: [], audioOn:false };
  suspects.forEach(s => state.links[s.id] = []);

  // helper
  function id(i){ return document.getElementById(i); }
  function el(q, ctx=document){ return ctx.querySelector(q); }
  function els(q, ctx=document){ return Array.from(ctx.querySelectorAll(q)); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  // render suspects (with generated SVG avatars)
  function renderSuspects(){
    const area = id('suspectsArea');
    area.innerHTML = '';
    suspects.forEach(s => {
      const d = document.createElement('div');
      d.className = 'suspect';
      d.dataset.id = s.id;
      d.innerHTML = `
        <div class="avatar" aria-hidden="true">${avatarSVG(s.name, s.color)}</div>
        <div class="meta">
          <div class="name">${s.name}</div>
          <div class="role">${s.role}</div>
        </div>
        <div class="dropzone" data-suspect="${s.id}">0</div>
      `;
      area.appendChild(d);
    });
    attachDropzones();
    renderLinksSummary();
    populateAccuseSelect();
  }

  // generated SVG for avatar — returns HTML string
  function avatarSVG(name, color){
    const initials = name.split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase();
    const svg = `<svg width="56" height="56" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="${color}44"/><stop offset="1" stop-color="${color}22"/></linearGradient></defs><rect width="100%" height="100%" rx="8" fill="url(#g)"/><text x="50%" y="54%" font-family="Raleway" font-weight="700" font-size="18" text-anchor="middle" fill="#fff">${initials}</text></svg>`;
    return svg;
  }

  // render clues grid — each clue has small generated thumbnail SVG
  function renderClues(){
    const grid = id('cluesGrid');
    if(!grid) return;
    grid.innerHTML = '';
    clues.forEach(c => {
      const card = document.createElement('div');
      card.className = 'clue' + (c.locked ? ' locked' : '');
      card.id = c.id;
      card.draggable = true;
      card.innerHTML = `<div class="thumb" aria-hidden="true">${thumbSVG(c.type)}</div>
                        <div style="flex:1"><h4>${c.title}</h4><p>${c.locked ? 'Зашифрована / скрыта' : c.text}</p></div>`;
      // events
      card.addEventListener('click', ()=>onClueClick(c));
      card.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', c.id); });
      // touch support for mobile: long press to start drag-mode (simulate)
      addTouchDragSupport(card, c.id);
      grid.appendChild(card);
    });
  }

  // small thumbnail SVG generator based on type
  function thumbSVG(type){
    switch(type){
      case 'foot': return svgIcon('M20 40c0 0 6-12 14-12 8 0 14 12 14 12s-6 4-14 4c-8 0-14-4-14-4z','foot');
      case 'paper': return svgIcon('<rect x="6" y="6" width="44" height="44" rx="6" fill="#2b2119"/>','paper');
      case 'symbol': return svgIcon('<circle cx="28" cy="28" r="16" fill="#3a2a22"/><path d="M28 18 L28 38 M18 28 L38 28" stroke="#b08a5c" stroke-width="2"/>','symbol');
      case 'photo': return svgIcon('<rect x="6" y="10" width="44" height="32" rx="4" fill="#2b2119"/><circle cx="20" cy="24" r="4" fill="#b08a5c"/>','photo');
      case 'vial': return svgIcon('<rect x="22" y="10" width="12" height="24" rx="4" fill="#2b2119"/><rect x="24" y="6" width="8" height="6" fill="#3a2a22"/>','vial');
      case 'ink': return svgIcon('<path d="M18 44 L44 44 L36 34 L28 34 L18 44z" fill="#2b2119"/>','ink');
      case 'seal': return svgIcon('<circle cx="28" cy="28" r="16" fill="#3a2a22"/><text x="28" y="33" font-size="12" text-anchor="middle" fill="#b08a5c">S</text>','seal');
      case 'note': return svgIcon('<rect x="6" y="8" width="44" height="40" rx="4" fill="#2b2119"/><path d="M12 18 H44" stroke="#b08a5c" stroke-width="1"/><path d="M12 26 H36" stroke="#b08a5c" stroke-width="1"/>','note');
      case 'ash': return svgIcon('<ellipse cx="28" cy="34" rx="16" ry="6" fill="#2b2119"/>','ash');
      default: return svgIcon('<rect x="6" y="6" width="44" height="44" rx="6" fill="#2b2119"/>','def');
    }
  }
  function svgIcon(inner, cls){
    if(inner.startsWith('<')) {
      return `<svg width="56" height="56" xmlns="http://www.w3.org/2000/svg">${inner}</svg>`;
    } else {
      return `<svg width="56" height="56" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" rx="8" fill="#221815"/></svg>`;
    }
  }

  // clue click behavior
  function onClueClick(c){
    if(c.locked){
      if(c.type === 'cipher'){ openCipherModal(); setCipherSource(c.text, c.id); }
      else if(c.type === 'photo'){ openMatchModal(true); } // demo: open match to restore
      else { toast('Эта улика требует инструментов. Откройте Инструменты.'); }
      return;
    }
    // show details modal
    showClueDetail(c);
  }

  function showClueDetail(c){
    const modal = document.createElement('div');
    modal.className = 'modal'; modal.style.display='flex';
    modal.innerHTML = `<div class="card"><h3>${c.title}</h3><div style="color:var(--muted); margin-top:6px">Найдено в: ${c.room}</div><p style="margin-top:10px; color:var(--muted)">${c.text}</p><div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px"><button class="btn" id="closeClue">Закрыть</button></div></div>`;
    document.body.appendChild(modal);
    modal.querySelector('#closeClue').addEventListener('click', ()=> modal.remove());
  }

  // drag & drop support for PC, touch support for mobile
  function attachDropzones(){
    const zones = els('.dropzone');
    zones.forEach(zone => {
      zone.addEventListener('dragover', ev => { ev.preventDefault(); zone.style.outline='2px dashed rgba(176,138,92,0.6)'; });
      zone.addEventListener('dragleave', ev => { zone.style.outline=''; });
      zone.addEventListener('drop', ev => {
        ev.preventDefault();
        zone.style.outline='';
        const clueId = ev.dataTransfer.getData('text/plain');
        const suspectId = zone.dataset.suspect;
        if(clueId && suspectId) linkEvidence(suspectId, clueId);
      });
    });
  }

  // touch drag simulation: long press to pick clue and tap suspect to drop
  let touchDrag = null;
  function addTouchDragSupport(card, clueId){
    let timer = null;
    card.addEventListener('touchstart', (ev)=>{
      timer = setTimeout(()=>{
        touchDrag = { clueId, card };
        card.style.opacity = '0.6';
        toast('Перетащите пальцем и коснитесь подозреваемого, чтобы привязать улику');
      }, 350);
    }, {passive:true});
    card.addEventListener('touchend', ()=>{ clearTimeout(timer); });
    card.addEventListener('touchmove', ()=>{ clearTimeout(timer); });
  }
  // tap on suspect when touchDrag active
  document.addEventListener('touchend', (ev)=>{
    if(!touchDrag) return;
    const t = ev.changedTouches[0];
    const elAt = document.elementFromPoint(t.clientX, t.clientY);
    const zone = elAt && (elAt.closest && elAt.closest('.dropzone'));
    if(zone){
      const suspectId = zone.dataset.suspect;
      if(suspectId) linkEvidence(suspectId, touchDrag.clueId);
    }
    // cleanup visuals
    if(touchDrag && touchDrag.card) touchDrag.card.style.opacity = '';
    touchDrag = null;
  });

  // link evidence
  function linkEvidence(suspectId, clueId){
    if(!state.links[suspectId]) state.links[suspectId] = [];
    if(!state.links[suspectId].includes(clueId)){
      state.links[suspectId].push(clueId);
      toast('Улика привязана к ' + suspectId);
      updateDropzoneCounts();
      saveAuto();
      updateProgress();
    } else toast('Улика уже привязана к этому подозреваемому');
  }

  function updateDropzoneCounts(){
    suspects.forEach(s => {
      const zone = document.querySelector(`.dropzone[data-suspect="${s.id}"]`);
      if(zone) zone.textContent = (state.links[s.id] || []).length || '0';
    });
    renderLinksSummary();
  }

  function renderLinksSummary(){
    const parts = [];
    suspects.forEach(s => {
      const arr = state.links[s.id] || [];
      if(arr.length) parts.push(`${s.name}: ${arr.join(', ')}`);
    });
    id('linksSummary').textContent = parts.length ? parts.join('; ') : 'нет';
  }

  // inspect room (hotspot)
  function attachHotspots(){
    els('.hotspot').forEach(h => h.addEventListener('click', ()=> inspectRoom(h.dataset.room)));
  }
  function inspectRoom(room){
    // reveal clues present in room (but keep locked ones closed until tools solved)
    const found = clues.filter(c => c.room === room);
    if(found.length === 0){ toast('Ничего не обнаружено в этой области'); return; }
    found.forEach(c => {
      const card = id(c.id);
      if(card){
        if(!c.locked){
          card.classList.remove('locked');
          card.querySelector('p').textContent = c.text;
          state.opened[c.id] = true;
        } else {
          card.querySelector('p').textContent = 'Найдена, но скрыта — требуется инструмент';
        }
      }
    });
    toast(`Осмотр ${room}: найдено ${found.length} улик`);
    saveAuto();
    updateProgress();
  }

  // simple toast
  function toast(text){ const d=document.createElement('div'); d.textContent=text; d.style.position='fixed'; d.style.left='50%'; d.style.bottom='100px'; d.style.transform='translateX(-50%)'; d.style.background='rgba(0,0,0,0.8)'; d.style.color='#fff'; d.style.padding='8px 12px'; d.style.borderRadius='8px'; d.style.zIndex=99999; document.body.appendChild(d); setTimeout(()=>{ d.style.transition='opacity .5s'; d.style.opacity=0; setTimeout(()=>d.remove(),600); }, 1400); }

  // cipher modal logic
  let currentCipher = { text:'', id:null };
  function openCipherModal(){
    id('modalCipher').style.display = 'flex';
    id('modalCipher').setAttribute('aria-hidden','false');
  }
  function closeCipherModal(){ id('modalCipher').style.display = 'none'; id('modalCipher').setAttribute('aria-hidden','true'); }
  function setCipherSource(text, clueId){ currentCipher.text = text; currentCipher.id = clueId; id('cipherOutput').value=''; }
  function tryCipher(){
    const shift = Number(id('cipherShift').value) || 0;
    const dec = caesarDecode(currentCipher.text, shift);
    id('cipherOutput').value = dec;
    debug('dec:', dec);
    // simple trigger if found keywords
    if(/он знает|в\./i.test(dec) || shift === 3){
      revealClue(currentCipher.id, 'Найдена в кабинете: «Он знает. Сегодня решу всё. — В.»');
      toast('Записка расшифрована');
      closeCipherModal();
    }
  }
  function caesarDecode(s, shift){
    if(!s) return s;
    const a='abcdefghijklmnopqrstuvwxyz';
    const A=a.toUpperCase();
    return s.split('').map(ch=>{
      if(a.includes(ch)) return a[(a.indexOf(ch)-shift+26)%26];
      if(A.includes(ch)) return A[(A.indexOf(ch)-shift+26)%26];
      return ch;
    }).join('');
  }

  // reveal clue programmatic
  function revealClue(idc, text){
    const c = clues.find(x=>x.id===idc);
    if(!c) return;
    c.locked = false;
    c.text = text;
    state.opened[idc] = true;
    const card = id(idc);
    if(card){
      card.classList.remove('locked');
      card.querySelector('p').textContent = c.text;
    }
    updateProgress();
    saveAuto();
  }

  // match modal (emblems)
  const emblems = [
    { id:'e1', tag:'morden', svg: emblemSVG('#b08a5c') },
    { id:'e2', tag:'rosewood', svg: emblemSVG('#9b6b49') },
    { id:'e3', tag:'other', svg: emblemSVG('#6b7f49') }
  ];
  function emblemSVG(color){ return `<svg width="72" height="72" xmlns="http://www.w3.org/2000/svg"><circle cx="36" cy="36" r="32" fill="${color}22"/><path d="M36 20 L44 44 L28 44 Z" fill="${color}"/></svg>`; }
  function openMatchModal(autoReveal=false){
    const modal = id('modalMatch');
    const area = id('matchArea');
    area.innerHTML = '';
    emblems.sort(()=>Math.random()-0.5).forEach(e=>{
      const div = document.createElement('div');
      div.style.cursor='pointer';
      div.innerHTML = e.svg + `<div style="text-align:center; color:var(--muted); margin-top:6px;">${e.id}</div>`;
      div.addEventListener('click', ()=> {
        if(e.tag === 'rosewood'){
          revealClue('cl4', 'Символ совпадает с эмблемой семьи Роузвуд.');
          toast('Эмблема совпала — улика открыта');
          closeMatchModal();
        } else {
          toast('Не то. Попробуйте другую эмблему.');
        }
      });
      area.appendChild(div);
    });
    modal.style.display='flex';
    modal.setAttribute('aria-hidden','false');
    if(autoReveal) setTimeout(()=>{ revealClue('cl6','Фрагменты карты восстановлены: найден тайный проход'); closeMatchModal(); }, 900);
  }
  function closeMatchModal(){ id('modalMatch').style.display='none'; id('modalMatch').setAttribute('aria-hidden','true'); }

  // notebook & timeline
  function openNotebook(){ id('modalNotebook').style.display='flex'; id('modalNotebook').setAttribute('aria-hidden','false'); id('notebookText').value = localStorage.getItem('rosewood_notes') || ''; }
  function closeNotebook(){ id('modalNotebook').style.display='none'; id('modalNotebook').setAttribute('aria-hidden','true'); }
  function saveNotebook(){ localStorage.setItem('rosewood_notes', id('notebookText').value || ''); toast('Блокнот сохранён'); }

  function addTimeline(text){
    if(!text) return;
    state.timeline.push({ time: new Date().toISOString(), text });
    renderTimeline();
    saveAuto();
  }
  function renderTimeline(){
    const el = id('timelineList');
    if(!el) return;
    if(!state.timeline.length) el.textContent = 'Пока пусто';
    else el.innerHTML = state.timeline.slice().reverse().map(t=>`<div style="margin-bottom:6px">${new Date(t.time).toLocaleString()}: <strong>${t.text}</strong></div>`).join('');
  }

  // accuse flow
  function populateAccuseSelect(){
    const sel = id('accuseSelect');
    sel.innerHTML = '<option value="">— Выберите —</option>';
    suspects.forEach(s => {
      const o = document.createElement('option');
      o.value = s.id; o.textContent = s.name;
      sel.appendChild(o);
    });
  }
  function accuse(){
    const sel = id('accuseSelect');
    const out = id('accuseResult');
    const idv = sel.value;
    if(!idv){ out.textContent = 'Выберите подозреваемого'; out.style.color='#ffb3b3'; return; }
    const linked = state.links[idv] || [];
    if(linked.length >= 3 && state.timeline.length >= 2){
      if(idv === 'adrian'){ out.textContent='Успех: обвинение обосновано — Эдриан виновен'; out.style.color='#b7f6b7'; } else { out.textContent='Обвинение не подтверждено'; out.style.color='#ffd1d1'; }
    } else { out.textContent='Недостаточно доказательств — нужно ≥3 улики и ≥2 события'; out.style.color='#ffd1d1'; }
  }

  function review(){
    const parts = suspects.map(s => `${s.name}: ${ (state.links[s.id] || []).length } улик`);
    toast(parts.join(' | '));
  }

  // autoload / autosave
  function saveAuto(){ try{ localStorage.setItem('rosewood_state', JSON.stringify(state)); debug('autosaved'); }catch(e){ debug('autosave err', e); } }
  function loadAuto(){
    try{
      const raw = localStorage.getItem('rosewood_state');
      if(!raw) return;
      const loaded = JSON.parse(raw);
      state = Object.assign(state, loaded);
      // ensure links keys exist
      suspects.forEach(s => state.links[s.id] = state.links[s.id] || []);
    }catch(e){ debug('load err', e); }
  }

  // progress
  function updateProgress(){
    const openedCount = Object.keys(state.opened || {}).length + Object.values(state.links || {}).flat().length;
    const pct = Math.min(100, Math.round((openedCount / (clues.length + 2)) * 100));
    id('progressPct').textContent = pct + '%';
    updateDropzoneCounts();
  }

  // small utilities
  function toastOnceDemo(){
    if(!localStorage.getItem('rosewood_demo')){ toast('Подсказка: долгий тап на улице запускает режим перетаскивания на мобильных'); localStorage.setItem('rosewood_demo', '1'); }
  }

  // initial UI wiring
  function init(){
    debug('init start');
    loadAuto();
    renderSuspects();
    renderClues();
    attachHotspots();
    attachDropzones();
    populateAccuseSelect();
    renderTimeline();
    updateProgress();
    // bind buttons
    id('openCipher').addEventListener('click', ()=>{ openCipherModal(); setCipherSource(clues.find(c=>c.type==='cipher').text, clues.find(c=>c.type==='cipher').id); });
    id('cipherClose').addEventListener('click', closeCipherModal);
    id('cipherTry').addEventListener('click', tryCipher);
    id('matchClose').addEventListener('click', closeMatchModal);
    id('openNotebook').addEventListener('click', openNotebook);
    id('nbClose').addEventListener('click', closeNotebook);
    id('nbSave').addEventListener('click', saveNotebook);
    id('openTimeline').addEventListener('click', ()=>{ const txt=prompt('Добавьте событие (например, 23:10 — шаги)'); if(txt) addTimeline(txt); });
    id('addTimelineBtn') && id('addTimelineBtn').addEventListener('click', ()=>{ const val = id('timelineInput') && id('timelineInput').value; if(val) addTimeline(val); });
    id('accuseBtn').addEventListener('click', accuse);
    id('reviewBtn').addEventListener('click', review);
    id('quickNotebook').addEventListener('click', openNotebook);
    id('quickCipher').addEventListener('click', ()=>{ openCipherModal(); setCipherSource(clues.find(c=>c.type==='cipher').text, clues.find(c=>c.type==='cipher').id); });
    id('quickMatch').addEventListener('click', ()=>openMatchModal(false));
    id('quickTimeline').addEventListener('click', ()=>{ const txt = prompt('Добавьте событие'); if(txt) addTimeline(txt); });
    id('matchClose') && id('matchClose').addEventListener('click', closeMatchModal);

    // mobile demo hint
    toastOnceDemo();
    debug('init done');
  }

  // expose some for debugging/testing
  window.revealClue = revealClue;
  window.openMatchModal = openMatchModal;

})();
</script>
</body>
</html>
