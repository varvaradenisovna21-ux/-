<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥ ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060607; --panel:#141214; --accent:#b08a5c; --muted:#cfcfcf; --danger:#b04a4a; --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,#040405 0%, #0b0b0d 80%); color:#efece6; -webkit-font-smoothing:antialiased;}
.header { display:flex; justify-content:space-between; align-items:center; padding:12px 18px; border-bottom:1px solid rgba(255,255,255,0.02); position:sticky; top:0; background:rgba(6,6,6,0.6); z-index:60; }
.logo { width:48px; height:48px; border-radius:10px; background:linear-gradient(180deg,#2b1f18,#191010); display:grid; place-items:center; font-family:Cinzel,serif; font-size:18px; color:#f7efe7; border:1px solid rgba(255,255,255,0.03);}
.header-right { display:flex; gap:10px; align-items:center; }

.container { max-width:1200px; margin:18px auto; padding:12px; display:grid; grid-template-columns:320px 1fr 360px; gap:18px; align-items:start; }
@media (max-width:1100px){ .container{ grid-template-columns:1fr; } .right-panel{ order:3 } }

.panel { background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.008)); padding:14px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.02); box-shadow: 0 14px 36px rgba(0,0,0,0.65); }
.small { color:var(--muted); font-size:0.92rem; }

.suspect { display:flex; gap:12px; align-items:center; padding:10px; margin-top:10px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02); cursor:pointer; }
.suspect .avatar { width:64px; height:64px; border-radius:10px; object-fit:cover; border:2px solid rgba(255,255,255,0.03); background:#1b1412; }
.smeta { flex:1; }
.sname { font-weight:700; }
.srole { color:var(--muted); font-size:0.9rem; }
.smeta .meta-row { display:flex; gap:10px; margin-top:6px; font-size:0.88rem; color:var(--muted); }

.map { position:relative; border-radius:12px; overflow:hidden; padding:10px; min-height:420px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.36)); }
.map-canvas { width:100%; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#231a17,#1b1411); display:block; position:relative; height:340px; }
.hotspot { position:absolute; transform:translate(-50%,-50%); background:linear-gradient(180deg, rgba(176,138,92,0.14), rgba(176,138,92,0.08)); padding:8px 12px; border-radius:999px; font-weight:700; color:#120b06; cursor:pointer; border:1px solid rgba(176,138,92,0.12); box-shadow:0 10px 28px rgba(0,0,0,0.6); user-select:none; transition:transform .14s ease; }
.hotspot:hover { transform:translate(-50%,-50%) scale(1.05); }

.clues { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; }
.clue { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); cursor:pointer; display:flex; gap:10px; align-items:flex-start; }
.thumb { width:56px; height:56px; border-radius:8px; background:#201612; display:grid; place-items:center; font-size:18px; color:#d9c8ae; }

.right-panel .tool { margin-bottom:12px; }
.btn { background:var(--accent); color:#070707; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
.btn.secondary { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }

.modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); }
.card { width:760px; max-width:94%; background:linear-gradient(180deg,#121212,#0f0f0f); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); color:#efece6; box-shadow:0 30px 80px rgba(0,0,0,0.8); }
.card.small { width:520px; max-width:92%; }

/* MENU */
#menuScreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99999; background:radial-gradient(ellipse at center, rgba(0,0,0,0.45), rgba(0,0,0,0.85)); }
.menuCard { width:880px; max-width:94%; background:linear-gradient(180deg,#0f0f0f,#090909); border-radius:14px; padding:26px; display:flex; gap:20px; box-shadow:0 30px 80px rgba(0,0,0,0.9); border:1px solid rgba(255,255,255,0.03); }
.menu-left { width:420px; padding-right:12px; border-right:1px solid rgba(255,255,255,0.02); }
.menu-right { flex:1; padding-left:12px; display:flex; flex-direction:column; gap:12px; }
.menu-title { font-family:Cinzel, serif; font-size:2.2rem; color:#efe6dc; margin:0; }
.menu-sub { color:var(--muted); margin-top:6px; }
.menu-buttons { display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; }
.menu-buttons .btn { padding:12px 18px; font-size:1rem; }

.phone { width:320px; border-radius:12px; background:linear-gradient(180deg,#0b0b0b,#0a0a0a); padding:10px; border:1px solid rgba(255,255,255,0.02); box-shadow:0 12px 30px rgba(0,0,0,0.6); }
.phone .screen{ height:260px; background:#060606; border-radius:8px; padding:8px; color:var(--muted); overflow:auto; }

.chat { display:flex; flex-direction:column; gap:8px; max-height:360px; overflow:auto; padding:8px; background:#0b0b0b; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }
.msg { padding:8px 10px; border-radius:8px; max-width:85%; }
.msg.ai { background:#1b1b1c; color:#e6e6e6; align-self:flex-start; }
.msg.user { background:#b08a5c; color:#070707; align-self:flex-end; }

#debug { position:fixed; right:12px; bottom:12px; width:320px; max-height:260px; overflow:auto; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(8,8,8,0.85)); color:#fff; border-radius:8px; padding:10px; border:1px solid rgba(255,255,255,0.03); font-size:12px; z-index:99998; }

/* small responsive */
@media (max-width:700px){
  .menuCard{ flex-direction:column; }
  .menu-left{ width:100%; border-right:none; padding-right:0; }
  .menu-right{ padding-left:0; }
}
</style>
</head>
<body>

<!-- MENU SCREEN -->
<div id="menuScreen" aria-hidden="false">
  <div class="menuCard" role="dialog" aria-modal="true" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
    <div class="menu-left">
      <h1 class="menu-title">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</h1>
      <p class="menu-sub">–ù–æ—á—å. –ì—Ä–æ–∑–∞. –¢–∞–π–Ω—ã. –°–æ–±–µ—Ä–∏—Ç–µ —É–ª–∏–∫–∏, –¥–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö, —Ä–µ—à–∏—Ç–µ –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–Ω–∞–ª.</p>
      <div style="margin-top:14px;">
        <div class="menu-buttons">
          <button id="startBtn" class="btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          <button id="loadBtn" class="btn secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤</button>
          <button id="settingsBtn" class="btn secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
      </div>
    </div>

    <div class="menu-right">
      <div>
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</strong>
        <ol style="color:var(--muted); margin-top:8px; padding-left:18px;">
          <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª. –í—ã –ø–æ–ø–∞–¥—ë—Ç–µ –≤ –æ—Å–æ–±–Ω—è–∫.</li>
          <li>–û—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—ã (–∫–Ω–æ–ø–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ), –æ—Ç–∫—Ä–æ–π—Ç–µ —É–ª–∏–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏.</li>
          <li>–ï—Å–ª–∏ —É–ª–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–¶–µ–∑–∞—Ä—å, –ø–∞–∑–ª, —ç–º–±–ª–µ–º—ã).</li>
          <li>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É–ª–∏–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º.</li>
          <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–î–æ–ø—Ä–æ—Å (–Ω–µ–π—Ä–æ—Å–µ—Ç—å)¬ª ‚Äî –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–≤–µ—á–∞–µ—Ç; –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≥–æ–ª–æ—Å.</li>
          <li>–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–ø–∞—Ä–Ω–∏–∫—É —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äî –æ–Ω –º–æ–∂–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.</li>
          <li>–ù–∞–∂–º–∏—Ç–µ ¬´–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É¬ª –∏–ª–∏ ¬´–û–±–≤–∏–Ω–∏—Ç—å¬ª, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã.</li>
        </ol>
      </div>

      <div style="margin-top:auto">
        <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞</strong>
        <p style="color:var(--muted)">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä—ã—Ç—å 3‚Äì5 —É–ª–∏–∫–æ–≤, –∑–∞—Ç–µ–º –Ω–∞—á–∞—Ç—å –¥–æ–ø—Ä–æ—Å—ã –∏ —Å–≤—è–∑—ã–≤–∞—Ç—å —É–ª–∏–∫–∏.</p>
      </div>
    </div>
  </div>
</div>

<!-- HEADER -->
<header class="header" role="banner">
  <div style="display:flex; gap:12px; align-items:center;">
    <div class="logo">–†</div>
    <div>
      <div style="font-family:Cinzel,serif;">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</div>
      <div class="small">–ü–æ–ª–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
    </div>
  </div>
  <div class="header-right">
    <div id="progressText" class="small">–ü—Ä–æ–≥—Ä–µ—Å—Å: <strong id="progressPct">0%</strong></div>
    <button id="menuOpenBtn" class="btn secondary">–ú–µ–Ω—é</button>
  </div>
</header>

<!-- MAIN -->
<main class="container" role="main" aria-live="polite">
  <!-- LEFT -->
  <aside class="panel left-panel" aria-label="–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ –∏ –∑–∞–º–µ—Ç–∫–∏">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <strong style="font-family:Cinzel, serif">–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ</strong>
      <button id="profilesBtn" class="btn secondary">–ü—Ä–æ—Ñ–∏–ª–∏</button>
    </div>
    <div id="suspectsList" style="margin-top:12px"></div>

    <div style="margin-top:14px;">
      <strong>–ë–ª–æ–∫–Ω–æ—Ç</strong>
      <textarea id="notebook" rows="6" style="width:100%; margin-top:8px; resize:vertical; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="saveNotes" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏</button>
        <button id="clearNotes" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="partnerHelp" class="btn">–ü–æ–º–æ—â—å –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <strong>–ö–∞–∫ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å —É–ª–∏–∫–∏</strong>
      <div class="small" style="margin-top:6px; color:var(--muted)">
        - –ù–∞ –ü–ö: –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É —É–ª–∏–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ.<br>
        - –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö: —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —É–ª–∏–∫—É 0.5‚Äì1—Å, –∑–∞—Ç–µ–º —Ç–∞–ø–Ω–∏—Ç–µ –ø–æ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–º—É.<br>
        - –ù–∞–ø–∞—Ä–Ω–∏–∫ –º–æ–∂–µ—Ç —É–∫–∞–∑–∞—Ç—å –Ω–∞ –ø–æ–ª–µ–∑–Ω—É—é —É–ª–∏–∫—É (–∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–º–æ—â—å –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞¬ª).
      </div>
    </div>
  </aside>

  <!-- CENTER -->
  <section class="panel map-panel" aria-label="–ö–∞—Ä—Ç–∞ –∏ —É–ª–∏–∫–∏">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="font-family:Cinzel, serif; font-size:1.05rem;">–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="findKiller" class="btn">–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É</button>
        <button id="interrogateBtn" class="btn secondary">–î–æ–ø—Ä–æ—Å (–Ω–µ–π—Ä–æ—Å–µ—Ç—å)</button>
        <button id="phoneOpenBtn" class="btn secondary">–¢–µ–ª–µ—Ñ–æ–Ω</button>
      </div>
    </div>

    <div class="map">
      <div class="map-canvas" id="mapCanvas">
        <div class="hotspot" data-room="library" style="left:18%; top:22%;">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div class="hotspot" data-room="music" style="left:48%; top:18%;">üéπ –ú—É–∑—ã–∫–∞</div>
        <div class="hotspot" data-room="office" style="left:76%; top:22%;">üóÑ –ö–∞–±–∏–Ω–µ—Ç</div>
        <div class="hotspot" data-room="dining" style="left:34%; top:56%;">üçΩ –°—Ç–æ–ª–æ–≤–∞—è</div>
        <div class="hotspot" data-room="garden" style="left:14%; top:78%;">üåπ –°–∞–¥</div>
        <div class="hotspot" data-room="basement" style="left:74%; top:76%;">‚öôÔ∏è –ü–æ–¥–≤–∞–ª</div>
        <div class="hotspot" data-room="attic" style="left:54%; top:44%;">üï∞ –ß–µ—Ä–¥–∞–∫</div>
      </div>

      <div style="display:flex; gap:12px; margin-top:12px;">
        <div style="flex:1">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>–£–ª–∏–∫–∏</strong>
            <div><span id="openedCount">0</span> / <span id="totalClues">0</span> –æ—Ç–∫—Ä—ã—Ç–æ</div>
          </div>
          <div id="cluesGrid" class="clues" style="margin-top:10px;"></div>
        </div>

        <div style="width:320px;">
          <div class="panel small">
            <strong>–¢–∞–π–º–ª–∞–π–Ω</strong>
            <div id="timelineList" style="margin-top:8px; min-height:80px; color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <input id="timelineInput" placeholder="23:10 ‚Äî –∫—Ä–∏–∫" style="flex:1; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"/>
              <button id="addTimeline" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div class="panel small" style="margin-top:12px;">
            <strong>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</strong>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button id="cipherBtn" class="btn">–¶–µ–∑–∞—Ä—å</button>
              <button id="puzzleBtn" class="btn secondary">–ü–∞–∑–ª</button>
              <button id="matchBtn" class="btn secondary">–≠–º–±–ª–µ–º—ã</button>
            </div>
            <div style="margin-top:8px; color:var(--muted)">–ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã –¥–∞—é—Ç –∫–ª—é—á–∏ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö —É–ª–∏–∫–æ–≤.</div>
          </div>

          <div class="panel small" style="margin-top:12px;">
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong>
            <div class="phone" style="margin-top:8px;">
              <div class="screen" id="phoneScreen">
                <div style="padding:6px; color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç—ã:
                  <div style="display:flex; gap:6px; margin-top:6px;">
                    <button id="callPartner" class="btn secondary">–ù–∞–ø–∞—Ä–Ω–∏–∫</button>
                    <button id="callPolice" class="btn secondary">–ü–æ–ª–∏—Ü–∏—è</button>
                  </div>
                </div>
                <div id="phoneLog" style="margin-top:8px; color:var(--muted)"></div>
              </div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input id="phoneInput" class="input" placeholder="–ù–æ–º–µ—Ä –∏–ª–∏ —Å–∞–π—Ç (–ø—Ä–∏–º–µ—Ä: 88 –∏–ª–∏ example.com)" style="flex:1; padding:8px; border-radius:8px; background:#0b0b0b; color:#efece6; border:1px solid rgba(255,255,255,0.03)">
                <button id="phoneCall" class="btn">–ó–≤–æ–Ω–æ–∫</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="panel right-panel" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
    <div class="tool">
      <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
      <div style="margin-top:8px;">–°–≤—è–∑–µ–π: <span id="linksCount">0</span></div>
      <div style="margin-top:8px;">–†–∏—Ç—É–∞–ª: <span id="ritualState">–Ω–µ—Ç</span></div>
      <div style="margin-top:8px;">–ê—É–¥–∏–æ: <span id="audioState">–≤—ã–∫–ª</span></div>
    </div>

    <div class="tool" style="margin-top:12px;">
      <strong>–ö–æ–Ω—Ü–æ–≤–∫–∏</strong>
      <div style="margin-top:8px; color:var(--muted)">–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏" ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä—ã—Ç—ã –∏ —Ç—Ä–µ–±—É—é—Ç –¥–µ–π—Å—Ç–≤–∏–π.</div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="endingsBtn" class="btn">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏</button>
        <button id="ritualBtn" class="btn secondary">–ò—Å–ø–æ–ª–Ω–∏—Ç—å —Ä–∏—Ç—É–∞–ª</button>
      </div>
    </div>

    <div class="tool" style="margin-top:12px;">
      <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong>
      <div style="margin-top:8px;">
        <label><input type="checkbox" id="toggleMusic"> –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</label><br>
        <label style="margin-top:6px"><input type="checkbox" id="toggleAmbience" checked> –¢—É–º–∞–Ω / —ç—Ñ—Ñ–µ–∫—Ç—ã</label><br>
        <label style="margin-top:6px"><input type="checkbox" id="toggleDetectiveVoice" checked> –ì–æ–ª–æ—Å –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ (TTS)</label>
      </div>
    </div>

    <div class="tool" style="margin-top:12px;">
      <strong>–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</strong>
      <div id="charsDesc" style="margin-top:8px; color:var(--muted)">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è (—Ä–æ—Å—Ç, –æ–±—É–≤—å, –ø—Ä–∏–≤—ã—á–∫–∏, –≤–Ω–µ—à–Ω–æ—Å—Ç—å).</div>
    </div>
  </aside>
</main>

<!-- MODALS (profiles, interrogation, cipher, puzzle, match, endings, ending reveal) -->
<div id="profilesModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö</h3><div id="profilesContent" style="margin-top:12px"></div><div style="text-align:right; margin-top:12px;"><button id="closeProfiles" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="interrogateModal" class="modal" aria-hidden="true"><div class="card"><h3>–î–æ–ø—Ä–æ—Å ‚Äî –ù–µ–π—Ä–æ—Å–µ—Ç—å –ø–æ–º–æ—â–Ω–∏–∫</h3>
  <div class="small" style="margin-top:6px">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ –∏ –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã. (–û—Ç–≤–µ—Ç—ã —Å–∏–º—É–ª–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.)</div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <select id="interrogateSelect" style="flex:1; padding:8px; border-radius:8px; background:#0b0b0b; color:#efece6; border:1px solid rgba(255,255,255,0.03)"></select>
    <button id="interrogateStart" class="btn">–í—ã–±—Ä–∞—Ç—å</button>
  </div>
  <div class="chat" id="chatWindow" style="margin-top:12px;"></div>
  <div style="display:flex; gap:8px; margin-top:8px;"><input id="chatInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å" class="input" style="flex:1; padding:8px; border-radius:8px;"><button id="chatSend" class="btn">–°–ø—Ä–æ—Å–∏—Ç—å</button><button id="chatClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div id="cipherModal" class="modal" aria-hidden="true"><div class="card small"><h3>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (–¶–µ–∑–∞—Ä—å)</h3><div class="small" style="margin-top:6px">–í–≤–µ–¥–∏—Ç–µ —Å–¥–≤–∏–≥ (1‚Äì25)</div><div style="display:flex; gap:8px; margin-top:8px;"><input id="cipherShift" class="input" type="number" min="1" max="25" value="3" style="padding:8px; border-radius:8px;"><button id="cipherTryBtn" class="btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button></div><textarea id="cipherOutput" rows="4" class="input" style="margin-top:8px; width:100%; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)" readonly></textarea><div style="text-align:right; margin-top:8px;"><button id="cipherCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="puzzleModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ü–∞–∑–ª ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞—Ä—Ç—É</h3><div id="puzzleBoard" style="margin-top:12px; display:grid; gap:4px; grid-template-columns: repeat(3, 1fr);"></div><div style="text-align:right; margin-top:12px;"><button id="puzzleClose" class="btn secondary">–û—Ç–º–µ–Ω–∞</button></div></div></div>

<div id="matchModal" class="modal" aria-hidden="true"><div class="card small"><h3>–≠–º–±–ª–µ–º—ã ‚Äî –ù–∞–π–¥–∏—Ç–µ –≤–µ—Ä–Ω—É—é</h3><div id="matchArea" style="display:flex; gap:8px; margin-top:12px; justify-content:space-around;"></div><div style="text-align:right; margin-top:12px;"><button id="matchCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingsModal" class="modal" aria-hidden="true"><div class="card"><h3>–ö–æ–Ω—Ü–æ–≤–∫–∏</h3><div id="endingsList" style="margin-top:12px" class="endings-grid"></div><div style="text-align:right; margin-top:12px;"><button id="endingsClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingRevealModal" class="modal" aria-hidden="true"><div class="card"><h3 id="endingTitle"></h3><div id="endingText" style="margin-top:12px; color:var(--muted)"></div><div style="text-align:right; margin-top:12px;"><button id="endingClose" class="btn">OK</button></div></div></div>

<!-- audio -->
<audio id="bgMusic" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2022/04/09/audio_2839a1de58.mp3" type="audio/mpeg"></audio>
<audio id="ambience" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2021/08/04/audio_5f5a8f1f44.mp3" type="audio/mpeg"></audio>
<audio id="clickSnd" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2023/03/03/audio_8f0b52d1b4.mp3?filename=interface-click-116929.mp3" type="audio/mpeg"></audio>

<div id="debug" aria-hidden="false"><strong>DEBUG</strong><div id="debugLog" style="white-space:pre-wrap; margin-top:8px; font-family:monospace; color:#cfcfcf">init...</div></div>

<script>
/*
  –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è:
   - –ù–∞–¥—ë–∂–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (DOMContentLoaded + –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
   - –†–∞–±–æ—á–µ–µ –º–µ–Ω—é (Start/Load/Settings)
   - –î–æ–ø—Ä–æ—Å (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏) + TTS –¥–ª—è –¥–µ—Ç–µ–∫—Ç–∏–≤–∞/—Å–≤–∏–¥–µ—Ç–µ–ª—è
   - –ü—Ä–æ—Ñ–∏–ª–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ (—Ä–æ—Å—Ç, –æ–±—É–≤—å, –ø—Ä–∏–≤—ã—á–∫–∏) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ –∫–ª–∏–∫—É
   - –¢–µ–ª–µ—Ñ–æ–Ω: –∫–Ω–æ–ø–∫–∏ "–Ω–∞–ø–∞—Ä–Ω–∏–∫" –∏ "–ø–æ–ª–∏—Ü–∏—è" + —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
   - –û–±–∑–æ—Ä –∫–æ–º–Ω–∞—Ç (hotspot) ‚Äî —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ —É–ª–∏–∫ –≤ –∫–æ–º–Ω–∞—Ç–µ
   - Drag&drop + –º–æ–±–∏–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ "—É–¥–µ—Ä–∂–∞–Ω–∏–µ -> —Ç–∞–ø" –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —É–ª–∏–∫
   - –ü–æ–º–æ—â—å –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞: –¥–∞—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫—É –∏–ª–∏ –≤—ã–¥–µ–ª–∏—Ç —É–ª–∏–∫—É
   - –ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã: –¶–µ–∑–∞—Ä—å, –ø–∞–∑–ª, —ç–º–±–ª–µ–º—ã
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–Ω—Ü–æ–≤–æ–∫, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–µ–π–≤–∞
   - –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –æ—à–∏–±–æ–∫
*/

/* ======= Helpers ======= */
const LOG = (...a)=>{ try{ document.getElementById('debugLog').textContent += '\\n' + a.join(' '); console.log(...a);}catch(e){ console.log(...a);} };
function $(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function showToast(text){ const d=document.createElement('div'); d.textContent = text; d.style.position='fixed'; d.style.left='50%'; d.style.bottom='18px'; d.style.transform='translateX(-50%)'; d.style.background='rgba(0,0,0,0.85)'; d.style.color='#fff'; d.style.padding='10px 14px'; d.style.borderRadius='8px'; d.style.zIndex=999999; document.body.appendChild(d); setTimeout(()=>{ d.style.transition='opacity .6s'; d.style.opacity=0; setTimeout(()=>d.remove(),600); }, 1500); }

/* ======= Data (same as before, kept short) ======= */
const DEFAULT_SUSPECTS = [
  { id:'adrian', name:'–≠–¥—Ä–∏–∞–Ω –†–æ—É–∑–≤—É–¥', role:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫', male:true, height:189, shoe:44, desc:'–•–æ–ª–æ–¥–Ω—ã–π, –≥–æ—Ä–¥—ã–π.' },
  { id:'beatrice', name:'–ë–µ–∞—Ç—Ä–∏—Å –•–µ–π–≤—É–¥', role:'–î–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞', male:false, height:165, shoe:37, desc:'–¢–∏—Ö–∞—è, –∑–Ω–∞–µ—Ç –≤—Å–µ —Ç–∞–π–Ω–∏–∫–∏.' },
  { id:'prof', name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ú–æ—Ä–¥–µ–Ω', role:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', male:true, height:178, shoe:42, desc:'–ü–æ–Ω–∏–º–∞–µ—Ç —Å–∏–º–≤–æ–ª—ã.' },
  { id:'victoria', name:'–í–∏–∫—Ç–æ—Ä–∏—è –†–æ—É–∑–≤—É–¥', role:'–ñ–µ–Ω–∞', male:false, height:172, shoe:39, desc:'–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞, –º–æ—Ç–∏–≤—ã.' },
  { id:'lina', name:'–õ–∏–Ω–∞ –ú–æ–Ω—Ç', role:'–ì–æ—Å—Ç—å—è', male:false, height:168, shoe:38, desc:'–ú–∏—Å—Ç–∏—á–µ—Å–∫–∞—è.' }
];

const MASTER_CLUES = [
  { id:'cl1', title:'–¢–∞–π–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞)', room:'office', type:'cipher', text:'Vkr ghqv wrfkh', locked:true },
  { id:'cl2', title:'–°–ª–µ–¥ –æ–±—É–≤–∏', room:'garden', type:'foot', text:'–ü–æ–¥–æ—à–≤–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º B7', locked:false },
  { id:'cl3', title:'–†–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç', room:'library', type:'paper', text:'–í—ã—Ä–≤–∞–Ω–æ –∏–º—è, –ø–æ–º–µ—Ç–∫–∞: 12/11', locked:false },
  { id:'cl4', title:'–°–∏–º–≤–æ–ª –Ω–∞ —Å—Ç–µ–Ω–µ', room:'music', type:'symbol', text:'–°—Ç—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª ‚Äî —ç–º–±–ª–µ–º–∞', locked:false },
  { id:'cl5', title:'–ü–µ–ø–µ–ª –∏ –ø—è—Ç–Ω–∞ –º–∞—Å–ª–∞', room:'dining', type:'ash', text:'–ü–µ–ø–µ–ª –∏ —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ', locked:false },
  { id:'cl6', title:'–§—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã (—Å–æ–∂–∂–µ–Ω)', room:'basement', type:'puzzle', text:'–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã ‚Äî –Ω—É–∂–µ–Ω –ø–∞–∑–ª', locked:true },
  { id:'cl7', title:'–§–ª–∞–∫–æ–Ω —Å —ç—Ñ–∏—Ä–æ–º', room:'attic', type:'vial', text:'–†–µ–¥–∫–∏–π —ç—Ñ–∏—Ä ‚Äî –∑–∞–ø–∞—Ö –Ω–∞—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞ –º—ã—Å–ª—å', locked:false }
];

const ENDINGS = [
  { id:'truth', title:'–ü—Ä–∞–≤–¥–∞ –∏ —Å—É–¥', desc:'–í—ã —Å–æ–±—Ä–∞–ª–∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî –≤–∏–Ω–æ–≤–Ω—ã–π –æ—Å—É–∂–¥—ë–Ω.', cond: s=> s.links['adrian'] && s.links['adrian'].length>=3 && s.timeline.length>=2 },
  { id:'open', title:'–ù–µ—Ä–∞—Å–∫—Ä—ã—Ç–æ', desc:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî –¥–µ–ª–æ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–∞–π–Ω–æ–π.', cond: s=> Object.values(s.links).flat().length < 3 }
];

/* ======= State ======= */
let state = {
  suspects: [], clues: [], opened: {}, links: {}, timeline: [], ritualPerformed:false, audioOn:false, musicOn:false, detectiveVoice:true
};

/* ======= Reliable init: DOMContentLoaded + delegation ======= */
document.addEventListener('DOMContentLoaded', () => {
  LOG('DOM ready ‚Äî initializing UI handlers');
  safeBindMenuDelegation();
  bindGlobalHandlers();
  // menu remains visible until Start
});

/* ======= Delegated menu handlers (works even if early script errors occurred) ======= */
function safeBindMenuDelegation(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#startBtn, #loadBtn, #settingsBtn, #menuOpenBtn');
    if(!btn) return;
    if(btn.id === 'startBtn'){ openMenu(false); newGame(); }
    if(btn.id === 'loadBtn'){ const s = loadState('autosave'); if(s && confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤?')){ state = s; renderAll(); openMenu(false); showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω'); } else showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'); }
    if(btn.id === 'settingsBtn'){ alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî —Å–ø—Ä–∞–≤–∞.'); }
    if(btn.id === 'menuOpenBtn'){ openMenu(true); }
  }, true);
  LOG('Menu delegation installed');
}

/* ======= Save / Load helpers ======= */
function saveState(key){ try{ localStorage.setItem('rose_'+key, JSON.stringify(state)); LOG('Saved', key); }catch(e){ LOG('save err', e); } }
function loadState(key){ try{ const raw = localStorage.getItem('rose_'+key); return raw ? JSON.parse(raw) : null; }catch(e){ LOG('load err', e); return null; }}

/* ======= New game ======= */
function newGame(){
  state.suspects = JSON.parse(JSON.stringify(DEFAULT_SUSPECTS)).sort(()=>Math.random()-0.5);
  state.clues = JSON.parse(JSON.stringify(MASTER_CLUES));
  state.opened = {}; state.links = {}; state.timeline = []; state.ritualPerformed = false;
  state.suspects.forEach(s => state.links[s.id]=[]);
  renderAll();
  saveState('autosave');
  showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞');
}

/* ======= Render functions ======= */
function renderSuspects(){
  const area = $('suspectsList'); area.innerHTML = '';
  state.suspects.forEach((s, idx)=>{
    const div = document.createElement('div'); div.className='suspect'; div.dataset.suspect = s.id;
    // use user-provided images for female suspects if available
    let avatarHtml = `<div class="avatar">${escapeHtml(s.name[0])}</div>`;
    if(!s.male){
      const femaleIndex = state.suspects.filter(x=>!x.male).map(x=>x.id).indexOf(s.id);
      const src = `assets/female${Math.min(3,femaleIndex+1)}.jpg`;
      avatarHtml = `<img class="avatar" src="${src}" alt="${escapeHtml(s.name)}" onerror="this.style.display='none';">`;
    }
    const linked = (state.links[s.id] || []).length;
    div.innerHTML = `${avatarHtml}<div class="smeta"><div class="sname">${escapeHtml(s.name)}</div><div class="srole">${escapeHtml(s.role)}</div><div class="meta-row">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe}</div><div class="meta-row" style="margin-top:6px; color:var(--muted)">${escapeHtml(s.desc)}</div></div><div class="dropzone" data-suspect="${s.id}">${linked}</div>`;
    // click opens profile modal
    div.addEventListener('click', ()=> openProfileModal(s));
    area.appendChild(div);
  });
  attachDropzones();
}

function renderClues(){
  const grid = $('cluesGrid'); grid.innerHTML = '';
  state.clues.forEach(c=>{
    const isOpen = !!state.opened[c.id];
    const el = document.createElement('div'); el.className='clue'; el.id=c.id; el.dataset.clue=c.id;
    el.innerHTML = `<div class="thumb">${getIcon(c.type)}</div><div><h4>${escapeHtml(c.title)}</h4><p>${ isOpen ? escapeHtml(c.text) : (c.locked ? '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ / —Å–∫—Ä—ã—Ç–∞' : escapeHtml(c.text)) }</p></div>`;
    el.addEventListener('click', ()=> onClueClick(c));
    el.draggable = true;
    el.addEventListener('dragstart', ev=> ev.dataTransfer.setData('text/plain', c.id));
    // touch support for long press
    addTouchDragSupport(el, c.id);
    grid.appendChild(el);
  });
  $('totalClues').innerText = state.clues.length;
  $('openedCount').innerText = Object.keys(state.opened).length;
}

function renderTimeline(){
  const el = $('timelineList'); if(state.timeline.length===0){ el.innerHTML = '<div class="small" style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  el.innerHTML = state.timeline.slice().reverse().map(t => `<div style="margin-bottom:6px">${escapeHtml(t.text)} <span style="color:var(--muted); font-size:0.82rem">(${new Date(t.time).toLocaleTimeString()})</span></div>`).join('');
}

function renderStats(){
  $('linksCount').innerText = Object.values(state.links).flat().length;
  $('ritualState').innerText = state.ritualPerformed ? '–¥–∞' : '–Ω–µ—Ç';
  updateProgress();
}

function renderProfilesModal(){
  const cont = $('profilesContent'); cont.innerHTML = '';
  state.suspects.forEach(s=>{
    const div = document.createElement('div'); div.style.marginBottom='12px';
    const linked = state.links[s.id] ? state.links[s.id].length : 0;
    div.innerHTML = `<strong>${escapeHtml(s.name)}</strong> ‚Äî <em>${escapeHtml(s.role)}</em><div style="color:var(--muted); margin-top:6px">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe} ¬∑ –£–ª–∏–∫: ${linked}</div><div style="margin-top:6px">${escapeHtml(s.desc)}</div><div style="margin-top:8px"><button class="btn" onclick="inspectSuspect('${s.id}')">–î–æ–ø—Ä–æ—Å–∏—Ç—å</button> <button class="btn secondary" onclick="showPhysical('${s.id}')">–í–Ω–µ—à–Ω–æ—Å—Ç—å</button></div>`;
    cont.appendChild(div);
  });
}

/* ======= Clue interactions ======= */
function onClueClick(c){
  LOG('Clue click', c.id);
  if(c.locked && !state.opened[c.id]){
    if(c.type==='cipher' || c.type==='cipher2'){ openCipherModal(c); return; }
    if(c.type==='puzzle'){ openPuzzleModal(); return; }
    if(c.type==='symbol' || c.type==='seal'){ openMatchModal(c); return; }
    showToast('–≠—Ç–∞ —É–ª–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.');
    return;
  }
  if(!state.opened[c.id]){ state.opened[c.id]=true; revealClueText(c); renderClues(); renderStats(); return; }
  showDetail(c);
}
function revealClueText(c){
  if(c.type==='cipher' && c.text==='Vkr ghqv wrfkh') c.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª';
  if(c.type==='puzzle' && c.text.includes('–ß–∞—Å—Ç–∏')) c.text = '–ö–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: –Ω–∞–π–¥–µ–Ω —Å–∫—Ä—ã—Ç—ã–π —Ö–æ–¥.';
  state.opened[c.id] = true;
}
function showDetail(c){
  $('endingTitle').innerText = c.title;
  $('endingText').innerHTML = `<div style="color:var(--muted)">${escapeHtml(c.text)}</div>`;
  $('endingRevealModal').style.display = 'flex';
}

/* ======= Drag & Drop / Mobile linking ======= */
function attachDropzones(){
  document.querySelectorAll('.dropzone').forEach(zone => {
    zone.addEventListener('dragover', ev=> { ev.preventDefault(); zone.style.outline='2px dashed rgba(176,138,92,0.6)'; });
    zone.addEventListener('dragleave', ev=> zone.style.outline='');
    zone.addEventListener('drop', ev=> { ev.preventDefault(); zone.style.outline=''; const clueId = ev.dataTransfer.getData('text/plain'); const suspectId = zone.dataset.suspect; if(clueId && suspectId) linkEvidence(suspectId, clueId); });
    // tap on dropzone while mobile "holding" a clue
    zone.addEventListener('touchend', ()=> {
      const held = document.body.dataset.draggingClue;
      if(held){ const suspectId = zone.dataset.suspect; linkEvidence(suspectId, held); document.body.dataset.draggingClue=''; }
    });
  });
}
function addTouchDragSupport(el, clueId){
  let timer=null;
  el.addEventListener('touchstart', ()=> {
    timer = setTimeout(()=> { document.body.dataset.draggingClue = clueId; el.style.opacity=0.6; showToast('–¢–µ–ø–µ—Äe –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å —É–ª–∏–∫—É'); }, 600);
  }, {passive:true});
  el.addEventListener('touchend', ()=> { clearTimeout(timer); setTimeout(()=> { el.style.opacity=''; document.body.dataset.draggingClue=''; }, 200); });
}

function linkEvidence(suspectId, clueId){
  if(!state.links[suspectId]) state.links[suspectId]=[];
  if(state.links[suspectId].includes(clueId)){ showToast('–£–ª–∏–∫–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞'); return; }
  state.links[suspectId].push(clueId);
  showToast('–£–ª–∏–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞');
  renderAll(); saveState('autosave');
}

/* ======= Mini-games & tools ======= */
function openCipherModal(clue){
  const modal = $('cipherModal'); modal.style.display='flex'; modal.dataset.clue = clue ? clue.id : '';
  $('cipherOutput').value=''; $('cipherShift').value=3;
}
function tryCipher(){
  const shift = Number($('cipherShift').value) || 0; const clueId = $('cipherModal').dataset.clue;
  const clue = state.clues.find(c=>c.id===clueId) || state.clues.find(c=>c.type==='cipher' || c.type==='cipher2');
  if(!clue){ showToast('–ó–∞–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
  const decoded = caesarDecode(clue.text, shift); $('cipherOutput').value = decoded;
  if(/–æ–Ω –∑–Ω–∞–µ—Ç|–≤\./i.test(decoded) || shift===3){
    showToast('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞'); clue.locked=false; clue.text='–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª'; state.opened[clue.id]=true; renderClues(); renderStats(); $('cipherModal').style.display='none';
  }
}
function caesarDecode(s, shift){ if(!s) return s; const a='abcdefghijklmnopqrstuvwxyz', A=a.toUpperCase(); return s.split('').map(ch=>{ if(a.includes(ch)) return a[(a.indexOf(ch)-shift+26)%26]; if(A.includes(ch)) return A[(A.indexOf(ch)-shift+26)%26]; return ch; }).join(''); }

let puzzleSolved=false;
function openPuzzleModal(){
  const modal = $('puzzleModal'); modal.style.display='flex'; const board = $('puzzleBoard'); board.innerHTML='';
  const nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
  nums.forEach(n=>{ const p=document.createElement('div'); p.style.background='#201612'; p.style.color='#d9c8ae'; p.style.display='grid'; p.style.placeItems='center'; p.style.height='80px'; p.style.borderRadius='6px'; p.style.cursor='pointer'; p.textContent = n===9? '': n; p.dataset.num=n; p.addEventListener('click', ()=> clickPuzzlePiece(board,p)); board.appendChild(p); });
}
function clickPuzzlePiece(board, piece){
  const empty = Array.from(board.children).find(c=>c.dataset.num=='9'); if(!empty) return;
  const idx = Array.from(board.children).indexOf(piece), eidx = Array.from(board.children).indexOf(empty), dist = Math.abs(idx-eidx);
  if(dist===1 || dist===3){ const t=piece.dataset.num; piece.dataset.num=empty.dataset.num; empty.dataset.num=t; const tmp = piece.textContent; piece.textContent = empty.textContent; empty.textContent = tmp; checkPuzzleSolved(board); }
}
function checkPuzzleSolved(board){
  const order = Array.from(board.children).map(c=>Number(c.dataset.num)); const ok = order.every((v,i)=> v===i+1);
  if(ok && !puzzleSolved){ puzzleSolved=true; const clue=state.clues.find(c=>c.type==='puzzle'); if(clue){ clue.locked=false; clue.text='–ö–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: –Ω–∞–π–¥–µ–Ω —Å–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ö–æ–¥.'; state.opened[clue.id]=true; renderClues(); renderStats(); } showToast('–ü–∞–∑–ª —Ä–µ—à—ë–Ω!'); $('puzzleModal').style.display='none'; }
}

function openMatchModal(clue){
  const modal = $('matchModal'); modal.style.display='flex'; const area = $('matchArea'); area.innerHTML='';
  const opts = [{id:'A',ok:false},{id:'B',ok:true},{id:'C',ok:false}].sort(()=>Math.random()-0.5);
  opts.forEach(o=>{ const btn=document.createElement('div'); btn.style.width='120px'; btn.style.height='120px'; btn.style.borderRadius='8px'; btn.style.background='#211815'; btn.style.display='grid'; btn.style.placeItems='center'; btn.style.cursor='pointer'; btn.innerHTML=`<div>${o.id}</div>`; btn.addEventListener('click', ()=>{ if(o.ok){ showToast('–≠–º–±–ª–µ–º–∞ —Å–æ–≤–ø–∞–ª–∞ ‚Äî —É–ª–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞.'); const target=(clue && state.clues.find(x=>x.id===clue.id))||state.clues.find(x=>x.type==='symbol'); if(target){ target.locked=false; state.opened[target.id]=true; renderClues(); renderStats(); } modal.style.display='none'; } else showToast('–ù–µ —Ç–æ.'); }); area.appendChild(btn); });
}

/* ======= Interrogation (simulated neural + TTS) ======= */
function openInterrogation(){
  $('interrogateModal').style.display='flex';
  populateInterrogateSelect();
  $('chatWindow').innerHTML='';
}
function populateInterrogateSelect(){ const sel = $('interrogateSelect'); sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ ‚Äî</option>'; state.suspects.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); }); }
function startInterrogation(){ const id=$('interrogateSelect').value; if(!id){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'); return; } addChatAI(`–í—ã –¥–æ–ø—Ä–æ—Å–∏—Ç–µ ${state.suspects.find(s=>s.id===id).name}. –ì–æ—Ç–æ–≤–æ.`); }
function addChatAI(text){ const chat=$('chatWindow'); const m=document.createElement('div'); m.className='msg ai'; m.textContent=text; chat.appendChild(m); chat.scrollTop=chat.scrollHeight; if(state.detectiveVoice) speakText(text,'suspect'); }
function addChatUser(text){ const chat=$('chatWindow'); const m=document.createElement('div'); m.className='msg user'; m.textContent=text; chat.appendChild(m); chat.scrollTop=chat.scrollHeight; if(state.detectiveVoice) speakText(text,'detective'); }
function handleChatAsk(){ const q=$('chatInput').value.trim(); if(!q) return; addChatUser(q); $('chatInput').value=''; setTimeout(()=>{ const id=$('interrogateSelect').value; const resp=generateAIResponseForSuspect(q,id); addChatAI(resp); }, 500 + Math.random()*800); }
function generateAIResponseForSuspect(question, suspectId){
  if(!suspectId) return '–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ.';
  const s = state.suspects.find(x=>x.id===suspectId);
  const q = question.toLowerCase();
  if(q.includes('–≥–¥–µ') && q.includes('–±—ã–ª–∏')) return `${s.name}: –Ø –±—ã–ª–∞(–±) –≤ –¥–æ–º–µ, –æ–∫–æ–ª–æ 23:00.`;
  if(q.includes('–∑–∞–ø–∏—Å') || q.includes('—à–∏—Ñ—Ä')) return `${s.name}: –í –∑–∞–ø–∏—Å–∫–µ —á—Ç–æ-—Ç–æ –ø—Ä–æ "–í." ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª—ã.`;
  if(q.includes('—Å–∏–º–≤–æ–ª')) return `${s.name}: –°–∏–º–≤–æ–ª –ø–æ—Ö–æ–∂ –Ω–∞ —Å–µ–º–µ–π–Ω—É—é –ø–µ—á–∞—Ç—å –ú–æ—Ä–¥–µ–Ω–æ–≤.`;
  return `${s.name}: –Ø –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –º–æ–ª—á–∞—Ç—å.`;
}
function speakText(text, who='detective'){ if(!('speechSynthesis' in window)) return; if(!state.detectiveVoice) return; const utter=new SpeechSynthesisUtterance(text); const voices=speechSynthesis.getVoices(); const v = voices[0] || null; if(v) utter.voice=v; utter.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(utter); }

/* ======= Profiles modal helpers (inspect / show physical) ======= */
function openProfileModal(s){ renderProfilesModal(); $('profilesModal').style.display='flex'; }
function inspectSuspect(id){ $('profilesModal').style.display='none'; $('interrogateModal').style.display='flex'; $('interrogateSelect').value = id; addChatAI(`–î–æ–ø—Ä–æ—Å ${state.suspects.find(s=>s.id===id).name} –≥–æ—Ç–æ–≤.`); }
function showPhysical(id){ const s = state.suspects.find(x=>x.id===id); const text = `${s.name}. –†–æ—Å—Ç: ${s.height} —Å–º. –û–±—É–≤—å: ${s.shoe}. –í–Ω–µ—à–Ω–æ—Å—Ç—å: ${s.desc}. –ü—Ä–∏–≤—ã—á–∫–∏: –¥–µ—Ä–∂–∞—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.`; $('endingTitle').innerText = '–í–Ω–µ—à–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–≤—ã—á–∫–∏'; $('endingText').innerHTML = `<div style="color:var(--muted)">${escapeHtml(text)}</div>`; $('endingRevealModal').style.display='flex'; }

/* ======= Phone actions ======= */
function bindPhone(){
  $('callPartner').addEventListener('click', ()=> {
    const log = $('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–ó–≤–æ–Ω–æ–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫—É... —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</div>` + log.innerHTML;
    setTimeout(()=> { log.innerHTML = `<div style="color:var(--muted)">'–ü—Ä–∏–µ–¥—É —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç. –ü—Ä–æ–≤–µ—Ä—å —á–µ—Ä–¥–∞–∫', ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞–ø–∞—Ä–Ω–∏–∫.</div>` + log.innerHTML; }, 1200);
  });
  $('callPolice').addEventListener('click', ()=> {
    const log = $('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–í—ã–∑–æ–≤ –ø–æ–ª–∏—Ü–∏–∏... —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</div>` + log.innerHTML;
    setTimeout(()=> { log.innerHTML = `<div style="color:var(--muted)">'–ü–∞—Ç—Ä—É–ª—å –≤—ã–µ—Ö–∞–ª –Ω–∞ –º–µ—Å—Ç–æ', ‚Äî —Å–æ–æ–±—â–∞–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä.</div>` + log.innerHTML; }, 1200);
  });
  $('phoneCall').addEventListener('click', ()=> {
    const val = $('phoneInput').value.trim(); const log = $('phoneLog');
    if(!val) return; if(val.includes('.')||val.startsWith('http')){ const url = val.startsWith('http')?val:'http://'+val; window.open(url,'_blank'); log.innerHTML = `<div style="color:var(--muted)">–û—Ç–∫—Ä—ã—Ç —Å–∞–π—Ç: ${escapeHtml(val)}</div>` + log.innerHTML; } else { log.innerHTML = `<div style="color:var(--muted)">–í—ã–∑–æ–≤ ${escapeHtml(val)} ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>` + log.innerHTML; setTimeout(()=>{ log.innerHTML = `<div style="color:var(--muted)">'–ù–æ–º–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', ‚Äî –≥–æ–ª–æ—Å —Å–æ–æ–±—â–∞–µ—Ç.</div>` + log.innerHTML; }, 1100); }
  });
}

/* ======= Find killer & accuse ======= */
function tryFindKiller(){
  const counts = state.suspects.map(s=>({ id:s.id, name:s.name, c:(state.links[s.id]||[]).length }));
  counts.sort((a,b)=>b.c-a.c);
  const top = counts[0];
  if(!top || top.c===0){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤'); return; }
  showToast('–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —É–±–∏–π—Ü–∞: ' + top.name);
  $('accuseSelect') && ($('accuseSelect').value = top.id);
  accuseSelected();
}
function populateAccuse(){ const sel = $('accuseSelect'); if(!sel) return; sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>'; state.suspects.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); }); }
function accuseSelected(){
  const sel = $('accuseSelect'); const id = sel ? sel.value : null; if(!id){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'); return; }
  const matched = ENDINGS.filter(e => e.cond(state));
  if(matched.length>0){ showEnding(matched[0].id); return; }
  const links = state.links[id]||[];
  if(links.length>=3 && id==='adrian'){ showEnding('truth'); return; }
  showEnding('open');
}
function showEnding(id){ const e = ENDINGS.find(x=>x.id===id); if(!e) return; $('endingTitle').innerText = e.title; $('endingText').innerText = e.desc; $('endingRevealModal').style.display='flex'; const hist = JSON.parse(localStorage.getItem('rose_endings')||'[]'); hist.unshift({id:e.id,time:new Date().toISOString()}); localStorage.setItem('rose_endings', JSON.stringify(hist.slice(0,50))); }

/* ======= Ritual helper (not required) ======= */
function performRitual(){ if(state.ritualPerformed){ showToast('–†–∏—Ç—É–∞–ª —É–∂–µ –∏—Å–ø–æ–ª–Ω–µ–Ω.'); return; } if(!confirm('–ò—Å–ø–æ–ª–Ω–∏—Ç—å —Ä–∏—Ç—É–∞–ª?')) return; state.ritualPerformed=true; showToast('–†–∏—Ç—É–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äî –≤–æ–∑–¥—É—Ö —Å—Ç–∞–ª —Ö–æ–ª–æ–¥–Ω–µ–µ...'); const special = { id:'cl_ritual', title:'–†–∏—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏', room:'basement', type:'ritual', text:'–ó–∞–≥–∞–¥–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –æ—Å—Ç–∞—Ç–∫–∏ –≤–æ—Å–∫–∞', locked:false }; state.clues.push(special); state.opened[special.id]=true; renderClues(); renderStats(); }

/* ======= Partner help feature ======= */
function partnerHelp(){
  // simple behavior: if there are unopened locked clues -> highlight one; otherwise give textual hint
  const locked = state.clues.filter(c=> c.locked && !state.opened[c.id]);
  if(locked.length>0){
    const pick = locked[Math.floor(Math.random()*locked.length)];
    // highlight pick element and show toast
    const el = document.getElementById(pick.id);
    if(el){ el.style.boxShadow = '0 0 18px rgba(176,138,92,0.9)'; setTimeout(()=> el.style.boxShadow='', 2400); }
    showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫ –ø–æ–¥—Å–∫–∞–∑–∞–ª: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ ' + pick.title);
  } else {
    // if no locked, suggest useful action
    const suggestion = '–ù–∞–ø–∞—Ä–Ω–∏–∫: –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —á–µ—Ä–Ω–∏–ª—å–Ω—ã–µ —Å–ª–µ–¥—ã –∏ —Å—Ä–∞–≤–Ω–∏ —Å –∑–∞–ø–∏—Å—è–º–∏ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.';
    showToast(suggestion);
  }
}

/* ======= Utilities: icons, progress ======= */
function getIcon(type){ switch(type){ case 'cipher': return '‚úâÔ∏è'; case 'puzzle': return 'üß©'; case 'symbol': return 'üî±'; case 'vial': return 'üß™'; case 'foot': return 'üë£'; case 'ink': return 'üñãÔ∏è'; default: return 'üîé'; } }
function updateProgress(){ const openedCount = Object.keys(state.opened).length + Object.values(state.links).flat().length; const total = state.clues.length + 2; const pct = Math.min(100, Math.round((openedCount/total)*100)); $('progressPct').innerText = pct + '%'; }

/* ======= Misc helpers for profile modals and UI bind ======= */
function openMenu(show){ document.getElementById('menuScreen').style.display = show ? 'flex' : 'none'; }

function renderAll(){ renderSuspects(); renderClues(); renderTimeline(); renderStats(); populateAccuse(); renderProfilesModal(); }

function renderProfilesModal(){ const cont = $('profilesContent'); cont.innerHTML=''; state.suspects.forEach(s=>{ const div=document.createElement('div'); div.style.marginBottom='12px'; const linked = state.links[s.id] ? state.links[s.id].length : 0; div.innerHTML = `<strong>${escapeHtml(s.name)}</strong> ‚Äî <em>${escapeHtml(s.role)}</em><div class="small" style="color:var(--muted); margin-top:6px">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe} ¬∑ –ü—Ä–∏–≤—ã—á–∫–∏: ${escapeHtml(s.desc)}</div><div style="margin-top:8px"><button class="btn" onclick="inspectSuspect('${s.id}')">–î–æ–ø—Ä–æ—Å–∏—Ç—å</button> <button class="btn secondary" onclick="showPhysical('${s.id}')">–í–Ω–µ—à–Ω–æ—Å—Ç—å</button></div><div style="margin-top:6px; color:var(--muted)">–°–≤—è–∑–∞–Ω–æ —É–ª–∏–∫: ${linked}</div>`; cont.appendChild(div); }); }

window.inspectSuspect = function(id){ $('profilesModal').style.display='none'; $('interrogateModal').style.display='flex'; $('interrogateSelect').value = id; addChatAI(`–ì–æ—Ç–æ–≤ –∫ –¥–æ–ø—Ä–æ—Å—É: ${state.suspects.find(s=>s.id===id).name}`); }
window.showPhysical = function(id){ const s = state.suspects.find(x=>x.id===id); if(!s) return; const text = `${s.name}. –†–æ—Å—Ç: ${s.height} —Å–º. –†–∞–∑–º–µ—Ä –æ–±—É–≤–∏: ${s.shoe}. –í–Ω–µ—à–Ω–æ—Å—Ç—å: ${s.desc}. –ü—Ä–∏–≤—ã—á–∫–∏: –∫—É—Ä–∏—Ç / –Ω–æ—Å–∏—Ç –ø–µ—Ä—á–∞—Ç–∫–∏.`; $('endingTitle').innerText = '–í–Ω–µ—à–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–≤—ã—á–∫–∏'; $('endingText').innerHTML = `<div style="color:var(--muted)">${escapeHtml(text)}</div>`; $('endingRevealModal').style.display='flex'; }

/* ======= Bind remaining UI after DOM loaded ======= */
function bindGlobalHandlers(){
  // hotspots
  document.querySelectorAll('.hotspot').forEach(h=> h.addEventListener('click', ()=> { const room=h.dataset.room; inspectRoom(room); try{ document.getElementById('clickSnd') && document.getElementById('clickSnd').play(); }catch(e){} }));
  // tools
  $('cipherBtn').addEventListener('click', ()=> openCipherModal(null));
  $('cipherTryBtn').addEventListener('click', tryCipher);
  $('cipherCloseBtn').addEventListener('click', ()=> $('cipherModal').style.display='none');
  $('puzzleBtn').addEventListener('click', openPuzzleModal);
  $('puzzleClose').addEventListener('click', ()=> $('puzzleModal').style.display='none');
  $('matchBtn').addEventListener('click', ()=> openMatchModal(null));
  $('matchCloseBtn').addEventListener('click', ()=> $('matchModal').style.display='none');

  // timeline
  $('addTimeline').addEventListener('click', ()=> { const v=$('timelineInput').value.trim(); if(!v) return; state.timeline.push({text:v,time:new Date().toISOString()}); $('timelineInput').value=''; renderTimeline(); saveState('autosave'); renderStats(); });

  // phone
  bindPhone();

  // interrogation
  $('interrogateBtn').addEventListener('click', ()=> { openInterrogation(); populateInterrogateSelect(); });
  $('interrogateStart').addEventListener('click', startInterrogation);
  $('chatSend').addEventListener('click', handleChatAsk);
  $('chatClose').addEventListener('click', ()=> $('interrogateModal').style.display='none');

  // partner help
  $('partnerHelp').addEventListener('click', partnerHelp);

  // find killer, accuse (accuseSelect may not exist in DOM in this simple file; ensure safe)
  $('findKiller').addEventListener('click', tryFindKiller);
  document.querySelectorAll('#accuseBtn').forEach(b=> b.addEventListener('click', accuseSelected));

  // endings
  $('endingsBtn').addEventListener('click', ()=> { const list=$('endingsList'); list.innerHTML=''; ENDINGS.forEach(e=>{ const card=document.createElement('div'); card.className='ending-card'; card.style.padding='10px'; const unlocked = e.cond ? e.cond(state) : false; card.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong>${escapeHtml(e.title)}</strong><div style="color:${unlocked?'#9fff9f':'#cfcfcf'}">${unlocked? '–î–æ—Å—Ç—É–ø–Ω–∞':'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}</div></div><div style="color:var(--muted); margin-top:6px">${escapeHtml(e.desc)}</div>`; card.addEventListener('click', ()=> { if(unlocked) showEnding(e.id); else showToast('–≠—Ç–∞ –∫–æ–Ω—Ü–æ–≤–∫–∞ –µ—â—ë –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞'); }); list.appendChild(card); }); $('endingsModal').style.display='flex'; });
  $('endingsClose').addEventListener('click', ()=> $('endingsModal').style.display='none');

  // ritual
  $('ritualBtn').addEventListener('click', performRitual);

  // profiles
  $('profilesBtn').addEventListener('click', ()=> { renderProfilesModal(); $('profilesModal').style.display='flex'; });
  $('closeProfiles').addEventListener('click', ()=> $('profilesModal').style.display='none');

  // phone open
  $('phoneOpenBtn').addEventListener('click', ()=> { showToast('–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–∫—Ä—ã—Ç'); });

  // menu open/close
  $('menuOpenBtn').addEventListener('click', ()=> openMenu(true));
  $('endingClose').addEventListener('click', ()=> $('endingRevealModal').style.display='none');

  // notes save/clear
  $('saveNotes').addEventListener('click', ()=> { localStorage.setItem('rose_notes', $('notebook').value||''); showToast('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'); });
  $('clearNotes').addEventListener('click', ()=> { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏?')) { $('notebook').value=''; localStorage.removeItem('rose_notes'); } });

  // audio toggles
  $('audioToggle') && $('audioToggle').addEventListener('click', ()=> {
    state.audioOn = !state.audioOn; $('audioState').innerText = state.audioOn ? '–≤–∫–ª' : '–≤—ã–∫–ª'; $('audioToggle').innerText = state.audioOn ? '–ó–≤—É–∫: –≤–∫–ª' : '–ó–≤—É–∫: –≤—ã–∫–ª';
    if(state.audioOn){ if($('toggleMusic').checked){ $('bgMusic').volume=0.12; $('bgMusic').play().catch(()=>{});} $('ambience').volume=0.18; $('ambience').play().catch(()=>{}); } else { $('bgMusic').pause(); $('ambience').pause(); }
  });

  // settings toggles
  $('toggleMusic').addEventListener('change', e=> { state.musicOn = e.target.checked; if(state.musicOn && state.audioOn) $('bgMusic').play().catch(()=>{}); else $('bgMusic').pause(); });
  $('toggleAmbience').addEventListener('change', e=> { if(e.target.checked && state.audioOn) $('ambience').play().catch(()=>{}); else $('ambience').pause(); });
  $('toggleDetectiveVoice').addEventListener('change', e=> state.detectiveVoice = e.target.checked);

  // initial load: try to load autosave
  const autos = loadState('autosave'); if(autos && confirm('–ù–∞–π–¥–µ–Ω –∞–≤—Ç–æ—Å–µ–π–≤. –ó–∞–≥—Ä—É–∑–∏—Ç—å?')){ state = autos; renderAll(); openMenu(false); showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω'); } else { /* leave menu open until start */ }
  bindPhone();
  LOG('Global handlers bound');
}

/* ======= Room inspection ======= */
function inspectRoom(room){
  const found = state.clues.filter(c=> c.room === room);
  if(found.length===0){ showToast('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ.'); return; }
  found.forEach(c=> {
    if(!c.locked){ state.opened[c.id] = true; }
    else {
      const el = document.getElementById(c.id); if(el) el.querySelector('p').textContent = '–ù–∞–π–¥–µ–Ω–∞, –Ω–æ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç';
    }
  });
  renderClues(); renderTimeline(); renderStats(); showToast(`–û—Å–º–æ—Ç—Ä ${room}: –Ω–∞–π–¥–µ–Ω–æ ${found.length} —É–ª–∏–∫`);
}

/* ======= Partner help (public) ======= */
$('partnerHelp') && $('partnerHelp').addEventListener('click', partnerHelp);
function partnerHelp(){
  const locked = state.clues.filter(c=> c.locked && !state.opened[c.id]);
  if(locked.length>0){
    const pick = locked[Math.floor(Math.random()*locked.length)];
    const el = document.getElementById(pick.id);
    if(el){ el.style.boxShadow = '0 0 18px rgba(176,138,92,0.95)'; setTimeout(()=> el.style.boxShadow = '', 2600); }
    showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ ‚Äî ' + pick.title);
  } else {
    showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫: –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —á–µ—Ä–Ω–∏–ª—å–Ω—ã–µ —Å–ª–µ–¥—ã –∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å –∑–∞–ø–∏—Å—è–º–∏ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.');
  }
}

/* ======= Utility initial render helpers ======= */
function renderAll(){ renderSuspects(); renderClues(); renderTimeline(); renderStats(); populateAccuse(); renderProfilesModal(); updateProgress(); }

function populateAccuse(){ /* safe populate if element exists */ const sel = $('accuseSelect'); if(!sel) return; sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>'; state.suspects.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); }); }

/* ======= Expose some functions for debug ======= */
window.newGame = newGame;
window.tryFindKiller = tryFindKiller;
window.performRitual = performRitual;
window.partnerHelp = partnerHelp;

LOG('Script loaded. Menu ready.');
</script>
</body>
</html>
