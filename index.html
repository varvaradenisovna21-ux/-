<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥ ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0b0d;
  --panel:#141215;
  --accent:#b08a5c;
  --accent-2:#7a4e2f;
  --muted:#cfcfcf;
  --danger:#b04a4a;
  --glass:rgba(255,255,255,0.035);
  --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; background:linear-gradient(180deg,#070607 0%, #0e0e10 80%); color:#efece6; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased;}
.header{
  display:flex; justify-content:space-between; align-items:center; padding:18px 22px; border-bottom:1px solid rgba(255,255,255,0.02); position:sticky; top:0; backdrop-filter: blur(4px); z-index:40;
}
.brand { display:flex; gap:14px; align-items:center; }
.logo { width:56px; height:56px; border-radius:8px; background:linear-gradient(180deg,#2b1f18,#191010); display:grid; place-items:center; font-family:Cinzel, serif; font-size:18px; color:#f7efe7; border:1px solid rgba(255,255,255,0.03); }
.title { font-family:Cinzel, serif; font-size:1.2rem; color:#efe6dc; }
.controls { display:flex; gap:10px; align-items:center; }

.container { max-width:1200px; margin:20px auto; padding:12px; display:grid; grid-template-columns: 320px 1fr 360px; gap:18px; align-items:start; }
@media (max-width:1100px){ .container{ grid-template-columns: 1fr; } .right-panel{ order:3 } }

.panel { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.02); box-shadow: 0 16px 40px rgba(0,0,0,0.6); }

.left-panel .case-title { font-family:Cinzel, serif; font-size:1.04rem; margin-bottom:8px; color:#fdecd6; }
.small { color:var(--muted); font-size:0.92rem; }

.suspect { display:flex; gap:12px; align-items:center; padding:10px; margin-top:10px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02); }
.avatar { width:64px; height:64px; border-radius:10px; object-fit:cover; border:2px solid rgba(255,255,255,0.03); background:#1b1412; }
.smeta { flex:1; }
.sname { font-weight:700; }
.srole { color:var(--muted); font-size:0.9rem; }

.map { position:relative; border-radius:12px; overflow:hidden; padding:8px; min-height:360px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.36)); }
.map-canvas { width:100%; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#231a17,#1b1411); display:block; position:relative; height:320px; }
.hotspot { position:absolute; transform:translate(-50%,-50%); background:linear-gradient(180deg, rgba(176,138,92,0.14), rgba(176,138,92,0.08)); padding:8px 12px; border-radius:999px; font-weight:700; color:#120b06; cursor:pointer; border:1px solid rgba(176,138,92,0.12); box-shadow:0 10px 28px rgba(0,0,0,0.6); user-select:none; transition:transform .12s ease, box-shadow .12s ease; }
.hotspot:hover { transform:translate(-50%,-50%) scale(1.05); box-shadow:0 18px 40px rgba(0,0,0,0.7); }

.clues { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; }
.clue { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); cursor:pointer; display:flex; gap:10px; align-items:flex-start; transition:transform .12s ease; }
.clue:hover { transform:translateY(-6px); box-shadow:0 20px 40px rgba(0,0,0,0.6); }
.thumb { width:64px; height:64px; border-radius:8px; background:#201612; display:grid; place-items:center; font-size:18px; color:#d9c8ae; }
.clue h4 { margin:0; font-size:1rem; }
.clue p { margin:6px 0 0 0; color:var(--muted); font-size:0.9rem; }

.right-panel .tool { margin-bottom:12px; }
.btn { background:var(--accent); color:#070707; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
.btn.secondary { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
.control-row { display:flex; gap:8px; align-items:center; margin-top:8px; }

.modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); }
.card { width:760px; max-width:94%; background:linear-gradient(180deg,#121212,#0f0f0f); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); color:#efece6; box-shadow:0 30px 80px rgba(0,0,0,0.8); }
.card.small { width:520px; max-width:92%; }

.header-overlay { display:flex; gap:12px; align-items:center; }
.progress { color:var(--muted); font-size:0.95rem; }
.footer-note { text-align:center; color:var(--muted); margin-top:18px; }

/* spooky touches */
.candle { width:10px; height:28px; background:linear-gradient(180deg,#ffd5a6,#ffcf8a); border-radius:6px; display:inline-block; margin-right:6px; box-shadow:0 0 16px rgba(255,200,120,0.08); }
.flicker { animation:flicker 1.2s infinite; }
@keyframes flicker { 0%{filter:brightness(0.95)} 25%{filter:brightness(1.12)} 50%{filter:brightness(0.9)} 75%{filter:brightness(1.06)} 100%{filter:brightness(0.94)} }

/* endings list */
.endings-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; }
.ending-card { padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02); }
/* debug */
#debug { position:fixed; right:14px; bottom:14px; width:320px; max-height:260px; overflow:auto; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(8,8,8,0.85)); color:#fff; border-radius:8px; padding:10px; border:1px solid rgba(255,255,255,0.03); font-size:12px; z-index:99999; }
</style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo">–†</div>
      <div>
        <div class="title">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</div>
        <div class="small">–ü–æ–ª–Ω–∞—è, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏ –∏ –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã</div>
      </div>
    </div>
    <div class="controls header-overlay">
      <div class="candle flicker" title="–°–≤–µ—á–∞"></div>
      <div class="progress">–ü—Ä–æ–≥—Ä–µ—Å—Å: <strong id="progressPct">0%</strong></div>
      <button id="audioToggle" class="btn secondary">–ó–≤—É–∫: –≤—ã–∫–ª</button>
      <button id="newGame" class="btn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      <div class="small">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: <span id="saveStatus">–Ω–µ—Ç</span></div>
    </div>
  </header>

  <main class="container">
    <!-- LEFT -->
    <aside class="panel left-panel">
      <div class="case-title">–î–µ–ª–æ: –°–º–µ—Ä—Ç—å –ª–æ—Ä–¥–∞ –†–∏—á–∞—Ä–¥–∞</div>
      <div class="small">–ù–æ—á—å. –ì—Ä–æ–∑–∞. –û—Å–æ–±–Ω—è–∫ —Ö—Ä–∞–Ω—è—Ç –±–æ–ª—å—à–µ —Ç–∞–π–Ω, —á–µ–º –≤–∏–¥–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ. –ò—â–∏—Ç–µ —É–ª–∏–∫–∏, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–π—Ç–µ –∑–∞–ø–∏—Å–∫–∏, –∏–≥—Ä–∞–π—Ç–µ –≤ –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã –∏ –ø—Ä–∏–Ω–∏–º–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è ‚Äî –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª.</div>

      <div style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ</strong>
          <button id="viewProfiles" class="btn secondary">–ü—Ä–æ—Ñ–∏–ª–∏</button>
        </div>
        <div id="suspectsList" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:12px;">
        <strong>–ë–ª–æ–∫–Ω–æ—Ç</strong>
        <textarea id="notebook" rows="6" style="width:100%; margin-top:8px; resize:vertical; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="saveNotes" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏</button>
          <button id="clearNotes" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞</strong>
        <div id="hintBox" class="small" style="margin-top:6px;">–û—Ç–∫—Ä–æ–π—Ç–µ —Ö–æ—Ç—è –±—ã 3 —É–ª–∏–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É.</div>
      </div>

    </aside>

    <!-- CENTER -->
    <section class="panel map-panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong style="font-family:Cinzel, serif; font-size:1.05rem;">–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞</strong>
        <div class="small">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å ‚Äî –æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏ —Å–æ–±–µ—Ä–∏—Ç–µ —É–ª–∏–∫–∏</div>
      </div>

      <div class="map">
        <div class="map-canvas" id="mapCanvas" role="img" aria-label="–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞">
          <!-- Hotspots: absolute positions in percent -->
          <div class="hotspot" data-room="library" style="left:18%; top:22%;">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
          <div class="hotspot" data-room="music" style="left:48%; top:18%;">üéπ –ú—É–∑—ã–∫–∞</div>
          <div class="hotspot" data-room="office" style="left:76%; top:22%;">üóÑ –ö–∞–±–∏–Ω–µ—Ç</div>
          <div class="hotspot" data-room="dining" style="left:34%; top:56%;">üçΩ –°—Ç–æ–ª–æ–≤–∞—è</div>
          <div class="hotspot" data-room="garden" style="left:14%; top:78%;">üåπ –°–∞–¥</div>
          <div class="hotspot" data-room="basement" style="left:74%; top:76%;">‚öôÔ∏è –ü–æ–¥–≤–∞–ª</div>
          <div class="hotspot" data-room="attic" style="left:54%; top:44%;">üï∞ –ß–µ—Ä–¥–∞–∫</div>
        </div>

        <div style="display:flex; justify-content:space-between; gap:12px; margin-top:12px;">
          <div style="flex:1">
            <strong>–£–ª–∏–∫–∏</strong>
            <div id="cluesGrid" class="clues" style="margin-top:10px;"></div>
          </div>

          <div style="width:320px;">
            <div class="panel small" style="padding:12px;">
              <strong>–¢–∞–π–º–ª–∞–π–Ω</strong>
              <div id="timelineList" style="margin-top:8px; min-height:80px; color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input id="timelineInput" placeholder="23:10 ‚Äî –∫—Ä–∏–∫" style="flex:1; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"/>
                <button id="addTimeline" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>

            <div class="panel tool" style="margin-top:12px; padding:12px;">
              <strong>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</strong>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <button id="cipherBtn" class="btn">–¶–µ–∑–∞—Ä—å (–∑–∞–ø–∏—Å–∫–∞)</button>
                <button id="puzzleBtn" class="btn secondary">–ü–∞–∑–ª (–∫–∞—Ä—Ç–∞)</button>
                <button id="matchBtn" class="btn secondary">–≠–º–±–ª–µ–º—ã</button>
              </div>
              <div style="margin-top:10px; color:var(--muted); font-size:0.9rem;">–ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã –¥–∞—é—Ç –∫–ª—é—á–∏ –∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç —Å–∫—Ä—ã—Ç—ã–µ —É–ª–∏–∫–∏.</div>
            </div>

            <div class="panel tool" style="margin-top:12px;">
              <strong>–û–±–≤–∏–Ω–µ–Ω–∏–µ</strong>
              <select id="accuseSelect" style="width:100%; margin-top:8px; background:#0b0b0b; color:#efece6; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03)"></select>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <button id="accuseBtn" class="btn">–û–±–≤–∏–Ω–∏—Ç—å</button>
                <button id="reviewBtn" class="btn secondary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</button>
              </div>
              <div id="accuseResult" style="margin-top:10px; font-weight:700;"></div>
            </div>

          </div>
        </div>
      </div>

      <div class="footer-note">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —É–ª–∏–∫, —Ç–∞–π–º–ª–∞–π–Ω–∞ –∏ –æ–¥–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è. –ò—â–∏—Ç–µ –Ω–µ —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã ‚Äî –∏—â–∏—Ç–µ –º–æ—Ç–∏–≤.</div>
    </section>

    <!-- RIGHT -->
    <aside class="panel right-panel">
      <div class="tool">
        <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
        <div style="margin-top:8px;">–£–ª–∏–∫ –æ—Ç–∫—Ä—ã—Ç–æ: <span id="openedCount">0</span> / <span id="totalClues">0</span></div>
        <div style="margin-top:8px;">–°–≤—è–∑–µ–π (–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Üí –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ): <span id="linksCount">0</span></div>
        <div style="margin-top:8px;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: <button id="saveBtn" class="btn secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      </div>

      <div class="tool">
        <strong>–ö–æ–Ω—Ü–æ–≤–∫–∏</strong>
        <div style="margin-top:8px; color:var(--muted)">–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏", —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏ —Å–∫—Ä—ã—Ç—ã –∏ —Ç—Ä–µ–±—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="endingsBtn" class="btn">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏</button>
          <button id="revealSecret" class="btn secondary">–°–¥–µ–ª–∞—Ç—å —Å—Ç—Ä–∞–Ω–Ω—ã–π —Ä–∏—Ç—É–∞–ª</button>
        </div>
      </div>

      <div class="tool" style="margin-top:12px;">
        <strong>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞</strong>
        <div style="margin-top:8px;">
          <label style="display:flex; gap:8px; align-items:center;"><input id="toggleFog" type="checkbox"> –¢—É–º–∞–Ω</label>
          <label style="display:flex; gap:8px; align-items:center; margin-top:6px;"><input id="toggleVfx" type="checkbox"> –≠—Ñ—Ñ–µ–∫—Ç—ã —Å–≤–µ—á–∏</label>
        </div>
      </div>
    </aside>
  </main>

  <!-- MODALS -->
  <div id="profilesModal" class="modal"><div class="card"><h3>–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö</h3><div id="profilesContent" style="margin-top:12px"></div><div style="margin-top:12px; text-align:right"><button id="closeProfiles" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="cipherModal" class="modal"><div class="card small"><h3>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (–¶–µ–∑–∞—Ä—å)</h3><div class="small" style="margin-top:6px">–í–≤–µ–¥–∏—Ç–µ —Å–¥–≤–∏–≥ (1‚Äì25)</div><div style="display:flex; gap:8px; margin-top:8px;"><input id="cipherShift" class="input" type="number" min="1" max="25" value="3" style="padding:8px; border-radius:8px; background:#0b0b0b; color:#efece6; border:1px solid rgba(255,255,255,0.03)"><button id="cipherTryBtn" class="btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button></div><textarea id="cipherOutput" rows="4" class="input" style="margin-top:8px; width:100%; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)" readonly></textarea><div style="margin-top:8px; text-align:right"><button id="cipherCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="puzzleModal" class="modal"><div class="card small"><h3>–ü–∞–∑–ª ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞—Ä—Ç—É</h3><div id="puzzleBoard" style="margin-top:12px; display:grid; gap:4px; grid-template-columns: repeat(3, 1fr);"></div><div style="margin-top:12px; text-align:right"><button id="puzzleClose" class="btn secondary">–û—Ç–º–µ–Ω–∞</button></div></div></div>

  <div id="matchModal" class="modal"><div class="card small"><h3>–≠–º–±–ª–µ–º—ã ‚Äî –ù–∞–π–¥–∏—Ç–µ –≤–µ—Ä–Ω—É—é</h3><div id="matchArea" style="display:flex; gap:8px; margin-top:12px; justify-content:space-around;"></div><div style="margin-top:12px; text-align:right"><button id="matchCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="endingsModal" class="modal"><div class="card"><h3>–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ü–æ–≤–æ–∫</h3><div id="endingsList" style="margin-top:12px"></div><div style="margin-top:12px; text-align:right"><button id="endingsClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="endingRevealModal" class="modal"><div class="card"><h3 id="endingTitle"></h3><div id="endingText" style="margin-top:12px; color:var(--muted)"></div><div style="margin-top:12px; text-align:right"><button id="endingClose" class="btn">OK</button></div></div></div>

  <div id="debug" aria-hidden="false"><strong>DEBUG</strong><div id="debugLog" style="white-space:pre-wrap; margin-top:8px; font-family:monospace; color:#cfcfcf">init...</div></div>

<script>
/*
  –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è: –¥–µ—Ç–µ–∫—Ç–∏–≤, —Å—Ç—Ä–∞—à–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –º–Ω–æ–≥–æ –∫–æ–Ω—Ü–æ–≤–æ–∫.
  –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
  - –ë–æ–ª–µ–µ 12 —É–ª–∏–∫ (—Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ)
  - –ú–∏–Ω–∏-–∏–≥—Ä—ã: –¶–µ–∑–∞—Ä—å, –ü–∞–∑–ª (3x3), –≠–º–±–ª–µ–º—ã (match)
  - –°–∏—Å—Ç–µ–º–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —É–ª–∏–∫ —Å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–º–∏ (drag&drop –¥–ª—è –ü–ö + tap –¥–ª—è –º–æ–±)
  - –¢–∞–π–º–ª–∞–π–Ω, –±–ª–æ–∫–Ω–æ—Ç, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
  - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∏–Ω–∞–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–ª–∏–∫–æ–≤, —Å–≤—è–∑–µ–π, —Ç–∞–π–º–ª–∞–π–Ω–∞ –∏ "—Ä–∏—Ç—É–∞–ª–æ–≤"
*/

(function(){
  const LOG = (msg)=>{ try{ const el=document.getElementById('debugLog'); if(el) el.textContent += '\\n' + msg; console.log(msg);}catch(e){} };

  window.addEventListener('error', (e)=> LOG('ERROR: '+e.message+' @ '+e.filename+':'+e.lineno) );

  const DEFAULT_SUSPECTS = [
    { id:'adrian', name:'–≠–¥—Ä–∏–∞–Ω –†–æ—É–∑–≤—É–¥', role:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫', male:true },
    { id:'beatrice', name:'–ë–µ–∞—Ç—Ä–∏—Å –•–µ–π–≤—É–¥', role:'–î–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞', male:false },
    { id:'prof', name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ú–æ—Ä–¥–µ–Ω', role:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', male:true },
    { id:'victoria', name:'–í–∏–∫—Ç–æ—Ä–∏—è –†–æ—É–∑–≤—É–¥', role:'–ñ–µ–Ω–∞', male:false },
    { id:'lina', name:'–õ–∏–Ω–∞ –ú–æ–Ω—Ç', role:'–ì–æ—Å—Ç—å—è', male:false }
  ];

  // –±–∞–∑–æ–≤—ã–µ —É–ª–∏–∫–∏ ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–≥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–π –∏–≥—Ä–µ
  const MASTER_CLUES = [
    { id:'cl1', title:'–¢–∞–π–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞)', room:'office', type:'cipher', text:'Vkr ghqv wrfkh', locked:true },
    { id:'cl2', title:'–°–ª–µ–¥ –æ–±—É–≤–∏', room:'garden', type:'foot', text:'–ü–æ–¥–æ—à–≤–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º B7', locked:false },
    { id:'cl3', title:'–†–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç', room:'library', type:'paper', text:'–í—ã—Ä–≤–∞–Ω–æ –∏–º—è, –ø–æ–º–µ—Ç–∫–∞: 12/11', locked:false },
    { id:'cl4', title:'–°–∏–º–≤–æ–ª –Ω–∞ —Å—Ç–µ–Ω–µ', room:'music', type:'symbol', text:'–°—Ç—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª ‚Äî —ç–º–±–ª–µ–º–∞', locked:false },
    { id:'cl5', title:'–ü–µ–ø–µ–ª –∏ –ø—è—Ç–Ω–∞ –º–∞—Å–ª–∞', room:'dining', type:'ash', text:'–ü–µ–ø–µ–ª –∏ —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ', locked:false },
    { id:'cl6', title:'–§—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã (—Å–æ–∂–∂–µ–Ω)', room:'basement', type:'puzzle', text:'–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã ‚Äî –Ω—É–∂–µ–Ω –ø–∞–∑–ª', locked:true },
    { id:'cl7', title:'–§–ª–∞–∫–æ–Ω —Å —ç—Ñ–∏—Ä–æ–º', room:'attic', type:'vial', text:'–†–µ–¥–∫–∏–π —ç—Ñ–∏—Ä ‚Äî –∑–∞–ø–∞—Ö –Ω–∞—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞ –º—ã—Å–ª—å', locked:false },
    { id:'cl8', title:'–ó–∞–ø–∏—Å–∫–∞ –≤ –∫–Ω–∏–≥–µ', room:'library', type:'note', text:'"–í–ª–∞—Å—Ç—å ‚Äî —á–µ—Ä–µ–∑ —Ç–∞–π–Ω—É" ‚Äî –ø–æ–¥–ø–∏—Å—å –í.', locked:false },
    { id:'cl9', title:'–ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç', room:'office', type:'seal', text:'–ö–æ–Ω–≤–µ—Ä—Ç —Å –ø–µ—á–∞—Ç—å—é', locked:true },
    { id:'cl10', title:'–ß–µ—Ä–Ω–∏–ª—å–Ω—ã–µ –±—Ä—ã–∑–≥–∏', room:'office', type:'ink', text:'–ß–µ—Ä–Ω–∏–ª–∞ Wyn ‚Äî —Ä–µ–¥–∫–∞—è —Ñ–∏—Ä–º–∞', locked:false },
    { id:'cl11', title:'–û—Ç–ø–µ—á–∞—Ç–æ–∫ –ø–µ—Ä—á–∞—Ç–∫–∏', room:'music', type:'glove', text:'–°–ª–µ–¥ –ø–µ—Ä—á–∞—Ç–∫–∏ —Å –≤–æ–ª–æ–∫–Ω–∞–º–∏', locked:false },
    { id:'cl12', title:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏', room:'attic', type:'cipher2', text:'Uifsf dbo zpv', locked:true }
  ];

  // Endings ‚Äî id + title + description + condition function (evaluates state) ‚Äî many endings
  const ENDINGS = [
    { id:'end_true_crime', title:'–ü—Ä–∞–≤–¥–∞ –∏ —Å—É–¥', desc:'–í—ã —Å–æ–±—Ä–∞–ª–∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî –≠–¥—Ä–∏–∞–Ω –ø—Ä–∏–∑–Ω–∞–Ω –≤–∏–Ω–æ–≤–Ω—ã–º –∏ –ø—Ä–µ–¥–∞–Ω —Å—É–¥—É.', cond: (s)=> s.links['adrian'] && s.links['adrian'].length>=3 && s.timeline.length>=2 },
    { id:'end_frame', title:'–ü–æ–¥—Å—Ç–∞–≤–ª–µ–Ω', desc:'–í—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏, —á—Ç–æ —É–ª–∏–∫–∏ –±—ã–ª–∏ –ø–æ–¥–±—Ä–æ—à–µ–Ω—ã. –ò—Å—Ç–∏–Ω–∞ ‚Äî —Å–ª–æ–∂–Ω–µ–µ. –ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π –±—ã–ª –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω.', cond: (s)=> (s.links['beatrice'] && s.links['beatrice'].length>=2) && (s.opened['cl6']===true) },
    { id:'end_society', title:'–¢–∞–π–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ', desc:'–í—ã —Ä–∞—Å–∫—Ä—ã–ª–∏ —Å–≤—è–∑—å —Å –æ–±—â–µ—Å—Ç–≤–æ–º –ú–æ—Ä–¥–µ–Ω–æ–≤ ‚Äî –¥–µ–ª–æ –º–∞—Å—à—Ç–∞–±–Ω–µ–µ: –∑–∞–∫—Ä—ã—Ç—ã–π –∑–∞–≥–æ–≤–æ—Ä.', cond: (s)=> s.opened['cl4'] && s.opened['cl9'] },
    { id:'end_supernatural', title:'–ó–∞ –≥—Ä–∞–Ω—å—é', desc:'–ù–µ–æ–±—ä—è—Å–Ω–∏–º–æ–µ. –í—ã –Ω–∞—à–ª–∏ —Ä–∏—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏ –∏ —Å—Ç—Ä–∞–Ω–Ω—ã–π —ç—Ñ–∏—Ä ‚Äî —Å–æ–±—ã—Ç–∏—è –∏–¥—É—Ç –∫ —Å–≤–µ—Ä—Ö—ä–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Ñ–∏–Ω–∞–ª—É.', cond: (s)=> s.opened['cl5'] && s.opened['cl7'] && s.ritualPerformed },
    { id:'end_innocent', title:'–ù–µ–≤–∏–Ω–æ–≤–µ–Ω', desc:'–í—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–≤—è–∑–∞–ª–∏ —É–ª–∏–∫–∏ ‚Äî –Ω–∞—Å—Ç–æ—è—â–∏–π —É–±–∏–π—Ü–∞ –æ—Å—Ç–∞–ª—Å—è –Ω–∞ —Å–≤–æ–±–æ–¥–µ.', cond: (s)=> s.links['adrian'] && s.links['adrian'].length===0 && Object.values(s.links).flat().length>=3 },
    { id:'end_treachery', title:'–ü—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ', desc:'–û—Ç–∫—Ä—ã–ª–æ—Å—å –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ: –±–ª–∏–∑–∫–∏–π —á–µ–ª–æ–≤–µ–∫ –∑–∞–º–µ—à–∞–Ω –≤ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–∏.', cond: (s)=> s.links['victoria'] && s.links['victoria'].length>=2 && s.opened['cl8'] },
    { id:'end_open', title:'–û—Ç–∫—Ä—ã—Ç—ã–π —Ñ–∏–Ω–∞–ª', desc:'–ù–µ —Ö–≤–∞—Ç–∏–ª–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî –¥–µ–ª–æ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Ä–∞—Å–∫—Ä—ã—Ç—ã–º. –ú–∏—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∂–∏—Ç—å —Å–æ —Å–≤–æ–µ–π —Ç–∞–π–Ω–æ–π.', cond: (s)=> Object.values(s.links).flat().length < 3 && Object.keys(s.opened).length < 4 },
    { id:'end_multiple_convict', title:'–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±–≤–∏–Ω–µ–Ω–∏–µ', desc:'–í—ã –∑–∞–ø—É—Ç–∞–ª–∏ —Å–ª–µ–¥—Å—Ç–≤–∏–µ ‚Äî –∞—Ä–µ—Å—Ç–æ–≤–∞–ª–∏ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ª—é–¥–µ–π, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å –ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º.', cond: (s)=> Object.values(s.links).filter(a=>a.length>0).length>=3 }
  ];

  // Application state
  let state = {
    suspects: JSON.parse(JSON.stringify(DEFAULT_SUSPECTS)),
    clues: [],
    opened: {},          // opened clue ids map to true
    links: {},           // suspectId => [clueId...]
    timeline: [],
    ritualPerformed: false,
    audioOn: false,
    fog: false,
    vfx: true
  };

  // Utilities
  const byId = id => document.getElementById(id);
  function randShuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

  // Initialize a new game (populate clues with random extra)
  function newGame(){
    LOG('Starting new game');
    // deep copy master clues
    state.clues = JSON.parse(JSON.stringify(MASTER_CLUES));
    // Randomly add a few "red herring" clues to increase variety
    const extraCount = 3 + Math.floor(Math.random()*4);
    for(let i=0;i<extraCount;i++){
      const idx = Math.floor(Math.random()*MASTER_CLUES.length);
      const c = MASTER_CLUES[idx];
      // create a variation
      state.clues.push(Object.assign({}, c, { id: c.id+'x'+i, title: c.title + ' (–≤—Å–ø–ª.)', locked: Math.random()<0.4 }));
    }
    // reset opened/links/timeline
    state.opened = {};
    state.links = {};
    state.timeline = [];
    state.ritualPerformed = false;
    state.suspects = JSON.parse(JSON.stringify(DEFAULT_SUSPECTS));
    state.suspects = randShuffle(state.suspects); // randomize suspects order
    state.suspects.forEach(s => state.links[s.id] = []);
    saveToLocal('autosave', state);
    renderAll();
    showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º –∏ –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã ‚Äî —Ä–µ—à–µ–Ω–∏—è –∏–º–µ—é—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.');
  }

  // Render functions
  function renderAll(){
    renderSuspects();
    renderClues();
    renderTimeline();
    renderStats();
    populateAccuse();
    updateHint();
    updateProgress();
  }

  function renderSuspects(){
    const area = byId('suspectsList');
    area.innerHTML = '';
    state.suspects.forEach(s=>{
      const div = document.createElement('div');
      div.className = 'suspect';
      const imgSrc = findFemaleImageFor(s);
      const imgHtml = imgSrc ? `<img class="avatar" src="${imgSrc}" alt="${escapeHtml(s.name)}">` : `<div class="avatar" style="display:grid; place-items:center; font-weight:700;">${escapeHtml(s.name.split(' ')[0].slice(0,1))}</div>`;
      div.innerHTML = `${imgHtml}<div class="smeta"><div class="sname">${escapeHtml(s.name)}</div><div class="srole">${escapeHtml(s.role)}</div></div><div class="dropzone" data-suspect="${s.id}">${(state.links[s.id]||[]).length}</div>`;
      area.appendChild(div);
    });
    attachDropzones();
  }

  // try to use user-provided images for female suspects (assets/female1.jpg..female3.jpg)
  function findFemaleImageFor(s){
    if(!s.male){
      // map female1..3 in order
      const femaleIndex = state.suspects.filter(x=>!x.male).map(x=>x.id).indexOf(s.id);
      if(femaleIndex >= 0){
        const src = `assets/female${Math.min(3, femaleIndex+1)}.jpg`;
        // We won't verify existence here; browser will fallback
        return src;
      }
    }
    return null;
  }

  function renderClues(){
    const grid = byId('cluesGrid');
    grid.innerHTML = '';
    state.clues.forEach(c=>{
      const el = document.createElement('div');
      el.className = 'clue' + (state.opened[c.id] ? ' opened' : (c.locked ? ' locked' : ''));
      el.id = c.id;
      el.dataset.clue = c.id;
      el.innerHTML = `<div class="thumb">${getTypeIcon(c.type)}</div><div><h4>${escapeHtml(c.title)}</h4><p>${ state.opened[c.id] ? escapeHtml(c.text) : (c.locked ? '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ / —Å–∫—Ä—ã—Ç–∞' : escapeHtml(c.text)) }</p></div>`;
      // Click: if locked and requires mini-game -> open tool, else toggle details
      el.addEventListener('click', ()=> handleClueClick(c));
      // draggable for desktop
      el.draggable = true;
      el.addEventListener('dragstart', (ev)=> { ev.dataTransfer.setData('text/plain', c.id); });
      grid.appendChild(el);
    });
    byId('totalClues').innerText = state.clues.length;
  }

  function renderTimeline(){
    const el = byId('timelineList');
    if(!el) return;
    if(state.timeline.length === 0){ el.innerHTML = '<div class="small" style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
    el.innerHTML = state.timeline.slice().reverse().map(t => `<div style="margin-bottom:6px">${escapeHtml(t.text)} <span style="color:var(--muted); font-size:0.85rem">(${new Date(t.time).toLocaleTimeString()})</span></div>`).join('');
  }

  function renderStats(){
    byId('openedCount').innerText = Object.keys(state.opened).length;
    byId('linksCount').innerText = Object.values(state.links).flat().length;
    updateProgress();
  }

  function populateAccuse(){
    const sel = byId('accuseSelect');
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ ‚Äî</option>';
    state.suspects.forEach(s=> {
      const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; sel.appendChild(opt);
    });
  }

  function updateHint(){
    const opened = Object.keys(state.opened).length;
    const hintBox = byId('hintBox');
    if(opened >= 6) hintBox.innerText = '–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–Ω–∏–ª—å–Ω—ã–µ —Å–ª–µ–¥—ã —Å –º–∞—Ä–∫–∏—Ä–æ–≤–∫–æ–π Wyn –∏ —Å–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ —Å –∑–∞–ø–∏—Å—è–º–∏ –≤ –±–ª–æ–∫–Ω–æ—Ç–µ.';
    else if(opened >= 3) hintBox.innerText = '–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∏—Ñ—Ä –¶–µ–∑–∞—Ä—è –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∫–µ –∏ –º–∏–Ω–∏‚Äë–∏–≥—Ä—É —ç–º–±–ª–µ–º –¥–ª—è —Å–∏–º–≤–æ–ª–∞ –Ω–∞ —Å—Ç–µ–Ω–µ.';
    else hintBox.innerText = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏–º—É–º 3 —É–ª–∏–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É.';
  }

  function updateProgress(){
    const total = state.clues.length + 2; // denom slightly larger to not reach 100 too early
    const opened = Object.keys(state.opened).length + Object.values(state.links).flat().length;
    const pct = Math.min(100, Math.round((opened/total)*100));
    byId('progressPct').innerText = pct + '%';
  }

  // Click handling for clue
  function handleClueClick(clue){
    LOG('Clicked clue '+clue.id);
    if(clue.locked && !state.opened[clue.id]){
      // Decide appropriate tool by type
      if(clue.type === 'cipher' || clue.type === 'cipher2'){ openCipherModal(clue); return; }
      if(clue.type === 'puzzle'){ openPuzzleModal(); return; }
      if(clue.type === 'symbol' || clue.type === 'seal'){ openMatchModal(clue); return; }
      // other locked types: hint to use tools
      showToast('–≠—Ç–∞ —É–ª–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –µ—ë.');
      return;
    }
    // toggle detail modal simple
    const alreadyOpen = !!state.opened[clue.id];
    if(!alreadyOpen){
      state.opened[clue.id] = true;
      // reveal text if had placeholder
      LOG('Revealing ' + clue.id);
      revealClueText(clue);
      renderClues(); renderStats(); updateHint();
    } else {
      // show details modal
      showClueDetail(clue);
    }
  }

  function revealClueText(clue){
    // If clue had locked text placeholders, adjust
    if(clue.type === 'cipher' && clue.text === 'Vkr ghqv wrfkh'){
      clue.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª';
    } else if(clue.type === 'puzzle' && clue.text.includes('–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã')){
      clue.text = '–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã —Å–æ–±—Ä–∞–Ω—ã ‚Äî –µ—Å—Ç—å –æ—Ç–º–µ—Ç–∫–∞ —Å–∫—Ä—ã—Ç–æ–≥–æ —Ö–æ–¥–∞ –º–µ–∂–¥—É –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –∏ –ø–æ–¥–≤–∞–ª–æ–º.';
    }
    state.opened[clue.id] = true;
  }

  function showClueDetail(clue){
    const modal = byId('endingRevealModal');
    byId('endingTitle').innerText = clue.title;
    byId('endingText').innerHTML = `<div style="color:var(--muted)">${escapeHtml(clue.text)}</div>`;
    modal.style.display = 'flex';
  }

  // Mini-games
  function openCipherModal(clue){
    const modal = byId('cipherModal');
    modal.style.display = 'flex';
    modal.dataset.clue = clue ? clue.id : '';
    byId('cipherOutput').value = '';
    byId('cipherShift').value = 3;
  }

  function tryCipher(){
    const shift = Number(byId('cipherShift').value) || 0;
    const clueId = byId('cipherModal').dataset.clue;
    const clue = state.clues.find(c=>c.id===clueId) || state.clues.find(c=>c.type==='cipher' || c.type==='cipher2');
    if(!clue){ showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –∑–∞–ø–∏—Å–∫–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏.'); return; }
    const decoded = caesarDecode(clue.text, shift);
    byId('cipherOutput').value = decoded;
    LOG('Decoded: '+decoded);
    // heuristic unlock: if decoded contains "–æ–Ω –∑–Ω–∞–µ—Ç" or "v." or certain char
    if(/–æ–Ω –∑–Ω–∞–µ—Ç|he knows|–≤\./i.test(decoded) || shift===3){
      showToast('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞!');
      // Reveal the clue fully
      clue.locked = false;
      clue.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª';
      state.opened[clue.id] = true;
      renderClues(); renderStats(); updateHint();
      byId('cipherModal').style.display = 'none';
    }
  }

  function caesarDecode(s, shift){
    if(!s) return s;
    const a='abcdefghijklmnopqrstuvwxyz';
    const A=a.toUpperCase();
    return s.split('').map(ch=>{
      if(a.indexOf(ch) !== -1) return a[(a.indexOf(ch)-shift+26)%26];
      if(A.indexOf(ch) !== -1) return A[(A.indexOf(ch)-shift+26)%26];
      return ch;
    }).join('');
  }

  // Puzzle (3x3 shuffle)
  let puzzleState = { solved:false };
  function openPuzzleModal(){
    const modal = byId('puzzleModal');
    modal.style.display = 'flex';
    initPuzzle();
  }
  function initPuzzle(){
    const board = byId('puzzleBoard');
    board.innerHTML = '';
    // create 3x3 pieces numbered 1..9 then shuffle
    const nums = [1,2,3,4,5,6,7,8,9];
    const shuffled = randShuffle(nums);
    shuffled.forEach(n=>{
      const piece = document.createElement('div');
      piece.style.background = '#201612';
      piece.style.color = '#d9c8ae';
      piece.style.display = 'grid';
      piece.style.placeItems = 'center';
      piece.style.height = '80px';
      piece.style.borderRadius = '6px';
      piece.style.cursor = 'pointer';
      piece.textContent = n === 9 ? '' : n; // treat 9 as empty space for sliding puzzle
      piece.dataset.num = n;
      board.appendChild(piece);
    });
    // simple clickable swap to simulate solving (not true sliding) ‚Äî for fun & easy
    board.querySelectorAll('div').forEach(el=>{
      el.addEventListener('click', ()=>{
        // if any neighbor empty -> swap
        const empty = Array.from(board.children).find(x=>x.dataset.num == 9);
        if(!empty) return;
        const idx = Array.from(board.children).indexOf(el);
        const eidx = Array.from(board.children).indexOf(empty);
        const dist = Math.abs(idx - eidx);
        // allow swap if neighboring cells (simple)
        if(dist === 1 || dist === 3){
          const tmp = el.dataset.num; el.dataset.num = empty.dataset.num; empty.dataset.num = tmp;
          const ttext = el.textContent; el.textContent = empty.textContent; empty.textContent = ttext;
        }
        checkPuzzleSolved(board);
      });
    });
  }
  function checkPuzzleSolved(board){
    const order = Array.from(board.children).map(c=>Number(c.dataset.num));
    // solved if order is 1..9
    let ok = true;
    for(let i=0;i<9;i++) if(order[i] !== i+1) { ok=false; break; }
    if(ok && !puzzleState.solved){
      puzzleState.solved = true;
      // reveal puzzle clue
      const clue = state.clues.find(c=>c.type==='puzzle' || c.title.toLowerCase().includes('–∫–∞—Ä—Ç–∞'));
      if(clue){ clue.locked = false; clue.text = '–ö–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: –Ω–∞–π–¥–µ–Ω —Å–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ö–æ–¥ –∫ –ø–æ–¥–≤–∞–ª—É.'; state.opened[clue.id] = true; renderClues(); renderStats(); updateHint(); }
      showToast('–ü–∞–∑–ª —Ä–µ—à—ë–Ω ‚Äî –∫–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
      byId('puzzleModal').style.display = 'none';
    }
  }

  // Emblems match
  function openMatchModal(clue){
    const modal = byId('matchModal');
    modal.style.display = 'flex';
    const area = byId('matchArea'); area.innerHTML = '';
    // generate options, one matches 'rosewood' tag
    const options = [
      { id:'e1', label:'–≠–º–±–ª–µ–º–∞ A', match:false },
      { id:'e2', label:'–≠–º–±–ª–µ–º–∞ B', match:true },
      { id:'e3', label:'–≠–º–±–ª–µ–º–∞ C', match:false }
    ].sort(()=>Math.random()-0.5);
    options.forEach(opt=>{
      const btn = document.createElement('div');
      btn.style.width='120px'; btn.style.height='120px'; btn.style.borderRadius='8px'; btn.style.background='#211815'; btn.style.display='grid'; btn.style.placeItems='center'; btn.style.cursor='pointer';
      btn.innerHTML = `<div style="text-align:center">${opt.label}</div>`;
      btn.addEventListener('click', ()=> {
        if(opt.match){
          showToast('–≠–º–±–ª–µ–º–∞ —Å–æ–≤–ø–∞–ª–∞ ‚Äî —É–ª–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞.');
          // reveal associated clue if provided
          const clueToOpen = (clue && state.clues.find(c=>c.id===clue.id)) || state.clues.find(c=>c.type==='symbol');
          if(clueToOpen){ clueToOpen.locked = false; clueToOpen.text = clueToOpen.text || '–≠–º–±–ª–µ–º–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —É–ª–∏–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞.'; state.opened[clueToOpen.id] = true; renderClues(); renderStats(); updateHint(); }
          modal.style.display = 'none';
        } else {
          showToast('–ù–µ —Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é.');
        }
      });
      area.appendChild(btn);
    });
  }

  // Drag & drop linking evidence
  function attachDropzones(){
    document.querySelectorAll('.dropzone').forEach(zone=>{
      zone.addEventListener('dragover', ev => { ev.preventDefault(); zone.style.outline = '2px dashed rgba(176,138,92,0.6)'; });
      zone.addEventListener('dragleave', ev => { zone.style.outline = ''; });
      zone.addEventListener('drop', ev => {
        ev.preventDefault(); zone.style.outline = '';
        const clueId = ev.dataTransfer.getData('text/plain'); const suspectId = zone.dataset.suspect;
        if(clueId && suspectId) linkEvidence(suspectId, clueId);
      });
    });
    // mobile tap linking: long press or manual prompt supported
  }

  function linkEvidence(suspectId, clueId){
    if(!state.links[suspectId]) state.links[suspectId] = [];
    if(state.links[suspectId].includes(clueId)){ showToast('–£–ª–∏–∫–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —ç—Ç–æ–º—É –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–º—É'); return; }
    state.links[suspectId].push(clueId);
    showToast('–£–ª–∏–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞: ' + clueId + ' ‚Üí ' + suspectId);
    // update UI
    renderSuspects();
    renderStats();
    saveToLocal('autosave', state);
  }

  // accuse evaluation and many endings decision tree
  function accuseSelected(){
    const sel = byId('accuseSelect'); const id = sel.value;
    const res = byId('accuseResult');
    if(!id){ res.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'; res.style.color = '#ffb3b3'; return; }
    // Evaluate endings: check all possible endings for matched conditions ‚Äî if multiple, prefer specific priority or show multiple
    const matched = ENDINGS.filter(e => e.cond(state));
    if(matched.length === 0){
      // fallback logic: if charged suspect has >=3 clues -> true_crime for adrian else innocent
      const links = state.links[id] || [];
      if(links.length >= 3 && id === 'adrian'){ showEnding('end_true_crime'); return; }
      if(links.length === 0){ showEnding('end_innocent'); return; }
      // ambiguous
      showEnding('end_open'); return;
    }
    // pick one matching ending at random if many
    const chosen = matched[Math.floor(Math.random()*matched.length)];
    showEnding(chosen.id);
  }

  function showEnding(endId){
    const end = ENDINGS.find(e=>e.id===endId);
    if(!end) return;
    byId('endingTitle').innerText = end.title;
    byId('endingText').innerText = end.desc;
    byId('endingRevealModal').style.display = 'flex';
    // Log and save ending history
    const history = JSON.parse(localStorage.getItem('rose_endings')||'[]');
    history.unshift({ id:end.id, title:end.title, time: new Date().toISOString() });
    localStorage.setItem('rose_endings', JSON.stringify(history.slice(0,50)));
    saveToLocal('autosave', state);
  }

  // show endings list
  function showEndingsList(){
    const list = byId('endingsList'); list.innerHTML = '';
    ENDINGS.forEach(e=>{
      const card = document.createElement('div'); card.className='ending-card';
      const unlocked = e.cond(state);
      card.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong>${escapeHtml(e.title)}</strong><div style="color:${unlocked?'#9fff9f':'#cfcfcf'}">${unlocked? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}</div></div><div style="color:var(--muted); margin-top:6px">${escapeHtml(e.desc.slice(0,140))}${e.desc.length>140?'...':''}</div>`;
      card.addEventListener('click', ()=> {
        // clicking a card shows full description and whether unlocked
        if(unlocked) showEnding(e.id);
        else showToast('–≠—Ç–∞ –∫–æ–Ω—Ü–æ–≤–∫–∞ –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî —Å–æ–≤–µ—Ä—à–∏—Ç–µ –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ—ë.');
      });
      list.appendChild(card);
    });
    byId('endingsModal').style.display = 'flex';
  }

  // Helpers & UI wiring
  function attachUI(){
    // hotspots
    document.querySelectorAll('.hotspot').forEach(h=>{
      h.addEventListener('click', ()=> { inspectRoom(h.dataset.room); });
    });
    byId('cipherTryBtn').addEventListener('click', tryCipher);
    byId('cipherCloseBtn').addEventListener('click', ()=> byId('cipherModal').style.display='none');
    byId('puzzleClose').addEventListener('click', ()=> byId('puzzleModal').style.display='none');
    byId('matchCloseBtn').addEventListener('click', ()=> byId('matchModal').style.display='none');
    byId('closeProfiles').addEventListener('click', ()=> byId('profilesModal').style.display='none');
    byId('newGame').addEventListener('click', ()=> { if(confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω.')) newGame(); });
    byId('viewProfiles').addEventListener('click', showProfiles);
    byId('addTimeline').addEventListener('click', ()=> { const t = byId('timelineInput').value.trim(); if(t){ state.timeline.push({text:t, time:new Date().toISOString()}); byId('timelineInput').value=''; renderTimeline(); saveToLocal('autosave', state); } renderStats(); });
    byId('saveNotes').addEventListener('click', ()=> { localStorage.setItem('rose_notes', byId('notebook').value || ''); showToast('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'); });
    byId('clearNotes').addEventListener('click', ()=> { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏?')) { byId('notebook').value=''; localStorage.removeItem('rose_notes'); }});
    byId('cipherBtn').addEventListener('click', ()=> openCipherModal(null));
    byId('puzzleBtn').addEventListener('click', ()=> openPuzzleModal());
    byId('matchBtn').addEventListener('click', ()=> openMatchModal(null));
    byId('accuseBtn').addEventListener('click', accuseSelected);
    byId('reviewBtn').addEventListener('click', ()=> { alert('–°–≤—è–∑–∏: '+ JSON.stringify(state.links)); });
    byId('saveBtn').addEventListener('click', ()=> { saveToLocal('manual_save', state); showToast('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); byId('saveStatus').innerText = '–µ—Å—Ç—å'; });
    byId('endingsBtn').addEventListener('click', showEndingsList);
    byId('revealSecret').addEventListener('click', performRitual);
    byId('endingsClose').addEventListener('click', ()=> byId('endingsModal').style.display='none');
    byId('endingClose').addEventListener('click', ()=> byId('endingRevealModal').style.display='none');
    byId('audioToggle').addEventListener('click', toggleAudio);
    byId('toggleFog').addEventListener('change', (e)=> { state.fog = e.target.checked; toggleFog(state.fog); });
    byId('toggleVfx').addEventListener('change', (e)=> { state.vfx = e.target.checked; toggleVfx(state.vfx); });
    // clue dragging & drop
    attachDropzones();
  }

  function inspectRoom(room){
    // find clues in room
    const found = state.clues.filter(c => c.room === room);
    if(found.length===0){ showToast('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —ç—Ç–æ–π –∑–æ–Ω–µ'); return; }
    found.forEach(c=>{
      const el = document.getElementById(c.id);
      // reveal briefly; if locked show hint text
      if(!c.locked){
        state.opened[c.id] = true;
      } else {
        // show mini hint
      }
    });
    renderClues(); renderStats(); updateHint();
    showToast(`–û—Å–º–æ—Ç—Ä: ${room} ‚Äî –Ω–∞–π–¥–µ–Ω–æ ${found.length} —É–ª–∏–∫`);
  }

  // ritual & secret
  function performRitual(){
    if(state.ritualPerformed){ showToast('–†–∏—Ç—É–∞–ª —É–∂–µ –±—ã–ª –∏—Å–ø–æ–ª–Ω–µ–Ω.'); return; }
    if(!confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç—å —Å—Ç—Ä–∞–Ω–Ω—ã–π —Ä–∏—Ç—É–∞–ª? –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã.')) return;
    state.ritualPerformed = true;
    showToast('–í—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏ —Ö–æ–ª–æ–¥–Ω—ã–π –≤–µ—Ç–µ—Ä ‚Äî —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å...');
    // unlock a hidden supernatural clue
    const superClue = { id:'cl_super', title:'–†–∏—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏', room:'basement', type:'ritual', text:'–°–∏–º–≤–æ–ª—ã –∂–µ—Ä—Ç–≤–æ–ø—Ä–∏–Ω–æ—à–µ–Ω–∏—è ‚Äî —Å–ª–µ–¥—ã –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è', locked:false };
    state.clues.push(superClue);
    state.opened[superClue.id] = true;
    renderClues(); renderStats(); updateHint();
  }

  // small helper: show profiles modal with details and images if available
  function showProfiles(){
    const content = byId('profilesContent'); content.innerHTML = '';
    state.suspects.forEach(s=>{
      const div = document.createElement('div'); div.style.marginBottom='12px';
      const linked = (state.links[s.id]||[]).length;
      div.innerHTML = `<strong>${escapeHtml(s.name)}</strong> ‚Äî <em>${escapeHtml(s.role)}</em><div class="small" style="color:var(--muted); margin-top:6px">–ü—Ä–∏–≤—è–∑–∞–Ω–æ —É–ª–∏–∫: ${linked}</div>`;
      content.appendChild(div);
    });
    byId('profilesModal').style.display = 'flex';
  }

  // Save/load helpers
  function saveToLocal(key, data){
    try{ localStorage.setItem('rose_'+key, JSON.stringify(data)); LOG('Saved '+key); } catch(e){ LOG('Save error: '+e); }
  }
  function loadFromLocal(key){
    try{ const raw = localStorage.getItem('rose_'+key); if(!raw) return null; return JSON.parse(raw); } catch(e){ LOG('Load error: '+e); return null; }
  }

  // Misc helpers
  function showToast(text){
    const d = document.createElement('div');
    d.textContent = text; d.style.position='fixed'; d.style.left='50%'; d.style.bottom='20px'; d.style.transform='translateX(-50%)';
    d.style.background='rgba(0,0,0,0.8)'; d.style.color='#fff'; d.style.padding='10px 14px'; d.style.borderRadius='8px'; d.style.zIndex=999999;
    document.body.appendChild(d); setTimeout(()=>{ d.style.transition='opacity .5s'; d.style.opacity=0; setTimeout(()=>d.remove(),600); }, 1800);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

  function getTypeIcon(t){
    switch(t){
      case 'cipher': return '‚úâÔ∏è';
      case 'cipher2': return 'üîê';
      case 'puzzle': return 'üß©';
      case 'symbol': return 'üî±';
      case 'vial': return 'üß™';
      case 'ink': return 'üñãÔ∏è';
      case 'foot': return 'üë£';
      default: return 'üîé';
    }
  }

  // Fog & VFX (visual toggles)
  function toggleFog(on){
    if(on){
      document.body.style.backgroundImage = 'radial-gradient(800px 400px at 8% 8%, rgba(176,138,92,0.02), transparent), linear-gradient(180deg,#060607, #0b0b0d)';
    } else {
      document.body.style.backgroundImage = 'linear-gradient(180deg,#070607 0%, #0e0e10 80%)';
    }
  }
  function toggleVfx(on){
    // small flicker effect on elements
    document.querySelectorAll('.flicker').forEach(el=> el.style.opacity = on ? 1 : 0.6);
  }

  // load saved autosave if present
  function tryLoadAutosave(){
    const saved = loadFromLocal('autosave');
    if(saved && confirm('–ù–∞–π–¥–µ–Ω –∞–≤—Ç–æ—Å–µ–π–≤. –ó–∞–≥—Ä—É–∑–∏—Ç—å?')) {
      state = Object.assign(state, saved);
      renderAll();
      showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω');
      return true;
    }
    return false;
  }

  // Initial wiring
  function init(){
    LOG('Initializing game');
    // try to autoload notes & autosave
    const notes = localStorage.getItem('rose_notes') || '';
    byId('notebook').value = notes;
    // if autosave exists, ask to load
    const loaded = tryLoadAutosave();
    if(!loaded) newGame();
    attachUI();
    renderAll();
    // UI toggles initial
    toggleVfx(true);
    LOG('Ready');
  }

  // Small utility: escape HTML already defined

  // Expose some functions for debugging/testing
  window._rose = { state, newGame, revealClueText, saveToLocal, loadFromLocal, showEndingsList };

  // Start
  document.addEventListener('DOMContentLoaded', init);

})();
</script>
</body>
</html>
