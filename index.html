<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥ ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060607; --panel:#141214; --accent:#b08a5c; --muted:#cfcfcf; --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,#040405 0%, #0b0b0d 80%); color:#efece6; -webkit-font-smoothing:antialiased;}
.header { display:flex; justify-content:space-between; align-items:center; padding:12px 18px; border-bottom:1px solid rgba(255,255,255,0.02); position:sticky; top:0; background:rgba(6,6,6,0.6); z-index:60; }
.logo { width:48px; height:48px; border-radius:10px; background:linear-gradient(180deg,#2b1f18,#191010); display:grid; place-items:center; font-family:Cinzel,serif; font-size:18px; color:#f7efe7; border:1px solid rgba(255,255,255,0.03);}
.header-right { display:flex; gap:10px; align-items:center; }

.container { max-width:1200px; margin:18px auto; padding:12px; display:grid; grid-template-columns:320px 1fr 380px; gap:18px; align-items:start; }
@media (max-width:1100px){ .container{ grid-template-columns:1fr; } .right-panel{ order:3 } }

.panel { background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.008)); padding:14px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.02); box-shadow: 0 14px 36px rgba(0,0,0,0.65); }
.small { color:var(--muted); font-size:0.92rem; }

.suspect { display:flex; gap:12px; align-items:center; padding:10px; margin-top:10px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02); cursor:pointer; }
.suspect .avatar { width:64px; height:64px; border-radius:10px; object-fit:cover; border:2px solid rgba(255,255,255,0.03); background:#1b1412; }
.smeta { flex:1; }
.sname { font-weight:700; }
.srole { color:var(--muted); font-size:0.9rem; }
.smeta .meta-row { display:flex; gap:10px; margin-top:6px; font-size:0.88rem; color:var(--muted); }

.map { position:relative; border-radius:12px; overflow:hidden; padding:10px; min-height:420px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.36)); }
.map-canvas { width:100%; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#231a17,#1b1411); display:block; position:relative; height:340px; }
.hotspot { position:absolute; transform:translate(-50%,-50%); background:linear-gradient(180deg, rgba(176,138,92,0.14), rgba(176,138,92,0.08)); padding:8px 12px; border-radius:999px; font-weight:700; color:#120b06; cursor:pointer; border:1px solid rgba(176,138,92,0.12); box-shadow:0 10px 28px rgba(0,0,0,0.6); user-select:none; transition:transform .14s ease; }
.hotspot:hover { transform:translate(-50%,-50%) scale(1.05); }

.clues { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; }
.clue { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); cursor:pointer; display:flex; gap:10px; align-items:flex-start; }
.thumb { width:56px; height:56px; border-radius:8px; background:#201612; display:grid; place-items:center; font-size:18px; color:#d9c8ae; }

.right-panel .tool { margin-bottom:12px; }
.btn { background:var(--accent); color:#070707; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
.btn.secondary { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }

.modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); }
.card { width:760px; max-width:94%; background:linear-gradient(180deg,#121212,#0f0f0f); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); color:#efece6; box-shadow:0 30px 80px rgba(0,0,0,0.8); }
.card.small { width:520px; max-width:92%; }

/* menu screen */
#menuScreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99999; background:radial-gradient(ellipse at center, rgba(0,0,0,0.45), rgba(0,0,0,0.85)); }
.menuCard { width:880px; max-width:94%; background:linear-gradient(180deg,#0f0f0f,#090909); border-radius:14px; padding:26px; display:flex; gap:20px; box-shadow:0 30px 80px rgba(0,0,0,0.9); border:1px solid rgba(255,255,255,0.03); }
.menu-left { width:420px; padding-right:12px; border-right:1px solid rgba(255,255,255,0.02); }
.menu-right { flex:1; padding-left:12px; display:flex; flex-direction:column; gap:12px; }
.menu-title { font-family:Cinzel, serif; font-size:2.2rem; color:#efe6dc; margin:0; }
.menu-sub { color:var(--muted); margin-top:6px; }
.menu-buttons { display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; }
.menu-buttons .btn { padding:12px 18px; font-size:1rem; }

/* phone */
.phone { width:320px; border-radius:12px; background:linear-gradient(180deg,#0b0b0b,#0a0a0a); padding:10px; border:1px solid rgba(255,255,255,0.02); box-shadow:0 12px 30px rgba(0,0,0,0.6); }
.phone .screen{ height:260px; background:#060606; border-radius:8px; padding:8px; color:var(--muted); overflow:auto; }

/* chat */
.chat { display:flex; flex-direction:column; gap:8px; max-height:360px; overflow:auto; padding:8px; background:#0b0b0b; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }
.msg { padding:8px 10px; border-radius:8px; max-width:85%; }
.msg.ai { background:#1b1b1c; color:#e6e6e6; align-self:flex-start; }
.msg.user { background:#b08a5c; color:#070707; align-self:flex-end; }

/* debug */
#debug { position:fixed; right:12px; bottom:12px; width:320px; max-height:260px; overflow:auto; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(8,8,8,0.85)); color:#fff; border-radius:8px; padding:10px; border:1px solid rgba(255,255,255,0.03); font-size:12px; z-index:99998; }

/* small responsive */
@media (max-width:700px){
  .menuCard{ flex-direction:column; }
  .menu-left{ width:100%; border-right:none; padding-right:0; }
  .menu-right{ padding-left:0; }
}
</style>
</head>
<body>

<!-- MENU SCREEN -->
<div id="menuScreen" aria-hidden="false">
  <div class="menuCard" role="dialog" aria-modal="true" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
    <div class="menu-left">
      <h1 class="menu-title">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</h1>
      <p class="menu-sub">–ù–æ—á—å. –ì—Ä–æ–∑–∞. –¢–∞–π–Ω—ã —Å—Ç–∞—Ä–æ–π —Å–µ–º—å–∏. –ò–≥—Ä–∞ ‚Äî –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∫–æ–Ω—Ü–æ–≤–æ–∫.<br><strong>–°–æ–≤–µ—Ç:</strong> —á–∏—Ç–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏, —Å–≤—è–∑—ã–≤–∞–π—Ç–µ —É–ª–∏–∫–∏ –∏ –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –ø—Ä–∏ –¥–æ–ø—Ä–æ—Å–∞—Ö ‚Äî –≤–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è –º–µ–Ω—è—é—Ç —Ñ–∏–Ω–∞–ª.</p>
      <div style="margin-top:14px;">
        <strong>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</strong>
        <div style="margin-top:8px" class="menu-buttons">
          <button id="startBtn" class="btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          <button id="loadBtn" class="btn secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤</button>
          <button id="settingsBtn" class="btn secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
      </div>
    </div>

    <div class="menu-right">
      <div>
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</strong>
        <ol style="color:var(--muted); margin-top:8px; padding-left:18px;">
          <li>–û—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—ã ‚Äî –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã. </li>
          <li>–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —É–ª–∏–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –∏–ª–∏ —Å–∫—Ä—ã—Ç—ã.</li>
          <li>–†–µ—à–∞–π—Ç–µ –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã (–¶–µ–∑–∞—Ä—å, –ø–∞–∑–ª, —ç–º–±–ª–µ–º—ã), —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ø—Ä—è—Ç–∞–Ω–Ω—ã–µ —É–ª–∏–∫–∏.</li>
          <li>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —É–ª–∏–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ (–∏–ª–∏ —Ç–∞–ø–Ω–∏—Ç–µ ‚Äî –º–æ–±–∏–ª—å–Ω—ã–π), —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ.</li>
          <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–î–æ–ø—Ä–æ—Å (–Ω–µ–π—Ä–æ—Å–µ—Ç—å)" ‚Äî –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Å–ª—É—à–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã (—Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å). –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–∏–Ω—Ç–µ–∑.</li>
          <li>–ü–æ–ª—å–∑—É–π—Ç–µ—Å—å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º: –∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–ø–∞—Ä–Ω–∏–∫—É –∏–ª–∏ –≤ –ø–æ–ª–∏—Ü–∏—é, –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —Å–∞–π—Ç—ã –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫.</li>
          <li>–ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –Ω–∞–∂–º–∏—Ç–µ "–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É" –∏–ª–∏ "–û–±–≤–∏–Ω–∏—Ç—å".</li>
        </ol>
      </div>

      <div style="margin-top:auto">
        <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</strong>
        <p style="color:var(--muted)">–í –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ –≤—ã –Ω–∞–π–¥–µ—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ü–æ–≤–æ–∫ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã (–º—É–∑—ã–∫–∞, —Ç—É–º–∞–Ω).</p>
      </div>
    </div>
  </div>
</div>

<!-- HEADER -->
<header class="header" role="banner">
  <div style="display:flex; gap:12px; align-items:center;">
    <div class="logo">–†</div>
    <div>
      <div style="font-family:Cinzel,serif;">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</div>
      <div class="small">–ü–æ–ª–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
    </div>
  </div>
  <div class="header-right">
    <div id="progressText" class="small">–ü—Ä–æ–≥—Ä–µ—Å—Å: <strong id="progressPct">0%</strong></div>
    <button id="menuOpenBtn" class="btn secondary">–ú–µ–Ω—é</button>
  </div>
</header>

<!-- MAIN -->
<main class="container" role="main">
  <!-- LEFT -->
  <aside class="panel left-panel" aria-label="–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ –∏ –∑–∞–º–µ—Ç–∫–∏">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <strong style="font-family:Cinzel, serif">–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ</strong>
      <button id="profilesBtn" class="btn secondary">–ü—Ä–æ—Ñ–∏–ª–∏</button>
    </div>
    <div id="suspectsList" style="margin-top:12px"></div>

    <div style="margin-top:14px;">
      <strong>–ë–ª–æ–∫–Ω–æ—Ç</strong>
      <textarea id="notebook" rows="6" style="width:100%; margin-top:8px; resize:vertical; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="saveNotes" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏</button>
        <button id="clearNotes" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ‚Äî –∫–∞–∫ —Å–≤—è–∑—ã–≤–∞—Ç—å —É–ª–∏–∫–∏</strong>
      <div class="small" style="margin-top:6px; color:var(--muted)">
        - –ù–∞ –ü–ö: –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É —É–ª–∏–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ, –≤ –ø—Ä–∞–≤–æ–º —É–≥–ª—É –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —É–ª–∏–∫ –ø—Ä–∏–≤—è–∑–∞–Ω–æ.<br>
        - –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö: —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —É–ª–∏–∫—É 0.5‚Äî1 —Å–µ–∫ –∏ –∑–∞—Ç–µ–º —Ç–∞–ø–Ω–∏—Ç–µ –ø–æ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–º—É, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å.<br>
        - –ü—Ä–∏–≤—è–∑–∫–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±–≤–∏–Ω–µ–Ω–∏—è –∏ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏.
      </div>
    </div>
  </aside>

  <!-- CENTER -->
  <section class="panel map-panel" aria-label="–ö–∞—Ä—Ç–∞ –∏ —É–ª–∏–∫–∏">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="font-family:Cinzel, serif; font-size:1.05rem;">–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="findKiller" class="btn">–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É</button>
        <button id="interrogateBtn" class="btn secondary">–î–æ–ø—Ä–æ—Å (–Ω–µ–π—Ä–æ—Å–µ—Ç—å)</button>
        <button id="phoneOpenBtn" class="btn secondary">–¢–µ–ª–µ—Ñ–æ–Ω</button>
      </div>
    </div>

    <div class="map">
      <div class="map-canvas" id="mapCanvas">
        <div class="hotspot" data-room="library" style="left:18%; top:22%;">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div class="hotspot" data-room="music" style="left:48%; top:18%;">üéπ –ú—É–∑—ã–∫–∞</div>
        <div class="hotspot" data-room="office" style="left:76%; top:22%;">üóÑ –ö–∞–±–∏–Ω–µ—Ç</div>
        <div class="hotspot" data-room="dining" style="left:34%; top:56%;">üçΩ –°—Ç–æ–ª–æ–≤–∞—è</div>
        <div class="hotspot" data-room="garden" style="left:14%; top:78%;">üåπ –°–∞–¥</div>
        <div class="hotspot" data-room="basement" style="left:74%; top:76%;">‚öôÔ∏è –ü–æ–¥–≤–∞–ª</div>
        <div class="hotspot" data-room="attic" style="left:54%; top:44%;">üï∞ –ß–µ—Ä–¥–∞–∫</div>
      </div>

      <div style="display:flex; gap:12px; margin-top:12px;">
        <div style="flex:1">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>–£–ª–∏–∫–∏</strong>
            <div><span id="openedCount">0</span> / <span id="totalClues">0</span> –æ—Ç–∫—Ä—ã—Ç–æ</div>
          </div>
          <div id="cluesGrid" class="clues" style="margin-top:10px;"></div>
        </div>

        <div style="width:320px;">
          <div class="panel small">
            <strong>–¢–∞–π–º–ª–∞–π–Ω</strong>
            <div id="timelineList" style="margin-top:8px; min-height:80px; color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <input id="timelineInput" placeholder="23:10 ‚Äî –∫—Ä–∏–∫" style="flex:1; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"/>
              <button id="addTimeline" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div class="panel small" style="margin-top:12px;">
            <strong>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</strong>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button id="cipherBtn" class="btn">–¶–µ–∑–∞—Ä—å</button>
              <button id="puzzleBtn" class="btn secondary">–ü–∞–∑–ª</button>
              <button id="matchBtn" class="btn secondary">–≠–º–±–ª–µ–º—ã</button>
            </div>
            <div style="margin-top:8px; color:var(--muted)">–ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã –¥–∞—é—Ç –∫–ª—é—á–∏ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö —É–ª–∏–∫–æ–≤.</div>
          </div>

          <div class="panel small" style="margin-top:12px;">
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong>
            <div class="phone" style="margin-top:8px;">
              <div class="screen" id="phoneScreen">
                <div style="padding:6px; color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç—ã: <br><button id="callPartner" class="btn secondary" style="margin-top:6px">–ü–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞–ø–∞—Ä–Ω–∏–∫—É</button> <button id="callPolice" class="btn secondary" style="margin-top:6px">–ü–æ–∑–≤–æ–Ω–∏—Ç—å –≤ –ø–æ–ª–∏—Ü–∏—é</button></div>
                <div id="phoneLog" style="margin-top:8px; color:var(--muted)"></div>
              </div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input id="phoneInput" class="input" placeholder="–ù–æ–º–µ—Ä –∏–ª–∏ —Å–∞–π—Ç (–ø—Ä–∏–º–µ—Ä: 88 –∏–ª–∏ example.com)" style="flex:1; padding:8px; border-radius:8px; background:#0b0b0b; color:#efece6; border:1px solid rgba(255,255,255,0.03)">
                <button id="phoneCall" class="btn">–ó–≤–æ–Ω–æ–∫</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="panel right-panel" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
    <div class="tool">
      <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
      <div style="margin-top:8px;">–°–≤—è–∑–µ–π: <span id="linksCount">0</span></div>
      <div style="margin-top:8px;">–†–∏—Ç—É–∞–ª: <span id="ritualState">–Ω–µ—Ç</span></div>
      <div style="margin-top:8px;">–ê—É–¥–∏–æ: <span id="audioState">–≤—ã–∫–ª</span></div>
    </div>

    <div class="tool" style="margin-top:12px;">
      <strong>–ö–æ–Ω—Ü–æ–≤–∫–∏</strong>
      <div style="margin-top:8px; color:var(--muted)">–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏" ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä—ã—Ç—ã –∏ —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.</div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="endingsBtn" class="btn">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏</button>
        <button id="ritualBtn" class="btn secondary">–ò—Å–ø–æ–ª–Ω–∏—Ç—å —Ä–∏—Ç—É–∞–ª</button>
      </div>
    </div>

    <div class="tool" style="margin-top:12px;">
      <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong>
      <div style="margin-top:8px;">
        <label><input type="checkbox" id="toggleMusic"> –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</label><br>
        <label style="margin-top:6px"><input type="checkbox" id="toggleAmbience" checked> –¢—É–º–∞–Ω / —ç—Ñ—Ñ–µ–∫—Ç—ã</label><br>
        <label style="margin-top:6px"><input type="checkbox" id="toggleDetectiveVoice" checked> –ì–æ–ª–æ—Å –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ (TTS)</label>
      </div>
    </div>

    <div class="tool" style="margin-top:12px;">
      <strong>–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</strong>
      <div id="charsDesc" style="margin-top:8px; color:var(--muted)">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è (—Ä–æ—Å—Ç, –æ–±—É–≤—å, –ø—Ä–∏–≤—ã—á–∫–∏, –≤–Ω–µ—à–Ω–æ—Å—Ç—å).</div>
    </div>
  </aside>
</main>

<!-- MODALS -->
<div id="profilesModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö</h3><div id="profilesContent" style="margin-top:12px"></div><div style="text-align:right; margin-top:12px;"><button id="closeProfiles" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="interrogateModal" class="modal" aria-hidden="true"><div class="card"><h3>–î–æ–ø—Ä–æ—Å ‚Äî –ù–µ–π—Ä–æ—Å–µ—Ç—å –ø–æ–º–æ—â–Ω–∏–∫</h3><div class="small" style="margin-top:6px">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ, –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã. –û—Ç–≤–µ—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–ª–∏–∫ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π; –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≥–æ–ª–æ—Å.</div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <select id="interrogateSelect" style="flex:1; padding:8px; border-radius:8px; background:#0b0b0b; color:#efece6; border:1px solid rgba(255,255,255,0.03)"></select>
    <button id="interrogateStart" class="btn">–ù–∞—á–∞—Ç—å</button>
  </div>
  <div class="chat" id="chatWindow" style="margin-top:12px;"></div>
  <div style="display:flex; gap:8px; margin-top:8px;"><input id="chatInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å" class="input" style="flex:1; padding:8px; border-radius:8px;"><button id="chatSend" class="btn">–°–ø—Ä–æ—Å–∏—Ç—å</button><button id="chatClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div id="cipherModal" class="modal" aria-hidden="true"><div class="card small"><h3>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (–¶–µ–∑–∞—Ä—å)</h3><div class="small" style="margin-top:6px">–í–≤–µ–¥–∏—Ç–µ —Å–¥–≤–∏–≥ (1‚Äì25)</div><div style="display:flex; gap:8px; margin-top:8px;"><input id="cipherShift" class="input" type="number" min="1" max="25" value="3" style="padding:8px; border-radius:8px;"><button id="cipherTryBtn" class="btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button></div><textarea id="cipherOutput" rows="4" class="input" style="margin-top:8px; width:100%; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)" readonly></textarea><div style="text-align:right; margin-top:8px;"><button id="cipherCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="puzzleModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ü–∞–∑–ª ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞—Ä—Ç—É</h3><div id="puzzleBoard" style="margin-top:12px; display:grid; gap:4px; grid-template-columns: repeat(3, 1fr);"></div><div style="text-align:right; margin-top:12px;"><button id="puzzleClose" class="btn secondary">–û—Ç–º–µ–Ω–∞</button></div></div></div>

<div id="matchModal" class="modal" aria-hidden="true"><div class="card small"><h3>–≠–º–±–ª–µ–º—ã ‚Äî –ù–∞–π–¥–∏—Ç–µ –≤–µ—Ä–Ω—É—é</h3><div id="matchArea" style="display:flex; gap:8px; margin-top:12px; justify-content:space-around;"></div><div style="text-align:right; margin-top:12px;"><button id="matchCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingsModal" class="modal" aria-hidden="true"><div class="card"><h3>–ö–æ–Ω—Ü–æ–≤–∫–∏</h3><div id="endingsList" style="margin-top:12px" class="endings-grid"></div><div style="text-align:right; margin-top:12px;"><button id="endingsClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingRevealModal" class="modal" aria-hidden="true"><div class="card"><h3 id="endingTitle"></h3><div id="endingText" style="margin-top:12px; color:var(--muted)"></div><div style="text-align:right; margin-top:12px;"><button id="endingClose" class="btn">OK</button></div></div></div>

<!-- audio -->
<audio id="bgMusic" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2022/04/09/audio_2839a1de58.mp3" type="audio/mpeg"></audio>
<audio id="ambience" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2021/08/04/audio_5f5a8f1f44.mp3" type="audio/mpeg"></audio>
<audio id="clickSnd" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2023/03/03/audio_8f0b52d1b4.mp3?filename=interface-click-116929.mp3" type="audio/mpeg"></audio>

<div id="debug" aria-hidden="false"><strong>DEBUG</strong><div id="debugLog" style="white-space:pre-wrap; margin-top:8px; font-family:monospace; color:#cfcfcf">init...</div></div>

<script>
/* MAIN GAME SCRIPT
   - Menu screen shown at start; Start button hides it and loads game.
   - Instructions in menu already added.
   - Interrogation: choose suspect -> chat with simulated 'neural' responses. Optional TTS for detective and suspect.
   - Click on suspect card opens profile modal with appearance, habits, height, shoe size.
   - Phone with preset buttons (partner / police) and manual dialing.
   - Room inspection: clicking hotspot shows clues in that room; opening clues and mini-games unlock hidden clues.
   - Detective voice (TTS) reads user's question optionally.
   - Bug fixes: defensive DOM queries, single definitions, clear event binding after DOMContentLoaded.
*/

const LOG = (...args) => { try { const el = document.getElementById('debugLog'); if(el) el.textContent += '\\n' + args.join(' '); console.log(...args); } catch(e){ console.log(...args);} };

document.addEventListener('DOMContentLoaded', () => {
  LOG('DOM loaded');
  setupMenu();
  bindMenuButtons();
  bindGlobalUI();
  // menu will start newGame when Start is pressed
});

/* ---------- Data ---------- */
const DEFAULT_SUSPECTS = [
  { id:'adrian', name:'–≠–¥—Ä–∏–∞–Ω –†–æ—É–∑–≤—É–¥', role:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫', male:true, height:189, shoe:44, desc:'–•–æ–ª–æ–¥–Ω—ã–π, –≥–æ—Ä–¥—ã–π. –°–∫–∞–Ω–¥–∞–ª–∏–ª —Å –æ—Ç—Ü–æ–º.' },
  { id:'beatrice', name:'–ë–µ–∞—Ç—Ä–∏—Å –•–µ–π–≤—É–¥', role:'–î–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞', male:false, height:165, shoe:37, desc:'–¢–∏—Ö–∞—è, –∑–Ω–∞–µ—Ç —É–∫—Ä–æ–º–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ –¥–æ–º–µ.' },
  { id:'prof', name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ú–æ—Ä–¥–µ–Ω', role:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', male:true, height:178, shoe:42, desc:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤; –ª—é–±–∏—Ç —É–µ–¥–∏–Ω–µ–Ω–∏–µ.' },
  { id:'victoria', name:'–í–∏–∫—Ç–æ—Ä–∏—è –†–æ—É–∑–≤—É–¥', role:'–ñ–µ–Ω–∞', male:false, height:172, shoe:39, desc:'–°—Ç—Ä–∞—Å—Ç–Ω–∞—è, —á–∞—Å—Ç–æ —Å—Å–æ—Ä–∏–ª–∞—Å—å —Å –º—É–∂–µ–º.' },
  { id:'lina', name:'–õ–∏–Ω–∞ –ú–æ–Ω—Ç', role:'–ì–æ—Å—Ç—å—è', male:false, height:168, shoe:38, desc:'–ó–∞–≥–∞–¥–æ—á–Ω–∞—è, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —ç–∑–æ—Ç–µ—Ä–∏–∫–æ–π.' }
];

const MASTER_CLUES = [
  { id:'cl1', title:'–¢–∞–π–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞)', room:'office', type:'cipher', text:'Vkr ghqv wrfkh', locked:true },
  { id:'cl2', title:'–°–ª–µ–¥ –æ–±—É–≤–∏', room:'garden', type:'foot', text:'–ü–æ–¥–æ—à–≤–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º B7', locked:false },
  { id:'cl3', title:'–†–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç', room:'library', type:'paper', text:'–í—ã—Ä–≤–∞–Ω–æ –∏–º—è, –ø–æ–º–µ—Ç–∫–∞: 12/11', locked:false },
  { id:'cl4', title:'–°–∏–º–≤–æ–ª –Ω–∞ —Å—Ç–µ–Ω–µ', room:'music', type:'symbol', text:'–°—Ç—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª ‚Äî —ç–º–±–ª–µ–º–∞', locked:false },
  { id:'cl5', title:'–ü–µ–ø–µ–ª –∏ –ø—è—Ç–Ω–∞ –º–∞—Å–ª–∞', room:'dining', type:'ash', text:'–ü–µ–ø–µ–ª –∏ —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ', locked:false },
  { id:'cl6', title:'–§—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã (—Å–æ–∂–∂–µ–Ω)', room:'basement', type:'puzzle', text:'–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã ‚Äî –Ω—É–∂–µ–Ω –ø–∞–∑–ª', locked:true },
  { id:'cl7', title:'–§–ª–∞–∫–æ–Ω —Å —ç—Ñ–∏—Ä–æ–º', room:'attic', type:'vial', text:'–†–µ–¥–∫–∏–π —ç—Ñ–∏—Ä ‚Äî –∑–∞–ø–∞—Ö –Ω–∞—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞ –º—ã—Å–ª—å', locked:false },
  { id:'cl8', title:'–ó–∞–ø–∏—Å–∫–∞ –≤ –∫–Ω–∏–≥–µ', room:'library', type:'note', text:'"–í–ª–∞—Å—Ç—å ‚Äî —á–µ—Ä–µ–∑ —Ç–∞–π–Ω—É" ‚Äî –ø–æ–¥–ø–∏—Å—å –í.', locked:false },
  { id:'cl9', title:'–ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç', room:'office', type:'seal', text:'–ö–æ–Ω–≤–µ—Ä—Ç —Å –ø–µ—á–∞—Ç—å—é', locked:true },
  { id:'cl10', title:'–ß–µ—Ä–Ω–∏–ª—å–Ω—ã–µ –±—Ä—ã–∑–≥–∏', room:'office', type:'ink', text:'–ß–µ—Ä–Ω–∏–ª–∞ Wyn ‚Äî —Ä–µ–¥–∫–∞—è —Ñ–∏—Ä–º–∞', locked:false }
];

const ENDINGS = [
  { id:'truth', title:'–ü—Ä–∞–≤–¥–∞ –∏ —Å—É–¥', desc:'–°–æ–±—Ä–∞–Ω—ã –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî –≤–∏–Ω–æ–≤–Ω—ã–π –æ—Å—É–∂–¥—ë–Ω.', cond: s=> s.links['adrian'] && s.links['adrian'].length>=3 && s.timeline.length>=2 },
  { id:'frame', title:'–ü–æ–¥—Å—Ç–∞–≤–ª–µ–Ω', desc:'–£–ª–∏–∫–∏ –ø–æ–¥–ª–æ–∂–∏–ª–∏ ‚Äî —Ä–µ—à–µ–Ω–∏–µ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ.', cond: s=> s.links['beatrice'] && s.links['beatrice'].length>=2 && s.opened['cl6'] },
  { id:'supernatural', title:'–ó–∞ –≥—Ä–∞–Ω—å—é', desc:'–†–∏—Ç—É–∞–ª –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –Ω–µ—á—Ç–æ... –§–∏–Ω–∞–ª —Å–≤–µ—Ä—Ö—ä–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π.', cond: s=> s.opened['cl5'] && s.opened['cl7'] && s.ritualPerformed },
  { id:'open', title:'–ù–µ—Ä–∞—Å–∫—Ä—ã—Ç–æ', desc:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî –¥–µ–ª–æ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–∞–π–Ω–æ–π.', cond: s=> Object.values(s.links).flat().length < 3 }
];

/* ---------- Game State ---------- */
let state = {
  suspects: [], clues: [], opened: {}, links: {}, timeline: [], ritualPerformed: false,
  audioOn: false, musicOn: false, detectiveVoice: true
};

/* ---------- Helpers ---------- */
function saveState(key){ try{ localStorage.setItem('rose_state_'+key, JSON.stringify(state)); LOG('Saved', key); }catch(e){ LOG('Save error', e); } }
function loadState(key){ try{ const raw = localStorage.getItem('rose_state_'+key); return raw ? JSON.parse(raw) : null; }catch(e){ LOG('Load err', e); return null; } }
function showToast(text){ const d=document.createElement('div'); d.textContent=text; d.style.position='fixed'; d.style.left='50%'; d.style.bottom='20px'; d.style.transform='translateX(-50%)'; d.style.background='rgba(0,0,0,0.85)'; d.style.color='#fff'; d.style.padding='10px 14px'; d.style.borderRadius='8px'; d.style.zIndex=99999; document.body.appendChild(d); setTimeout(()=>{ d.style.transition='opacity .6s'; d.style.opacity=0; setTimeout(()=>d.remove(),600); }, 1600); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function getIcon(t){ switch(t){ case 'cipher': return '‚úâÔ∏è'; case 'puzzle': return 'üß©'; case 'symbol': return 'üî±'; case 'vial': return 'üß™'; case 'foot': return 'üë£'; case 'ink': return 'üñãÔ∏è'; default: return 'üîé'; } }

/* ---------- Menu & Start ---------- */
function setupMenu(){
  const startBtn = document.getElementById('startBtn');
  const loadBtn = document.getElementById('loadBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  startBtn && startBtn.addEventListener('click', ()=> {
    document.getElementById('menuScreen').style.display='none';
    newGame();
  });
  loadBtn && loadBtn.addEventListener('click', ()=> {
    const s = loadState('manual');
    if(s && confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ?')) { state = s; renderAll(); document.getElementById('menuScreen').style.display='none'; showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ'); }
    else showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –Ω–µ—Ç');
  });
  settingsBtn && settingsBtn.addEventListener('click', ()=> alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–º—É–∑—ã–∫–∞, –≥–æ–ª–æ—Å –∏ —Ç.–¥.)'));
  document.getElementById('menuOpenBtn') && document.getElementById('menuOpenBtn').addEventListener('click', ()=> {
    document.getElementById('menuScreen').style.display='flex';
  });
}

/* ---------- Global UI Binding ---------- */
function bindMenuButtons(){
  // nothing else here for now
}

/* ---------- Game Start ---------- */
function newGame(){
  LOG('newGame');
  state.suspects = JSON.parse(JSON.stringify(DEFAULT_SUSPECTS)).sort(()=>Math.random()-0.5);
  state.clues = JSON.parse(JSON.stringify(MASTER_CLUES));
  // add a couple of extra random clues
  for(let i=0;i<2;i++){
    const base = MASTER_CLUES[Math.floor(Math.random()*MASTER_CLUES.length)];
    const copy = Object.assign({}, base, { id: base.id + '_x' + i, title: base.title + ' (–≤—Å–ø–ª.)', locked: Math.random() < 0.5 });
    state.clues.push(copy);
  }
  state.opened = {}; state.links = {}; state.timeline = []; state.ritualPerformed = false;
  state.suspects.forEach(s => state.links[s.id]=[]);
  renderAll();
  showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞.');
  saveState('autosave');
}

/* ---------- Rendering ---------- */
function renderSuspects(){
  const area = document.getElementById('suspectsList'); area.innerHTML='';
  state.suspects.forEach(s=>{
    const div = document.createElement('div'); div.className='suspect'; div.dataset.suspect = s.id;
    // try to use user-provided female images assets/female1..3.jpg (if exist) ‚Äî browser will show broken icon if not
    let avatarHtml = `<div class="avatar">${escapeHtml(s.name[0])}</div>`;
    if(!s.male){
      const idx = state.suspects.filter(x=>!x.male).map(x=>x.id).indexOf(s.id);
      const src = `assets/female${Math.min(3, idx+1)}.jpg`;
      avatarHtml = `<img class="avatar" src="${src}" alt="${escapeHtml(s.name)}">`;
    }
    div.innerHTML = `${avatarHtml}<div class="smeta"><div class="sname">${escapeHtml(s.name)}</div><div class="srole">${escapeHtml(s.role)}</div><div class="meta-row">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe}</div><div class="meta-row" style="margin-top:6px; color:var(--muted)">${escapeHtml(s.desc)}</div></div><div class="dropzone" data-suspect="${s.id}">${(state.links[s.id]||[]).length}</div>`;
    // click opens profile modal with detailed info and habits
    div.addEventListener('click', ()=> openProfileModal(s));
    area.appendChild(div);
  });
  attachDropzones();
}

function renderClues(){
  const grid = document.getElementById('cluesGrid'); grid.innerHTML='';
  state.clues.forEach(c=>{
    const el = document.createElement('div'); el.className='clue'; el.id = c.id; el.dataset.clue = c.id;
    const isOpen = !!state.opened[c.id];
    el.innerHTML = `<div class="thumb">${getIcon(c.type)}</div><div><h4>${escapeHtml(c.title)}</h4><p>${ isOpen ? escapeHtml(c.text) : (c.locked ? '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ / —Å–∫—Ä—ã—Ç–∞' : escapeHtml(c.text)) }</p></div>`;
    el.addEventListener('click', ()=> onClueClick(c));
    el.draggable = true;
    el.addEventListener('dragstart', ev=> ev.dataTransfer.setData('text/plain', c.id));
    grid.appendChild(el);
  });
  document.getElementById('totalClues').innerText = state.clues.length;
  document.getElementById('openedCount').innerText = Object.keys(state.opened).length;
}

function renderTimeline(){
  const el = document.getElementById('timelineList');
  if(state.timeline.length===0){ el.innerHTML = '<div class="small" style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  el.innerHTML = state.timeline.slice().reverse().map(t=> `<div style="margin-bottom:6px">${escapeHtml(t.text)} <span style="color:var(--muted); font-size:0.82rem">(${new Date(t.time).toLocaleTimeString()})</span></div>`).join('');
}

function renderStats(){
  document.getElementById('linksCount').innerText = Object.values(state.links).flat().length;
  document.getElementById('ritualState').innerText = state.ritualPerformed ? '–¥–∞' : '–Ω–µ—Ç';
  updateProgress();
}

function renderAll(){
  renderSuspects(); renderClues(); renderTimeline(); renderStats(); populateAccuse(); renderProfilesModal();
}

/* ---------- Attach dropzones ---------- */
function attachDropzones(){
  document.querySelectorAll('.dropzone').forEach(zone=>{
    zone.addEventListener('dragover', ev=> { ev.preventDefault(); zone.style.outline='2px dashed rgba(176,138,92,0.6)'; });
    zone.addEventListener('dragleave', ev=> { zone.style.outline=''; });
    zone.addEventListener('drop', ev=> { ev.preventDefault(); zone.style.outline=''; const clueId = ev.dataTransfer.getData('text/plain'); const suspectId = zone.dataset.suspect; if(clueId && suspectId) linkEvidence(suspectId, clueId); });
  });
  // mobile long-press is handled in clue touch support
  document.querySelectorAll('.clue').forEach(c => addTouchDragSupport(c));
}

/* ---------- Clue interactions ---------- */
function onClueClick(c){
  LOG('clue clicked', c.id);
  if(c.locked && !state.opened[c.id]){
    // open appropriate tool
    if(c.type === 'cipher' || c.type === 'cipher2'){ openCipherModal(c); return; }
    if(c.type === 'puzzle'){ openPuzzleModal(); return; }
    if(c.type === 'symbol' || c.type === 'seal'){ openMatchModal(c); return; }
    showToast('–≠—Ç–∞ —É–ª–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.');
    return;
  }
  if(!state.opened[c.id]){
    state.opened[c.id] = true;
    revealClueText(c);
    renderClues(); renderStats(); updateHint();
    return;
  }
  // already opened -> show detail
  showDetail(c);
}
function revealClueText(c){
  if(c.type === 'cipher' && c.text === 'Vkr ghqv wrfkh') c.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª';
  if(c.type === 'puzzle' && c.text.includes('–ß–∞—Å—Ç–∏')) c.text = '–ö–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: –Ω–∞–π–¥–µ–Ω —Å–∫—Ä—ã—Ç—ã–π —Ö–æ–¥ –º–µ–∂–¥—É –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –∏ –ø–æ–¥–≤–∞–ª–æ–º.';
  state.opened[c.id] = true;
}
function showDetail(c){
  byId('endingTitle').innerText = c.title;
  byId('endingText').innerHTML = `<div style="color:var(--muted)">${escapeHtml(c.text)}</div>`;
  byId('endingRevealModal').style.display = 'flex';
}

/* ---------- Mini-games ---------- */
function openCipherModal(clue){
  const modal = byId('cipherModal'); modal.style.display='flex'; modal.dataset.clue = clue ? clue.id : '';
  byId('cipherOutput').value = ''; byId('cipherShift').value = 3;
}
function tryCipher(){
  const shift = Number(byId('cipherShift').value) || 0; const clueId = byId('cipherModal').dataset.clue;
  const clue = state.clues.find(c=>c.id===clueId) || state.clues.find(c=>c.type==='cipher' || c.type==='cipher2');
  if(!clue){ showToast('–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∑–∞–ø–∏—Å–∫–∏.'); return; }
  const decoded = caesarDecode(clue.text, shift); byId('cipherOutput').value = decoded;
  if(/–æ–Ω –∑–Ω–∞–µ—Ç|–≤\./i.test(decoded) || shift===3){ showToast('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞'); clue.locked=false; clue.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª'; state.opened[clue.id]=true; renderClues(); renderStats(); byId('cipherModal').style.display='none'; }
}
function caesarDecode(s, shift){ if(!s) return s; const a='abcdefghijklmnopqrstuvwxyz', A=a.toUpperCase(); return s.split('').map(ch=>{ if(a.includes(ch)) return a[(a.indexOf(ch)-shift+26)%26]; if(A.includes(ch)) return A[(A.indexOf(ch)-shift+26)%26]; return ch; }).join(''); }

let puzzleSolved = false;
function openPuzzleModal(){
  const modal = byId('puzzleModal'); modal.style.display='flex';
  const board = byId('puzzleBoard'); board.innerHTML='';
  const nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
  nums.forEach(n=>{
    const p = document.createElement('div'); p.style.background='#201612'; p.style.color='#d9c8ae'; p.style.display='grid'; p.style.placeItems='center'; p.style.height='80px'; p.style.borderRadius='6px'; p.style.cursor='pointer';
    p.textContent = n===9 ? '' : n; p.dataset.num = n;
    p.addEventListener('click', ()=> { clickPuzzlePiece(board, p); });
    board.appendChild(p);
  });
}
function clickPuzzlePiece(board, piece){
  const empty = Array.from(board.children).find(c=>c.dataset.num=='9'); if(!empty) return;
  const idx = Array.from(board.children).indexOf(piece), eidx = Array.from(board.children).indexOf(empty), dist = Math.abs(idx-eidx);
  if(dist === 1 || dist === 3){ const t = piece.dataset.num; piece.dataset.num = empty.dataset.num; empty.dataset.num = t; const tmp = piece.textContent; piece.textContent = empty.textContent; empty.textContent = tmp; checkPuzzleSolved(board); }
}
function checkPuzzleSolved(board){
  const order = Array.from(board.children).map(c=>Number(c.dataset.num)); const ok = order.every((v,i)=> v===i+1);
  if(ok && !puzzleSolved){ puzzleSolved=true; const clue = state.clues.find(c=>c.type==='puzzle'); if(clue){ clue.locked=false; clue.text='–ö–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: –Ω–∞–π–¥–µ–Ω —Å–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ö–æ–¥.'; state.opened[clue.id]=true; renderClues(); renderStats(); updateHint(); } showToast('–ü–∞–∑–ª —Ä–µ—à—ë–Ω!'); byId('puzzleModal').style.display='none'; }
}

function openMatchModal(clue){
  const modal = byId('matchModal'); modal.style.display='flex';
  const area = byId('matchArea'); area.innerHTML='';
  const opts = [{id:'A',ok:false},{id:'B',ok:true},{id:'C',ok:false}].sort(()=>Math.random()-0.5);
  opts.forEach(o=> {
    const btn = document.createElement('div'); btn.style.width='120px'; btn.style.height='120px'; btn.style.borderRadius='8px'; btn.style.background='#211815'; btn.style.display='grid'; btn.style.placeItems='center'; btn.style.cursor='pointer'; btn.innerHTML=`<div>${o.id}</div>`;
    btn.addEventListener('click', ()=> { if(o.ok){ showToast('–≠–º–±–ª–µ–º–∞ —Å–æ–≤–ø–∞–ª–∞ ‚Äî —É–ª–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞.'); const target = (clue && state.clues.find(x=>x.id===clue.id)) || state.clues.find(x=>x.type==='symbol'); if(target){ target.locked=false; state.opened[target.id]=true; renderClues(); renderStats(); updateHint(); } modal.style.display='none'; } else { showToast('–ù–µ –ø–æ—Ö–æ–∂–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é.'); }});
    area.appendChild(btn);
  });
}

/* ---------- Interrogation (simulated neural) ---------- */
function openInterrogation(){
  const modal = byId('interrogateModal'); modal.style.display='flex';
  const sel = byId('interrogateSelect'); sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ ‚Äî</option>';
  state.suspects.forEach(s=> { const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; sel.appendChild(o); });
  byId('chatWindow').innerHTML = '';
}
function startInterrogation(){
  const sel = byId('interrogateSelect'); const id = sel.value; if(!id){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'); return; }
  const suspect = state.suspects.find(s=>s.id===id);
  addChatAI(`–í—ã –¥–æ–ø—Ä–æ—Å–∏—Ç–µ ${suspect.name}. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞.`);
}
function addChatAI(text, speak=true){
  const chat = byId('chatWindow'); const m = document.createElement('div'); m.className='msg ai'; m.textContent = text; chat.appendChild(m); chat.scrollTop = chat.scrollHeight;
  if(speak && state.detectiveVoice){ speakText(text, {voice:'suspect'}); }
}
function addChatUser(text, speak=true){
  const chat = byId('chatWindow'); const m = document.createElement('div'); m.className='msg user'; m.textContent = text; chat.appendChild(m); chat.scrollTop = chat.scrollHeight;
  if(speak && state.detectiveVoice){ speakText(text, {voice:'detective'}); }
}
function handleChatAsk(){
  const q = byId('chatInput').value.trim(); if(!q) return; addChatUser(q); byId('chatInput').value='';
  // Generate response
  setTimeout(()=> {
    const selId = byId('interrogateSelect').value;
    const resp = generateAIResponseForSuspect(q, selId);
    addChatAI(resp);
  }, 500 + Math.random()*600);
}
function generateAIResponseForSuspect(question, suspectId){
  if(!suspectId) return '–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ.';
  const s = state.suspects.find(x=>x.id===suspectId);
  const q = question.toLowerCase();
  if(q.includes('–≥–¥–µ') && q.includes('–±—ã–ª–∏')) return `${s.name}: –Ø –±—ã–ª–∞(–±) –≤ ${s.male ? '–∫–æ–º–Ω–∞—Ç–µ' : '–∫–æ—Ä–∏–¥–æ—Ä–µ'} –æ–∫–æ–ª–æ –ø–æ–ª—É–Ω–æ—á–∏.`;
  if(q.includes('–∑–∞–ø–∏—Å') || q.includes('—à–∏—Ñ—Ä')) return `${s.name}: –≠—Ç–∞ –∑–∞–ø–∏—Å–∫–∞? –Ø —Å–ª—ã—à–∞–ª(–∞) –æ –Ω–µ–π ‚Äî –∫–∞–∂–µ—Ç—Å—è, —Ç–∞–º –∏–Ω–∏—Ü–∏–∞–ª—ã "–í."`;
  if(q.includes('—Å–∏–º–≤–æ–ª')) return `${s.name}: –°–∏–º–≤–æ–ª –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –≥–µ—Ä–± —Å–µ–º—å–∏ –ú–æ—Ä–¥–µ–Ω.`;
  // If clue mentions suspect
  const linked = Object.entries(state.links).filter(([k,arr]) => arr.includes('cl2') || arr.includes('cl10'));
  if(linked.length>0) return `${s.name}: –£–ª–∏–∫–∏ –µ—Å—Ç—å, –Ω–æ –æ–Ω–∏ –ª–µ–≥–∫–æ –ø–æ–¥–¥–µ–ª—ã–≤–∞—é—Ç—Å—è.`;
  // default
  return `${s.name}: –Ø –Ω–µ –≥–æ—Ç–æ–≤(–∞) –æ–±—Å—É–∂–¥–∞—Ç—å —ç—Ç–æ.`;
}

/* ---------- Profiles modal ---------- */
function openProfileModal(s){
  // show the same profile modal but scroll to target
  renderProfilesModal();
  const modal = byId('profilesModal'); modal.style.display='flex';
  // optionally highlight suspect (not implemented highlight for simplicity)
}
function renderProfilesModal(){
  const cont = byId('profilesContent'); cont.innerHTML = '';
  state.suspects.forEach(s=>{
    const div = document.createElement('div'); div.style.marginBottom='12px';
    const linked = state.links[s.id] ? state.links[s.id].length : 0;
    div.innerHTML = `<strong>${escapeHtml(s.name)}</strong> ‚Äî <em>${escapeHtml(s.role)}</em><div class="small" style="color:var(--muted); margin-top:6px">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe} ¬∑ –ü—Ä–∏–≤—ã—á–∫–∏: ${escapeHtml(s.desc)}</div><div style="margin-top:8px"><button class="btn" onclick="inspectSuspect('${s.id}')">–î–æ–ø—Ä–æ—Å–∏—Ç—å</button> <button class="btn secondary" onclick="showPhysical('${s.id}')">–í–Ω–µ—à–Ω–æ—Å—Ç—å</button></div><div style="margin-top:6px; color:var(--muted)">–°–≤—è–∑–∞–Ω–æ —É–ª–∏–∫: ${linked}</div>`;
    cont.appendChild(div);
  });
}
window.inspectSuspect = function(id){ document.getElementById('profilesModal').style.display='none'; document.getElementById('interrogateModal').style.display='flex'; document.getElementById('interrogateSelect').value = id; addChatAI('–ù–∞—á–∏–Ω–∞–µ–º –¥–æ–ø—Ä–æ—Å.'); };
window.showPhysical = function(id){
  const s = state.suspects.find(x=>x.id===id); if(!s) return;
  const text = `${s.name}. –†–æ—Å—Ç: ${s.height} —Å–º. –†–∞–∑–º–µ—Ä –æ–±—É–≤–∏: ${s.shoe}. –í–Ω–µ—à–Ω–æ—Å—Ç—å: ${s.desc}. –ü—Ä–∏–≤—ã—á–∫–∏: —á–∞—Å—Ç–æ –Ω–æ—Å–∏—Ç –ø–µ—Ä—á–∞—Ç–∫–∏, –≤–µ—á–µ—Ä–æ–º –ª—é–±–∏—Ç –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ.`;
  byId('endingTitle').innerText = '–í–Ω–µ—à–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–≤—ã—á–∫–∏';
  byId('endingText').innerHTML = `<div style="color:var(--muted)">${escapeHtml(text)}</div>`;
  byId('endingRevealModal').style.display='flex';
}

/* ---------- Phone ---------- */
function bindPhone(){
  byId('callPartner').addEventListener('click', ()=> {
    const log = byId('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–í—ã –∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–ø–∞—Ä–Ω–∏–∫—É... –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>` + log.innerHTML;
    setTimeout(()=> { log.innerHTML = `<div style="color:var(--muted)">'–Ø –Ω–∞ –ø—É—Ç–∏, –¥–µ—Ä–∂–∏ –º–µ–Ω—è –≤ –∫—É—Ä—Å–µ', ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞–ø–∞—Ä–Ω–∏–∫.</div>` + log.innerHTML; }, 1200);
  });
  byId('callPolice').addEventListener('click', ()=> {
    const log = byId('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–í—ã–∑–æ–≤ –≤ –ø–æ–ª–∏—Ü–∏—é... –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ –ª–∏–Ω–∏–∏.</div>` + log.innerHTML;
    setTimeout(()=> { log.innerHTML = `<div style="color:var(--muted)">'–ü–æ–ª–∏—Ü–∏—è –≤—ã–µ—Ö–∞–ª–∞ –Ω–∞ –º–µ—Å—Ç–æ', ‚Äî —Å–æ–æ–±—â–∞–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä.</div>` + log.innerHTML; }, 1200);
  });
  byId('phoneCall').addEventListener('click', ()=> {
    const val = byId('phoneInput').value.trim(); const log = byId('phoneLog');
    if(!val) return;
    if(val.includes('.') || val.startsWith('http')) { window.open(val.startsWith('http')?val:'http://'+val,'_blank'); log.innerHTML = `<div style="color:var(--muted)">–û—Ç–∫—Ä—ã—Ç —Å–∞–π—Ç: ${escapeHtml(val)}</div>` + log.innerHTML; } else { log.innerHTML = `<div style="color:var(--muted)">–í—ã–∑–æ–≤ ${escapeHtml(val)} ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>` + log.innerHTML; setTimeout(()=> { log.innerHTML = `<div style="color:var(--muted)">'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —ç—Ç–æ–º—É –Ω–æ–º–µ—Ä—É', ‚Äî –≥–æ–ª–æ—Å —Å–æ–æ–±—â–∞–µ—Ç.</div>` + log.innerHTML; }, 1200); }
  });
}

/* ---------- Find killer / Accuse ---------- */
function tryFindKiller(){
  const counts = state.suspects.map(s=>({ id:s.id, name:s.name, c:(state.links[s.id]||[]).length }));
  counts.sort((a,b)=>b.c-a.c);
  const top = counts[0];
  if(!top || top.c===0){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤'); return; }
  byId('accuseSelect').value = top.id;
  showToast('–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —É–±–∏–π—Ü–∞: '+top.name);
  accuseSelected();
}
function populateAccuse(){ const sel = byId('accuseSelect'); if(!sel) return; sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>'; state.suspects.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); }); }
function accuseSelected(){
  const sel = byId('accuseSelect'); const id = sel.value; if(!id){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'); return; }
  // evaluate endings
  const matched = ENDINGS.filter(e => e.cond(state));
  if(matched.length>0){ showEnding(matched[0].id); return; }
  // fallback
  const links = state.links[id]||[];
  if(links.length>=3 && id==='adrian'){ showEnding('truth'); return; }
  showEnding('open');
}
function showEnding(id){
  const e = ENDINGS.find(x=>x.id===id); if(!e) return;
  byId('endingTitle').innerText = e.title; byId('endingText').innerText = e.desc; byId('endingRevealModal').style.display='flex';
  // save history
  const hist = JSON.parse(localStorage.getItem('rose_endings')||'[]'); hist.unshift({id:e.id,time:new Date().toISOString()}); localStorage.setItem('rose_endings', JSON.stringify(hist.slice(0,50)));
}

/* ---------- Ritual ---------- */
function performRitual(){
  if(state.ritualPerformed){ showToast('–†–∏—Ç—É–∞–ª —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω.'); return; }
  if(!confirm('–ò—Å–ø–æ–ª–Ω–∏—Ç—å —Ä–∏—Ç—É–∞–ª? –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º.')) return;
  state.ritualPerformed = true;
  showToast('–•–æ–ª–æ–¥–Ω—ã–π –≤–µ—Ç–µ—Ä –ø—Ä–æ–Ω—ë—Å—Å—è –ø–æ –∫–æ—Ä–∏–¥–æ—Ä—É...');
  const special = { id:'cl_ritual', title:'–†–∏—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏', room:'basement', type:'ritual', text:'–ó–∞—Ç–µ–Ω—ë–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª–∏–Ω–∏–∏ –∫—Ä–æ–≤–∏', locked:false };
  state.clues.push(special); state.opened[special.id] = true; renderClues(); renderStats();
}

/* ---------- Interrogation TTS ---------- */
function speakText(text, opts={voice:'detective'}) {
  if(!('speechSynthesis' in window)) return;
  if(!state.detectiveVoice) return;
  const utter = new SpeechSynthesisUtterance(text);
  // choose a default voice (browser-dependent)
  const voices = speechSynthesis.getVoices();
  // simple heuristics: use a female voice for suspect, male for detective if available
  if(opts.voice === 'suspect'){
    const v = voices.find(v=>/female|woman|zira|samantha|alexa/i.test(v.name)) || voices[0];
    if(v) utter.voice = v;
  } else {
    const v = voices.find(v=>/male|man|david|alex/i.test(v.name)) || voices[0];
    if(v) utter.voice = v;
  }
  utter.rate = 1;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

/* ---------- Utilities ---------- */
function populateInterrogateSelect(){ const sel = byId('interrogateSelect'); sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>'; state.suspects.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); }); }

/* ---------- Binding Global UI ---------- */
function bindGlobalUI(){
  // hotspots
  document.querySelectorAll('.hotspot').forEach(h=> h.addEventListener('click', ()=> { const room = h.dataset.room; inspectRoom(room); document.getElementById('clickSnd') && document.getElementById('clickSnd').play && document.getElementById('clickSnd').play().catch(()=>{}); }));
  // tools
  document.getElementById('cipherBtn').addEventListener('click', ()=> openCipherModal(null));
  document.getElementById('cipherTryBtn').addEventListener('click', tryCipher);
  document.getElementById('cipherCloseBtn').addEventListener('click', ()=> byId('cipherModal').style.display='none');
  document.getElementById('puzzleBtn').addEventListener('click', openPuzzleModal);
  document.getElementById('puzzleClose').addEventListener('click', ()=> byId('puzzleModal').style.display='none');
  document.getElementById('matchBtn').addEventListener('click', ()=> openMatchModal(null));
  document.getElementById('matchCloseBtn').addEventListener('click', ()=> byId('matchModal').style.display='none');

  // timeline
  document.getElementById('addTimeline').addEventListener('click', ()=> {
    const v = byId('timelineInput').value.trim(); if(!v) return; state.timeline.push({ text:v, time:new Date().toISOString() }); byId('timelineInput').value=''; renderTimeline(); saveState('autosave'); renderStats();
  });

  // phone
  bindPhone();

  // interrogation
  document.getElementById('interrogateBtn').addEventListener('click', ()=> { openInterrogation(); populateInterrogateSelect(); });
  document.getElementById('interrogateStart').addEventListener('click', startInterrogation);
  document.getElementById('chatSend').addEventListener('click', handleChatAsk);
  document.getElementById('chatClose').addEventListener('click', ()=> byId('interrogateModal').style.display='none');

  // endings
  document.getElementById('endingsBtn').addEventListener('click', ()=> {
    const list = byId('endingsList'); list.innerHTML='';
    ENDINGS.forEach(e=>{
      const card = document.createElement('div'); card.className='ending-card'; card.style.padding='10px';
      const unlocked = e.cond(state);
      card.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong>${escapeHtml(e.title)}</strong><div style="color:${unlocked?'#9fff9f':'#cfcfcf'}">${unlocked? '–î–æ—Å—Ç—É–ø–Ω–∞':'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}</div></div><div style="color:var(--muted); margin-top:6px">${escapeHtml(e.desc)}</div>`;
      card.addEventListener('click', ()=> { if(unlocked) showEnding(e.id); else showToast('–≠—Ç–∞ –∫–æ–Ω—Ü–æ–≤–∫–∞ –µ—â—ë –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞'); });
      list.appendChild(card);
    });
    byId('endingsModal').style.display='flex';
  });
  document.getElementById('endingsClose').addEventListener('click', ()=> byId('endingsModal').style.display='none');

  // ritual
  document.getElementById('ritualBtn').addEventListener('click', performRitual);

  // profiles
  document.getElementById('profilesBtn').addEventListener('click', ()=> { renderProfilesModal(); byId('profilesModal').style.display='flex'; });
  document.getElementById('closeProfiles').addEventListener('click', ()=> byId('profilesModal').style.display='none');

  // phone open
  document.getElementById('phoneOpenBtn').addEventListener('click', ()=> { const inp = prompt('–û—Ç–∫—Ä—ã—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω? (ok)'); if(inp!==null) showToast('–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–∫—Ä—ã—Ç'); });

  // find killer & accuse
  document.getElementById('findKiller').addEventListener('click', tryFindKiller);
  // bind accuse select population and accuse button
  populateAccuse();
  document.getElementById('accuseBtn') && document.getElementById('accuseBtn').addEventListener('click', accuseSelected);

  // save notes
  document.getElementById('saveNotes').addEventListener('click', ()=> { localStorage.setItem('rose_notes', byId('notebook').value||''); showToast('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'); });
  document.getElementById('clearNotes').addEventListener('click', ()=> { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏?')) { byId('notebook').value=''; localStorage.removeItem('rose_notes'); } });

  // audio toggles
  document.getElementById('audioToggle').addEventListener('click', ()=> {
    state.audioOn = !state.audioOn; document.getElementById('audioState').innerText = state.audioOn? '–≤–∫–ª':'–≤—ã–∫–ª'; document.getElementById('audioToggle').innerText = state.audioOn ? '–ó–≤—É–∫: –≤–∫–ª' : '–ó–≤—É–∫: –≤—ã–∫–ª';
    if(state.audioOn){ const bg = document.getElementById('bgMusic'); const amb = document.getElementById('ambience'); if(document.getElementById('toggleMusic').checked){ bg.volume = 0.12; bg.play().catch(()=>{}); } amb.volume = 0.18; amb.play().catch(()=>{}); } else { document.getElementById('bgMusic').pause(); document.getElementById('ambience').pause(); }
  });

  // settings toggles
  document.getElementById('toggleMusic').addEventListener('change', e=> { if(e.target.checked && state.audioOn) document.getElementById('bgMusic').play().catch(()=>{}); else document.getElementById('bgMusic').pause(); });
  document.getElementById('toggleAmbience').addEventListener('change', e=> { if(e.target.checked && state.audioOn) document.getElementById('ambience').play().catch(()=>{}); else document.getElementById('ambience').pause(); });
  document.getElementById('toggleDetectiveVoice').addEventListener('change', e=> { state.detectiveVoice = e.target.checked; });

  // start/close modals
  document.getElementById('endingClose').addEventListener('click', ()=> byId('endingRevealModal').style.display='none');
  document.getElementById('cipherCloseBtn').addEventListener('click', ()=> byId('cipherModal').style.display='none');
});

/* ---------- Additional Utilities ---------- */
function populateAccuse(){ const sel = byId('accuseSelect'); if(!sel) return; sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>'; state.suspects.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); }); }

/* ---------- Room inspection ---------- */
function inspectRoom(room){
  const found = state.clues.filter(c=> c.room === room);
  if(found.length === 0){ showToast('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ.'); return; }
  // reveal simple un-locked clues
  found.forEach(c=> {
    if(!c.locked){ state.opened[c.id] = true; }
    else {
      // give hint on tooltip (left as text update)
      const el = document.getElementById(c.id);
      if(el) el.querySelector('p').textContent = '–ù–∞–π–¥–µ–Ω–∞, –Ω–æ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç';
    }
  });
  renderClues(); renderStats(); updateHint(); showToast(`–û—Å–º–æ—Ç—Ä ${room}: –Ω–∞–π–¥–µ–Ω–æ ${found.length} —É–ª–∏–∫`);
}

/* ---------- Touch long-press for mobile drag (basic) ---------- */
function addTouchDragSupport(el){
  let timer = null; let clueId = el.dataset && el.dataset.clue;
  el.addEventListener('touchstart', (ev)=>{ timer = setTimeout(()=> { el.style.opacity=0.6; document.body.dataset.draggingClue = clueId; showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å —É–ª–∏–∫—É'); }, 500); }, {passive:true});
  el.addEventListener('touchend', ()=> { clearTimeout(timer); setTimeout(()=>{ el.style.opacity=''; document.body.dataset.draggingClue = ''; }, 100); });
}
function linkEvidence(suspectId, clueId){
  if(!state.links[suspectId]) state.links[suspectId]=[];
  if(state.links[suspectId].includes(clueId)){ showToast('–£–ª–∏–∫–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞'); return; }
  state.links[suspectId].push(clueId);
  showToast('–£–ª–∏–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞');
  renderAll(); saveState('autosave');
}

/* ---------- Simple initial load ---------- */
function updateProgress(){ const opened = Object.keys(state.opened).length + Object.values(state.links).flat().length; const total = state.clues.length + 2; const pct = Math.min(100, Math.round((opened/total)*100)); byId('progressPct').innerText = pct + '%'; }
function renderProfilesModal(){ /* already defined above */ } // noop if function exists

// expose some functions for debug/testing
window.openCipherModal = openCipherModal;
window.openInterrogation = openInterrogation;
window.openMatchModal = openMatchModal;
window.performRitual = performRitual;

LOG('Script loaded ‚Äî menu awaits start.');
</script>
</body>
</html>
