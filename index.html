<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–†–æ—É–∑–≤—É–¥ ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#040406; --bg-2:#0b0b0d;
  --panel:#121212; --accent:#b04e3a; --muted:#bfb7ae;
  --glass: rgba(255,255,255,0.03); --radius:12px; --danger:#9b2b2b;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#efe7df;-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
.logo{width:48px;height:48px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(180deg,#2b1f18,#191010);font-family:Cinzel,serif}
.app{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:320px 1fr 360px;gap:16px;padding:12px}
@media(max-width:1100px){.app{grid-template-columns:1fr}}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.008));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
.small{color:var(--muted);font-size:0.95rem}
.suspect{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;margin-top:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);cursor:pointer}
.avatar{width:64px;height:64px;border-radius:10px;object-fit:cover;background:#1b1412}
.smeta{flex:1}
.map{border-radius:10px;overflow:hidden;background:linear-gradient(180deg,#1b1411,#0f0f0f);padding:10px;min-height:500px}
.map-canvas{position:relative;height:360px;border-radius:8px;overflow:hidden;background:linear-gradient(180deg,#231815,#0f0d0d)}
.hotspot{position:absolute;transform:translate(-50%,-50%);background:linear-gradient(180deg, rgba(176,138,92,0.12), rgba(176,138,92,0.06));padding:8px 12px;border-radius:999px;cursor:pointer;border:1px solid rgba(176,138,92,0.08)}
.clues{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:12px}
.clue{display:flex;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
.thumb{width:56px;height:56px;border-radius:8px;background:#201612;display:grid;place-items:center}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85));z-index:9999}
.card{width:760px;max-width:94%;background:linear-gradient(180deg,#121212,#0f0f0f);padding:18px;border-radius:12px}
.menu-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at center, rgba(0,0,0,0.6), rgba(0,0,0,0.95));z-index:99999}
.menu-card{width:900px;max-width:96%;display:flex;gap:16px;background:linear-gradient(180deg,#0f0f0f,#080808);padding:20px;border-radius:12px}
.blood-overlay{position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 20% 30%, rgba(180,20,20,0.22) 0 6%, transparent 12%),radial-gradient(circle at 70% 50%, rgba(120,10,10,0.16) 0 8%, transparent 14%);mix-blend-mode:multiply;opacity:0;transition:opacity .5s}
.blood-overlay.on{opacity:1}
.coin{background:linear-gradient(90deg,#ffd166,#ffb703);color:#222;padding:6px 10px;border-radius:8px;font-weight:800}
.debug{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.6);padding:8px;border-radius:8px;color:#cfcfcf;font-family:monospace;font-size:12px;z-index:99999}
</style>
</head>
<body>

<!-- cinematic menu -->
<div id="menuScreen" class="menu-screen" role="dialog" aria-modal="true">
  <div class="menu-card">
    <div style="flex:0 0 420px;border-right:1px solid rgba(255,255,255,0.02);padding-right:12px">
      <h1 style="font-family:Cinzel,serif;margin:0;color:#f3e6dc">–†–æ—É–∑–≤—É–¥ ‚Äî –¢–µ–º–Ω–∞—è –ø—Ä–∞–≤–¥–∞</h1>
      <p class="small" style="margin-top:8px">–Ø –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–ª –∏–≥—Ä—É: —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚Äî —É–ª–∏–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã, –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–≥–∏—Ä—É—é—Ç, –∑–≤—É–∫ –∏ –≥–æ–ª–æ—Å –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–ù–∞—á–∞—Ç—å".</p>
      <div style="margin-top:16px;display:flex;gap:8px">
        <button id="startBtn" class="btn">–ù–∞—á–∞—Ç—å</button>
        <button id="soundBtn" class="btn secondary">–†–∞–∑—Ä–µ—à–∏—Ç—å –∑–≤—É–∫</button>
        <button id="loadBtn" class="btn secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤</button>
      </div>
      <p class="small" style="margin-top:12px;color:var(--muted)">–ï—Å–ª–∏ –∑–≤—É–∫ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å –∑–≤—É–∫", –∑–∞—Ç–µ–º "–ù–∞—á–∞—Ç—å".</p>
    </div>
    <div style="flex:1;padding-left:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–º–∞—Å—Ç–µ—Ä–∞</strong></div>
        <div class="coin" id="menuCoins">0</div>
      </div>
      <ul style="margin-top:12px;color:var(--muted)">
        <li>–†–µ–∞–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ‚Äî —É–ª–∏–∫–∏ –∫–ª–∏–∫–∞—é—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ</li>
        <li>–û–∑–≤—É—á–∫–∞ —á–µ—Ä–µ–∑ Web Speech –∏ —Å—ç–º–ø–ª—ã (–≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞)</li>
        <li>–ê—Ç–∞–∫–∏ —Å —Ç–∞–π–º–µ—Ä–æ–º 10—Å, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è, –î–ù–ö, –∫—Ä–æ–≤—å</li>
      </ul>
    </div>
  </div>
</div>

<header class="header" role="banner">
  <div style="display:flex;gap:12px;align-items:center">
    <div class="logo">–†</div>
    <div>
      <div style="font-family:Cinzel,serif">–†–æ—É–∑–≤—É–¥ ‚Äî –¢–µ–º–Ω–∞—è –ø—Ä–∞–≤–¥–∞</div>
      <div class="small">–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —É–ª–∏–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ ‚Äî —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç</div>
    </div>
  </div>
  <div style="display:flex;gap:12px;align-items:center">
    <div>–ú–æ–Ω–µ—Ç—ã: <span id="coinTop" class="coin">0</span></div>
    <div>–ó–¥–æ—Ä–æ–≤—å–µ: <progress id="healthBar" max="100" value="100" style="width:140px"></progress></div>
    <button id="menuToggle" class="btn secondary">–ú–µ–Ω—é</button>
  </div>
</header>

<div class="app" role="main" aria-live="polite">
  <aside class="panel" aria-label="–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong style="font-family:Cinzel,serif">–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ</strong>
      <button id="profilesBtn" class="btn secondary">–ü—Ä–æ—Ñ–∏–ª–∏</button>
    </div>
    <div id="suspectsList" style="margin-top:12px;max-height:360px;overflow:auto"></div>

    <div style="margin-top:12px">
      <strong>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</strong>
      <div class="small" style="margin-top:6px;color:var(--muted)">–î–ù–ö –∏ –∫—Ä–æ–≤—å ‚Äî —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="dnaBtn" class="btn">–î–ù–ö</button>
        <button id="bloodBtn" class="btn secondary">–ö—Ä–æ–≤—å</button>
        <button id="fpBtn" class="btn secondary">–û—Ç–ø–µ—á–∞—Ç–∫–∏</button>
      </div>
    </div>
  </aside>

  <main class="panel" aria-label="–ö–∞—Ä—Ç–∞ –∏ —É–ª–∏–∫–∏">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-family:Cinzel,serif">–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="accuseBtn" class="btn">–û–±–≤–∏–Ω–∏—Ç—å</button>
        <button id="interrogateBtn" class="btn secondary">–î–æ–ø—Ä–æ—Å</button>
        <button id="phoneBtn" class="btn secondary">–¢–µ–ª–µ—Ñ–æ–Ω</button>
      </div>
    </div>

    <div class="map" style="margin-top:12px">
      <div class="map-canvas" id="mapCanvas">
        <div class="hotspot" data-room="library" style="left:14%;top:20%">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div class="hotspot" data-room="hall" style="left:40%;top:16%">üö™ –ö–æ—Ä–∏–¥–æ—Ä</div>
        <div class="hotspot" data-room="office" style="left:72%;top:22%">üóÑ –ö–∞–±–∏–Ω–µ—Ç</div>
        <div class="hotspot" data-room="dining" style="left:30%;top:58%">üçΩ –°—Ç–æ–ª–æ–≤–∞—è</div>
        <div class="hotspot" data-room="garden" style="left:10%;top:82%">üåø –°–∞–¥</div>
        <div class="hotspot" data-room="basement" style="left:74%;top:76%">‚öôÔ∏è –ü–æ–¥–≤–∞–ª</div>
        <div class="hotspot" data-room="attic" style="left:58%;top:44%">üï∞ –ß–µ—Ä–¥–∞–∫</div>

        <div id="bloodOverlay" class="blood-overlay" aria-hidden="true"></div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <section style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>–£–ª–∏–∫–∏</strong>
            <div><span id="openedCount">0</span> / <span id="totalClues">0</span></div>
          </div>
          <div id="cluesGrid" class="clues"></div>
        </section>

        <aside style="width:320px">
          <div class="panel small">
            <strong>–¢–∞–π–º–ª–∞–π–Ω</strong>
            <div id="timeline" style="margin-top:8px;min-height:100px;color:var(--muted)"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="timelineInput" placeholder="22:44 ‚Äî –∑–≤—É–∫" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6;border:1px solid rgba(255,255,255,0.03)">
              <button id="timelineAdd" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div style="margin-top:12px" class="panel small">
            <strong>–ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã</strong>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <button id="memGame" class="btn">–ü–∞—Ä—ã (+10)</button>
              <button id="spotGame" class="btn secondary">–†–∞–∑–ª–∏—á–∏—è (+12)</button>
              <button id="imgPuzzle" class="btn secondary">–ü–∞–∑–ª (+15)</button>
            </div>
          </div>

          <div style="margin-top:12px" class="panel small">
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="callPartner" class="btn secondary">–ù–∞–ø–∞—Ä–Ω–∏–∫</button>
              <button id="callPolice" class="btn secondary">–ü–æ–ª–∏—Ü–∏—è</button>
            </div>
            <div id="phoneLog" style="margin-top:8px;color:var(--muted);max-height:80px;overflow:auto"></div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <aside class="panel right-panel">
    <div>
      <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
      <div class="small" style="margin-top:8px">–°–≤—è–∑–µ–π: <span id="linksCount">0</span></div>
      <div class="small" style="margin-top:8px">–†–∏—Ç—É–∞–ª: <span id="ritualState">–Ω–µ—Ç</span></div>
      <div class="small" style="margin-top:8px">–ú–æ–Ω–µ—Ç—ã: <span id="coinRight" class="coin">0</span></div>
    </div>

    <div style="margin-top:12px">
      <strong>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è / –î–ù–ö</strong>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="dnaInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ (–ø—Ä–∏–º–µ—Ä ER189)" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6;border:1px solid rgba(255,255,255,0.03)">
        <button id="dnaCheck" class="btn">–°–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div id="labLog" style="margin-top:8px;color:var(--muted)"></div>
    </div>

    <div style="margin-top:12px">
      <strong>–§–∏–Ω–∞–ª—ã</strong>
      <div style="margin-top:8px"><button id="showEndings" class="btn">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button></div>
    </div>
  </aside>
</div>

<!-- Modals (profiles, interrogation, cipher, mini-games, attack, endings) -->
<div id="profilesModal" class="modal"><div class="card small"><h3>–ü—Ä–æ—Ñ–∏–ª–∏</h3><div id="profilesContent" style="margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="closeProfiles" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="interrogateModal" class="modal"><div class="card"><h3>–î–æ–ø—Ä–æ—Å</h3><div class="small" style="margin-top:6px">–í—ã–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å</div><div style="display:flex;gap:8px;margin-top:12px"><select id="interrogateSelect" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6"></select><button id="startInterrogate" class="btn">–û—Ç–∫—Ä—ã—Ç—å</button></div><div id="chatBox" style="margin-top:12px;max-height:220px;overflow:auto"></div><div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" class="input" placeholder="–í–æ–ø—Ä–æ—Å"><button id="chatSend" class="btn">–°–ø—Ä–æ—Å–∏—Ç—å</button><button id="closeChat" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="cipherModal" class="modal"><div class="card small"><h3>–¶–µ–∑–∞—Ä—å</h3><div style="display:flex;gap:8px;margin-top:8px"><input id="caesarShift" type="number" min="1" max="25" value="3" style="padding:8px;border-radius:8px"><button id="caesarTry" class="btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button></div><textarea id="caesarOut" readonly style="margin-top:8px;width:100%;height:80px;background:#0b0b0b;color:#efece6;border-radius:8px;padding:8px"></textarea><div style="text-align:right;margin-top:8px"><button id="caesarClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="attackModal" class="modal"><div class="card small"><h3>–ù–∞–ø–∞–¥–µ–Ω–∏–µ!</h3><p class="small">–ù–∞ –≤–∞—Å –Ω–∞–ø–∞–ª–∏ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ. –í—Ä–µ–º—è: <span id="attackTimer">10</span>s</p><div style="display:flex;gap:8px"><button id="fightBtn" class="btn">–î—Ä–∞—Ç—å—Å—è</button><button id="runBtn" class="btn secondary">–£–±–µ–∂–∞—Ç—å</button><button id="itemBtn" class="btn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (-5)</button></div></div></div>

<div id="memoryModal" class="modal"><div class="card small"><h3>–ü–∞—Ä—ã</h3><p class="small">–ù–∞–π–¥–∏—Ç–µ –ø–∞—Ä—ã ‚Äî +10 –º–æ–Ω–µ—Ç</p><div id="memoryBoard" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="memoryClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="spotModal" class="modal"><div class="card small"><h3>–†–∞–∑–ª–∏—á–∏—è</h3><p class="small">–ù–∞–π–¥–∏—Ç–µ 3 –æ—Ç–ª–∏—á–∏—è ‚Äî +12 –º–æ–Ω–µ—Ç</p><img id="spotA" style="width:100%;height:120px;object-fit:cover;border-radius:6px" src="https://picsum.photos/seed/spotA/800/400"><img id="spotB" style="width:100%;height:120px;object-fit:cover;border-radius:6px;margin-top:8px" src="https://picsum.photos/seed/spotB/800/400"><div id="spotChoices" style="display:flex;gap:8px;margin-top:8px"></div><div style="text-align:right;margin-top:12px"><button id="spotClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="imgPuzzleModal" class="modal"><div class="card small"><h3>–ü–∞–∑–ª</h3><p class="small">–°–æ–±–µ—Ä–∏—Ç–µ 3x3 ‚Äî +15 –º–æ–Ω–µ—Ç</p><div id="imgPuzzleBoard" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="imgPuzzleClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingsModal" class="modal"><div class="card"><h3>–ö–æ–Ω—Ü–æ–≤–∫–∏</h3><div id="endingsList" style="margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="endingsClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingModal" class="modal"><div class="card small"><h3 id="endingTitle"></h3><div id="endingText" style="margin-top:8px;color:var(--muted)"></div><div style="text-align:right;margin-top:12px"><button id="endingClose" class="btn">OK</button></div></div></div>

<!-- audio assets -->
<audio id="bgMusic" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2022/04/09/audio_2839a1de58.mp3" type="audio/mpeg"></audio>
<audio id="ambience" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2021/08/04/audio_5f5a8f1f44.mp3" type="audio/mpeg"></audio>
<audio id="fxJump" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_5f5a8f1f44.mp3?filename=impact-6052.mp3" type="audio/mpeg"></audio>

<div class="debug" id="debugPanel">DEBUG:<div id="debugLog"></div></div>

<script>
/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è:
   - –ù–∞–¥—ë–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤: –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (.clue, .hotspot, .dropzone)
   - –í—Å–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ/—è–≤–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏; –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã id
   - –î–æ–±–∞–≤–ª–µ–Ω safePlay() –¥–ª—è –∞—É–¥–∏–æ (–≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∂–µ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è detectiveSpeak() (TTS) ‚Äî –¥–µ—Ç–µ–∫—Ç–∏–≤ "–≥–æ–≤–æ—Ä–∏—Ç" –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —É–ª–∏–∫—É –∏ –ø—Ä–∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∏—á–∏–Ω—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º "—É–ª–∏–∫–∏ –Ω–µ –Ω–∞–∂–∏–º–∞–ª–∏—Å—å" (–ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–π overlay, —Ä–∞–Ω–Ω—è—è –ø—Ä–∏–≤—è–∑–∫–∞): —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–µ—à–∞—é—Ç—Å—è –ø–æ—Å–ª–µ DOMContentLoaded –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∏–∫–∏
   - –õ—ë–≥–∫–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏, –º–∏–Ω–∏‚Äë–∏–≥—Ä –∏ –∞—Ç–∞–∫
*/

/* --- Utils --- */
const LOG = (...a)=>{ try{ document.getElementById('debugLog').textContent += '\\n' + a.join(' '); console.log(...a); }catch(e){ console.log(...a); } };
const $ = id => document.getElementById(id);
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function showToast(msg, t=1500){ const d=document.createElement('div'); d.textContent=msg; d.style.position='fixed'; d.style.left='50%'; d.style.bottom='20px'; d.style.transform='translateX(-50%)'; d.style.background='rgba(0,0,0,0.85)'; d.style.color='#fff'; d.style.padding='8px 12px'; d.style.borderRadius='8px'; d.style.zIndex=100000; document.body.appendChild(d); setTimeout(()=>{ d.style.transition='opacity .4s'; d.style.opacity=0; setTimeout(()=>d.remove(),420); }, t); }

/* --- Game model simplified --- */
let GAME = {
  suspects: [],
  clues: [],
  opened: {},
  links: {},
  timeline: [],
  coins: 20,
  health: 100,
  ritual: false
};

const DEFAULT_SUSPECTS = [
  { id:'adrian', name:'–≠–¥—Ä–∏–∞–Ω –†–æ—É–∑–≤—É–¥', role:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫', height:189, shoe:44, desc:'–•–æ–ª–æ–¥–Ω—ã–π' },
  { id:'beatrice', name:'–ë–µ–∞—Ç—Ä–∏—Å –•–µ–π–≤—É–¥', role:'–î–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞', height:165, shoe:37, desc:'–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è' },
  { id:'prof', name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ú–æ—Ä–¥–µ–Ω', role:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', height:178, shoe:42, desc:'–°–∏–º–≤–æ–ª–∏—Å—Ç' },
  { id:'victoria', name:'–í–∏–∫—Ç–æ—Ä–∏—è –†–æ—É–∑–≤—É–¥', role:'–ñ–µ–Ω–∞', height:172, shoe:39, desc:'–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞' },
  { id:'lina', name:'–õ–∏–Ω–∞ –ú–æ–Ω—Ç', role:'–ì–æ—Å—Ç—å—è', height:168, shoe:38, desc:'–ú–∏—Å—Ç–∏—á–µ—Å–∫–∞—è' }
];

const MASTER_CLUES = [
  { id:'c1', title:'–ó–∞–ø–∏—Å–∫–∞ (—à–∏—Ñ—Ä)', room:'office', type:'cipher', text:'Vkr ghqv wrfkh', locked:true },
  { id:'c2', title:'–°–ª–µ–¥—ã –æ–±—É–≤–∏', room:'garden', type:'foot', text:'–ü–æ–¥–æ—à–≤–∞: B7', locked:false },
  { id:'c3', title:'–õ–∏—Å—Ç —Å –Ω–∞–¥–ø–∏—Å—å—é', room:'library', type:'paper', text:'"...12/11..."', locked:false },
  { id:'c4', title:'–°–∏–º–≤–æ–ª –∫—Ä–æ–≤—å—é', room:'music', type:'symbol', text:'–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', locked:false },
  { id:'c5', title:'–§—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã', room:'basement', type:'puzzle', text:'–ü–ª–∞–Ω –ø–æ–¥–≤–∞–ª–∞', locked:true }
];

/* --- Audio / TTS helpers --- */
const AUDIO = {
  bg: $('bgMusic'),
  amb: $('ambience'),
  fx: $('fxJump')
};
function safePlay(el){
  if(!el) return Promise.reject('no audio');
  el.muted = false;
  el.volume = el.volume || 0.12;
  return el.play().catch(err => { LOG('audio play rejected', err); return Promise.reject(err); });
}
function detectiveSpeak(text){
  // also show a quick toast
  showToast(text, 1600);
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices();
  if(voices && voices.length) u.voice = voices[0];
  u.rate = 1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* --- Initialization --- */
document.addEventListener('DOMContentLoaded', ()=> {
  LOG('DOM loaded ‚Äî binding handlers');
  setupGame();
  bindUI();
  // prompt autosave presence (menu remains visible until user Start)
});

/* --- Setup game data --- */
function setupGame(){
  GAME.suspects = JSON.parse(JSON.stringify(DEFAULT_SUSPECTS));
  GAME.clues = JSON.parse(JSON.stringify(MASTER_CLUES));
  GAME.opened = {}; GAME.links = {};
  GAME.suspects.forEach(s => GAME.links[s.id] = []);
  renderAll();
}

/* --- Render helpers --- */
function renderAll(){
  renderSuspects();
  renderClues();
  renderTimeline();
  renderStats();
  populateInterrogateSelect();
}
function renderSuspects(){
  const el = $('suspectsList'); el.innerHTML = '';
  GAME.suspects.forEach((s,i)=>{
    const div = document.createElement('div'); div.className='suspect'; div.dataset.suspect = s.id;
    const avatar = `<div class="avatar">${escapeHtml(s.name[0])}</div>`;
    const linked = GAME.links[s.id].length;
    div.innerHTML = `${avatar}<div class="smeta"><div class="sname">${escapeHtml(s.name)}</div><div class="meta-row">${escapeHtml(s.role)}</div><div style="margin-top:6px;color:var(--muted)">${escapeHtml(s.desc)}</div></div><div style="padding-left:8px">${linked}</div>`;
    el.appendChild(div);
    div.addEventListener('click', ()=> { openProfile(s); });
  });
}
function renderClues(){
  const grid = $('cluesGrid'); grid.innerHTML = '';
  GAME.clues.forEach(c=>{
    const opened = !!GAME.opened[c.id];
    const item = document.createElement('div'); item.className='clue'; item.dataset.clue = c.id;
    item.innerHTML = `<div class="thumb">${getIcon(c.type)}</div><div><h4>${escapeHtml(c.title)}</h4><p>${opened ? escapeHtml(c.text) : (c.locked ? '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ / —Å–∫—Ä—ã—Ç–∞' : escapeHtml(c.text))}</p></div>`;
    grid.appendChild(item);
  });
  $('totalClues').textContent = GAME.clues.length;
  $('openedCount').textContent = Object.keys(GAME.opened).length;
}
function renderTimeline(){
  const el = $('timeline');
  if(GAME.timeline.length === 0){ el.innerHTML = '<div class="small" style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  el.innerHTML = GAME.timeline.slice().reverse().map(t=> `<div style="margin-bottom:6px">${escapeHtml(t.text)} <span style="color:var(--muted);font-size:0.82rem">(${new Date(t.time).toLocaleTimeString()})</span></div>`).join('');
}
function renderStats(){
  $('linksCount').textContent = Object.values(GAME.links).flat().length;
  $('coinTop').textContent = GAME.coins;
  $('coinRight').textContent = GAME.coins;
  $('healthBar').value = GAME.health;
  $('ritualState').textContent = GAME.ritual ? '–¥–∞' : '–Ω–µ—Ç';
}

/* --- Event binding (robust) --- */
function bindUI(){
  // Menu
  document.querySelector('#startBtn').addEventListener('click', ()=> {
    $('menuScreen').style.display = 'none';
    // start audio on user gesture
    safePlay(AUDIO.amb).catch(()=>{});
    safePlay(AUDIO.bg).catch(()=>{});
    detectiveSpeak('–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ');
  });
  document.querySelector('#soundBtn').addEventListener('click', ()=> {
    safePlay(AUDIO.bg).catch(()=>{});
    safePlay(AUDIO.amb).catch(()=>{});
    showToast('–ü–æ–ø—ã—Ç–∫–∞ –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫');
  });
  document.querySelector('#loadBtn').addEventListener('click', ()=> {
    const s = localStorage.getItem('rose_autosave');
    if(s && confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤?')){ try{ GAME = JSON.parse(s); renderAll(); $('menuScreen').style.display='none'; showToast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ'); }catch(e){ showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); } } else showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –Ω–µ—Ç');
  });
  document.querySelector('#menuToggle').addEventListener('click', ()=> $('menuScreen').style.display = 'flex');

  // Delegated clicks for clues and hotspots and dropzones
  document.addEventListener('click', (e) => {
    const clueEl = e.target.closest('.clue');
    if(clueEl){
      const id = clueEl.dataset.clue;
      onClueClick(id);
      return;
    }
    const hotspot = e.target.closest('.hotspot');
    if(hotspot){
      const room = hotspot.dataset.room;
      inspectRoom(room);
      return;
    }
    const dropzone = e.target.closest('.dropzone');
    if(dropzone && document.body.dataset.draggingClue){
      const suspectId = dropzone.dataset.suspect;
      const clueId = document.body.dataset.draggingClue;
      linkEvidence(suspectId, clueId);
      document.body.dataset.draggingClue='';
      return;
    }
    // specific buttons
    if(e.target.id === 'timelineAdd'){
      const v = $('timelineInput').value.trim(); if(!v) return;
      GAME.timeline.push({ text:v, time:new Date().toISOString() }); $('timelineInput').value=''; renderTimeline(); saveGame(); showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–∞–π–º–ª–∞–π–Ω');
    }
    if(e.target.id === 'memGame'){ openMemory(); }
    if(e.target.id === 'spotGame'){ openSpot(); }
    if(e.target.id === 'imgPuzzle'){ openImgPuzzle(); }
    if(e.target.id === 'profilesBtn'){ renderProfilesModal(); $('profilesModal').style.display='flex'; }
    if(e.target.id === 'closeProfiles'){ $('profilesModal').style.display='none'; }
    if(e.target.id === 'interrogateBtn'){ $('interrogateModal').style.display='flex'; populateInterrogateSelect(); }
    if(e.target.id === 'accuseBtn'){ attemptAccuse(); }
    if(e.target.id === 'dnaCheck'){ dnaCheck(); }
    if(e.target.id === 'callPartner'){ phoneCall('partner'); }
    if(e.target.id === 'callPolice'){ phoneCall('police'); }
    if(e.target.id === 'showEndings'){ renderEndings(); $('endingsModal').style.display='flex'; }
    if(e.target.id === 'endingsClose'){ $('endingsModal').style.display='none'; }
    if(e.target.id === 'endingClose'){ $('endingModal').style.display='none'; }
  });

  // dragstart for clues: set data attribute for mobile fallback
  document.addEventListener('dragstart', (e) => {
    const el = e.target.closest('.clue');
    if(el) e.dataTransfer.setData('text/plain', el.dataset.clue);
  });

  // Allow drag->drop to suspect dropzones (they are created with suspect cards)
  document.addEventListener('dragover', (e)=> e.preventDefault());
  document.addEventListener('drop', (e)=> {
    const suspectEl = e.target.closest('.suspect');
    if(!suspectEl) return;
    const clueId = e.dataTransfer.getData('text/plain');
    if(!clueId) return;
    const suspectId = suspectEl.dataset.suspect;
    linkEvidence(suspectId, clueId);
  });

  // mini-game specific close buttons
  const mc = $('memoryClose'); if(mc) mc.addEventListener('click', ()=> $('memoryModal').style.display='none');
  const sc = $('spotClose'); if(sc) sc.addEventListener('click', ()=> $('spotModal').style.display='none');
  const ipc = $('imgPuzzleClose'); if(ipc) ipc.addEventListener('click', ()=> $('imgPuzzleModal').style.display='none');

  // attack modal options
  $('fightBtn').addEventListener('click', ()=> resolveAttack('fight'));
  $('runBtn').addEventListener('click', ()=> resolveAttack('run'));
  $('itemBtn').addEventListener('click', ()=> { if(GAME.coins>=5){ GAME.coins -=5; renderStats(); resolveAttack('use'); } else showToast('–ù–µ—Ç –º–æ–Ω–µ—Ç'); });

  // cipher modal handlers
  $('caesarTry').addEventListener('click', ()=> {
    const shift = Number($('caesarShift').value) || 0;
    const target = GAME.clues.find(c=> c.locked && c.type === 'cipher') || GAME.clues[0];
    if(!target){ showToast('–ù–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–æ–∫'); return; }
    const dec = caesarDecode(target.text, shift); $('caesarOut').value = dec;
    if(/–æ–Ω –∑–Ω–∞–µ—Ç|–≤\./i.test(dec) || shift === 3){ target.locked = false; GAME.opened[target.id] = true; renderClues(); renderStats(); $('cipherModal').style.display='none'; saveGame(); showToast('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞'); detectiveSpeak('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞'); }
  });
  $('caesarClose').addEventListener('click', ()=> $('cipherModal').style.display='none');

  // interrogation chat
  $('startInterrogate').addEventListener('click', ()=> {
    const id = $('interrogateSelect').value; if(!id) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'); return; }
    addChat('ai', '–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç: ' + GAME.suspects.find(s=>s.id===id).name); detectiveSpeak('–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç');
  });
  $('chatSend').addEventListener('click', ()=> {
    const q = $('chatInput').value.trim(); if(!q) return; addChat('user', q); $('chatInput').value=''; const id = $('interrogateSelect').value;
    setTimeout(()=> { const r = aiReply(q, id); addChat('ai', r); detectiveSpeak(r); }, 600);
  });
  $('closeChat').addEventListener('click', ()=> $('interrogateModal').style.display='none');

  LOG('UI bound (delegated handlers)');
}

/* --- On clue click (robust) --- */
function onClueClick(id){
  const clue = GAME.clues.find(c=>c.id===id);
  if(!clue){ showToast('–£–ª–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); LOG('clue not found', id); return; }
  if(clue.locked && !GAME.opened[clue.id]){
    // open cipher/puzzle modals depending on type
    if(clue.type === 'cipher'){ $('cipherModal').style.display='flex'; $('caesarOut').value = ''; detectiveSpeak('–ó–∞–ø–∏—Å–∫–∞ —Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏'); }
    else if(clue.type === 'puzzle'){ $('imgPuzzleModal').style.display='flex'; detectiveSpeak('–ü–æ—Ö–æ–∂–µ, –Ω—É–∂–µ–Ω –ø–∞–∑–ª'); }
    else { showToast('–≠—Ç–∞ —É–ª–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞.'); }
    return;
  }
  // open or reveal
  if(!GAME.opened[clue.id]){ GAME.opened[clue.id] = true; renderClues(); renderStats(); detectiveSpeak('–í—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ ' + clue.title); saveGame(); return; }
  // show details
  $('endingTitle').innerText = clue.title;
  $('endingText').innerHTML = `<div style="color:var(--muted)">${escapeHtml(clue.text)}</div>`;
  $('endingModal').style.display = 'flex';
  detectiveSpeak('–î–µ—Ç–µ–∫—Ç–∏–≤ —á–∏—Ç–∞–µ—Ç —É–ª–∏–∫—É: ' + clue.title);
}

/* --- Link evidence to suspect --- */
function linkEvidence(suspectId, clueId){
  if(!GAME.links[suspectId]) GAME.links[suspectId] = [];
  if(GAME.links[suspectId].includes(clueId)){ showToast('–£–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ'); return; }
  GAME.links[suspectId].push(clueId);
  showToast('–£–ª–∏–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞');
  saveGame(); renderStats();
}

/* --- Inspect room (reveal clues) --- */
function inspectRoom(room){
  const found = GAME.clues.filter(c=> c.room === room);
  if(found.length === 0){ showToast('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  found.forEach(c=> {
    if(!c.locked) GAME.opened[c.id] = true;
  });
  renderAll();
  showToast(`–ù–∞–π–¥–µ–Ω–æ ${found.length} —É–ª–∏–∫(–∏) –≤ ${room}`);
  // random attack chance
  if(Math.random() < 0.18) triggerAttack();
  saveGame();
}

/* --- Mini-games implementations (same as earlier but compact) --- */
let memoryState=null;
function openMemory(){
  $('memoryModal').style.display='flex';
  const b = $('memoryBoard'); b.innerHTML='';
  const imgs = []; for(let i=0;i<8;i++) imgs.push('https://picsum.photos/seed/mem'+i+'/200/200');
  const arr = imgs.concat(imgs).sort(()=>Math.random()-0.5);
  memoryState = { first:null, second:null, matched:0, board:b };
  arr.forEach(src=>{
    const card = document.createElement('div'); card.style.height='80px'; card.style.background='#131212'; card.style.borderRadius='6px'; card.style.cursor='pointer'; card.dataset.src = src;
    card.addEventListener('click', ()=> {
      if(card.classList.contains('matched')) return;
      card.style.backgroundImage = `url(${card.dataset.src})`; card.style.backgroundSize='cover';
      if(!memoryState.first){ memoryState.first = card; return; }
      memoryState.second = card;
      if(memoryState.first.dataset.src === memoryState.second.dataset.src){
        memoryState.first.classList.add('matched'); memoryState.second.classList.add('matched'); memoryState.matched += 2; memoryState.first = null; memoryState.second = null;
        if(memoryState.matched === memoryState.board.children.length){ GAME.coins += 10; renderStats(); saveGame(); showToast('+10 –º–æ–Ω–µ—Ç'); $('memoryModal').style.display='none'; }
      } else {
        setTimeout(()=> { memoryState.first.style.backgroundImage=''; memoryState.second.style.backgroundImage=''; memoryState.first=null; memoryState.second=null; }, 700);
      }
    });
    b.appendChild(card);
  });
}

function openSpot(){
  $('spotModal').style.display='flex';
  const choices = $('spotChoices'); choices.innerHTML=''; let rem=3;
  for(let i=0;i<3;i++){
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='–û—Ç–º–µ—Ç–∏—Ç—å';
    btn.addEventListener('click', ()=> {
      if(confirm('–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç–ª–∏—á–∏–µ?')){ rem--; showToast('–û—Ç–ª–∏—á–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å: ' + rem); if(rem===0){ GAME.coins += 12; renderStats(); saveGame(); $('spotModal').style.display='none'; showToast('+12 –º–æ–Ω–µ—Ç'); } }
    });
    choices.appendChild(btn);
  }
}

function openImgPuzzle(){
  $('imgPuzzleModal').style.display='flex';
  const board = $('imgPuzzleBoard'); board.innerHTML='';
  const nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
  nums.forEach(n=>{
    const p = document.createElement('div'); p.style.height='80px'; p.style.background='#201612'; p.style.display='grid'; p.style.placeItems='center'; p.style.borderRadius='6px'; p.textContent = n===9 ? '' : n; p.dataset.num = n;
    p.addEventListener('click', ()=> {
      const empty = Array.from(board.children).find(c=>c.dataset.num=='9'); if(!empty) return;
      const idx = Array.from(board.children).indexOf(p), eidx = Array.from(board.children).indexOf(empty); const dist = Math.abs(idx-eidx);
      if(dist===1 || dist===3){ const t = p.dataset.num; p.dataset.num = empty.dataset.num; empty.dataset.num = t; const tmp = p.textContent; p.textContent = empty.textContent; empty.textContent = tmp;
        const order = Array.from(board.children).map(c=>Number(c.dataset.num)); if(order.every((v,i)=> v===i+1)){ GAME.coins += 15; renderStats(); saveGame(); $('imgPuzzleModal').style.display='none'; showToast('+15 –º–æ–Ω–µ—Ç'); }
      }
    });
    board.appendChild(p);
  });
}

/* --- Interrogation AI --- */
function populateInterrogateSelect(){
  const sel = $('interrogateSelect'); sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
  GAME.suspects.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; sel.appendChild(o); });
}
function addChat(who, text){
  const box = $('chatBox'); const d = document.createElement('div'); d.style.marginBottom='6px'; d.textContent = `${who === 'ai' ? '–°–≤–∏–¥–µ—Ç–µ–ª—å: ' : '–í—ã: '}${text}`; d.style.color = who==='ai' ? '#e6e6e6' : '#ffd166'; box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function aiReply(q, id){
  if(!id) return '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ';
  const s = GAME.suspects.find(x=>x.id===id);
  q = q.toLowerCase();
  if(q.includes('–≥–¥–µ')) return `${s.name}: –Ø –±—ã–ª –≤ –¥–æ–º–µ –≤–µ—á–µ—Ä–æ–º.`;
  if(q.includes('–∫—Ä–æ–≤')) return `${s.name}: –Ø –≤–∏–¥–µ–ª(–∞) –∫—Ä–æ–≤—å –≤ –∫–∞–±–∏–Ω–µ—Ç–µ.`;
  return `${s.name}: –Ø –Ω–µ –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–æ.`;
}

/* --- Cipher decode --- */
function caesarDecode(text, shift){ if(!text) return text; const a='abcdefghijklmnopqrstuvwxyz'; const A=a.toUpperCase(); return text.split('').map(ch=>{ if(a.includes(ch)) return a[(a.indexOf(ch)-shift+26)%26]; if(A.includes(ch)) return A[(A.indexOf(ch)-shift+26)%26]; return ch; }).join(''); }

/* --- Profiles modal --- */
function openProfile(s){ renderProfileDetail(s); $('profilesModal').style.display='flex'; }
function renderProfileDetail(s){
  $('profilesContent').innerHTML = `<strong>${escapeHtml(s.name)}</strong> ‚Äî <em>${escapeHtml(s.role)}</em><div style="margin-top:6px;color:var(--muted)">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe}</div><div style="margin-top:6px">${escapeHtml(s.desc)}</div><div style="margin-top:8px"><button class="btn" onclick="inspectSuspect('${s.id}')">–î–æ–ø—Ä–æ—Å–∏—Ç—å</button></div>`;
}
function inspectSuspect(id){ $('profilesModal').style.display='none'; $('interrogateModal').style.display='flex'; $('interrogateSelect').value = id; addChat('ai','–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç: ' + GAME.suspects.find(s=>s.id===id).name); detectiveSpeak('–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç'); }

/* --- Accuse / endings --- */
function attemptAccuse(){
  // simple heuristic: suspect with most linked clues
  const counts = GAME.suspects.map(s=>({id:s.id,name:s.name,c:GAME.links[s.id].length}));
  counts.sort((a,b)=>b.c-a.c);
  const top = counts[0];
  if(!top || top.c === 0){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤'); detectiveSpeak('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤'); return; }
  // decide ending
  const matched = ENDINGS.find(e => e.cond(GAME));
  if(matched){ showEnding(matched.id); } else { showToast('–ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ'); detectiveSpeak('–ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ'); }
}
function renderEndings(){
  const node = $('endingsList'); node.innerHTML = '';
  ENDINGS.forEach(e=>{
    const unlocked = e.cond(GAME);
    const div = document.createElement('div'); div.style.padding='8px'; div.style.marginBottom='8px'; div.style.border='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<strong>${escapeHtml(e.title)}</strong><div style="color:var(--muted);margin-top:6px">${escapeHtml(e.desc)}</div><div style="color:${unlocked? '#9fff9f':'#cfcfcf'};margin-top:6px">${unlocked? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}</div>`;
    div.addEventListener('click', ()=> { if(unlocked) showEnding(e.id); else showToast('–ó–∞–∫—Ä—ã—Ç–∞'); });
    node.appendChild(div);
  });
}
function showEnding(id){
  const e = ENDINGS.find(x=>x.id===id); if(!e) return; $('endingTitle').innerText = e.title; $('endingText').innerText = e.desc; $('endingModal').style.display='flex'; detectiveSpeak('–ö–æ–Ω—Ü–æ–≤–∫–∞: ' + e.title);
}

/* --- Save / load --- */
function saveGame(){ try{ localStorage.setItem('rose_autosave', JSON.stringify(GAME)); LOG('autosave saved'); }catch(e){ LOG('save err', e); } }
function loadGame(){ const s = localStorage.getItem('rose_autosave'); if(!s) return false; try{ GAME = JSON.parse(s); renderAll(); return true; }catch(e){ return false; } }

/* --- Helpers --- */
function getIcon(type){ switch(type){ case 'cipher': return '‚úâÔ∏è'; case 'puzzle': return 'üß©'; case 'symbol': return 'üî±'; case 'vial': return 'üß™'; case 'foot': return 'üë£'; default: return 'üîé'; } }

/* --- Setup initial content --- */
setupGame(); renderAll();

LOG('Fixes applied: –∫–ª–∏–∫–∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω—ã; —É–ª–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã; –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–∑–≤—É—á–∫–∞ –∏ –≥–æ–ª–æ—Å –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ (TTS).');
</script>
</body>
</html>
