<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–†–æ—É–∑–≤—É–¥ ‚Äî –¢–µ–º–Ω–∞—è –ø—Ä–∞–≤–¥–∞ (—Ä–µ–º–∞—Å—Ç–µ—Ä)</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=DM+Serif+Display&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-0:#040406;
  --bg-1:#0b0b0d;
  --panel:#121212;
  --accent:#b04e3a;
  --muted:#bfb7ae;
  --glass: rgba(255,255,255,0.03);
  --coin:#ffd166;
  --danger:#9b2b2b;
  --radius:14px;
  --shadow: 0 18px 60px rgba(0,0,0,0.7);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(1200px 600px at 10% 10%, rgba(176,138,92,0.03), transparent), linear-gradient(180deg,var(--bg-0),var(--bg-1)); color:#efe7df; -webkit-font-smoothing:antialiased;}
button{font-family:inherit}
.app{max-width:1280px;margin:18px auto;padding:12px;display:grid;grid-template-columns:320px 1fr 360px;gap:18px;align-items:start}
@media (max-width:1100px){ .app{grid-template-columns:1fr} }

/* Header / HUD */
.header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#2b1f18,#191010);display:grid;place-items:center;font-family:'Cinzel',serif;font-size:20px;color:#fff;border:1px solid rgba(255,255,255,0.03)}
.title{font-family:'Cinzel',serif;font-size:1.1rem}
.hud{display:flex;gap:12px;align-items:center}

/* Panels */
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.008));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.small{color:var(--muted);font-size:0.95rem}

/* Suspects */
.suspect{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;margin-top:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.avatar{width:64px;height:64px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.03);background:#1b1412}
.smeta{flex:1}
.sname{font-weight:700}
.meta-row{display:flex;gap:10px;margin-top:6px;font-size:0.9rem;color:var(--muted)}

/* Map */
.map{position:relative;border-radius:12px;overflow:hidden;padding:10px;min-height:480px;background:linear-gradient(180deg,#1b1411,#120f0f);box-shadow:inset 0 0 80px rgba(0,0,0,0.45)}
.map-canvas{position:relative;height:360px;border-radius:10px;overflow:hidden;background-image:linear-gradient(180deg,#231815,#0f0d0d);display:block}
.hotspot{position:absolute;transform:translate(-50%,-50%);background:linear-gradient(180deg, rgba(176,138,92,0.12), rgba(176,138,92,0.06));padding:8px 12px;border-radius:999px;font-weight:700;color:#120b06;cursor:pointer;border:1px solid rgba(176,138,92,0.08);box-shadow:0 12px 40px rgba(0,0,0,0.6);user-select:none;transition:transform .12s ease}
.hotspot:hover{transform:translate(-50%,-50%) scale(1.06)}

/* Clues */
.clues{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
.clue{display:flex;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.thumb{width:64px;height:64px;border-radius:8px;background:#201612;display:grid;place-items:center;color:#d9c8ae;font-size:20px}

/* Buttons / menus */
.controls{display:flex;gap:8px;align-items:center}
.menu-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at center, rgba(0,0,0,0.6), rgba(0,0,0,0.95));z-index:9999}
.menu-card{width:980px;max-width:96%;display:flex;gap:18px;background:linear-gradient(180deg,#0f0f0f,#080808);padding:24px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.9)}
.menu-left{flex:0 0 420px;border-right:1px solid rgba(255,255,255,0.02);padding-right:12px}
.menu-title{font-family:'Cinzel',serif;font-size:2rem;margin:0}
.menu-right{flex:1;padding-left:12px}

/* Attack / blood */
.blood-overlay{position:absolute;inset:0;pointer-events:none;background-image:radial-gradient(circle at 20% 30%, rgba(180,20,20,0.22) 0 6%, transparent 12%), radial-gradient(circle at 70% 50%, rgba(120,10,10,0.16) 0 8%, transparent 14%);mix-blend-mode:multiply;opacity:0;transition:opacity .6s}
.blood-overlay.on{opacity:1}

/* Modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.85))}
.card{width:760px;max-width:94%;background:linear-gradient(180deg,#121212,#0f0f0f);padding:18px;border-radius:12px}
.small-card{width:520px;max-width:94%}

/* HUD small styles */
.coin{background:linear-gradient(90deg,#ffd166,#ffb703);color:#222;padding:6px 10px;border-radius:8px;font-weight:800}

/* Animations */
.flicker{animation:flicker 1.1s infinite}
@keyframes flicker{0%{filter:brightness(0.96)}25%{filter:brightness(1.06)}50%{filter:brightness(0.94)}75%{filter:brightness(1.03)}100%{filter:brightness(0.97)}}

/* debug */
#debugLog{font-family:monospace;font-size:12px;color:#cfcfcf;white-space:pre-wrap}
</style>
</head>
<body>

<!-- Cinematic Menu -->
<div id="menuScreen" class="menu-screen" role="dialog" aria-modal="true">
  <div class="menu-card">
    <div class="menu-left">
      <h1 class="menu-title">–†–æ—É–∑–≤—É–¥ ‚Äî –¢–µ–º–Ω–∞—è –ø—Ä–∞–≤–¥–∞</h1>
      <p class="small">–ü–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è –∏ –æ–∂–∏–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: –º—Ä–∞—á–Ω–µ–µ, –≥–ª—É–±–∂–µ, —Å –≥–æ–ª–æ—Å–∞–º–∏ –∏ –Ω–æ–≤—ã–º–∏ –º–∏–Ω–∏‚Äë–∏–≥—Ä–∞–º–∏. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å", —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –∑–≤—É–∫ –∏ –Ω–∞—á–∞—Ç—å —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ.</p>
      <div style="margin-top:16px;display:flex;gap:8px">
        <button id="startBtn" class="btn">–ù–∞—á–∞—Ç—å —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</button>
        <button id="soundBtn" class="btn secondary">–†–∞–∑—Ä–µ—à–∏—Ç—å –∑–≤—É–∫</button>
        <button id="continueBtn" class="btn secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤</button>
      </div>
      <p class="small" style="margin-top:12px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –æ—Å–º–æ—Ç—Ä, –∑–∞—Ç–µ–º ‚Äî –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∏ –¥–æ–ø—Ä–æ—Å—ã. –°–ª—É—Ö–∏, –∫—Ä–æ–≤—å –∏ —Ç–∞–π–Ω—ã –±—É–¥—É—Ç –º–µ–Ω—è—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π.</p>
    </div>
    <div class="menu-right">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>–ù–æ–≤—ã–µ —Ñ–∏—á–∏</strong></div>
        <div class="coin" id="menuCoins">0</div>
      </div>
      <ul style="margin-top:12px;color:var(--muted)">
        <li>–ü–æ–ª–Ωo–µ –æ–∑–≤—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Web Speech + –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–µ —Å—ç–º–ø–ª—ã</li>
        <li>–î–æ–ø. –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (pairs, spot, image puzzle)</li>
        <li>–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã (–î–ù–ö, –∫—Ä–æ–≤—å, –æ—Ç–ø–µ—á–∞—Ç–∫–∏)</li>
        <li>–°–ª—É—á–∞–π–Ω—ã–µ –Ω–∞–ø–∞–¥–µ–Ω–∏—è ‚Äî —Ä–µ—à–µ–Ω–∏—è –∑–∞ 10 —Å–µ–∫—É–Ω–¥</li>
        <li>–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–Ω—Ü–æ–≤–æ–∫, –∑–∞–≤–∏—Å—è—â–∏—Ö –æ—Ç —É–ª–∏–∫ –∏ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π</li>
      </ul>
      <div style="margin-top:auto;text-align:right;color:var(--muted)"><small>–í–µ—Ä—Å–∏—è: Remaster 1.0 ‚Äî –∑–≤—É—á–∏—Ç –ª—É—á—à–µ, –ø–∞—Ö–Ω–µ—Ç —Å—Ç—Ä–∞—à–Ω–µ–µ</small></div>
    </div>
  </div>
</div>

<!-- Header -->
<header class="header">
  <div class="brand">
    <div class="logo">–†</div>
    <div>
      <div class="title">–†–æ—É–∑–≤—É–¥ ‚Äî –¢–µ–º–Ω–∞—è –ø—Ä–∞–≤–¥–∞</div>
      <div class="small">–†–µ–º–∞—Å—Ç–µ—Ä ‚Äî –º—Ä–∞—á–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–∏–≤ —Å –æ–∑–≤—É—á–∫–æ–π</div>
    </div>
  </div>
  <div class="hud">
    <div>–ú–æ–Ω–µ—Ç—ã: <span id="coinTop" class="coin">0</span></div>
    <div style="margin-left:12px">–ó–¥–æ—Ä–æ–≤—å–µ: <progress id="healthBar" value="100" max="100" style="width:140px"></progress></div>
    <div style="margin-left:12px"><button id="menuToggle" class="btn secondary">–ú–µ–Ω—é</button></div>
  </div>
</header>

<!-- App layout -->
<div class="app" role="application" aria-label="–ò–≥—Ä–∞ –†–æ—É–∑–≤—É–¥">
  <!-- Left: suspects, lab -->
  <aside class="panel" aria-label="–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ –∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong style="font-family:'Cinzel',serif">–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ</strong>
      <div class="controls"><button id="profilesBtn" class="btn secondary">–ü—Ä–æ—Ñ–∏–ª–∏</button></div>
    </div>
    <div id="suspectsList" style="margin-top:12px;max-height:360px;overflow:auto"></div>

    <div style="margin-top:12px">
      <strong>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</strong>
      <div class="small" style="margin-top:6px">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã: –î–ù–ö, –∫—Ä–æ–≤—å, –æ—Ç–ø–µ—á–∞—Ç–∫–∏, —Ç–æ–∫—Å–∏–∫–æ–ª–æ–≥–∏—é.</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="dnaBtn" class="btn">–°–≤–µ—Ä–∏—Ç—å –î–ù–ö</button>
        <button id="bloodBtn" class="btn secondary">–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏</button>
        <button id="fpBtn" class="btn secondary">–û—Ç–ø–µ—á–∞—Ç–∫–∏</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <strong>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</strong>
      <div id="inventory" class="small" style="margin-top:8px;color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
      <div style="margin-top:8px"><button id="useItem" class="btn secondary">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button></div>
    </div>
  </aside>

  <!-- Center: map & clues -->
  <main class="panel" aria-label="–ö–∞—Ä—Ç–∞ –∏ —É–ª–∏–∫–∏">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-family:'Cinzel',serif;font-size:1.05rem">–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="accuseBtn" class="btn">–û–±–≤–∏–Ω–∏—Ç—å</button>
        <button id="investigateBtn" class="btn secondary">–î–æ–ø—Ä–æ—Å</button>
        <button id="phoneBtn" class="btn secondary">–¢–µ–ª–µ—Ñ–æ–Ω</button>
      </div>
    </div>

    <div class="map" style="margin-top:12px">
      <div class="map-canvas" id="mapCanvas" aria-label="–ö–∞—Ä—Ç–∞">
        <div class="hotspot" data-room="library" style="left:14%;top:20%">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div class="hotspot" data-room="hall" style="left:40%;top:16%">üö™ –ö–æ—Ä–∏–¥–æ—Ä</div>
        <div class="hotspot" data-room="office" style="left:72%;top:22%">üóÑ –ö–∞–±–∏–Ω–µ—Ç</div>
        <div class="hotspot" data-room="dining" style="left:30%;top:58%">üçΩ –°—Ç–æ–ª–æ–≤–∞—è</div>
        <div class="hotspot" data-room="garden" style="left:10%;top:82%">üåø –°–∞–¥</div>
        <div class="hotspot" data-room="basement" style="left:74%;top:76%">‚öôÔ∏è –ü–æ–¥–≤–∞–ª</div>
        <div class="hotspot" data-room="attic" style="left:58%;top:44%">üï∞ –ß–µ—Ä–¥–∞–∫</div>

        <div id="bloodOverlay" class="blood-overlay" aria-hidden="true"></div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <section style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>–£–ª–∏–∫–∏</strong>
            <div><span id="openedCount">0</span> / <span id="totalClues">0</span></div>
          </div>
          <div id="cluesGrid" class="clues" style="margin-top:12px;max-height:260px;overflow:auto"></div>
        </section>

        <aside style="width:320px">
          <div class="panel small">
            <strong>–¢–∞–π–º–ª–∞–π–Ω</strong>
            <div id="timeline" style="margin-top:8px;min-height:100px;color:var(--muted)"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="timelineInput" placeholder="22:44 ‚Äî –∑–≤—É–∫" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6;border:1px solid rgba(255,255,255,0.03)">
              <button id="timelineAdd" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div style="margin-top:12px" class="panel small">
            <strong>–ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã</strong>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <button id="memGame" class="btn">–ü–∞—Ä–∞ ‚Äî –ø–∞–º—è—Ç—å (+10)</button>
              <button id="spotGame" class="btn secondary">–ù–∞–π–¥–∏ —Ä–∞–∑–ª–∏—á–∏—è (+12)</button>
              <button id="imgPuzzleGame" class="btn secondary">–ü–∞–∑–ª‚Äë–∫–∞—Ä—Ç–∏–Ω–∫–∞ (+15)</button>
            </div>
          </div>

          <div style="margin-top:12px" class="panel small">
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong>
            <div class="small" style="margin-top:6px;color:var(--muted)">–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–ø–∞—Ä–Ω–∏–∫—É –∏–ª–∏ –≤ –ø–æ–ª–∏—Ü–∏—é</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="callPartner" class="btn secondary">–ù–∞–ø–∞—Ä–Ω–∏–∫</button>
              <button id="callPolice" class="btn secondary">–ü–æ–ª–∏—Ü–∏—è</button>
            </div>
            <div id="phoneLog" style="margin-top:8px;color:var(--muted);max-height:80px;overflow:auto"></div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Right: stats, lab, dna -->
  <aside class="panel right-panel">
    <div>
      <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
      <div class="small" style="margin-top:8px">–°–≤—è–∑–µ–π: <span id="linksCount">0</span></div>
      <div class="small" style="margin-top:8px">–†–∏—Ç—É–∞–ª: <span id="ritual">–Ω–µ—Ç</span></div>
      <div class="small" style="margin-top:8px">–ú–æ–Ω–µ—Ç—ã: <span id="coinRight" class="coin">0</span></div>
    </div>

    <div style="margin-top:12px">
      <strong>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</strong>
      <div class="small" style="margin-top:8px">–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –¥–ª—è –î–ù–ö (–ø—Ä–∏–º–µ—Ä: ER189) –∏ —Å–≤–µ—Ä—è–π—Ç–µ —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏.</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="dnaInput" placeholder="DNA-" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6;border:1px solid rgba(255,255,255,0.03)">
        <button id="dnaCheck" class="btn">–°–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div id="labLog" style="margin-top:8px;color:var(--muted)"></div>
    </div>

    <div style="margin-top:12px">
      <strong>–ö–æ–Ω—Ü–æ–≤–∫–∏</strong>
      <div style="margin-top:8px;color:var(--muted)">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–∏–Ω–∞–ª—ã</div>
      <div style="margin-top:8px"><button id="showEndings" class="btn">–ö–æ–Ω—Ü–æ–≤–∫–∏</button></div>
    </div>
  </aside>
</div>

<!-- Modals & UI elements (memory, spot, puzzle, attack, profiles, interrogate, cipher, match, endings) -->
<div id="profilesModal" class="modal"><div class="card small"><h3>–ü—Ä–æ—Ñ–∏–ª–∏</h3><div id="profilesContent" style="margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="closeProfiles" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="interrogateModal" class="modal"><div class="card"><h3>–î–æ–ø—Ä–æ—Å ‚Äî –ù–µ–π—Ä–æ—Å–µ—Ç—å</h3><div style="margin-top:8px" class="small">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ –∏ –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã. –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (TTS).</div><div style="display:flex;gap:8px;margin-top:12px"><select id="interrogateSelect" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6"></select><button id="interrogateStart" class="btn">–ù–∞—á–∞—Ç—å</button></div><div class="chat" id="chatBox" style="margin-top:12px"></div><div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" class="input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å"><button id="chatSend" class="btn">–°–ø—Ä–æ—Å–∏—Ç—å</button><button id="chatClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="cipherModal" class="modal"><div class="card small"><h3>–¶–µ–∑–∞—Ä—å ‚Äî —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3><div style="display:flex;gap:8px;margin-top:8px"><input id="caesarShift" type="number" min="1" max="25" value="3" class="input" style="padding:8px;border-radius:8px"><button id="caesarTry" class="btn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button></div><textarea id="caesarOut" readonly style="margin-top:8px;width:100%;height:80px;background:#0b0b0b;color:#efece6;border-radius:8px;padding:8px"></textarea><div style="text-align:right;margin-top:8px"><button id="caesarClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="attackModal" class="modal"><div class="card small"><h3>–ù–∞–ø–∞–¥–µ–Ω–∏–µ!</h3><p class="small">–ù–∞ –≤–∞—Å –Ω–∞–ø–∞–ª –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ. <strong>–í—Ä–µ–º—è: <span id="attackTimer">10</span> —Å–µ–∫</strong></p><div style="display:flex;gap:8px"><button id="fightBtn" class="btn">–î—Ä–∞—Ç—å—Å—è</button><button id="runBtn" class="btn secondary">–£–±–µ–∂–∞—Ç—å</button><button id="useItemBtn" class="btn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç (-5)</button></div></div></div>

<div id="memoryModal" class="modal"><div class="card small"><h3>–ü–∞–º—è—Ç—å ‚Äî –ø–∞—Ä—ã</h3><p class="small">–ù–∞–π–¥–∏—Ç–µ –ø–∞—Ä—ã –∫–∞—Ä—Ç ‚Äî –Ω–∞–≥—Ä–∞–¥–∞ +10 –º–æ–Ω–µ—Ç</p><div id="memoryBoard" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="memoryClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="spotModal" class="modal"><div class="card small"><h3>–ù–∞–π–¥–∏ —Ä–∞–∑–ª–∏—á–∏–µ</h3><p class="small">–ù–∞–π–¥–∏—Ç–µ 3 —Ä–∞–∑–ª–∏—á–∏—è ‚Äî –Ω–∞–≥—Ä–∞–¥–∞ +12 –º–æ–Ω–µ—Ç</p><img id="spotA" class="minigame-img" src="https://picsum.photos/seed/spotA/800/400"><img id="spotB" class="minigame-img" src="https://picsum.photos/seed/spotB/800/400" style="margin-top:8px"><div id="spotChoices" style="display:flex;gap:8px;margin-top:8px"></div><div style="text-align:right;margin-top:12px"><button id="spotClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="imgPuzzleModal" class="modal"><div class="card small"><h3>–ü–∞–∑–ª‚Äë–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3><p class="small">–°–æ–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É 3x3 ‚Äî –Ω–∞–≥—Ä–∞–¥–∞ +15 –º–æ–Ω–µ—Ç</p><div id="imgPuzzleBoard" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="imgPuzzleClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingsModal" class="modal"><div class="card"><h3>–ö–æ–Ω—Ü–æ–≤–∫–∏</h3><div id="endingsList" style="margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="endingsClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingModal" class="modal"><div class="card small"><h3 id="endingTitle"></h3><div id="endingText" style="margin-top:8px;color:var(--muted)"></div><div style="text-align:right;margin-top:12px"><button id="endingClose" class="btn">OK</button></div></div></div>

<!-- Audio: atmosphere, whispers, jump, voice lines -->
<audio id="bgMusic" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2022/04/09/audio_2839a1de58.mp3" type="audio/mpeg"></audio>
<audio id="ambience" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2021/08/04/audio_5f5a8f1f44.mp3" type="audio/mpeg"></audio>
<audio id="whisper" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_5f5a8f1f44.mp3?filename=whisper-ambient-6051.mp3" type="audio/mpeg"></audio>
<audio id="jump" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_5f5a8f1f44.mp3?filename=impact-6052.mp3" type="audio/mpeg"></audio>

<!-- Debug panel -->
<div style="position:fixed;right:12px;bottom:12px;z-index:99999;background:rgba(0,0,0,0.6);padding:8px;border-radius:8px;color:#cfcfcf;font-family:monospace;font-size:12px" id="debugPanel">DEBUG:<div id="debugLog"></div></div>

<script>
/*
  Full remaster: "–†–æ—É–∑–≤—É–¥ ‚Äî –¢–µ–º–Ω–∞—è –ø—Ä–∞–≤–¥–∞"
  - Complete game rewrite with cinematic menu, atmospheric audio, TTS for interrogation and narrator,
  - Improved UI + blood visual, mini-games with images, lab checks (DNA, blood), attack mechanic (10s), inventory & coins,
  - Multiple endings.
  - All audio playback is triggered on user gesture (Start) to avoid autoplay blocks.
*/

/* -------------------- Utilities -------------------- */
const LOG = (...a)=>{ try{ const el=document.getElementById('debugLog'); if(el) el.textContent += '\\n' + a.join(' '); console.log(...a);}catch(e){ console.log(...a);} };
const $ = id => document.getElementById(id);
function showToast(text, t=1600){ const el=document.createElement('div'); el.textContent=text; el.style.position='fixed'; el.style.left='50%'; el.style.bottom='24px'; el.style.transform='translateX(-50%)'; el.style.background='rgba(0,0,0,0.85)'; el.style.color='#fff'; el.style.padding='8px 12px'; el.style.borderRadius='8px'; el.style.zIndex=99999; document.body.appendChild(el); setTimeout(()=>{ el.style.transition='opacity .4s'; el.style.opacity=0; setTimeout(()=>el.remove(),420); }, t); }
function save(key){ try{ localStorage.setItem('rose_'+key, JSON.stringify(GAME)); LOG('Saved', key); }catch(e){ LOG('save err', e); } }
function load(key){ try{ const raw = localStorage.getItem('rose_'+key); return raw ? JSON.parse(raw) : null; }catch(e){ LOG('load err', e); return null; } }

/* -------------------- Game model -------------------- */
const DEFAULT_SUSPECTS = [
  { id:'adrian', name:'–≠–¥—Ä–∏–∞–Ω –†–æ—É–∑–≤—É–¥', role:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫', male:true, height:189, shoe:44, desc:'–•–æ–ª–æ–¥–Ω—ã–π, –ª—é–±–∏—Ç–µ–ª—å –≤–∏–Ω–∞, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å –æ—Ç—Ü–æ–º.' },
  { id:'beatrice', name:'–ë–µ–∞—Ç—Ä–∏—Å –•–µ–π–≤—É–¥', role:'–î–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞', male:false, height:165, shoe:37, desc:'–¢–∏—Ö–∞—è, –Ω–æ –≤—Å—ë –≤–∏–¥–∏—Ç. –•—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∫–ª—é—á–µ–π.' },
  { id:'prof', name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ú–æ—Ä–¥–µ–Ω', role:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', male:true, height:178, shoe:42, desc:'–ó–Ω–∞–µ—Ç —Å–∏–º–≤–æ–ª—ã. –ß–∞—Å—Ç–æ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.' },
  { id:'victoria', name:'–í–∏–∫—Ç–æ—Ä–∏—è –†–æ—É–∑–≤—É–¥', role:'–ñ–µ–Ω–∞', male:false, height:172, shoe:39, desc:'–°—Ç—Ä–∞—Å—Ç–Ω–∞—è, —É –Ω–µ—ë –±—ã–ª–∏ –º–æ—Ç–∏–≤—ã.' },
  { id:'lina', name:'–õ–∏–Ω–∞ –ú–æ–Ω—Ç', role:'–ì–æ—Å—Ç—å—è', male:false, height:168, shoe:38, desc:'–ó–∞–º–∫–Ω—É—Ç–∞—è, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —ç–∑–æ—Ç–µ—Ä–∏–∫–æ–π.' }
];
const MASTER_CLUES = [
  { id:'c1', title:'–ó–∞–ø–∏—Å–∫–∞ (—à–∏—Ñ—Ä)', room:'office', type:'cipher', text:'Vkr ghqv wrfkh', locked:true },
  { id:'c2', title:'–°–ª–µ–¥—ã –æ–±—É–≤–∏', room:'garden', type:'foot', text:'–ü–æ–¥–æ—à–≤–∞: B7', locked:false },
  { id:'c3', title:'–õ–∏—Å—Ç —Å –Ω–∞–¥–ø–∏—Å—å—é', room:'library', type:'paper', text:'"...12/11..."', locked:false },
  { id:'c4', title:'–°–∏–º–≤–æ–ª –∫—Ä–æ–≤–∏', room:'music', type:'symbol', text:'–ù–∞—Ä–∏—Å–æ–≤–∞–Ω –∫—Ä–æ–≤—å—é: —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', locked:false },
  { id:'c5', title:'–§—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã', room:'basement', type:'puzzle', text:'–ü–æ—Ö–æ–∂–µ –Ω–∞ –ø–ª–∞–Ω –ø–æ–¥–≤–∞–ª–∞', locked:true },
  { id:'c6', title:'–§–ª–∞–∫–æ–Ω —ç—Ñ–∏—Ä–∞', room:'attic', type:'vial', text:'–ü—É—Å—Ç–æ–π —Ñ–ª–∞–∫–æ–Ω —Å –º–µ—Ç–∫–æ–π', locked:false }
];
const ENDINGS = [
  { id:'justice', title:'–ü—Ä–∞–≤–æ—Å—É–¥–∏–µ', desc:'–í—ã —Å–æ–±—Ä–∞–ª–∏ —Ñ–∞–∫—Ç—ã: –≤–∏–Ω–æ–≤–Ω—ã–π –ø—Ä–µ–¥–∞–Ω —Å—É–¥—É.', cond: g => (g.links.adrian && g.links.adrian.length>=3) },
  { id:'occult', title:'–û–±—Ä—è–¥', desc:'–í—ã –ø–æ–∑–≤–æ–ª–∏–ª–∏ —Ä–∏—Ç—É–∞–ª—É –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è ‚Äî —Ç—å–º–∞ –≤—ã—à–ª–∞ –Ω–∞—Ä—É–∂—É.', cond: g => g.ritual },
  { id:'unsolved', title:'–ù–µ—Ä–∞—Å–∫—Ä—ã—Ç–æ', desc:'–ö–æ–º–Ω–∞—Ç–∞ —Å–∫—Ä—ã–ª–∞ –∏—Å—Ç–∏–Ω—É ‚Äî –¥–µ–ª–æ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–∞–π–Ω–æ–π.', cond: g => Object.values(g.links).flat().length < 3 }
];

/* Game runtime object */
let GAME = {
  suspects: [],
  clues: [],
  opened: {},
  links: {},
  timeline: [],
  coins: 0,
  health: 100,
  inventory: [],
  ritual: false
};

/* -------------------- Audio / TTS helpers -------------------- */
const audio = {
  bg: $('bgMusic'),
  amb: $('ambience'),
  whisper: $('whisper'),
  jump: $('jump')
};
function safePlay(el){
  if(!el) return Promise.reject('noel');
  el.muted = false;
  el.volume = el.volume || 0.14;
  return el.play().catch(e => { LOG('play err', e); return Promise.reject(e); });
}
function ttsSpeak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  const v = speechSynthesis.getVoices();
  if(v && v.length) u.voice = v[Math.floor(Math.random()*v.length)];
  u.rate = 1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* -------------------- Initialization & menu -------------------- */
document.addEventListener('DOMContentLoaded', ()=> {
  LOG('DOM ready');
  bindUI();
  // try autosave prompt
  const autos = load('autosave');
  if(autos){
    // keep menu open; user can choose to load
  } else {
    // show cinematic (menu already visible)
  }
});

function bindUI(){
  // menu buttons
  document.querySelector('#startBtn').addEventListener('click', ()=> {
    $('menuScreen').style.display = 'none';
    if(GAME.suspects.length === 0) newGame();
    // allow audio on first gesture
    if($('toggleMusic') && $('toggleMusic').checked) safePlay(audio.bg).catch(()=>{});
    safePlay(audio.amb).catch(()=>{});
    showToast('–ó–≤—É–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä —Ä–∞–∑—Ä–µ—à–∏–ª)');
  });
  document.querySelector('#soundBtn').addEventListener('click', ()=> {
    safePlay(audio.bg).catch(()=>{}); safePlay(audio.amb).catch(()=>{}); showToast('–ü–æ–ø—ã—Ç–∫–∞ –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫');
  });
  document.querySelector('#continueBtn').addEventListener('click', ()=> {
    const autos = load('autosave'); if(autos && confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤?')){ GAME = autos; renderAll(); $('menuScreen').style.display='none'; showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω'); } else showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –Ω–µ—Ç');
  });

  // header menu
  $('menuToggle').addEventListener('click', ()=> $('menuScreen').style.display = 'flex');

  // hotspots (delegated later when rendering)
  // timeline
  $('timelineAdd').addEventListener('click', ()=> { const v = $('timelineInput').value.trim(); if(!v) return; GAME.timeline.push({text:v,time:new Date().toISOString()}); $('timelineInput').value=''; renderTimeline(); save('autosave'); });

  // labs
  $('dnaBtn').addEventListener('click', ()=> {
    const code = prompt('–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ–±—Ä–∞–∑—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä ER189)');
    if(!code) return;
    // simple simulated match: suspect DNA = initials + (height%100)
    const matches = GAME.suspects.map(s => ({id:s.id,name:s.name,dna:(s.name.split(' ').map(p=>p[0]).join('') + (s.height%100))}));
    const found = matches.find(m => m.dna.toLowerCase() === code.toLowerCase());
    if(found){ $('labLog').innerHTML = `<div style="color:var(--muted)">–î–ù–ö —Å–æ–≤–ø–∞–ª–∞: ${found.name}</div>`; GAME.coins += 8; renderStats(); save('autosave'); showToast('–î–ù–ö —Å–æ–≤–ø–∞–ª–∞ ‚Äî –º–æ–Ω–µ—Ç—ã +8'); ttsSpeak('–î–ù–ö —Å–æ–≤–ø–∞–¥–∞–µ—Ç'); }
    else { $('labLog').innerHTML = `<div style="color:var(--muted)">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`; showToast('–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); }
  });
  $('bloodBtn').addEventListener('click', ()=> {
    // show blood overlay briefly
    $('bloodOverlay').classList.add('on');
    setTimeout(()=> $('bloodOverlay').classList.remove('on'), 6000);
    $('labLog').innerHTML = `<div style="color:var(--muted)">–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏: —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ</div>`;
    ttsSpeak('–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤—è–Ω—ã—Ö —Å–ª–µ–¥–æ–≤ –ø–æ–∫–∞–∑–∞–ª —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ');
  });
  $('fpBtn').addEventListener('click', ()=> {
    $('labLog').innerHTML = `<div style="color:var(--muted)">–û—Ç–ø–µ—á–∞—Ç–∫–∏: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ø–µ—Ä—á–∞—Ç–∫–æ–π</div>`; showToast('–û—Ç–ø–µ—á–∞—Ç–∫–∏: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'); save('autosave');
  });

  // inventory / use item
  $('useItem').addEventListener('click', ()=> {
    if(GAME.coins >= 5){ GAME.coins -= 5; showToast('–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –∑–∞—â–∏—Ç—ã (-5 –º–æ–Ω–µ—Ç)'); renderStats(); save('autosave'); } else showToast('–£ –≤–∞—Å –Ω–µ—Ç –º–æ–Ω–µ—Ç –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞');
  });

  // lab DNA compare on right
  $('dnaCheck').addEventListener('click', ()=> {
    const code = $('dnaInput').value.trim(); if(!code){ showToast('–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥'); return; }
    const matches = GAME.suspects.map(s => ({id:s.id,name:s.name,dna:(s.name.split(' ').map(p=>p[0]).join('') + (s.height%100))}));
    const found = matches.find(m => m.dna.toLowerCase() === code.toLowerCase());
    if(found){ $('labLog').innerHTML = `<div style="color:var(--muted)">–î–ù–ö —Å–æ–≤–ø–∞–ª–∞: ${found.name}</div>`; GAME.coins += 8; renderStats(); save('autosave'); showToast('–î–ù–ö —Å–æ–≤–ø–∞–ª–∞ ‚Äî –º–æ–Ω–µ—Ç—ã +8'); }
    else { $('labLog').innerHTML = `<div style="color:var(--muted)">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç</div>`; showToast('–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç'); }
  });

  // phone calls
  $('callPartner').addEventListener('click', ()=> { const log = $('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–ó–≤–æ–Ω–æ–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫—É...</div>` + log.innerHTML; setTimeout(()=> { log.innerHTML = `<div style="color:var(--muted)">'–ï–¥—É –Ω–∞ –º–µ—Å—Ç–æ', ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞–ø–∞—Ä–Ω–∏–∫.</div>` + log.innerHTML; showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫ –≤—ã–µ–∑–∂–∞–µ—Ç'); }, 1200); });
  $('callPolice').addEventListener('click', ()=> { const log = $('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø–æ–ª–∏—Ü–∏–µ–π...</div>` + log.innerHTML; setTimeout(()=> { log.innerHTML = `<div style="color:var(--muted)">'–ü–∞—Ç—Ä—É–ª—å –µ–¥–µ—Ç', ‚Äî —Å–æ–æ–±—â–∞–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä.</div>` + log.innerHTML; showToast('–ü–æ–ª–∏—Ü–∏—è –≤—ã–µ—Ö–∞–ª–∞'); }, 1200); });

  // interrogation modal
  $('interrogateStart').addEventListener('click', ()=> {
    const id = $('interrogateSelect').value; if(!id){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'); return; }
    addChat('ai', `–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç: ${GAME.suspects.find(s=>s.id===id).name}`); ttsSpeak('–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç');
  });
  $('chatSend').addEventListener('click', ()=> {
    const q = $('chatInput').value.trim(); if(!q) return; addChat('user', q); $('chatInput').value=''; setTimeout(()=> { const id = $('interrogateSelect').value; const resp = aiResp(q,id); addChat('ai', resp); ttsSpeak(resp); }, 600);
  });
  $('chatClose').addEventListener('click', ()=> $('interrogateModal').style.display='none');

  // mini-games triggers
  $('memGame').addEventListener('click', ()=> openMemory());
  $('spotGame').addEventListener('click', ()=> openSpot());
  $('imgPuzzleGame').addEventListener('click', ()=> openImgPuzzle());
  $('memoryClose').addEventListener('click', ()=> $('memoryModal').style.display='none');
  $('spotClose').addEventListener('click', ()=> $('spotModal').style.display='none');
  $('imgPuzzleClose').addEventListener('click', ()=> $('imgPuzzleModal').style.display='none');

  // attack options
  $('fightBtn').addEventListener('click', ()=> resolveAttack('fight'));
  $('runBtn').addEventListener('click', ()=> resolveAttack('run'));
  $('useItemBtn').addEventListener('click', ()=> { if(GAME.coins >= 5){ GAME.coins -=5; resolveAttack('use'); } else showToast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç'); });

  // endings modal
  $('showEndings').addEventListener('click', ()=> { renderEndings(); $('endingsModal').style.display='flex'; });
  $('endingsClose').addEventListener('click', ()=> $('endingsModal').style.display='none');
  $('endingClose').addEventListener('click', ()=> $('endingModal').style.display='none');

  // other binds
  $('profilesBtn').addEventListener('click', ()=> { renderProfilesModal(); $('profilesModal').style.display='flex'; });
  $('closeProfiles').addEventListener('click', ()=> $('profilesModal').style.display='none');
  $('menuToggle').addEventListener('click', ()=> $('menuScreen').style.display = 'flex');

  LOG('UI bound');
}

/* -------------------- Game logic functions -------------------- */

function newGame(){
  GAME.suspects = JSON.parse(JSON.stringify(DEFAULT_SUSPECTS)).sort(()=>Math.random()-0.5);
  GAME.clues = JSON.parse(JSON.stringify(MASTER_CLUES));
  GAME.opened = {}; GAME.links = {}; GAME.timeline = []; GAME.coins = 25; GAME.health = 100; GAME.inventory = []; GAME.ritual = false;
  GAME.suspects.forEach(s=> GAME.links[s.id]=[]);
  // add extra random clues
  for(let i=0;i<3;i++){ const b = MASTER_CLUES[Math.floor(Math.random()*MASTER_CLUES.length)]; GAME.clues.push(Object.assign({}, b, { id: b.id + '_x'+i, title: b.title + ' (–≤—Å–ø–ª.)', locked: Math.random() < 0.5 })); }
  save('autosave'); renderAll();
  showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞ ‚Äî –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã.');
}

function renderAll(){
  renderSuspects(); renderClues(); renderTimeline(); renderStats();
  populateInterrogateSelect();
}

function renderSuspects(){
  const el = $('suspectsList'); el.innerHTML = '';
  GAME.suspects.forEach(s=>{
    const div = document.createElement('div'); div.className='suspect'; div.dataset.suspect = s.id;
    let avatar = `<div class="avatar">${escapeHtml(s.name[0])}</div>`;
    if(!s.male){
      const idx = GAME.suspects.filter(x=>!x.male).map(x=>x.id).indexOf(s.id);
      const src = `assets/female${Math.min(3,idx+1)}.jpg`;
      avatar = `<img class="avatar" src="${src}" alt="${escapeHtml(s.name)}" onerror="this.style.display='none'">`;
    }
    const linked = (GAME.links[s.id]||[]).length;
    div.innerHTML = `${avatar}<div class="smeta"><div class="sname">${escapeHtml(s.name)}</div><div class="meta-row">${escapeHtml(s.role)}</div><div style="margin-top:6px;color:var(--muted)">${escapeHtml(s.desc)}</div></div><div class="dropzone" data-suspect="${s.id}">${linked}</div>`;
    div.addEventListener('click', ()=> openProfileModal(s));
    el.appendChild(div);
  });
  attachDropzones();
}

function renderClues(){
  const grid = $('cluesGrid'); grid.innerHTML = '';
  GAME.clues.forEach(c=>{
    const isOpen = !!GAME.opened[c.id];
    const item = document.createElement('div'); item.className='clue'; item.id = c.id;
    item.innerHTML = `<div class="thumb">${getIcon(c.type)}</div><div><h4>${escapeHtml(c.title)}</h4><p>${ isOpen ? escapeHtml(c.text) : (c.locked ? '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ / —Å–∫—Ä—ã—Ç–∞' : escapeHtml(c.text)) }</p></div>`;
    item.addEventListener('click', ()=> {
      if(c.locked && !GAME.opened[c.id]){ if(c.type==='cipher') openCipher(c); else if(c.type==='puzzle') openPuzzle(); else showToast('–£–ª–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç'); return; }
      if(!GAME.opened[c.id]){ GAME.opened[c.id] = true; revealClue(c); renderClues(); renderStats(); } else showDetail(c);
    });
    item.draggable = true;
    item.addEventListener('dragstart', ev => ev.dataTransfer.setData('text/plain', c.id));
    addTouchDragSupport(item, c.id);
    grid.appendChild(item);
  });
  $('totalClues').textContent = GAME.clues.length;
  $('openedCount').textContent = Object.keys(GAME.opened).length;
}

function renderTimeline(){
  const el = $('timeline');
  if(GAME.timeline.length === 0){ el.innerHTML = '<div class="small" style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  el.innerHTML = GAME.timeline.slice().reverse().map(t=> `<div style="margin-bottom:6px">${escapeHtml(t.text)} <span style="color:var(--muted);font-size:0.82rem">(${new Date(t.time).toLocaleTimeString()})</span></div>`).join('');
}

function renderStats(){
  $('linksCount').textContent = Object.values(GAME.links).flat().length;
  $('ritual').textContent = GAME.ritual ? '–¥–∞' : '–Ω–µ—Ç';
  $('coinTop').textContent = GAME.coins;
  $('coinRight') && ($('coinRight').textContent = GAME.coins);
  $('healthBar').value = GAME.health;
}

/* -------------------- Interactions: rooms, attacks -------------------- */
function inspectRoom(room){
  const found = GAME.clues.filter(c=> c.room === room);
  if(found.length === 0){ showToast('–ü–æ—Ö–æ–∂–µ, –∑–¥–µ—Å—å –Ω–∏—á–µ–≥–æ'); return; }
  found.forEach(c=> {
    if(!c.locked) GAME.opened[c.id] = true;
    else {
      const el = document.getElementById(c.id);
      if(el) el.querySelector('p').textContent = '–ù–∞–π–¥–µ–Ω–∞, –Ω–æ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç';
    }
  });
  renderAll();
  showToast(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${found.length} —É–ª–∏–∫(–∞)`);
  // possible attack
  if(Math.random() < 0.18){ triggerAttack(); }
  save('autosave');
}

/* -------------------- Attack mechanic -------------------- */
let attackInterval = null;
function triggerAttack(){
  $('attackModal').style.display='flex';
  let t = 10; $('attackTimer').textContent = t;
  attackInterval = setInterval(()=>{ t--; $('attackTimer').textContent = t; if(t<=0){ clearInterval(attackInterval); attackInterval = null; resolveAttack('timeout'); } }, 1000);
}
function resolveAttack(action){
  clearInterval(attackInterval); attackInterval = null;
  $('attackModal').style.display = 'none';
  if(action === 'fight'){
    if(Math.random() < 0.65){ showToast('–í—ã –æ—Ç–±–∏–ª–∏—Å—å!'); safePlay(audio.jump).catch(()=>{}); }
    else { GAME.health = Math.max(0, GAME.health - 30); showToast('–í—ã —Ä–∞–Ω–µ–Ω—ã ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ -30'); }
  } else if(action === 'run'){
    if(Math.random() < 0.55){ GAME.coins = Math.max(0, GAME.coins - 5); showToast('–£–±–µ–∂–∞–ª–∏ ‚Äî –º–æ–Ω–µ—Ç—ã -5'); } else { GAME.health = Math.max(0, GAME.health - 20); showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–±–µ–∂–∞—Ç—å ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ -20'); }
  } else if(action === 'use'){
    if(GAME.coins >= 5){ GAME.coins -= 5; showToast('–ü—Ä–µ–¥–º–µ—Ç —Å–ø–∞—Å –≤–∞—Å ‚Äî –º–æ–Ω–µ—Ç—ã -5'); } else { GAME.health = Math.max(0, GAME.health - 25); showToast('–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–∞ ‚Äî –ø–æ–ª—É—á–∏–ª–∏ —É—Ä–æ–Ω -25'); }
  } else if(action === 'timeout'){
    GAME.health = Math.max(0, GAME.health - 35); showToast('–í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ -35'); safePlay(audio.whisper).catch(()=>{});
  }
  renderStats();
  save('autosave');
  if(GAME.health <= 0) { alert('–í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–æ–∑–Ω–∞–Ω–∏–µ ‚Äî –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'); location.reload(); }
}

/* -------------------- Mini-games implementations -------------------- */
/* Memory pairs */
let memory = null;
function openMemory(){
  $('memoryModal').style.display='flex';
  const board = $('memoryBoard'); board.innerHTML = '';
  const imgs = []; for(let i=0;i<8;i++) imgs.push('https://picsum.photos/seed/mem'+i+'/200/200');
  const arr = imgs.concat(imgs).sort(()=>Math.random()-0.5);
  memory = { first:null, second:null, matched:0, board };
  arr.forEach(src=>{
    const card = document.createElement('div'); card.style.height='80px'; card.style.background='#131212'; card.style.borderRadius='6px'; card.style.cursor='pointer'; card.dataset.src = src;
    card.addEventListener('click', ()=> {
      if(card.classList.contains('matched')) return;
      card.style.backgroundImage = `url(${card.dataset.src})`; card.style.backgroundSize='cover';
      if(!memory.first){ memory.first = card; return; }
      memory.second = card;
      if(memory.first.dataset.src === memory.second.dataset.src){
        memory.first.classList.add('matched'); memory.second.classList.add('matched'); memory.matched += 2; memory.first=null; memory.second=null;
        if(memory.matched === memory.board.children.length){ GAME.coins += 10; renderStats(); save('autosave'); showToast('–ü–æ–±–µ–¥–∞! +10 –º–æ–Ω–µ—Ç'); $('memoryModal').style.display='none'; }
      } else {
        setTimeout(()=>{ memory.first.style.backgroundImage=''; memory.second.style.backgroundImage=''; memory.first=null; memory.second=null; }, 700);
      }
    });
    board.appendChild(card);
  });
}

/* Spot the difference simple simulation */
function openSpot(){
  $('spotModal').style.display='flex';
  const choices = $('spotChoices'); choices.innerHTML = '';
  let remaining = 3;
  for(let i=0;i<3;i++){
    const b = document.createElement('button'); b.className='btn'; b.textContent = '–û—Ç–º–µ—Ç–∏—Ç—å'; b.addEventListener('click', ()=> {
      if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')){ remaining--; showToast('–û—Ç–ª–∏—á–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å: ' + remaining); if(remaining===0){ GAME.coins += 12; renderStats(); save('autosave'); showToast('–ü–æ–±–µ–¥–∞! +12 –º–æ–Ω–µ—Ç'); $('spotModal').style.display='none'; } }
    });
    choices.appendChild(b);
  }
}

/* Image puzzle (3x3) */
function openImgPuzzle(){
  $('imgPuzzleModal').style.display='flex';
  const board = $('imgPuzzleBoard'); board.innerHTML = ''; const nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
  nums.forEach(n=>{
    const p = document.createElement('div'); p.style.height='80px'; p.style.background='#201612'; p.style.display='grid'; p.style.placeItems='center'; p.style.borderRadius='6px'; p.textContent = n===9? '': n; p.dataset.num = n;
    p.addEventListener('click', ()=> {
      const empty = Array.from(board.children).find(c=>c.dataset.num=='9'); if(!empty) return;
      const idx = Array.from(board.children).indexOf(p), eidx = Array.from(board.children).indexOf(empty); const dist = Math.abs(idx-eidx);
      if(dist === 1 || dist === 3){ const t = p.dataset.num; p.dataset.num = empty.dataset.num; empty.dataset.num = t; const tmp = p.textContent; p.textContent = empty.textContent; empty.textContent = tmp;
        const order = Array.from(board.children).map(c=>Number(c.dataset.num)); if(order.every((v,i)=> v===i+1)){ GAME.coins += 15; renderStats(); showToast('–ü–æ–±–µ–¥–∞! +15 –º–æ–Ω–µ—Ç'); $('imgPuzzleModal').style.display='none'; save('autosave'); }
      }
    });
    board.appendChild(p);
  });
}

/* -------------------- Interrogation (simple AI) -------------------- */
function populateInterrogateSelect(){
  const sel = $('interrogateSelect'); sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
  GAME.suspects.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; sel.appendChild(o); });
}
function addChat(who, text){
  const box = $('chatBox'); const m = document.createElement('div'); m.className = 'msg ' + (who === 'ai' ? 'ai' : 'user'); m.textContent = text; box.appendChild(m); box.scrollTop = box.scrollHeight;
}
function aiResp(q, id){
  if(!id) return '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ';
  const s = GAME.suspects.find(x=>x.id===id);
  q = q.toLowerCase();
  if(q.includes('–≥–¥–µ')) return `${s.name}: –Ø –±—ã–ª(–∞) –≤ –¥–æ–º–µ.`;
  if(q.includes('–∑–∞–ø–∏—Å')) return `${s.name}: –í –∑–∞–ø–∏—Å–∫–µ –±—ã–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª—ã '–í.'`;
  if(q.includes('–∫—Ä–æ–≤')) return `${s.name}: –Ø –≤–∏–¥–µ–ª(–∞) –∫—Ä–æ–≤—å –≤ –∫–∞–±–∏–Ω–µ—Ç–µ.`;
  return `${s.name}: –Ø –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å.`;
}

/* -------------------- Profiles modal functions -------------------- */
function renderProfilesModal(){
  const cont = $('profilesContent'); cont.innerHTML = '';
  GAME.suspects.forEach(s=> {
    const div = document.createElement('div'); div.style.marginBottom = '10px';
    const linked = (GAME.links[s.id]||[]).length;
    div.innerHTML = `<strong>${escapeHtml(s.name)}</strong> ‚Äî <em>${escapeHtml(s.role)}</em><div class="small" style="color:var(--muted);margin-top:6px">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe} ¬∑ –£–ª–∏–∫: ${linked}</div><div style="margin-top:6px">${escapeHtml(s.desc)}</div><div style="margin-top:8px"><button class="btn" onclick="inspectSuspect('${s.id}')">–î–æ–ø—Ä–æ—Å–∏—Ç—å</button> <button class="btn secondary" onclick="showPhysical('${s.id}')">–í–Ω–µ—à–Ω–æ—Å—Ç—å</button></div>`;
    cont.appendChild(div);
  });
}
function openProfileModal(s){ renderProfilesModal(); $('profilesModal').style.display='flex'; }
function inspectSuspect(id){ $('profilesModal').style.display='none'; $('interrogateModal').style.display='flex'; $('interrogateSelect').value = id; addChat('ai', '–ì–æ—Ç–æ–≤–æ –∫ –¥–æ–ø—Ä–æ—Å—É: ' + GAME.suspects.find(s=>s.id===id).name); }

/* -------------------- Cipher handling -------------------- */
function openCipher(c){
  $('cipherModal').style.display='flex'; $('cipherModal').dataset.clue = c.id; $('caesarOut').value = '';
}
function tryCipher(){
  const shift = Number($('caesarShift').value) || 0; const clueId = $('cipherModal').dataset.clue;
  const clue = GAME.clues.find(x=>x.id===clueId) || GAME.clues.find(x=>x.type==='cipher');
  if(!clue){ showToast('–ó–∞–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
  const decoded = caesarDecode(clue.text, shift); $('caesarOut').value = decoded;
  if(/–æ–Ω –∑–Ω–∞–µ—Ç|–≤\./i.test(decoded) || shift === 3){ clue.locked = false; clue.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: "–û–Ω –∑–Ω–∞–µ—Ç."'; GAME.opened[clue.id] = true; renderAll(); $('cipherModal').style.display='none'; save('autosave'); showToast('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞'); }
}
function caesarDecode(text, shift){ if(!text) return text; const a='abcdefghijklmnopqrstuvwxyz'; const A=a.toUpperCase(); return text.split('').map(ch=>{ if(a.includes(ch)) return a[(a.indexOf(ch)-shift+26)%26]; if(A.includes(ch)) return A[(A.indexOf(ch)-shift+26)%26]; return ch; }).join(''); }

/* -------------------- Endings -------------------- */
function renderEndings(){
  const list = $('endingsList'); list.innerHTML = '';
  ENDINGS.forEach(e=>{
    const unlocked = e.cond(GAME);
    const card = document.createElement('div'); card.style.padding = '10px'; card.style.marginBottom = '8px'; card.style.border = '1px solid rgba(255,255,255,0.03)';
    card.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${escapeHtml(e.title)}</strong><div style="color:${unlocked? '#9fff9f':'#cfcfcf'}">${unlocked? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}</div></div><div style="color:var(--muted);margin-top:6px">${escapeHtml(e.desc)}</div>`;
    card.addEventListener('click', ()=> { if(unlocked) showEnding(e.id); else showToast('–ö–æ–Ω—Ü–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); });
    list.appendChild(card);
  });
}
function showEnding(id){ const e = ENDINGS.find(x=>x.id===id); if(!e) return; $('endingTitle').innerText = e.title; $('endingText').innerText = e.desc; $('endingModal').style.display='flex'; const hist = JSON.parse(localStorage.getItem('rose_endings')||'[]'); hist.unshift({id:e.id,time:new Date().toISOString()}); localStorage.setItem('rose_endings', JSON.stringify(hist.slice(0,50))); }

/* -------------------- Helpers -------------------- */
function getIcon(t){ switch(t){ case 'cipher': return '‚úâÔ∏è'; case 'puzzle': return 'üß©'; case 'symbol': return 'üî±'; case 'vial': return 'üß™'; case 'foot': return 'üë£'; default: return 'üîé'; } }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* -------------------- Persist / load helpers -------------------- */
function saveAll(){ save('autosave'); }
function loadAll(){ const a = load('autosave'); if(a){ GAME = a; renderAll(); showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω'); } }

/* -------------------- Start new (default on menu or load) -------------------- */
// wire some UI elements for direct testing
window.newGame = newGame;
window.inspectSuspect = inspectSuspect;
window.showPhysical = showPhysical;
LOG('Remaster script loaded. Use Start to begin.');

</script>
</body>
</html>
