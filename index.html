<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥ ‚Äî –ü–æ–ª–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060607;
  --panel:#141214;
  --accent:#b08a5c;
  --accent-2:#7a4e2f;
  --muted:#cfcfcf;
  --danger:#b04a4a;
  --glass:rgba(255,255,255,0.03);
  --radius:12px;
  --glass-2: rgba(255,255,255,0.02);
}

/* Reset & base */
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#efece6; background:linear-gradient(180deg,#040405 0%, #0b0b0d 80%); -webkit-font-smoothing:antialiased;}
button{font-family:inherit}

/* Header and menu */
.header {
  display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid rgba(255,255,255,0.02); position:sticky; top:0; z-index:60; background:linear-gradient(90deg, rgba(10,10,10,0.6), rgba(6,6,6,0.6)); backdrop-filter: blur(6px);
}
.brand { display:flex; gap:12px; align-items:center; }
.logo { width:52px; height:52px; border-radius:10px; background:linear-gradient(180deg,#2b1f18,#191010); display:grid; place-items:center; font-family:Cinzel, serif; font-size:20px; color:#f7efe7; border:1px solid rgba(255,255,255,0.03); }
.title { font-family:Cinzel, serif; font-size:1.06rem; color:#efe6dc; }
.top-controls { display:flex; gap:8px; align-items:center; }

/* Main layout */
.container { max-width:1200px; margin:18px auto; padding:12px; display:grid; grid-template-columns: 320px 1fr 380px; gap:18px; align-items:start; }
@media (max-width:1100px){ .container{ grid-template-columns: 1fr; } .right-panel{ order:3 } }

/* Panels */
.panel { background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.008)); padding:14px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.02); box-shadow: 0 14px 36px rgba(0,0,0,0.65); }
.small { color:var(--muted); font-size:0.92rem; }

/* Suspects */
.suspect { display:flex; gap:12px; align-items:center; padding:10px; margin-top:10px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02); }
.avatar { width:64px; height:64px; border-radius:10px; object-fit:cover; border:2px solid rgba(255,255,255,0.03); background:#1b1412; }
.smeta { flex:1; }
.sname { font-weight:700; }
.srole { color:var(--muted); font-size:0.9rem; }
.smeta .meta-row { display:flex; gap:10px; margin-top:6px; font-size:0.88rem; color:var(--muted); }

/* Map */
.map { position:relative; border-radius:12px; overflow:hidden; padding:10px; min-height:420px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.36)); }
.map-canvas { width:100%; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#231a17,#1b1411); display:block; position:relative; height:340px; }
.hotspot { position:absolute; transform:translate(-50%,-50%); background:linear-gradient(180deg, rgba(176,138,92,0.14), rgba(176,138,92,0.08)); padding:8px 12px; border-radius:999px; font-weight:700; color:#120b06; cursor:pointer; border:1px solid rgba(176,138,92,0.12); box-shadow:0 10px 28px rgba(0,0,0,0.6); user-select:none; transition:transform .14s ease, box-shadow .14s ease; }

/* Clues */
.clues { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; }
.clue { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); cursor:pointer; display:flex; gap:10px; align-items:flex-start; transition:transform .12s ease; }
.clue:hover { transform:translateY(-6px); box-shadow:0 20px 40px rgba(0,0,0,0.6); }
.thumb { width:56px; height:56px; border-radius:8px; background:#201612; display:grid; place-items:center; font-size:18px; color:#d9c8ae; }
.clue h4 { margin:0; font-size:0.98rem; }
.clue p { margin:6px 0 0 0; color:var(--muted); font-size:0.88rem; }

/* Right */
.right-panel .tool { margin-bottom:12px; }
.btn { background:var(--accent); color:#070707; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
.btn.secondary { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }

/* Modals */
.modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); }
.card { width:760px; max-width:94%; background:linear-gradient(180deg,#121212,#0f0f0f); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); color:#efece6; box-shadow:0 30px 80px rgba(0,0,0,0.8); }
.card.small { width:520px; max-width:92%; }

/* Interrogation chat */
.chat { display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto; padding:8px; background:#0b0b0b; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }
.msg { padding:8px 10px; border-radius:8px; max-width:85%; }
.msg.ai { background:#1b1b1c; color:#e6e6e6; align-self:flex-start; }
.msg.user { background:#b08a5c; color:#070707; align-self:flex-end; }

/* Phone UI */
.phone { width:320px; border-radius:12px; background:linear-gradient(180deg,#0b0b0b,#0a0a0a); padding:10px; border:1px solid rgba(255,255,255,0.02); box-shadow:0 12px 30px rgba(0,0,0,0.6); }
.phone .screen{ height:360px; background:#060606; border-radius:8px; padding:8px; color:var(--muted); overflow:auto; }

/* Animations & ambience */
.flicker { animation:flicker 1.1s infinite; }
@keyframes flicker { 0%{filter:brightness(0.96)}25%{filter:brightness(1.06)}50%{filter:brightness(0.94)}75%{filter:brightness(1.03)}100%{filter:brightness(0.97)} }
.dust { position:absolute; inset:0; pointer-events:none; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="200"><circle cx="10" cy="20" r="1" fill="%23cfcfcf" opacity="0.06"/></svg>'); mix-blend-mode:overlay; opacity:0.08; animation: drift 18s linear infinite; }
@keyframes drift { from{transform:translateY(0)} to{transform:translateY(-40px)} }

/* instruction & menu */
.menu { display:flex; gap:8px; align-items:center; }
.menu .item { color:var(--muted); padding:6px 10px; border-radius:8px; cursor:pointer; }
.menu .item:hover { background:var(--glass-2) }

/* endings */
.endings-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:12px; }

/* responsive tweaks */
@media (max-width:700px){
  .avatar{ width:48px; height:48px }
  .map-canvas{ height:260px }
  .phone{ width:100% }
}

/* subtle transitions */
* { transition: background 200ms ease, color 200ms ease; }
</style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo">–†</div>
      <div>
        <div class="title">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</div>
        <div class="small">–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏ –∏ —Å–∏–º—É–ª—è—Ü–∏—è –¥–æ–ø—Ä–æ—Å–∞</div>
      </div>
    </div>

    <div class="top-controls">
      <nav class="menu" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é">
        <div class="item" id="menuStart">–ù–∞—á–∞—Ç—å</div>
        <div class="item" id="menuLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
        <div class="item" id="menuSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="item" id="menuHelp">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
      </nav>
      <button id="audioToggle" class="btn secondary">–ó–≤—É–∫: –≤—ã–∫–ª</button>
    </div>
  </header>

  <main class="container" role="main">
    <!-- LEFT: suspects & notebook -->
    <aside class="panel left-panel" aria-label="–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ –∏ –∑–∞–º–µ—Ç–∫–∏">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <strong style="font-family:Cinzel, serif">–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ</strong>
        <button id="profilesBtn" class="btn secondary">–ü—Ä–æ—Ñ–∏–ª–∏</button>
      </div>
      <div id="suspectsList" style="margin-top:12px"></div>

      <div style="margin-top:14px;">
        <strong>–ë–ª–æ–∫–Ω–æ—Ç</strong>
        <textarea id="notebook" rows="6" style="width:100%; margin-top:8px; resize:vertical; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="saveNotes" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏</button>
          <button id="clearNotes" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</strong>
        <div id="quickHelp" class="small" style="margin-top:8px; color:var(--muted)">
          - –û—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ "–ö–∞—Ä—Ç–∞" –æ–±–ª–∞—Å—Ç–∏. <br>
          - –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —É–ª–∏–∫–∏, —Ä–µ—à–∞–π—Ç–µ –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã, —Å–≤—è–∑—ã–≤–∞–π—Ç–µ —É–ª–∏–∫–∏ —Å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–º–∏ (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º). <br>
          - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–î–æ–ø—Ä–æ—Å" (–Ω–µ–π—Ä–æ—Å–µ—Ç—å-–ø–æ–º–æ—â–Ω–∏–∫) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π ‚Äî –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –∫ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è–º. <br>
          - –°–æ–±–µ—Ä–∏—Ç–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É" –∏–ª–∏ "–û–±–≤–∏–Ω–∏—Ç—å".
        </div>
      </div>
    </aside>

    <!-- CENTER: map & clues -->
    <section class="panel map-panel" aria-label="–ö–∞—Ä—Ç–∞ –∏ —É–ª–∏–∫–∏">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-family:Cinzel, serif; font-size:1.05rem;">–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="findKiller" class="btn">–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É</button>
          <button id="interrogateBtn" class="btn secondary">–î–æ–ø—Ä–æ—Å (–Ω–µ–π—Ä–æ—Å–µ—Ç—å)</button>
          <button id="callBtn" class="btn secondary">–¢–µ–ª–µ—Ñ–æ–Ω</button>
        </div>
      </div>

      <div class="map">
        <div class="map-canvas" id="mapCanvas">
          <div class="hotspot" data-room="library" style="left:18%; top:22%;">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
          <div class="hotspot" data-room="music" style="left:48%; top:18%;">üéπ –ú—É–∑—ã–∫–∞</div>
          <div class="hotspot" data-room="office" style="left:76%; top:22%;">üóÑ –ö–∞–±–∏–Ω–µ—Ç</div>
          <div class="hotspot" data-room="dining" style="left:34%; top:56%;">üçΩ –°—Ç–æ–ª–æ–≤–∞—è</div>
          <div class="hotspot" data-room="garden" style="left:14%; top:78%;">üåπ –°–∞–¥</div>
          <div class="hotspot" data-room="basement" style="left:74%; top:76%;">‚öôÔ∏è –ü–æ–¥–≤–∞–ª</div>
          <div class="hotspot" data-room="attic" style="left:54%; top:44%;">üï∞ –ß–µ—Ä–¥–∞–∫</div>

          <!-- ambiance elements -->
          <div class="dust"></div>
        </div>

        <div style="display:flex; gap:12px; margin-top:12px;">
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>–£–ª–∏–∫–∏</strong>
              <div><span id="openedCount">0</span> / <span id="totalClues">0</span> –æ—Ç–∫—Ä—ã—Ç–æ</div>
            </div>
            <div id="cluesGrid" class="clues" style="margin-top:10px;"></div>
          </div>

          <div style="width:320px;">
            <div class="panel small">
              <strong>–¢–∞–π–º–ª–∞–π–Ω</strong>
              <div id="timelineList" style="margin-top:8px; min-height:80px; color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input id="timelineInput" placeholder="23:10 ‚Äî –∫—Ä–∏–∫" style="flex:1; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)"/>
                <button id="addTimeline" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>

            <div class="panel small" style="margin-top:12px;">
              <strong>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</strong>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <button id="cipherBtn" class="btn">–¶–µ–∑–∞—Ä—å</button>
                <button id="puzzleBtn" class="btn secondary">–ü–∞–∑–ª</button>
                <button id="matchBtn" class="btn secondary">–≠–º–±–ª–µ–º—ã</button>
              </div>
              <div style="margin-top:8px; color:var(--muted)">–ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã –¥–∞—é—Ç –∫–ª—é—á–∏ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö —É–ª–∏–∫–æ–≤.</div>
            </div>

            <div class="panel small" style="margin-top:12px;">
              <strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong>
              <div class="phone" style="margin-top:8px;">
                <div class="screen" id="phoneScreen">
                  <div style="padding:6px; color:var(--muted)">–ù–∞–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç</div>
                  <div id="phoneLog" style="margin-top:8px; color:var(--muted)"></div>
                </div>
                <div style="display:flex; gap:8px; margin-top:8px;">
                  <input id="phoneInput" class="input" placeholder="–ù–æ–º–µ—Ä –∏–ª–∏ —Å–∞–π—Ç (–ø—Ä–∏–º–µ—Ä: 88 –∏–ª–∏ example.com)" style="flex:1; padding:8px; border-radius:8px; background:#0b0b0b; color:#efece6; border:1px solid rgba(255,255,255,0.03)">
                  <button id="phoneCall" class="btn">–ó–≤–æ–Ω–æ–∫</button>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- RIGHT: stats, endings, settings -->
    <aside class="panel right-panel" aria-label="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
      <div class="tool">
        <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
        <div style="margin-top:8px;">–°–≤—è–∑–µ–π: <span id="linksCount">0</span></div>
        <div style="margin-top:8px;">–†–∏—Ç—É–∞–ª: <span id="ritualState">–Ω–µ—Ç</span></div>
        <div style="margin-top:8px;">–ê—É–¥–∏–æ: <span id="audioState">–≤—ã–∫–ª</span></div>
      </div>

      <div class="tool" style="margin-top:12px;">
        <strong>–ö–æ–Ω—Ü–æ–≤–∫–∏</strong>
        <div style="margin-top:8px; color:var(--muted)">–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏" ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä—ã—Ç—ã –∏ —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="endingsBtn" class="btn">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ü–æ–≤–∫–∏</button>
          <button id="ritualBtn" class="btn secondary">–ò—Å–ø–æ–ª–Ω–∏—Ç—å —Ä–∏—Ç—É–∞–ª</button>
        </div>
      </div>

      <div class="tool" style="margin-top:12px;">
        <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong>
        <div style="margin-top:8px;">
          <label><input type="checkbox" id="toggleMusic"> –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</label><br>
          <label style="margin-top:6px"><input type="checkbox" id="toggleAmbience" checked> –¢—É–º–∞–Ω / —ç—Ñ—Ñ–µ–∫—Ç—ã</label>
        </div>
      </div>

      <div class="tool" style="margin-top:12px;">
        <strong>–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</strong>
        <div id="charsDesc" style="margin-top:8px; color:var(--muted)">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è (—Ä–æ—Å—Ç, –æ–±—É–≤—å, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏).</div>
      </div>
    </aside>
  </main>

  <!-- MODALS -->
  <div id="profilesModal" class="modal"><div class="card small"><h3>–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö</h3><div id="profilesContent" style="margin-top:10px"></div><div style="text-align:right; margin-top:12px;"><button id="closeProfiles" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="interrogateModal" class="modal"><div class="card"><h3>–î–æ–ø—Ä–æ—Å ‚Äî –ù–µ–π—Ä–æ—Å–µ—Ç—å –ø–æ–º–æ—â–Ω–∏–∫</h3>
    <div class="small" style="margin-top:6px">–°–ø—Ä–æ—Å–∏—Ç–µ —É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–≤–∏–¥–µ—Ç–µ–ª—è ‚Äî –Ω–µ–π—Ä–æ—Å–µ—Ç—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–ª–∏–∫ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π. (–≠—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ)</div>
    <div class="chat" id="chatWindow" style="margin-top:12px;"></div>
    <div style="display:flex; gap:8px; margin-top:8px;"><input id="chatInput" class="input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ì–¥–µ –≤—ã –±—ã–ª–∏ –≤ 23:00?)" style="flex:1; padding:8px; background:#0b0b0b; color:#efece6; border-radius:8px; border:1px solid rgba(255,255,255,0.03)"><button id="chatSend" class="btn">–°–ø—Ä–æ—Å–∏—Ç—å</button><button id="chatClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div></div>

  <div id="cipherModal" class="modal"><div class="card small"><h3>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (–¶–µ–∑–∞—Ä—å)</h3><div class="small" style="margin-top:6px">–í–≤–µ–¥–∏—Ç–µ —Å–¥–≤–∏–≥ (1‚Äì25)</div><div style="display:flex; gap:8px; margin-top:8px;"><input id="cipherShift" class="input" type="number" min="1" max="25" value="3" style="padding:8px; border-radius:8px;"><button id="cipherTryBtn" class="btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button></div><textarea id="cipherOutput" rows="4" class="input" style="margin-top:8px; width:100%; background:#0b0b0b; color:#efece6; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03)" readonly></textarea><div style="text-align:right; margin-top:8px;"><button id="cipherCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="puzzleModal" class="modal"><div class="card small"><h3>–ü–∞–∑–ª ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞—Ä—Ç—É</h3><div id="puzzleBoard" style="margin-top:12px; display:grid; gap:4px; grid-template-columns: repeat(3, 1fr);"></div><div style="text-align:right; margin-top:12px;"><button id="puzzleClose" class="btn secondary">–û—Ç–º–µ–Ω–∞</button></div></div></div>

  <div id="matchModal" class="modal"><div class="card small"><h3>–≠–º–±–ª–µ–º—ã ‚Äî –ù–∞–π–¥–∏—Ç–µ –≤–µ—Ä–Ω—É—é</h3><div id="matchArea" style="display:flex; gap:8px; margin-top:12px; justify-content:space-around;"></div><div style="text-align:right; margin-top:12px;"><button id="matchCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="endingsModal" class="modal"><div class="card"><h3>–ö–æ–Ω—Ü–æ–≤–∫–∏</h3><div id="endingsList" style="margin-top:12px" class="endings-grid"></div><div style="text-align:right; margin-top:12px;"><button id="endingsClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

  <div id="endingRevealModal" class="modal"><div class="card"><h3 id="endingTitle"></h3><div id="endingText" style="margin-top:12px; color:var(--muted)"></div><div style="text-align:right; margin-top:12px;"><button id="endingClose" class="btn">OK</button></div></div></div>

  <!-- audio -->
  <audio id="bgMusic" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2022/04/09/audio_2839a1de58.mp3" type="audio/mpeg"></audio>
  <audio id="ambience" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2021/08/04/audio_5f5a8f1f44.mp3" type="audio/mpeg"></audio>
  <audio id="clickSnd" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2023/03/03/audio_8f0b52d1b4.mp3?filename=interface-click-116929.mp3" type="audio/mpeg"></audio>
  <audio id="whisper" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_5f5a8f1f44.mp3?filename=whisper-ambient-6051.mp3" type="audio/mpeg"></audio>
  <div id="debug" aria-hidden="false"><strong>DEBUG</strong><div id="debugLog" style="white-space:pre-wrap; margin-top:8px; font-family:monospace; color:#cfcfcf">init...</div></div>

<script>
/* –ü–æ–ª–Ω–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞:
   - –ö–Ω–æ–ø–∫–∞ "–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É"
   - –î–æ–ø—Ä–æ—Å (–ª–æ–∫–∞–ª—å–Ω–∞—è "–Ω–µ–π—Ä–æ—Å–µ—Ç—å" ‚Äî —Å–∏–º—É–ª—è—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–ª–∏–∫ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π)
   - –ú–µ–Ω—é (–ù–∞—á–∞—Ç—å, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
   - –¢–µ–ª–µ—Ñ–æ–Ω (–∑–≤–æ–Ω–∫–∏/–ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–∞ —Å–∞–π—Ç—ã ‚Äî —Å–∏–º—É–ª—è—Ü–∏—è)
   - –ó–≤—É–∫–∏ (—Ñ–æ–Ω, ambience, click), –∞–Ω–∏–º–∞—Ü–∏–∏, —Ç—É–º–∞–Ω
   - –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: —Ä–æ—Å—Ç, –æ–±—É–≤—å, –ø—Ä–∏–º–µ—Ç—ã
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–Ω—Ü–æ–≤–æ–∫ –∏ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ autosave/manual
*/

/* ========== Helpers & Data ========== */
const LOG = (t)=>{ try{ const el=document.getElementById('debugLog'); if(el) el.textContent += '\\n' + t; console.log(t);}catch(e){} };
window.addEventListener('error', e=> LOG('ERROR: '+e.message+' @'+e.filename+':'+e.lineno) );

const DEFAULT_SUSPECTS = [
  { id:'adrian', name:'–≠–¥—Ä–∏–∞–Ω –†–æ—É–∑–≤—É–¥', role:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫', male:true, height:189, shoe:44, desc:'–•–æ–ª–æ–¥–Ω—ã–π, –±–æ–≥–∞—Ç—ã–π, —á–∞—Å—Ç–æ —Å—Å–æ—Ä–∏–ª—Å—è —Å –æ—Ç—Ü–æ–º.' },
  { id:'beatrice', name:'–ë–µ–∞—Ç—Ä–∏—Å –•–µ–π–≤—É–¥', role:'–î–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞', male:false, height:165, shoe:37, desc:'–¢–∏—Ö–∞—è, –Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è; –∑–Ω–∞–µ—Ç –≤—Å–µ —Ç–∞–π–Ω–∏–∫–∏.' },
  { id:'prof', name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ú–æ—Ä–¥–µ–Ω', role:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', male:true, height:178, shoe:42, desc:'–≠–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∏–º–≤–æ–ª–∞–º, —Å—Ç–∞—Ä—ã–π –¥—Ä—É–≥ —Å–µ–º—å–∏.' },
  { id:'victoria', name:'–í–∏–∫—Ç–æ—Ä–∏—è –†–æ—É–∑–≤—É–¥', role:'–ñ–µ–Ω–∞', male:false, height:172, shoe:39, desc:'–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞; –µ—Å—Ç—å –º–æ—Ç–∏–≤—ã –∑–∞–≤–ª–∞–¥–µ—Ç—å –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ–º.' },
  { id:'lina', name:'–õ–∏–Ω–∞ –ú–æ–Ω—Ç', role:'–ì–æ—Å—Ç—å—è', male:false, height:168, shoe:38, desc:'–ú–∏—Å—Ç–∏—á–µ—Å–∫–∞—è, –¥–µ—Ä–∂–∏—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.' }
];

const MASTER_CLUES = [
  { id:'cl1', title:'–¢–∞–π–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞)', room:'office', type:'cipher', text:'Vkr ghqv wrfkh', locked:true },
  { id:'cl2', title:'–°–ª–µ–¥ –æ–±—É–≤–∏', room:'garden', type:'foot', text:'–ü–æ–¥–æ—à–≤–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º B7', locked:false },
  { id:'cl3', title:'–†–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç', room:'library', type:'paper', text:'–í—ã—Ä–≤–∞–Ω–æ –∏–º—è, –ø–æ–º–µ—Ç–∫–∞: 12/11', locked:false },
  { id:'cl4', title:'–°–∏–º–≤–æ–ª –Ω–∞ —Å—Ç–µ–Ω–µ', room:'music', type:'symbol', text:'–°—Ç—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª ‚Äî —ç–º–±–ª–µ–º–∞', locked:false },
  { id:'cl5', title:'–ü–µ–ø–µ–ª –∏ –ø—è—Ç–Ω–∞ –º–∞—Å–ª–∞', room:'dining', type:'ash', text:'–ü–µ–ø–µ–ª –∏ —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ', locked:false },
  { id:'cl6', title:'–§—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã (—Å–æ–∂–∂–µ–Ω)', room:'basement', type:'puzzle', text:'–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã ‚Äî –Ω—É–∂–µ–Ω –ø–∞–∑–ª', locked:true },
  { id:'cl7', title:'–§–ª–∞–∫–æ–Ω —Å —ç—Ñ–∏—Ä–æ–º', room:'attic', type:'vial', text:'–†–µ–¥–∫–∏–π —ç—Ñ–∏—Ä ‚Äî –∑–∞–ø–∞—Ö –Ω–∞—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞ –º—ã—Å–ª—å', locked:false },
  { id:'cl8', title:'–ó–∞–ø–∏—Å–∫–∞ –≤ –∫–Ω–∏–≥–µ', room:'library', type:'note', text:'"–í–ª–∞—Å—Ç—å ‚Äî —á–µ—Ä–µ–∑ —Ç–∞–π–Ω—É" ‚Äî –ø–æ–¥–ø–∏—Å—å –í.', locked:false },
  { id:'cl9', title:'–ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç', room:'office', type:'seal', text:'–ö–æ–Ω–≤–µ—Ä—Ç —Å –ø–µ—á–∞—Ç—å—é', locked:true },
  { id:'cl10', title:'–ß–µ—Ä–Ω–∏–ª—å–Ω—ã–µ –±—Ä—ã–∑–≥–∏', room:'office', type:'ink', text:'–ß–µ—Ä–Ω–∏–ª–∞ Wyn ‚Äî —Ä–µ–¥–∫–∞—è —Ñ–∏—Ä–º–∞', locked:false },
  { id:'cl11', title:'–û—Ç–ø–µ—á–∞—Ç–æ–∫ –ø–µ—Ä—á–∞—Ç–∫–∏', room:'music', type:'glove', text:'–°–ª–µ–¥ –ø–µ—Ä—á–∞—Ç–∫–∏ —Å –≤–æ–ª–æ–∫–Ω–∞–º–∏', locked:false },
  { id:'cl12', title:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏', room:'attic', type:'cipher2', text:'Uifsf dbo zpv', locked:true }
];

const ENDINGS = [
  { id:'truth', title:'–ü—Ä–∞–≤–¥–∞ –∏ —Å—É–¥', desc:'–í—ã —Å–æ–±—Ä–∞–ª–∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî –≤–∏–Ω–æ–≤–Ω—ã–π –æ—Å—É–∂–¥—ë–Ω.', cond: s=> s.links['adrian'] && s.links['adrian'].length>=3 && s.timeline.length>=2 },
  { id:'frame', title:'–ü–æ–¥—Å—Ç–∞–≤–ª–µ–Ω', desc:'–í—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ø–æ–¥—Å—Ç–∞–≤—É ‚Äî –≤–∏–Ω–æ–≤–Ω–∏–∫ –æ—Å—Ç–∞–ª—Å—è –Ω–∞ —Å–≤–æ–±–æ–¥–µ.', cond: s=> s.links['beatrice'] && s.links['beatrice'].length>=2 && s.opened['cl6'] },
  { id:'society', title:'–¢–∞–π–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ', desc:'–†–∞—Å–∫—Ä—ã—Ç–∞ —Å–µ—Ç—å ‚Äî –¥–µ–ª–æ –±–æ–ª—å—à–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.', cond: s=> s.opened['cl4'] && s.opened['cl9'] },
  { id:'supernatural', title:'–ó–∞ –≥—Ä–∞–Ω—å—é', desc:'–°–≤–µ—Ä—Ö—ä–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∏–Ω–∞–ª: —Ä–∏—Ç—É–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.', cond: s=> s.opened['cl5'] && s.opened['cl7'] && s.ritualPerformed },
  { id:'open', title:'–ù–µ—Ä–∞—Å–∫—Ä—ã—Ç–æ', desc:'–ù–µ —Ö–≤–∞—Ç–∏–ª–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî –¥–µ–ª–æ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–∞–π–Ω–æ–π.', cond: s=> Object.values(s.links).flat().length < 3 }
];

/* ========== State ========== */
let state = {
  suspects: JSON.parse(JSON.stringify(DEFAULT_SUSPECTS)),
  clues: [],
  opened: {},      // map clause id => true
  links: {},       // suspectId => [clueId...]
  timeline: [],
  ritualPerformed: false,
  audioOn: false,
  fog: true,
  musicOn: false
};

/* ========== Init / Game Start ========== */
function saveToLocal(key, obj){ try{ localStorage.setItem('rose_'+key, JSON.stringify(obj)); LOG('Saved '+key); }catch(e){ LOG('save err '+e); } }
function loadFromLocal(key){ try{ const raw = localStorage.getItem('rose_'+key); return raw ? JSON.parse(raw) : null; }catch(e){ LOG('load err '+e); return null; } }

function newGame(){
  state.clues = JSON.parse(JSON.stringify(MASTER_CLUES));
  // add some random extra clues for replayability
  const extras = 2 + Math.floor(Math.random()*3);
  for(let i=0;i<extras;i++){
    const base = MASTER_CLUES[Math.floor(Math.random()*MASTER_CLUES.length)];
    const copy = Object.assign({}, base, { id: base.id + '_x' + i, title: base.title + ' (–≤—Å–ø–ª.)', locked: Math.random() < 0.4 });
    state.clues.push(copy);
  }
  state.opened = {}; state.links = {}; state.timeline = []; state.ritualPerformed = false; state.suspects = JSON.parse(JSON.stringify(DEFAULT_SUSPECTS));
  state.suspects = state.suspects.sort(()=>Math.random()-0.5);
  state.suspects.forEach(s=> state.links[s.id] = []);
  saveToLocal('autosave', state);
  renderAll();
  showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –£–¥–∞—á–∏, –¥–µ—Ç–µ–∫—Ç–∏–≤.');
}

/* ========== Rendering ========== */
function byId(id){ return document.getElementById(id); }

function renderSuspects(){
  const area = byId('suspectsList'); area.innerHTML = '';
  state.suspects.forEach((s, idx)=>{
    const div = document.createElement('div'); div.className='suspect';
    // try user female images if present (female1..3)
    let imgSrc = null;
    if(!s.male){
      const femaleIndex = state.suspects.filter(x=>!x.male).map(x=>x.id).indexOf(s.id);
      imgSrc = `assets/female${Math.min(3, femaleIndex+1)}.jpg`;
    }
    // add avatar tag ‚Äî if image doesn't exist browser falls back to broken image icon; it's okay
    const avatarHtml = imgSrc ? `<img class="avatar" src="${imgSrc}" alt="${s.name}">` : `<div class="avatar" style="display:grid; place-items:center">${s.name.split(' ')[0][0]}</div>`;
    div.innerHTML = `${avatarHtml}<div class="smeta"><div class="sname">${escape(s.name)}</div><div class="srole">${escape(s.role)}</div><div class="meta-row"><div>–†–æ—Å—Ç: ${s.height} —Å–º</div><div>–†–∞–∑–º–µ—Ä –æ–±—É–≤–∏: ${s.shoe}</div></div><div class="meta-row" style="margin-top:6px; color:var(--muted)">${escape(s.desc)}</div></div><div class="dropzone" data-suspect="${s.id}">${(state.links[s.id]||[]).length}</div>`;
    area.appendChild(div);
  });
  attachDropzones();
}

function renderClues(){
  const grid = byId('cluesGrid'); grid.innerHTML = '';
  state.clues.forEach(c=>{
    const el = document.createElement('div'); el.className='clue' + (state.opened[c.id] ? ' opened' : (c.locked ? ' locked' : ''));
    el.id = c.id; el.dataset.clue = c.id;
    el.innerHTML = `<div class="thumb">${getIcon(c.type)}</div><div><h4>${escape(c.title)}</h4><p>${ state.opened[c.id] ? escape(c.text) : (c.locked ? '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ / —Å–∫—Ä—ã—Ç–∞' : escape(c.text)) }</p></div>`;
    el.addEventListener('click', ()=> onClueClick(c));
    el.draggable = true;
    el.addEventListener('dragstart', ev=> ev.dataTransfer.setData('text/plain', c.id));
    grid.appendChild(el);
  });
  byId('totalClues').innerText = state.clues.length;
  byId('openedCount').innerText = Object.keys(state.opened).length;
}

function renderTimeline(){
  const el = byId('timelineList'); if(state.timeline.length===0) { el.innerHTML = '<div class="small" style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  el.innerHTML = state.timeline.slice().reverse().map(t=> `<div style="margin-bottom:6px">${escape(t.text)} <span style="color:var(--muted); font-size:0.82rem">(${new Date(t.time).toLocaleTimeString()})</span></div>`).join('');
}

function renderStats(){
  byId('linksCount').innerText = Object.values(state.links).flat().length;
  byId('ritualState').innerText = state.ritualPerformed ? '–¥–∞' : '–Ω–µ—Ç';
  updateProgress();
}

function populateAccuseSelect(){
  const sel = byId('accuseSelect'); sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
  state.suspects.forEach(s => { const opt=document.createElement('option'); opt.value=s.id; opt.textContent=s.name; sel.appendChild(opt); });
}

function renderProfilesModal(){
  const cont = byId('profilesContent'); cont.innerHTML = '';
  state.suspects.forEach(s=>{
    const div = document.createElement('div'); div.style.marginBottom='12px';
    const linked = state.links[s.id] ? state.links[s.id].length : 0;
    div.innerHTML = `<strong>${escape(s.name)}</strong> ‚Äî <em>${escape(s.role)}</em><div class="small" style="color:var(--muted); margin-top:6px">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe} ¬∑ –£–ª–∏–∫: ${linked}</div><div style="margin-top:6px">${escape(s.desc)}</div>`;
    cont.appendChild(div);
  });
}

/* ========== Interactions ========== */
function onClueClick(c){
  LOG('clue clicked '+c.id);
  if(c.locked && !state.opened[c.id]){
    // open right tool
    if(c.type === 'cipher' || c.type === 'cipher2') { openCipherModal(c); return; }
    if(c.type === 'puzzle') { openPuzzleModal(); return; }
    if(c.type === 'symbol' || c.type === 'seal') { openMatchModal(c); return; }
    showToast('–£–ª–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.');
    return;
  }
  if(!state.opened[c.id]){ state.opened[c.id] = true; revealClueText(c); renderClues(); renderStats(); updateHint(); return; }
  // else show details
  showDetailModal(c.title, c.text);
}

function revealClueText(c){
  if(c.type === 'cipher' && c.text === 'Vkr ghqv wrfkh') c.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª';
  if(c.type === 'puzzle' && c.text.includes('–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã')) c.text = '–ö–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: –µ—Å—Ç—å –æ—Ç–º–µ—Ç–∫–∞ —Å–∫—Ä—ã—Ç–æ–≥–æ —Ö–æ–¥–∞ –º–µ–∂–¥—É –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –∏ –ø–æ–¥–≤–∞–ª–æ–º.';
  state.opened[c.id] = true;
}

function showDetailModal(title, text){
  byId('endingTitle').innerText = title;
  byId('endingText').innerHTML = `<div style="color:var(--muted)">${escape(text)}</div>`;
  byId('endingRevealModal').style.display = 'flex';
}

/* ========== Mini-games & Tools ========== */
function openCipherModal(clue){
  const modal = byId('cipherModal'); modal.style.display='flex'; modal.dataset.clue = clue ? clue.id : '';
  byId('cipherOutput').value = '';
  byId('cipherShift').value = 3;
}
function tryCipher(){
  const shift = Number(byId('cipherShift').value) || 0;
  const clueId = byId('cipherModal').dataset.clue;
  const clue = state.clues.find(c=>c.id===clueId) || state.clues.find(c=>c.type==='cipher' || c.type==='cipher2');
  if(!clue){ showToast('–ó–∞–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.'); return; }
  const decoded = caesarDecode(clue.text, shift);
  byId('cipherOutput').value = decoded;
  if(/–æ–Ω –∑–Ω–∞–µ—Ç|–≤\./i.test(decoded) || shift===3){
    showToast('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞!');
    clue.locked = false; clue.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª'; state.opened[clue.id]=true;
    renderClues(); renderStats(); updateHint();
    byId('cipherModal').style.display='none';
  }
}
function caesarDecode(s, shift){
  if(!s) return s;
  const a='abcdefghijklmnopqrstuvwxyz';
  const A=a.toUpperCase();
  return s.split('').map(ch=>{
    if(a.includes(ch)) return a[(a.indexOf(ch)-shift+26)%26];
    if(A.includes(ch)) return A[(A.indexOf(ch)-shift+26)%26];
    return ch;
  }).join('');
}

/* Puzzle 3x3 (simple click-swap for accessibility) */
let puzzleSolved=false;
function openPuzzleModal(){
  const modal = byId('puzzleModal'); modal.style.display='flex';
  const board = byId('puzzleBoard'); board.innerHTML='';
  const nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
  nums.forEach(n=>{
    const p = document.createElement('div'); p.style.background='#201612'; p.style.color='#d9c8ae'; p.style.display='grid'; p.style.placeItems='center'; p.style.height='80px'; p.style.borderRadius='6px'; p.style.cursor='pointer';
    p.textContent = n===9 ? '' : n; p.dataset.num = n;
    p.addEventListener('click', ()=> { clickPuzzlePiece(board, p); });
    board.appendChild(p);
  });
}
function clickPuzzlePiece(board, piece){
  const empty = Array.from(board.children).find(c=>c.dataset.num=='9');
  if(!empty) return;
  const idx = Array.from(board.children).indexOf(piece), eidx = Array.from(board.children).indexOf(empty);
  const dist = Math.abs(idx-eidx);
  if(dist === 1 || dist === 3){
    // swap
    const t = piece.dataset.num; piece.dataset.num = empty.dataset.num; empty.dataset.num = t;
    const tmp = piece.textContent; piece.textContent = empty.textContent; empty.textContent = tmp;
    checkPuzzleSolved(board);
  }
}
function checkPuzzleSolved(board){
  const order = Array.from(board.children).map(c=>Number(c.dataset.num));
  const ok = order.every((v,i)=> v===i+1);
  if(ok && !puzzleSolved){
    puzzleSolved=true;
    const clue = state.clues.find(c=>c.type==='puzzle');
    if(clue){ clue.locked=false; clue.text='–ö–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: –Ω–∞–π–¥–µ–Ω —Å–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ö–æ–¥.'; state.opened[clue.id]=true; renderClues(); renderStats(); updateHint(); }
    showToast('–ü–∞–∑–ª —Ä–µ—à—ë–Ω ‚Äî –∫–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
    byId('puzzleModal').style.display='none';
  }
}

/* Emblem match */
function openMatchModal(clue){
  const modal = byId('matchModal'); modal.style.display='flex';
  const area = byId('matchArea'); area.innerHTML='';
  const opts = [{id:'A',ok:false},{id:'B',ok:true},{id:'C',ok:false}].sort(()=>Math.random()-0.5);
  opts.forEach(o=>{
    const btn = document.createElement('div'); btn.style.width='120px'; btn.style.height='120px'; btn.style.borderRadius='8px'; btn.style.background='#211815'; btn.style.display='grid'; btn.style.placeItems='center'; btn.style.cursor='pointer'; btn.innerHTML=`<div>${o.id}</div>`;
    btn.addEventListener('click', ()=>{
      if(o.ok){
        showToast('–≠–º–±–ª–µ–º–∞ —Å–æ–≤–ø–∞–ª–∞ ‚Äî —É–ª–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞.');
        const target = (clue && state.clues.find(x=>x.id===clue.id)) || state.clues.find(x=>x.type==='symbol');
        if(target){ target.locked=false; state.opened[target.id]=true; renderClues(); renderStats(); updateHint(); }
        modal.style.display='none';
      } else { showToast('–ù–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é.'); }
    });
    area.appendChild(btn);
  });
}

/* ========== Drag & Drop Evidence linking ========== */
function attachDropzones(){
  document.querySelectorAll('.dropzone').forEach(zone=>{
    zone.addEventListener('dragover', ev=>{ ev.preventDefault(); zone.style.outline='2px dashed rgba(176,138,92,0.6)'; });
    zone.addEventListener('dragleave', ev=> zone.style.outline='');
    zone.addEventListener('drop', ev=> {
      ev.preventDefault(); zone.style.outline='';
      const clueId = ev.dataTransfer.getData('text/plain'); const suspectId = zone.dataset.suspect;
      if(clueId && suspectId) linkEvidence(suspectId, clueId);
    });
  });
}

function linkEvidence(suspectId, clueId){
  if(!state.links[suspectId]) state.links[suspectId]=[];
  if(state.links[suspectId].includes(clueId)){ showToast('–£–ª–∏–∫–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞'); return; }
  state.links[suspectId].push(clueId);
  showToast(`–£–ª–∏–∫–∞ ${clueId} –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ ${suspectId}`);
  renderSuspects(); renderStats();
  saveToLocal('autosave', state);
}

/* ========== Interrogate (local "neural" simulation) ========== */
function openInterrogation(){
  const modal = byId('interrogateModal'); modal.style.display='flex';
  const chat = byId('chatWindow'); chat.innerHTML = '';
  addChatAI('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–≤–∏–¥–µ—Ç–µ–ª—å. –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è, —è –æ—Ç–≤–µ—á—É —á–µ—Å—Ç–Ω–æ... (—Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ).');
}
function addChatAI(text){
  const chat = byId('chatWindow'); const m = document.createElement('div'); m.className='msg ai'; m.textContent = text; chat.appendChild(m); chat.scrollTop = chat.scrollHeight;
}
function addChatUser(text){
  const chat = byId('chatWindow'); const m = document.createElement('div'); m.className='msg user'; m.textContent = text; chat.appendChild(m); chat.scrollTop = chat.scrollHeight;
}
function handleChatAsk(){
  const inp = byId('chatInput'); const q = inp.value.trim(); if(!q) return;
  addChatUser(q); inp.value='';
  // Local "neural" response: simple rule-based combining clues & suspect info
  setTimeout(()=>{
    const resp = generateAIResponse(q);
    addChatAI(resp);
  }, 600 + Math.random()*800);
}
function generateAIResponse(question){
  // Very simple heuristic: inspect timeline, clues, suspects for keywords
  const ql = question.toLowerCase();
  if(ql.includes('–≥–¥–µ') && ql.includes('–±—ã–ª–∏')) return '–Ø –≤–∏–¥–µ–ª(–∞) –∫–æ–≥–æ-—Ç–æ –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ –æ–∫–æ–ª–æ 23:00. –¢–µ–Ω—å —à–ª–∞ –æ—Ç –∫–∞–±–∏–Ω–µ—Ç–∞ –∫ —Å–∞–¥—É.';
  if(ql.includes('–∞–¥—Ä–∏–∞–Ω') || ql.includes('—ç–¥—Ä–∏–∞–Ω')) {
    if(state.links['adrian'] && state.links['adrian'].length>1) return '–≠–¥—Ä–∏–∞–Ω –Ω–µ—Ä–≤–Ω–∏—á–∞–ª –∏ —á–∞—Å—Ç–æ –ª–≥–∞–ª –≤ –ø–æ–∫–∞–∑–∞–Ω–∏—è—Ö. –£ –Ω–µ–≥–æ –º–æ—Ç–∏–≤.';
    return '–≠–¥—Ä–∏–∞–Ω –±—ã–ª –≤ —Å–≤–æ–µ–π –∫–æ–º–Ω–∞—Ç–µ, –Ω–æ –µ—Å—Ç—å —Å–≤–∏–¥–µ—Ç–µ–ª–∏, —á—Ç–æ –æ–Ω –≤—ã—Ö–æ–¥–∏–ª –Ω–æ—á—å—é.';
  }
  if(ql.includes('–∑–∞–ø–∏—Å–∫–∞') || ql.includes('—à–∏—Ñ—Ä')) return '–í –∑–∞–ø–∏—Å–∫–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –±—É–∫–≤–∞ "–í." –∏ —Ñ—Ä–∞–∑–∞ "–û–Ω –∑–Ω–∞–µ—Ç". –í–æ–∑–º–æ–∂–Ω–æ, –∏–Ω–∏—Ü–∏–∞–ª—ã.';
  if(ql.includes('—Å–∏–º–≤–æ–ª') || ql.includes('—ç–º–±–ª–µ–º')) return '–°–∏–º–≤–æ–ª –ø–æ—Ö–æ–∂ –Ω–∞ —Å–µ–º–µ–π–Ω—É—é –ø–µ—á–∞—Ç—å ‚Äî –ø–æ–∏—â–∏—Ç–µ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ö.';
  // fallback: combine random clue text
  const opened = Object.keys(state.opened);
  if(opened.length===0) return '–Ø –º–∞–ª–æ —á—Ç–æ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–ª–∏–∫ –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å.';
  const sample = state.clues.find(c=> state.opened[c.id]) || state.clues[0];
  return '–°—É–¥—è –ø–æ —É–ª–∏–∫e: "' + (sample.text || sample.title) + '". –≠—Ç–æ –≤–∞–∂–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞.';
}

/* ========== Find killer / Accuse ========== */
function tryFindKiller(){
  // Quick heuristic: count linked clues per suspect and timeline events
  const counts = state.suspects.map(s=>({ id:s.id, name:s.name, c: (state.links[s.id]||[]).length }));
  counts.sort((a,b)=>b.c-a.c);
  const top = counts[0];
  if(!top || top.c===0){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤. –û—Ç–∫—Ä–æ–π—Ç–µ –∏ —Å–≤—è–∂–∏—Ç–µ —É–ª–∏–∫–∏.'); return; }
  const candidate = top.id;
  // evaluate possible endings and show
  byId('accuseSelect').value = candidate;
  showToast('–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —É–±–∏–π—Ü–∞: ' + top.name);
  // Immediately evaluate endings for this candidate
  accuseSelected();
}

function accuseSelected(){
  const sel = byId('accuseSelect'); const id = sel.value;
  if(!id){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ –¥–ª—è –æ–±–≤–∏–Ω–µ–Ω–∏—è'); return; }
  // find matching endings
  const matched = ENDINGS.filter(e => e.cond(state));
  if(matched.length>0){
    // prefer first
    showEnding(matched[0].id); return;
  }
  // fallback heuristics
  const links = state.links[id] || [];
  if(links.length>=3 && id === 'adrian') { showEnding('truth'); return; }
  if(state.ritualPerformed && state.links[id] && state.links[id].length>=1) { showEnding('supernatural'); return; }
  showEnding('open');
}

/* ========== Endings UI ========== */
function showEndingsList(){
  const list = byId('endingsList'); list.innerHTML='';
  ENDINGS.forEach(e=>{
    const card = document.createElement('div'); card.className='ending-card'; card.style.padding='10px'; card.style.borderRadius='8px'; card.style.border='1px solid rgba(255,255,255,0.03)';
    const unlocked = e.cond(state);
    card.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong>${escape(e.title)}</strong><div style="color:${unlocked ? '#9fff9f' : '#cfcfcf'}">${unlocked ? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}</div></div><div style="color:var(--muted); margin-top:6px">${escape(e.desc)}</div>`;
    card.addEventListener('click', ()=> {
      if(unlocked) showEnding(e.id); else showToast('–≠—Ç–∞ –∫–æ–Ω—Ü–æ–≤–∫–∞ –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ.');
    });
    list.appendChild(card);
  });
  byId('endingsModal').style.display='flex';
}
function showEnding(id){
  const e = ENDINGS.find(x=>x.id===id);
  if(!e) return;
  byId('endingTitle').innerText = e.title;
  byId('endingText').innerText = e.desc;
  byId('endingRevealModal').style.display='flex';
  // log
  const hist = JSON.parse(localStorage.getItem('rose_endings') || '[]'); hist.unshift({ id:e.id, time:new Date().toISOString() }); localStorage.setItem('rose_endings', JSON.stringify(hist.slice(0,50)));
}

/* ========== Phone UI ========== */
function phoneCall(){
  const inp = byId('phoneInput'); const val = inp.value.trim();
  const log = byId('phoneLog');
  if(!val) return;
  if(val.includes('.') || val.includes('http')) {
    // open site (simulate) ‚Äî open in new window to example or search
    const url = val.startsWith('http') ? val : 'http://' + val;
    window.open(url, '_blank');
    log.innerHTML = `<div style="color:var(--muted)">–û—Ç–∫—Ä—ã—Ç —Å–∞–π—Ç: ${escape(val)}</div>` + log.innerHTML;
    showToast('–û—Ç–∫—Ä—ã—Ç —Å–∞–π—Ç (—Å–∏–º—É–ª—è—Ü–∏—è).');
  } else {
    // dial numeric: simulate caller info
    log.innerHTML = `<div style="color:var(--muted)">–í—ã–∑–æ–≤ ${escape(val)} ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>` + log.innerHTML;
    setTimeout(()=> {
      log.innerHTML = `<div style="color:var(--muted)">–û—Ç–≤–µ—Ç: "–í—ã –¥–æ–∑–≤–æ–Ω–∏–ª–∏—Å—å –¥–æ –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ—á—Ç—ã."</div>` + log.innerHTML;
    }, 1200);
  }
}

/* ========== Ritual ========== */
function performRitual(){
  if(state.ritualPerformed){ showToast('–†–∏—Ç—É–∞–ª —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω.'); return; }
  if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç—å —Ä–∏—Ç—É–∞–ª? –≠—Ç–æ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ö–æ–¥ –¥–µ–ª–∞.')) return;
  state.ritualPerformed = true;
  showToast('–•–æ–ª–æ–¥–Ω—ã–π –≤–µ—Ç–µ—Ä... –ß—Ç–æ-—Ç–æ –ø—Ä–æ–±—É–¥–∏–ª–æ—Å—å.');
  // unlock special clue
  const special = { id:'cl_ritual', title:'–†–∏—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏', room:'basement', type:'ritual', text:'–ó–∞—Ç–µ–Ω—ë–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª–∏–Ω–∏–∏ –∫—Ä–æ–≤–∏', locked:false };
  state.clues.push(special); state.opened[special.id] = true;
  renderClues(); renderStats();
}

/* ========== UI Utilities ========== */
function showToast(text){
  const d = document.createElement('div'); d.textContent = text; d.style.position='fixed'; d.style.left='50%'; d.style.bottom='20px'; d.style.transform='translateX(-50%)'; d.style.background='rgba(0,0,0,0.85)'; d.style.color='#fff'; d.style.padding='10px 14px'; d.style.borderRadius='8px'; d.style.zIndex=99999; document.body.appendChild(d);
  setTimeout(()=>{ d.style.transition='opacity .6s'; d.style.opacity=0; setTimeout(()=> d.remove(),600); }, 1600);
}
function escape(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function getIcon(type){
  switch(type){ case 'cipher': return '‚úâÔ∏è'; case 'puzzle': return 'üß©'; case 'symbol': return 'üî±'; case 'vial': return 'üß™'; case 'foot': return 'üë£'; case 'ink': return 'üñãÔ∏è'; default: return 'üîé'; }
}

/* ========== Audio & Ambience ========== */
const bgMusic = byId('bgMusic'), ambience = byId('ambience'), clickSnd = byId('clickSnd'), whisper = byId('whisper');
function toggleAudio(){
  state.audioOn = !state.audioOn;
  byId('audioState').innerText = state.audioOn ? '–≤–∫–ª' : '–≤—ã–∫–ª';
  byId('audioToggle').innerText = state.audioOn ? '–ó–≤—É–∫: –≤–∫–ª' : '–ó–≤—É–∫: –≤—ã–∫–ª';
  if(state.audioOn){ if(byId('toggleMusic').checked){ bgMusic.volume=0.14; bgMusic.play().catch(()=>{}); } ambience.volume = 0.22; ambience.play().catch(()=>{}); } else { bgMusic.pause(); ambience.pause(); whisper.pause(); }
}

/* ========== Hint & Progress ========== */
function updateHint(){
  const opened = Object.keys(state.opened).length;
  const h = byId('quickHelp');
  if(opened>=8) h.innerText = '–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—á–∞—Ç—å –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–µ –∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∏.';
  else if(opened>=4) h.innerText = '–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ä–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ –∑–∞–ø–∏—Å–∫—É –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª—ã –Ω–∞ —Å—Ç–µ–Ω–µ.';
  else h.innerText = '–û—Ç–∫—Ä–æ–π—Ç–µ —Ö–æ—Ç—è –±—ã 3 —É–ª–∏–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É.';
}
function updateProgress(){
  const opened = Object.keys(state.opened).length + Object.values(state.links).flat().length;
  const total = state.clues.length + 2;
  const pct = Math.min(100, Math.round((opened/total)*100));
  byId('progressPct').innerText = pct + '%';
}

/* ========== Event wiring ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  LOG('Initializing UI');
  // wire menu
  byId('menuStart').addEventListener('click', ()=> { if(confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É?')) newGame(); });
  byId('menuHelp').addEventListener('click', ()=> alert(document.getElementById('quickHelp').innerText));
  byId('menuSettings').addEventListener('click', ()=> alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏.'));
  byId('menuLoad').addEventListener('click', ()=> { const s = loadFromLocal('manual_save'); if(s){ if(confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ?')) { state = s; renderAll(); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ'); } } else showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –Ω–µ—Ç'); });

  // hotspots
  document.querySelectorAll('.hotspot').forEach(h => h.addEventListener('click', ()=> { const room = h.dataset.room; inspectRoom(room); if(state.audioOn) clickSnd.play(); }));

  // tools buttons
  byId('cipherBtn').addEventListener('click', ()=> openCipherModal(null));
  byId('cipherTryBtn').addEventListener('click', tryCipher);
  byId('cipherCloseBtn').addEventListener('click', ()=> byId('cipherModal').style.display='none');
  byId('puzzleBtn').addEventListener('click', openPuzzleModal);
  byId('puzzleClose').addEventListener('click', ()=> byId('puzzleModal').style.display='none');
  byId('matchBtn').addEventListener('click', ()=> openMatchModal(null));
  byId('matchCloseBtn').addEventListener('click', ()=> byId('matchModal').style.display='none');

  // timeline
  byId('addTimeline').addEventListener('click', ()=> { const v = byId('timelineInput').value.trim(); if(!v) return; state.timeline.push({ text:v, time:new Date().toISOString() }); byId('timelineInput').value=''; renderTimeline(); saveToLocal('autosave', state); });

  // phone
  byId('phoneCall').addEventListener('click', phoneCall);

  // interrogation
  byId('interrogateBtn').addEventListener('click', openInterrogation);
  byId('chatSend').addEventListener('click', handleChatAsk);
  byId('chatClose').addEventListener('click', ()=> byId('interrogateModal').style.display='none');

  // phone & accusing
  byId('callBtn').addEventListener('click', ()=> { const v = prompt('–ù–æ–º–µ—Ä –∏–ª–∏ —Å–∞–π—Ç (–ø—Ä–∏–º–µ—Ä: 88 –∏–ª–∏ example.com)'); if(v){ byId('phoneInput').value = v; phoneCall(); }});
  byId('findKiller').addEventListener('click', tryFindKiller);
  byId('accuseBtn').addEventListener('click', accuseSelected);

  // endings & ritual
  byId('endingsBtn').addEventListener('click', showEndingsList);
  byId('ritualBtn').addEventListener('click', performRitual);

  // profiles modal
  byId('profilesBtn').addEventListener('click', ()=> { renderProfilesModal(); byId('profilesModal').style.display='flex'; });
  byId('closeProfiles').addEventListener('click', ()=> byId('profilesModal').style.display='none');

  // save/load
  byId('saveNotes').addEventListener('click', ()=> { localStorage.setItem('rose_notes', byId('notebook').value||''); showToast('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'); });
  byId('clearNotes').addEventListener('click', ()=> { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏?')) { byId('notebook').value=''; localStorage.removeItem('rose_notes'); } });

  byId('audioToggle').addEventListener('click', ()=> {
    state.audioOn = !state.audioOn; if(state.audioOn){ bgMusic.volume=0.12; ambience.volume=0.2; bgMusic.play().catch(()=>{}); ambience.play().catch(()=>{}); } else { bgMusic.pause(); ambience.pause(); }
    byId('audioToggle').innerText = state.audioOn ? '–ó–≤—É–∫: –≤–∫–ª' : '–ó–≤—É–∫: –≤—ã–∫–ª';
    byId('audioState').innerText = state.audioOn ? '–≤–∫–ª' : '–≤—ã–∫–ª';
  });

  byId('endingsClose').addEventListener('click', ()=> byId('endingsModal').style.display='none');
  byId('endingClose').addEventListener('click', ()=> byId('endingRevealModal').style.display='none');

  // toggle music & ambience
  byId('toggleMusic').addEventListener('change', e=> {
    state.musicOn = e.target.checked;
    if(state.musicOn && state.audioOn){ bgMusic.play().catch(()=>{}); } else { bgMusic.pause(); }
  });
  byId('toggleAmbience').addEventListener('change', e=> { state.fog = e.target.checked; toggleFog(state.fog); });

  // load notes
  const notes = localStorage.getItem('rose_notes'); if(notes) byId('notebook').value = notes;

  // attempt autoload autosave
  const autos = loadFromLocal('autosave'); if(autos && confirm('–ù–∞–π–¥–µ–Ω –∞–≤—Ç–æ—Å–µ–π–≤. –ó–∞–≥—Ä—É–∑–∏—Ç—å?')) { state = autos; renderAll(); showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω'); } else newGame();

  LOG('UI ready');
});

/* ========== Misc functions ========== */
function renderAll(){ renderSuspects(); renderClues(); renderTimeline(); renderStats(); populateAccuseSelect(); renderProfilesModal(); updateHint(); attachDropzones(); }
function inspectRoom(room){
  const found = state.clues.filter(c=> c.room === room);
  if(found.length===0){ showToast('–ù–∏—á–µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ.'); return; }
  found.forEach(c=> {
    const el = document.getElementById(c.id);
    if(!c.locked) state.opened[c.id] = true;
    else if(el) el.querySelector('p').textContent = '–ù–∞–π–¥–µ–Ω–∞, –Ω–æ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç';
  });
  renderClues(); renderStats(); updateHint();
  showToast(`–û—Å–º–æ—Ç—Ä–µ–Ω–æ ${room}: –Ω–∞–π–¥–µ–Ω–æ ${found.length} —É–ª–∏–∫.`);
}
function updateProgress(){ const openedCount = Object.keys(state.opened).length; const total = state.clues.length + 2; const pct = Math.min(100, Math.round((openedCount/total)*100)); byId('progressPct').innerText = pct+'%'; }

/* ========== Utilities ========== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

/* ========== End of script ========== */
</script>
</body>
</html>
