<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥ ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060607;
  --panel:#141214;
  --accent:#b08a5c;
  --muted:#cfcfcf;
  --danger:#b04a4a;
  --coin:#ffd166;
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#040405 0%, #0b0b0d 80%); color:#efece6; -webkit-font-smoothing:antialiased;}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;z-index:80;background:rgba(6,6,6,0.6)}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#2b1f18,#191010);display:grid;place-items:center;font-family:Cinzel,serif;font-size:18px;color:#f7efe7;border:1px solid rgba(255,255,255,0.03)}
.container{max-width:1200px;margin:18px auto;padding:14px;display:grid;grid-template-columns:320px 1fr 360px;gap:18px;align-items:start}
@media (max-width:1100px){.container{grid-template-columns:1fr}.right-panel{order:3}}
.panel{background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(255,255,255,0.008));padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.02);box-shadow:0 14px 36px rgba(0,0,0,0.65)}
.small{color:var(--muted);font-size:0.92rem}
.btn{background:var(--accent);color:#070707;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
.hud{display:flex;gap:12px;align-items:center;font-size:0.95rem;color:var(--muted)}
.coins{background:linear-gradient(90deg,#ffd166,#ffb703);color:#2b2b2b;padding:6px 10px;border-radius:8px;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
.suspect{display:flex;gap:12px;align-items:center;padding:10px;margin-top:10px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.avatar{width:64px;height:64px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.03);background:#1b1412}
.smeta{flex:1}
.map{position:relative;border-radius:12px;overflow:hidden;padding:10px;min-height:420px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,rgba(0,0,0,0.22),rgba(0,0,0,0.36))}
.map-canvas{width:100%;border-radius:8px;overflow:hidden;background:linear-gradient(180deg,#231a17,#1b1411);display:block;position:relative;height:340px}
.hotspot{position:absolute;transform:translate(-50%,-50%);background:linear-gradient(180deg,rgba(176,138,92,0.14),rgba(176,138,92,0.08));padding:8px 12px;border-radius:999px;font-weight:700;color:#120b06;cursor:pointer;border:1px solid rgba(176,138,92,0.12);box-shadow:0 10px 28px rgba(0,0,0,0.6);user-select:none;transition:transform .14s ease}
.hotspot:hover{transform:translate(-50%,-50%) scale(1.05)}
.clues{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.clue{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
.thumb{width:56px;height:56px;border-radius:8px;background:#201612;display:grid;place-items:center;font-size:18px;color:#d9c8ae}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.85))}
.card{width:760px;max-width:94%;background:linear-gradient(180deg,#121212,#0f0f0f);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);color:#efece6;box-shadow:0 30px 80px rgba(0,0,0,0.8)}
.card.small{width:520px;max-width:92%}
.attack-options{display:flex;gap:8px;margin-top:12px}
.countdown{font-weight:800;color:#ffd166}
.minigame-img{width:100%;height:180px;object-fit:cover;border-radius:8px}
.blood-overlay{position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 20% 30%, rgba(180,20,20,0.22) 0 6%, transparent 12%), radial-gradient(circle at 70% 50%, rgba(120,10,10,0.16) 0 8%, transparent 14%);mix-blend-mode:multiply;opacity:0;transition:opacity .6s}
.blood-overlay.on{opacity:1}
.debug{position:fixed;right:12px;bottom:12px;width:320px;max-height:260px;overflow:auto;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(8,8,8,0.85));color:#fff;border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.03);font-size:12px;z-index:99998}
.note{color:var(--muted);font-size:0.9rem}
</style>
</head>
<body>

<!-- MENU (start must be clicked to enable audio) -->
<div id="menuScreen" class="modal" style="display:flex;align-items:center;justify-content:center;z-index:99999">
  <div class="card small" style="width:900px;display:flex;gap:12px;">
    <div style="flex:0 0 420px;border-right:1px solid rgba(255,255,255,0.02);padding-right:12px">
      <h1 style="font-family:Cinzel,serif;margin:0">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</h1>
      <p class="note">–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–∞—è –∏–≥—Ä–∞: —É–ª–∏–∫–∏, –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã, –î–ù–ö‚Äë–∞–Ω–∞–ª–∏–∑ –∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
      <div style="margin-top:16px;display:flex;gap:8px">
        <button id="startBtn" class="btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="enableSound" class="btn secondary">–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</button>
        <button id="loadBtn" class="btn secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤</button>
      </div>
      <p class="note" style="margin-top:10px">–ù–∞–∂–º–∏—Ç–µ –ù–∞—á–∞—Ç—å ‚Äî —ç—Ç–æ –¥–∞—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∂–µ—Å—Ç –∏ –ø–æ–∑–≤–æ–ª–∏—Ç –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç—å –∑–≤—É–∫.</p>
    </div>
    <div style="flex:1;padding-left:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞</strong></div>
        <div class="hud">–ú–æ–Ω–µ—Ç—ã: <span id="coinDisplay" class="coins">0</span></div>
      </div>
      <p class="note" style="margin-top:8px">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—ã ‚Üí —Ä–µ—à–∞–π—Ç–µ –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã ‚Üí —Å–≤—è–∑—ã–≤–∞–π—Ç–µ —É–ª–∏–∫–∏ —Å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–º–∏ ‚Üí –¥–æ–ø—Ä–æ—Å—ã / –î–ù–ö ‚Üí –æ–±–≤–∏–Ω–µ–Ω–∏–µ.</p>
    </div>
  </div>
</div>

<!-- HEADER -->
<header class="header">
  <div style="display:flex;gap:12px;align-items:center">
    <div class="logo">–†</div>
    <div>
      <div style="font-family:Cinzel,serif">–£–±–∏–π—Å—Ç–≤–æ –≤ –æ—Å–æ–±–Ω—è–∫–µ –†–æ—É–∑–≤—É–¥</div>
      <div class="small">–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî —Å –∞–Ω–∞–ª–∏–∑–æ–º –î–ù–ö –∏ –æ–ø–∞—Å–Ω–æ—Å—Ç—è–º–∏</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="hud">–ú–æ–Ω–µ—Ç—ã: <span id="coinDisplayTop" class="coins">0</span></div>
    <div class="hud">–ó–¥–æ—Ä–æ–≤—å–µ: <progress id="healthBar" max="100" value="100" style="width:120px"></progress></div>
    <button id="menuOpenBtn" class="btn secondary">–ú–µ–Ω—é</button>
  </div>
</header>

<!-- MAIN -->
<main class="container" role="main" aria-live="polite">
  <!-- LEFT -->
  <aside class="panel left-panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong style="font-family:Cinzel,serif">–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ</strong>
      <button id="profilesBtn" class="btn secondary">–ü—Ä–æ—Ñ–∏–ª–∏</button>
    </div>
    <div id="suspectsList" style="margin-top:12px;max-height:420px;overflow:auto"></div>

    <div style="margin-top:14px">
      <strong>–ë–ª–æ–∫–Ω–æ—Ç</strong>
      <textarea id="notebook" rows="6" style="width:100%;margin-top:8px;background:#0b0b0b;color:#efece6;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03)"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveNotes" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="clearNotes" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="partnerHelp" class="btn">–ü–æ–º–æ—â—å –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <strong>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</strong>
      <div class="note" style="margin-top:8px">–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –î–ù–ö‚Äë—Ç–µ—Å—Ç, –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏, –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤ –∏ —Ç–æ–∫—Å–∏–∫–æ–ª–æ–≥–∏—é.</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="dnaLab" class="btn">–î–ù–ö‚Äë—Ç–µ—Å—Ç</button>
        <button id="bloodLab" class="btn secondary">–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏</button>
        <button id="fpLab" class="btn secondary">–û—Ç–ø–µ—á–∞—Ç–∫–∏</button>
      </div>
    </div>
  </aside>

  <!-- CENTER -->
  <section class="panel map-panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-family:Cinzel,serif;font-size:1.05rem">–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="findKiller" class="btn">–£–∑–Ω–∞—Ç—å —É–±–∏–π—Ü—É</button>
        <button id="interrogateBtn" class="btn secondary">–î–æ–ø—Ä–æ—Å</button>
        <button id="phoneOpenBtn" class="btn secondary">–¢–µ–ª–µ—Ñ–æ–Ω</button>
        <button id="revealBlood" class="btn secondary">–ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–æ–≤—å</button>
      </div>
    </div>

    <div class="map">
      <div class="map-canvas" id="mapCanvas" aria-label="–ö–∞—Ä—Ç–∞ –æ—Å–æ–±–Ω—è–∫–∞">
        <div class="hotspot" data-room="library" style="left:18%;top:22%">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div class="hotspot" data-room="music" style="left:48%;top:18%">üéπ –ú—É–∑—ã–∫–∞</div>
        <div class="hotspot" data-room="office" style="left:76%;top:22%">üóÑ –ö–∞–±–∏–Ω–µ—Ç</div>
        <div class="hotspot" data-room="dining" style="left:34%;top:56%">üçΩ –°—Ç–æ–ª–æ–≤–∞—è</div>
        <div class="hotspot" data-room="garden" style="left:14%;top:78%">üåπ –°–∞–¥</div>
        <div class="hotspot" data-room="basement" style="left:74%;top:76%">‚öôÔ∏è –ü–æ–¥–≤–∞–ª</div>
        <div class="hotspot" data-room="attic" style="left:54%;top:44%">üï∞ –ß–µ—Ä–¥–∞–∫</div>

        <div id="bloodOverlay" class="blood-overlay"></div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>–£–ª–∏–∫–∏</strong>
            <div><span id="openedCount">0</span> / <span id="totalClues">0</span></div>
          </div>
          <div id="cluesGrid" class="clues" style="margin-top:10px;max-height:260px;overflow:auto"></div>
        </div>

        <div style="width:320px">
          <div class="panel small">
            <strong>–¢–∞–π–º–ª–∞–π–Ω</strong>
            <div id="timelineList" style="margin-top:8px;min-height:80px;color:var(--muted)"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="timelineInput" placeholder="23:10 ‚Äî –∫—Ä–∏–∫" style="flex:1;background:#0b0b0b;color:#efece6;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03)">
              <button id="addTimeline" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div class="panel small" style="margin-top:12px">
            <strong>–ú–∏–Ω–∏‚Äë–∏–≥—Ä—ã</strong>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <button id="gamememory" class="btn">–ü–∞–º—è—Ç—å ‚Äî –ø–∞—Ä—ã (+10 –º–æ–Ω–µ—Ç)</button>
              <button id="gamespot" class="btn secondary">–ù–∞–π–¥–∏ —Ä–∞–∑–ª–∏—á–∏–µ (+12 –º–æ–Ω–µ—Ç)</button>
              <button id="gameimagepuzzle" class="btn secondary">–ü–∞–∑–ª‚Äë–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (+15 –º–æ–Ω–µ—Ç)</button>
            </div>
            <div style="margin-top:8px;color:var(--muted)">–ù–∞–≥—Ä–∞–¥—ã –º–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤.</div>
          </div>

          <div class="panel small" style="margin-top:12px">
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong>
            <div class="phone" style="margin-top:8px">
              <div class="screen" id="phoneScreen"><div style="padding:6px;color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç—ã:<div style="display:flex;gap:6px;margin-top:6px"><button id="callPartner" class="btn secondary">–ù–∞–ø–∞—Ä–Ω–∏–∫</button><button id="callPolice" class="btn secondary">–ü–æ–ª–∏—Ü–∏—è</button></div></div>
              <div id="phoneLog" style="margin-top:8px;color:var(--muted);max-height:120px;overflow:auto"></div></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="phoneInput" class="input" placeholder="–ù–æ–º–µ—Ä –∏–ª–∏ —Å–∞–π—Ç" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6;border:1px solid rgba(255,255,255,0.03)">
                <button id="phoneCall" class="btn">–ó–≤–æ–Ω–æ–∫</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="panel right-panel">
    <div class="tool">
      <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
      <div style="margin-top:8px">–°–≤—è–∑–µ–π: <span id="linksCount">0</span></div>
      <div style="margin-top:8px">–†–∏—Ç—É–∞–ª: <span id="ritualState">–Ω–µ—Ç</span></div>
      <div style="margin-top:8px">–ú–æ–Ω–µ—Ç—ã: <span id="coinDisplayRight" class="coins">0</span></div>
    </div>

    <div class="tool" style="margin-top:12px">
      <strong>–ö–æ–Ω—Ü–æ–≤–∫–∏</strong>
      <div style="margin-top:8px;color:var(--muted)">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏.</div>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="endingsBtn" class="btn">–ö–æ–Ω—Ü–æ–≤–∫–∏</button><button id="ritualBtn" class="btn secondary">–†–∏—Ç—É–∞–ª</button></div>
    </div>

    <div class="tool" style="margin-top:12px">
      <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong>
      <div style="margin-top:8px">
        <label><input type="checkbox" id="toggleMusic"> –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</label><br>
        <label style="margin-top:6px"><input type="checkbox" id="toggleAmbience" checked> –¢—É–º–∞–Ω / —ç—Ñ—Ñ–µ–∫—Ç—ã</label><br>
        <label style="margin-top:6px"><input type="checkbox" id="toggleDetectiveVoice" checked> –ì–æ–ª–æ—Å (TTS)</label>
      </div>
    </div>

    <div class="tool" style="margin-top:12px">
      <strong>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è ‚Äî –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã</strong>
      <div style="margin-top:8px;color:var(--muted)">–ù–∞–ø—Ä–∏–º–µ—Ä, ¬´–°–≤–µ—Ä–∏—Ç—å –î–ù–ö¬ª ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –æ–±—Ä–∞–∑—Ü–∞ —Å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–º–∏.</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="dnaInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ DNA-–∫–æ–¥ (–ø—Ä–∏–º–µ—Ä: ACGT123)" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6;border:1px solid rgba(255,255,255,0.03)">
        <button id="dnaCompare" class="btn">–°–≤–µ—Ä–∏—Ç—å –î–ù–ö</button>
      </div>
    </div>
  </aside>
</main>

<!-- Attack modal -->
<div id="attackModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ù–∞–ø–∞–¥–µ–Ω–∏–µ!</h3><p class="note">–ù–∞ –≤–∞—Å –Ω–∞–ø–∞–ª –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî —É –≤–∞—Å <span id="attackCountdown" class="countdown">10</span> —Å–µ–∫.</p><div class="attack-options"><button id="attackFight" class="btn">–î—Ä–∞—Ç—å—Å—è</button><button id="attackRun" class="btn secondary">–£–±–µ–∂–∞—Ç—å</button><button id="attackUseItem" class="btn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç (-5 –º–æ–Ω–µ—Ç)</button></div></div></div>

<!-- Mini-game modals -->
<div id="memoryModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ü–∞–º—è—Ç—å ‚Äî –ø–∞—Ä—ã</h3><p class="note">–ù–∞–π–¥–∏—Ç–µ –ø–∞—Ä—ã –∫–∞—Ä—Ç. –ù–∞–≥—Ä–∞–¥–∞: +10 –º–æ–Ω–µ—Ç</p><div id="memoryBoard" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="memoryClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="spotModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ù–∞–π–¥–∏ —Ä–∞–∑–ª–∏—á–∏–µ</h3><p class="note">–ù–∞–π–¥–∏—Ç–µ 3 –æ—Ç–ª–∏—á–∏—è. –ù–∞–≥—Ä–∞–¥–∞: +12 –º–æ–Ω–µ—Ç</p><img id="spotImgA" class="minigame-img" src="https://picsum.photos/seed/spotA/800/400" alt=""><img id="spotImgB" class="minigame-img" src="https://picsum.photos/seed/spotB/800/400" alt=""><div id="spotChoices" style="display:flex;gap:8px;margin-top:8px"></div><div style="text-align:right;margin-top:12px"><button id="spotClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="imgPuzzleModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ü–∞–∑–ª‚Äë–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3><p class="note">–°–æ–±–µ—Ä–∏—Ç–µ 3x3. –ù–∞–≥—Ä–∞–¥–∞: +15 –º–æ–Ω–µ—Ç</p><div id="imgPuzzleBoard" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="imgPuzzleClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<!-- Profiles/Interrogate/Cipher/Match/Endings -->
<div id="profilesModal" class="modal" aria-hidden="true"><div class="card small"><h3>–ü—Ä–æ—Ñ–∏–ª–∏</h3><div id="profilesContent" style="margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="closeProfiles" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="interrogateModal" class="modal" aria-hidden="true"><div class="card"><h3>–î–æ–ø—Ä–æ—Å ‚Äî –ù–µ–π—Ä–æ—Å–µ—Ç—å</h3><div class="note">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ –∏ –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã. (–°–∏–º—É–ª—è—Ü–∏—è)</div><div style="display:flex;gap:8px;margin-top:12px"><select id="interrogateSelect" style="flex:1;padding:8px;border-radius:8px;background:#0b0b0b;color:#efece6"></select><button id="interrogateStart" class="btn">–í—ã–±—Ä–∞—Ç—å</button></div><div class="chat" id="chatWindow" style="margin-top:12px"></div><div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" class="input" placeholder="–í–æ–ø—Ä–æ—Å"><button id="chatSend" class="btn">–°–ø—Ä–æ—Å–∏—Ç—å</button><button id="chatClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="cipherModal" class="modal" aria-hidden="true"><div class="card small"><h3>–¶–µ–∑–∞—Ä—å</h3><div style="display:flex;gap:8px;margin-top:8px"><input id="cipherShift" type="number" min="1" max="25" value="3" class="input" style="padding:8px;border-radius:8px"><button id="cipherTryBtn" class="btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button></div><textarea id="cipherOutput" rows="4" readonly class="input" style="margin-top:8px;width:100%"></textarea><div style="text-align:right;margin-top:8px"><button id="cipherCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="matchModal" class="modal" aria-hidden="true"><div class="card small"><h3>–≠–º–±–ª–µ–º—ã</h3><div id="matchArea" style="display:flex;gap:8px;margin-top:12px;justify-content:space-around"></div><div style="text-align:right;margin-top:12px"><button id="matchCloseBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingsModal" class="modal" aria-hidden="true"><div class="card"><h3>–ö–æ–Ω—Ü–æ–≤–∫–∏</h3><div id="endingsList" style="margin-top:12px"></div><div style="text-align:right;margin-top:12px"><button id="endingsClose" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<div id="endingRevealModal" class="modal" aria-hidden="true"><div class="card"><h3 id="endingTitle"></h3><div id="endingText" style="margin-top:12px;color:var(--muted)"></div><div style="text-align:right;margin-top:12px"><button id="endingClose" class="btn">OK</button></div></div></div>

<!-- audio elements -->
<audio id="bgMusic" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2022/04/09/audio_2839a1de58.mp3" type="audio/mpeg"></audio>
<audio id="ambience" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2021/08/04/audio_5f5a8f1f44.mp3" type="audio/mpeg"></audio>
<audio id="fxClick" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2023/03/03/audio_8f0b52d1b4.mp3?filename=interface-click-116929.mp3" type="audio/mpeg"></audio>

<div class="debug" id="debugPanel"><strong>DEBUG</strong><div id="debugLog" style="white-space:pre-wrap;margin-top:8px;font-family:monospace;color:#cfcfcf">init...</div></div>

<script>
/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –≤—Å—ë –ø—Ä–∏–≤—è–∑–∞–Ω–æ —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ user gesture –¥–ª—è –∑–≤—É–∫–∞.
   –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏, –∏–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ (coins), –Ω–∞–ø–∞–¥–µ–Ω–∏—è –Ω–∞ –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ (10s —Ç–∞–π–º–µ—Ä), –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –î–ù–ö, "–∫—Ä–æ–≤—å" ‚Äî –≤–∏–∑—É–∞–ª.
   –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω ‚Äî –ø–æ–º–µ—Å—Ç–∏—Ç–µ –µ–≥–æ –≤ –ø—Ä–æ–µ–∫—Ç –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ http(s) –∏–ª–∏ localhost.
*/

/* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
const LOG = (...args) => { try { const el = document.getElementById('debugLog'); if(el) el.textContent += '\\n' + args.join(' '); console.log(...args); } catch(e){ console.log(...args); } };
const $ = id => document.getElementById(id);
function showToast(msg){ const d=document.createElement('div'); d.textContent=msg; d.style.position='fixed'; d.style.left='50%'; d.style.bottom='18px'; d.style.transform='translateX(-50%)'; d.style.background='rgba(0,0,0,0.85)'; d.style.color='#fff'; d.style.padding='8px 12px'; d.style.borderRadius='8px'; d.style.zIndex=999999; document.body.appendChild(d); setTimeout(()=>{ d.style.transition='opacity .5s'; d.style.opacity=0; setTimeout(()=>d.remove(),500); },1500); }
function save(key){ try{ localStorage.setItem('rose_'+key, JSON.stringify(state)); LOG('Saved',key); }catch(e){ LOG('save err',e); } }
function load(key){ try{ const raw = localStorage.getItem('rose_'+key); return raw?JSON.parse(raw):null; }catch(e){ LOG('load err',e); return null; } }

/* ====== Initial data ====== */
const DEFAULT_SUSPECTS = [
  { id:'adrian', name:'–≠–¥—Ä–∏–∞–Ω –†–æ—É–∑–≤—É–¥', role:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫', male:true, height:189, shoe:44, desc:'–•–æ–ª–æ–¥–Ω—ã–π –∏ —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π.' },
  { id:'beatrice', name:'–ë–µ–∞—Ç—Ä–∏—Å –•–µ–π–≤—É–¥', role:'–î–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞', male:false, height:165, shoe:37, desc:'–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è –∏ –º–æ–ª—á–∞–ª–∏–≤–∞—è.' },
  { id:'prof', name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ú–æ—Ä–¥–µ–Ω', role:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', male:true, height:178, shoe:42, desc:'–ó–Ω–∞–µ—Ç —Å–∏–º–≤–æ–ª—ã –∏ –∏—Å—Ç–æ—Ä–∏—é —Å–µ–º—å–∏.' },
  { id:'victoria', name:'–í–∏–∫—Ç–æ—Ä–∏—è –†–æ—É–∑–≤—É–¥', role:'–ñ–µ–Ω–∞', male:false, height:172, shoe:39, desc:'–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏ –≤–ª–∞—Å—Ç–Ω–∞—è.' },
  { id:'lina', name:'–õ–∏–Ω–∞ –ú–æ–Ω—Ç', role:'–ì–æ—Å—Ç—å—è', male:false, height:168, shoe:38, desc:'–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —ç–∑–æ—Ç–µ—Ä–∏–∫–æ–π.' }
];
const MASTER_CLUES = [
  { id:'cl1', title:'–¢–∞–π–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞', room:'office', type:'cipher', text:'Vkr ghqv wrfkh', locked:true },
  { id:'cl2', title:'–°–ª–µ–¥ –æ–±—É–≤–∏', room:'garden', type:'foot', text:'–ü–æ–¥–æ—à–≤–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º B7', locked:false },
  { id:'cl3', title:'–†–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç', room:'library', type:'paper', text:'–í—ã—Ä–≤–∞–Ω–æ –∏–º—è, –ø–æ–º–µ—Ç–∫–∞: 12/11', locked:false },
  { id:'cl4', title:'–°–∏–º–≤–æ–ª –Ω–∞ —Å—Ç–µ–Ω–µ', room:'music', type:'symbol', text:'–°—Ç—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª', locked:false },
  { id:'cl5', title:'–ü–µ–ø–µ–ª –∏ –º–∞—Å–ª–æ', room:'dining', type:'ash', text:'–ü–µ–ø–µ–ª –∏ —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ', locked:false },
  { id:'cl6', title:'–§—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã', room:'basement', type:'puzzle', text:'–ß–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã ‚Äî –Ω—É–∂–µ–Ω –ø–∞–∑–ª', locked:true },
  { id:'cl7', title:'–§–ª–∞–∫–æ–Ω —Å —ç—Ñ–∏—Ä–æ–º', room:'attic', type:'vial', text:'–†–µ–¥–∫–∏–π —ç—Ñ–∏—Ä', locked:false }
];
const ENDINGS = [
  { id:'truth', title:'–ü—Ä–∞–≤–¥–∞ –∏ —Å—É–¥', desc:'–°–æ–±—Ä–∞–Ω—ã –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî –≤–∏–Ω–æ–≤–Ω—ã–π –æ—Å—É–∂–¥—ë–Ω.', cond: s => (s.links.adrian && s.links.adrian.length>=3) && s.timeline.length>=2 },
  { id:'open', title:'–ù–µ—Ä–∞—Å–∫—Ä—ã—Ç–æ', desc:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî –¥–µ–ª–æ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–∞–π–Ω–æ–π.', cond: s => Object.values(s.links).flat().length < 3 }
];

/* ====== Game state ====== */
let state = {
  suspects: [], clues: [], opened:{}, links:{}, timeline:[], ritualPerformed:false,
  coins: 0, health: 100, audioOn:false, musicOn:false, detectiveVoice:true
};

/* ====== Safe audio play helper ====== */
function safePlay(audioEl){
  if(!audioEl) return Promise.reject(new Error('no-audio'));
  audioEl.muted = false;
  audioEl.volume = audioEl.volume || 0.12;
  return audioEl.play().catch(err => {
    LOG('Audio play rejected', err);
    return Promise.reject(err);
  });
}

/* ====== Menu delegation (ensures handlers work even if earlier script errors) ====== */
document.addEventListener('click', function delegatedMenu(e){
  const btn = e.target.closest('#startBtn, #enableSound, #loadBtn, #menuOpenBtn');
  if(!btn) return;
  if(btn.id === 'startBtn'){
    $('menuScreen').style.display = 'none';
    if(state.suspects.length === 0) startNewGame();
    // play audio because user interacted
    if($('toggleMusic') && $('toggleMusic').checked){ safePlay($('bgMusic')).catch(()=>{}); }
    safePlay($('ambience')).catch(()=>{});
  }
  if(btn.id === 'enableSound'){
    // attempt to unlock audio
    safePlay($('bgMusic')).catch(()=>{}); safePlay($('ambience')).catch(()=>{});
    showToast('–ü–æ–ø—ã—Ç–∫–∞ –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫. –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç ‚Äî –Ω–∞–∂–º–∏—Ç–µ Start –∑–∞—Ç–µ–º "–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫" –µ—â—ë —Ä–∞–∑.');
  }
  if(btn.id === 'loadBtn'){
    const autos = load('autosave'); if(autos && confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤?')){ state = autos; renderAll(); $('menuScreen').style.display='none'; showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω'); } else showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'); 
  }
  if(btn.id === 'menuOpenBtn'){ $('menuScreen').style.display = 'flex'; }
}, true);

/* ====== Start new game ====== */
function startNewGame(){
  state = {
    suspects: JSON.parse(JSON.stringify(DEFAULT_SUSPECTS)).sort(()=>Math.random()-0.5),
    clues: JSON.parse(JSON.stringify(MASTER_CLUES)),
    opened: {}, links:{}, timeline:[], ritualPerformed:false,
    coins: 20, health:100, audioOn:false, musicOn:false, detectiveVoice:true
  };
  state.suspects.forEach(s => state.links[s.id]=[]);
  // add a few extras for variety
  for(let i=0;i<3;i++){
    const base = MASTER_CLUES[Math.floor(Math.random()*MASTER_CLUES.length)];
    state.clues.push(Object.assign({}, base, { id: base.id + '_x' + i, title: base.title + ' (–≤—Å–ø–ª.)', locked: Math.random() < 0.5 }));
  }
  save('autosave');
  renderAll();
  showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –ú–æ–Ω–µ—Ç—ã: ' + state.coins);
}

/* ====== Rendering functions ====== */
function renderAll(){
  renderSuspects(); renderClues(); renderTimeline(); renderStats(); renderProfilesModal(); populateAccuse();
}
function renderSuspects(){
  const area = $('suspectsList'); area.innerHTML = '';
  state.suspects.forEach((s, idx) => {
    const div = document.createElement('div'); div.className = 'suspect'; div.dataset.suspect = s.id;
    let avatar = `<div class="avatar">${escape(s.name[0])}</div>`;
    if(!s.male){
      const femaleIndex = state.suspects.filter(x=>!x.male).map(x=>x.id).indexOf(s.id);
      const src = `assets/female${Math.min(3,femaleIndex+1)}.jpg`;
      avatar = `<img class="avatar" src="${src}" alt="${escape(s.name)}" onerror="this.style.display='none'">`;
    }
    const linked = (state.links[s.id] || []).length;
    div.innerHTML = `${avatar}<div class="smeta"><div class="sname">${escape(s.name)}</div><div class="meta-row">${escape(s.role)} ¬∑ –†–æ—Å—Ç ${s.height} —Å–º ¬∑ –û–±—É–≤—å ${s.shoe}</div><div style="margin-top:6px;color:var(--muted)">${escape(s.desc)}</div></div><div class="dropzone" data-suspect="${s.id}">${linked}</div>`;
    div.addEventListener('click', ()=> openProfileModal(s));
    area.appendChild(div);
  });
  attachDropzones();
}
function renderClues(){
  const grid = $('cluesGrid'); grid.innerHTML = '';
  state.clues.forEach(c => {
    const opened = !!state.opened[c.id];
    const el = document.createElement('div'); el.className = 'clue'; el.id = c.id; el.dataset.clue = c.id;
    el.innerHTML = `<div class="thumb">${getIcon(c.type)}</div><div><h4>${escape(c.title)}</h4><p>${opened ? escape(c.text) : (c.locked ? '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ / —Å–∫—Ä—ã—Ç–∞' : escape(c.text))}</p></div>`;
    el.addEventListener('click', ()=> onClueClick(c));
    el.draggable = true; el.addEventListener('dragstart', ev => ev.dataTransfer.setData('text/plain', c.id));
    addTouchDragSupport(el,c.id);
    grid.appendChild(el);
  });
  $('totalClues').textContent = state.clues.length;
  $('openedCount').textContent = Object.keys(state.opened).length;
}
function renderTimeline(){
  const el = $('timelineList');
  if(state.timeline.length === 0){ el.innerHTML = '<div class="small" style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  el.innerHTML = state.timeline.slice().reverse().map(t => `<div style="margin-bottom:6px">${escape(t.text)} <span style="color:var(--muted);font-size:0.82rem">(${new Date(t.time).toLocaleTimeString()})</span></div>`).join('');
}
function renderStats(){
  $('linksCount').textContent = Object.values(state.links).flat().length;
  $('ritualState').textContent = state.ritualPerformed ? '–¥–∞' : '–Ω–µ—Ç';
  $('coinDisplay').textContent = state.coins;
  $('coinDisplayTop').textContent = state.coins;
  $('coinDisplayRight') && ($('coinDisplayRight').textContent = state.coins);
  $('healthBar').value = state.health;
  updateProgress();
}
function renderProfilesModal(){
  const cont = $('profilesContent'); cont.innerHTML = '';
  state.suspects.forEach(s=>{
    const div = document.createElement('div'); div.style.marginBottom='12px';
    const linked = (state.links[s.id]||[]).length;
    div.innerHTML = `<strong>${escape(s.name)}</strong> ‚Äî <em>${escape(s.role)}</em><div class="small" style="color:var(--muted);margin-top:6px">–†–æ—Å—Ç: ${s.height} —Å–º ¬∑ –û–±—É–≤—å: ${s.shoe} ¬∑ –£–ª–∏–∫: ${linked}</div><div style="margin-top:6px">${escape(s.desc)}</div><div style="margin-top:8px"><button class="btn" onclick="inspectSuspect('${s.id}')">–î–æ–ø—Ä–æ—Å–∏—Ç—å</button> <button class="btn secondary" onclick="showPhysical('${s.id}')">–í–Ω–µ—à–Ω–æ—Å—Ç—å</button></div>`;
    cont.appendChild(div);
  });
}

/* ====== Clue interactions ====== */
function onClueClick(c){
  LOG('clue clicked', c.id);
  if(c.locked && !state.opened[c.id]){
    if(c.type === 'cipher' || c.type === 'cipher2'){ openCipherModal(c); return; }
    if(c.type === 'puzzle'){ openPuzzleModal(); return; }
    if(c.type === 'symbol' || c.type === 'seal'){ openMatchModal(c); return; }
    showToast('–≠—Ç–∞ —É–ª–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç');
    return;
  }
  if(!state.opened[c.id]){ state.opened[c.id] = true; revealClue(c); renderClues(); renderStats(); return; }
  showDetail(c);
}
function revealClue(c){
  if(c.type === 'cipher' && c.text === 'Vkr ghqv wrfkh') c.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª';
  state.opened[c.id] = true;
}
function showDetail(c){
  $('endingTitle').innerText = c.title; $('endingText').innerHTML = `<div style="color:var(--muted)">${escape(c.text)}</div>`; $('endingRevealModal').style.display = 'flex';
}

/* ====== Drag & Mobile linking ====== */
function attachDropzones(){
  document.querySelectorAll('.dropzone').forEach(zone=>{
    zone.addEventListener('dragover', ev=>{ ev.preventDefault(); zone.style.outline = '2px dashed rgba(176,138,92,0.6)'; });
    zone.addEventListener('dragleave', ev=> zone.style.outline = '');
    zone.addEventListener('drop', ev=> { ev.preventDefault(); zone.style.outline=''; const clueId = ev.dataTransfer.getData('text/plain'); const suspectId = zone.dataset.suspect; if(clueId && suspectId) linkEvidence(suspectId, clueId); });
    zone.addEventListener('touchend', ()=> {
      const held = document.body.dataset.draggingClue;
      if(held){ const suspectId = zone.dataset.suspect; linkEvidence(suspectId, held); document.body.dataset.draggingClue = ''; }
    });
  });
}
function addTouchDragSupport(el, clueId){
  let timer = null;
  el.addEventListener('touchstart', ()=> { timer = setTimeout(()=> { document.body.dataset.draggingClue = clueId; el.style.opacity = 0.6; showToast('–¢–∞–ø–Ω–∏—Ç–µ –ø–æ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–º—É, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å —É–ª–∏–∫—É'); }, 600); }, {passive:true});
  el.addEventListener('touchend', ()=> { clearTimeout(timer); setTimeout(()=> { el.style.opacity=''; document.body.dataset.draggingClue=''; }, 200); });
}
function linkEvidence(suspectId, clueId){
  if(!state.links[suspectId]) state.links[suspectId] = [];
  if(state.links[suspectId].includes(clueId)){ showToast('–£–ª–∏–∫–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞'); return; }
  state.links[suspectId].push(clueId);
  showToast('–£–ª–∏–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞');
  renderAll(); save('autosave');
}

/* ====== Mini-games (memory, spot, img puzzle) ====== */
/* Memory pairs */
let memoryState = null;
function openMemoryGame(){
  $('memoryModal').style.display='flex';
  const board = $('memoryBoard'); board.innerHTML='';
  const imgs = []; for(let i=0;i<8;i++) imgs.push('https://picsum.photos/seed/mem'+i+'/200/200');
  const pair = imgs.concat(imgs).sort(()=>Math.random()-0.5);
  memoryState = { first:null, second:null, matched:0, board };
  pair.forEach(src=>{
    const card = document.createElement('div'); card.style.height='80px'; card.style.background='#151212'; card.style.borderRadius='6px'; card.style.cursor='pointer'; card.dataset.src = src;
    card.addEventListener('click', ()=> memoryFlip(card));
    board.appendChild(card);
  });
}
function memoryFlip(card){
  if(card.classList.contains('matched') || memoryState.second) return;
  card.style.backgroundImage = `url(${card.dataset.src})`; card.style.backgroundSize='cover';
  if(!memoryState.first){ memoryState.first = card; return; }
  memoryState.second = card;
  if(memoryState.first.dataset.src === memoryState.second.dataset.src){
    memoryState.first.classList.add('matched'); memoryState.second.classList.add('matched');
    memoryState.matched += 2; memoryState.first=null; memoryState.second=null;
    if(memoryState.matched === memoryState.board.children.length){ state.coins += 10; renderStats(); showToast('+10 –º–æ–Ω–µ—Ç (–ø–∞—Ä—ã)'); $('memoryModal').style.display='none'; save('autosave'); }
  } else {
    setTimeout(()=>{ memoryState.first.style.backgroundImage=''; memoryState.second.style.backgroundImage=''; memoryState.first=null; memoryState.second=null; }, 700);
  }
}

/* Spot differences (very simple) */
let spotRemaining = 3;
function openSpotGame(){
  $('spotModal').style.display='flex';
  const choices = $('spotChoices'); choices.innerHTML='';
  spotRemaining = 3;
  for(let i=0;i<3;i++){
    const b = document.createElement('button'); b.className='btn'; b.textContent='–û—Ç–º–µ—Ç–∏—Ç—å'; b.addEventListener('click', ()=> {
      if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')){ spotRemaining--; showToast('–û—Ç–ª–∏—á–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å: ' + spotRemaining); if(spotRemaining===0){ state.coins += 12; renderStats(); showToast('+12 –º–æ–Ω–µ—Ç (—Ä–∞–∑–ª–∏—á–∏—è)'); $('spotModal').style.display='none'; save('autosave'); } }
    });
    choices.appendChild(b);
  }
}

/* Image puzzle */
function openImagePuzzle(){
  $('imgPuzzleModal').style.display='flex';
  const board = $('imgPuzzleBoard'); board.innerHTML='';
  const nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
  nums.forEach(n=>{ const p=document.createElement('div'); p.style.height='80px'; p.style.background='#201612'; p.style.display='grid'; p.style.placeItems='center'; p.style.borderRadius='6px'; p.textContent = n===9? '': n; p.dataset.num = n; p.addEventListener('click', ()=> imgPuzzleClick(board,p)); board.appendChild(p); });
}
function imgPuzzleClick(board,piece){
  const empty = Array.from(board.children).find(c=>c.dataset.num=='9'); if(!empty) return;
  const idx = Array.from(board.children).indexOf(piece), eidx = Array.from(board.children).indexOf(empty); const dist = Math.abs(idx-eidx);
  if(dist===1||dist===3){ const t=piece.dataset.num; piece.dataset.num=empty.dataset.num; empty.dataset.num=t; const tmp=piece.textContent; piece.textContent=empty.textContent; empty.textContent=tmp; imgPuzzleCheck(board); }
}
function imgPuzzleCheck(board){ const order = Array.from(board.children).map(c=>Number(c.dataset.num)); if(order.every((v,i)=> v===i+1)){ state.coins += 15; renderStats(); showToast('+15 –º–æ–Ω–µ—Ç (–ø–∞–∑–ª)'); $('imgPuzzleModal').style.display='none'; save('autosave'); } }

/* ====== Attack mechanic ====== */
let attackTimer = null;
function maybeTriggerAttack(){ if(Math.random() < 0.18){ triggerAttack(); } }
function triggerAttack(){
  $('attackModal').style.display='flex';
  let t = 10; $('attackCountdown').textContent = t;
  attackTimer = setInterval(()=>{ t--; $('attackCountdown').textContent = t; if(t<=0){ clearInterval(attackTimer); attackTimer = null; resolveAttack('timeout'); } }, 1000);
}
function resolveAttack(action){
  clearInterval(attackTimer); attackTimer=null; $('attackModal').style.display='none';
  if(action==='fight'){ if(Math.random()<0.65){ showToast('–í—ã –æ—Ç–±–∏–ª–∏—Å—å!'); } else { state.health = Math.max(0, state.health-30); showToast('–ü—Ä–æ–∏–≥—Ä–∞–ª–∏ ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ -30'); } }
  else if(action==='run'){ if(Math.random()<0.55){ state.coins = Math.max(0, state.coins-5); showToast('–£–±–µ–∂–∞–ª–∏ ‚Äî –ø–æ—Ç–µ—Ä—è -5 –º–æ–Ω–µ—Ç'); } else { state.health = Math.max(0, state.health-20); showToast('–ù–µ —É–¥–∞–ª–æ—Å—å ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ -20'); } }
  else if(action==='use'){ showToast('–ü—Ä–µ–¥–º–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'); }
  else if(action==='timeout'){ state.health = Math.max(0, state.health-35); showToast('–í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ -35'); }
  renderStats(); save('autosave');
  if(state.health <= 0) gameOver();
}
$('attackFight') && $('attackFight').addEventListener('click', ()=> resolveAttack('fight'));
$('attackRun') && $('attackRun').addEventListener('click', ()=> resolveAttack('run'));
$('attackUseItem') && $('attackUseItem').addEventListener('click', ()=> { if(state.coins>=5){ state.coins -=5; resolveAttack('use'); } else showToast('–ù–µ—Ç –º–æ–Ω–µ—Ç'); });

/* ====== Interrogation (simulated neural + TTS) ====== */
function openInterrogation(){ $('interrogateModal').style.display='flex'; populateInterrogateSelect(); $('chatWindow').innerHTML=''; }
function populateInterrogateSelect(){ const sel = $('interrogateSelect'); sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>'; state.suspects.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); }); }
function startInterrogation(){ const id = $('interrogateSelect').value; if(!id){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ'); return; } addChatAI('–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç: ' + state.suspects.find(s=>s.id===id).name); }
function handleChatAsk(){ const q = $('chatInput').value.trim(); if(!q) return; addChatUser(q); $('chatInput').value=''; setTimeout(()=>{ const id = $('interrogateSelect').value; const r = generateAIResponse(q,id); addChatAI(r); }, 600); }
function addChatAI(text){ const chat = $('chatWindow'); const m=document.createElement('div'); m.className='msg ai'; m.textContent = text; chat.appendChild(m); chat.scrollTop = chat.scrollHeight; if(state.detectiveVoice) speak(text); }
function addChatUser(text){ const chat = $('chatWindow'); const m=document.createElement('div'); m.className='msg user'; m.textContent = text; chat.appendChild(m); chat.scrollTop = chat.scrollHeight; if(state.detectiveVoice) speak(text); }
function generateAIResponse(q, id){ if(!id) return '–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ.'; const s = state.suspects.find(x=>x.id===id); q=q.toLowerCase(); if(q.includes('–≥–¥–µ')) return `${s.name}: –Ø –±—ã–ª(–∞) –≤ –¥–æ–º–µ –æ–∫–æ–ª–æ 23:00.`; if(q.includes('–∑–∞–ø–∏—Å')) return `${s.name}: –í –∑–∞–ø–∏—Å–∫–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è "–í." ‚Äî –∏–Ω–∏—Ü–∏–∞–ª.`; return `${s.name}: –Ø –Ω–µ –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å.`; }
function speak(text){ if(!('speechSynthesis' in window) || !state.detectiveVoice) return; const u = new SpeechSynthesisUtterance(text); const voices = speechSynthesis.getVoices(); if(voices.length) u.voice = voices[0]; speechSynthesis.cancel(); speechSynthesis.speak(u); }
$('chatSend') && $('chatSend').addEventListener('click', handleChatAsk);
$('chatClose') && $('chatClose').addEventListener('click', ()=> $('interrogateModal').style.display='none');

/* ====== DNA / Blood lab (simple simulated tests) ====== */
function bindLab(){
  $('dnaCompare').addEventListener('click', ()=> {
    const code = $('dnaInput').value.trim();
    if(!code){ showToast('–í—Å—Ç–∞–≤—å—Ç–µ DNA-–∫–æ–¥'); return; }
    // simulate: each suspect has a short DNA id derived from name
    const matches = state.suspects.map(s => ({ id: s.id, name: s.name, dnaId: s.name.split(' ').map(p=>p[0]).join('') + (s.height%100) }));
    const found = matches.find(m => m.dnaId.toLowerCase() === code.toLowerCase());
    if(found){ showToast('–î–ù–ö —Å–æ–≤–ø–∞–ª–∞ —Å ' + found.name); state.coins += 8; save('autosave'); renderStats(); } else { showToast('–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); }
  });
  $('bloodLab') && $('bloodLab').addEventListener('click', ()=> {
    // simple blood analysis yields blood type and possible toxin
    const types = ['A', 'B', 'AB', 'O']; const t = types[Math.floor(Math.random()*types.length)];
    showToast('–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏: —Ç–∏–ø ' + t + '. –í–æ–∑–º–æ–∂–Ω–æ —Å–ª–µ–¥—ã –≥–æ—Ä—é—á–µ–≥–æ.');
    // reveal blood overlay to emphasize
    $('bloodOverlay').classList.add('on'); setTimeout(()=> $('bloodOverlay').classList.remove('on'), 6000);
  });
  $('fpLab') && $('fpLab').addEventListener('click', ()=> {
    showToast('–û—Ç–ø–µ—á–∞—Ç–∫–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã: –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ø–µ—Ä—á–∞—Ç–∫–æ–π –Ω–∞ —Å—Ç–æ–ª–µ.');
  });
}
bindLab();

/* ====== Partner help ====== */
$('partnerHelp') && $('partnerHelp').addEventListener('click', ()=> {
  const locked = state.clues.filter(c=> c.locked && !state.opened[c.id]);
  if(locked.length){ const pick = locked[Math.floor(Math.random()*locked.length)]; const el = document.getElementById(pick.id); if(el){ el.style.boxShadow='0 0 18px rgba(176,138,92,0.95)'; setTimeout(()=> el.style.boxShadow='', 2600); } showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫ –ø–æ–¥—Å–∫–∞–∑–∞–ª: ' + pick.title); } else showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫ —Å–æ–≤–µ—Ç—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–Ω–∏–ª—å–Ω—ã–µ —Å–ª–µ–¥—ã.');
});

/* ====== Misc helpers ====== */
function getIcon(t){ switch(t){ case 'cipher': return '‚úâÔ∏è'; case 'puzzle': return 'üß©'; case 'symbol': return 'üî±'; case 'vial': return 'üß™'; case 'foot': return 'üë£'; case 'ink': return 'üñãÔ∏è'; default: return 'üîé'; } }
function updateProgress(){ const opened = Object.keys(state.opened).length + Object.values(state.links).flat().length; const total = state.clues.length + 2; const pct = Math.min(100, Math.round((opened/total)*100)); $('progressPct') && ($('progressPct').innerText = pct + '%'); }
function escape(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ====== Core binds and initial UI wiring ====== */
function bindGlobalUI(){
  // hotspots - inspect room + maybe attack
  document.querySelectorAll('.hotspot').forEach(h => h.addEventListener('click', ()=> { const room = h.dataset.room; inspectRoom(room); maybeTriggerAttack(); }));
  // tools bindings
  $('cipherTryBtn') && $('cipherTryBtn').addEventListener('click', tryCipher);
  $('cipherCloseBtn') && $('cipherCloseBtn').addEventListener('click', ()=> $('cipherModal').style.display='none');
  // mini-games
  $('gamememory') && $('gamememory').addEventListener('click', openMemoryGame);
  $('gamespot') && $('gamespot').addEventListener('click', openSpotGame);
  $('gameimagepuzzle') && $('gameimagepuzzle').addEventListener('click', openImagePuzzle);
  // phone
  if($('callPartner')){ $('callPartner').addEventListener('click', ()=> { const log=$('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–ó–≤–æ–Ω–æ–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫—É...</div>` + log.innerHTML; setTimeout(()=> log.innerHTML = `<div style="color:var(--muted)">'–Ø –µ–¥—É', ‚Äî –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞–ø–∞—Ä–Ω–∏–∫.</div>` + log.innerHTML, 1200); }); }
  if($('callPolice')){ $('callPolice').addEventListener('click', ()=> { const log=$('phoneLog'); log.innerHTML = `<div style="color:var(--muted)">–í—ã–∑–æ–≤ –ø–æ–ª–∏—Ü–∏–∏...</div>` + log.innerHTML; setTimeout(()=> log.innerHTML = `<div style="color:var(--muted)">'–ü–∞—Ç—Ä—É–ª—å –≤—ã–µ—Ö–∞–ª', ‚Äî —Å–æ–æ–±—â–∞–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä.</div>` + log.innerHTML, 1200); }); }
  $('phoneCall') && $('phoneCall').addEventListener('click', ()=> { const v=$('phoneInput').value.trim(); const log=$('phoneLog'); if(!v) return; if(v.includes('.')||v.startsWith('http')){ window.open(v.startsWith('http')?v:'http://'+v,'_blank'); log.innerHTML = `<div style="color:var(--muted)">–û—Ç–∫—Ä—ã—Ç —Å–∞–π—Ç: ${escape(v)}</div>` + log.innerHTML; } else { log.innerHTML = `<div style="color:var(--muted)">–í—ã–∑–æ–≤ ${escape(v)}...</div>` + log.innerHTML; setTimeout(()=> log.innerHTML = `<div style="color:var(--muted)">'–ù–æ–º–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç', ‚Äî –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫.</div>` + log.innerHTML, 1200); } });
  // other binds
  $('profilesBtn') && $('profilesBtn').addEventListener('click', ()=> { renderProfilesModal(); $('profilesModal').style.display='flex'; });
  $('closeProfiles') && $('closeProfiles').addEventListener('click', ()=> $('profilesModal').style.display='none');
  $('interrogateBtn') && $('interrogateBtn').addEventListener('click', ()=> openInterrogation());
  $('findKiller') && $('findKiller').addEventListener('click', tryFindKiller);
  $('endingsBtn') && $('endingsBtn').addEventListener('click', ()=> { renderEndings(); $('endingsModal').style.display='flex'; });
  $('endingsClose') && $('endingsClose').addEventListener('click', ()=> $('endingsModal').style.display='none');
  $('endingClose') && $('endingClose').addEventListener('click', ()=> $('endingRevealModal').style.display='none');
  $('revealBlood') && $('revealBlood').addEventListener('click', ()=> { $('bloodOverlay').classList.toggle('on'); });
  $('dnaCompare') && $('dnaCompare').addEventListener('click', ()=> {
    const code = $('dnaInput').value.trim();
    if(!code){ showToast('–í—Å—Ç–∞–≤—å—Ç–µ DNA-–∫–æ–¥'); return; }
    const matches = state.suspects.map(s => ({ id: s.id, name: s.name, dna: (s.name.split(' ').map(p=>p[0]).join('')+(s.height%100)) }));
    const found = matches.find(m => m.dna.toLowerCase() === code.toLowerCase());
    if(found){ showToast('–î–ù–ö —Å–æ–≤–ø–∞–ª–∞: ' + found.name); state.coins += 8; renderStats(); save('autosave'); } else showToast('–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
  });
  $('addTimeline') && $('addTimeline').addEventListener('click', ()=> { const v = $('timelineInput').value.trim(); if(!v) return; state.timeline.push({ text:v, time:new Date().toISOString() }); $('timelineInput').value=''; renderTimeline(); save('autosave'); renderStats(); });
  $('partnerHelp') && $('partnerHelp').addEventListener('click', partnerHelp);
  $('saveNotes') && $('saveNotes').addEventListener('click', ()=> { localStorage.setItem('rose_notes', $('notebook').value||''); showToast('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'); });
  $('clearNotes') && $('clearNotes').addEventListener('click', ()=> { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏?')){ $('notebook').value=''; localStorage.removeItem('rose_notes'); } });
  // cipher modal close
  $('cipherCloseBtn') && $('cipherCloseBtn').addEventListener('click', ()=> $('cipherModal').style.display='none');
}

/* ====== DNA & labs bound above (bindLab already called earlier in some flows) ====== */

/* ====== Helper functions and small UI functions ====== */
function inspectSuspect(id){ $('profilesModal').style.display='none'; $('interrogateModal').style.display='flex'; $('interrogateSelect').value = id; addChatAI('–î–æ–ø—Ä–æ—Å –Ω–∞—á–∞—Ç: ' + state.suspects.find(s=>s.id===id).name); }
function showPhysical(id){ const s = state.suspects.find(x=>x.id===id); if(!s) return; const text = `${s.name}. –†–æ—Å—Ç: ${s.height} —Å–º. –û–±—É–≤—å: ${s.shoe}. –í–Ω–µ—à–Ω–æ—Å—Ç—å: ${s.desc}`; $('endingTitle').innerText = '–í–Ω–µ—à–Ω–æ—Å—Ç—å'; $('endingText').innerHTML = `<div style="color:var(--muted)">${escape(text)}</div>`; $('endingRevealModal').style.display='flex'; }
function partnerHelp(){ const locked = state.clues.filter(c=> c.locked && !state.opened[c.id]); if(locked.length){ const pick = locked[Math.floor(Math.random()*locked.length)]; const el = document.getElementById(pick.id); if(el){ el.style.boxShadow='0 0 18px rgba(176,138,92,0.95)'; setTimeout(()=> el.style.boxShadow='',2600); } showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ ' + pick.title); } else showToast('–ù–∞–ø–∞—Ä–Ω–∏–∫: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–Ω–∏–ª—å–Ω—ã–µ —Å–ª–µ–¥—ã'); }

/* ====== Render endings ====== */
function renderEndings(){
  const list = $('endingsList'); list.innerHTML = '';
  ENDINGS.forEach(e=>{
    const unlocked = e.cond(state);
    const card = document.createElement('div'); card.className='ending-card'; card.style.padding='10px'; card.style.marginBottom='8px'; card.style.border='1px solid rgba(255,255,255,0.03)';
    card.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${escape(e.title)}</strong><div style="color:${unlocked?'#9fff9f':'#cfcfcf'}">${unlocked? '–î–æ—Å—Ç—É–ø–Ω–∞':'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}</div></div><div style="color:var(--muted);margin-top:6px">${escape(e.desc)}</div>`;
    card.addEventListener('click', ()=> { if(unlocked) showEnding(e.id); else showToast('–≠—Ç–∞ –∫–æ–Ω—Ü–æ–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞'); });
    list.appendChild(card);
  });
}
function showEnding(id){ const e = ENDINGS.find(x=>x.id===id); if(!e) return; $('endingTitle').innerText = e.title; $('endingText').innerText = e.desc; $('endingRevealModal').style.display='flex'; const hist = JSON.parse(localStorage.getItem('rose_endings')||'[]'); hist.unshift({id:e.id,time:new Date().toISOString()}); localStorage.setItem('rose_endings', JSON.stringify(hist.slice(0,50))); }

/* ====== Basic gameplay: room inspection, clue reveal ====== */
function inspectRoom(room){
  const found = state.clues.filter(c=> c.room === room);
  if(found.length === 0){ showToast('–í —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ –Ω–∏—á–µ–≥–æ'); return; }
  found.forEach(c=> {
    if(!c.locked) state.opened[c.id] = true;
    else {
      const el = document.getElementById(c.id);
      if(el) el.querySelector('p').textContent = '–ù–∞–π–¥–µ–Ω–∞, –Ω–æ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç';
    }
  });
  renderAll();
  showToast(`–í ${room} –Ω–∞–π–¥–µ–Ω–æ ${found.length} —É–ª–∏–∫`);
  save('autosave');
}

/* ====== Cipher functions (simple Caesar) ====== */
function tryCipher(){
  const shift = Number($('cipherShift').value) || 0; const clueId = $('cipherModal').dataset.clue;
  const clue = state.clues.find(c=> c.id === clueId) || state.clues.find(c=> c.type === 'cipher' || c.type === 'cipher2');
  if(!clue){ showToast('–ó–∞–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
  const decoded = caesarDecode(clue.text, shift); $('cipherOutput').value = decoded;
  if(/–æ–Ω –∑–Ω–∞–µ—Ç|–≤\./i.test(decoded) || shift === 3){
    showToast('–ó–∞–ø–∏—Å–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞');
    clue.locked = false; clue.text = '–ù–∞–π–¥–µ–Ω–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: ¬´–û–Ω –∑–Ω–∞–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ä–µ—à—É –≤—Å—ë. ‚Äî –í.¬ª'; state.opened[clue.id] = true; renderAll(); $('cipherModal').style.display='none'; save('autosave');
  }
}
function caesarDecode(text, shift){ if(!text) return text; const a='abcdefghijklmnopqrstuvwxyz'; const A=a.toUpperCase(); return text.split('').map(ch=>{ const i = a.indexOf(ch); if(i>=0) return a[(i-shift+26)%26]; const I=A.indexOf(ch); if(I>=0) return A[(I-shift+26)%26]; return ch; }).join(''); }

/* ====== Initialize UI on load (attempt to load autosave prompt) ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  LOG('Initializing UI');
  bindGlobalUI();
  bindPhone(); bindMinigameTriggers();
  // load notes
  const notes = localStorage.getItem('rose_notes'); if(notes) $('notebook').value = notes;
  // autosave prompt
  const autos = load('autosave'); if(autos && confirm('–ù–∞–π–¥–µ–Ω –∞–≤—Ç–æ—Å–µ–π–≤. –ó–∞–≥—Ä—É–∑–∏—Ç—å?')){ state = autos; renderAll(); $('menuScreen').style.display='none'; showToast('–ê–≤—Ç–æ—Å–µ–π–≤ –∑–∞–≥—Ä—É–∂–µ–Ω'); } else {
    // leave menu visible until Start
  }
});

/* ====== Helpers for binds not defined earlier ====== */
function bindPhone(){ /* already bound in bindGlobalUI via function, left for safe access */ }
function bindMinigameTriggers(){ /* bound in bindGlobalUI */ }

/* ====== Expose some functions for debugging/testing ====== */
window.startNewGame = startNewGame;
window.triggerAttack = triggerAttack;
window.safePlay = safePlay;

LOG('Script loaded ‚Äî ready.');
</script>
</body>
</html>
