<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Убийство в особняке Роузвуд — Тайна</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;500;700&display=swap" rel="stylesheet">
<style>
/* --- Общая тема: загадочно, винтаж, свечи, туман --- */
:root{
  --bg-1:#070608;
  --bg-2:#121113;
  --panel:#191818;
  --accent:#b08a5c;
  --accent-2:#7a4e2f;
  --muted:#cfcfcf;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: "Raleway", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:#efeae4;
  background:
   radial-gradient(1200px 600px at 10% 10%, rgba(176,138,92,0.03), transparent),
   linear-gradient(180deg,var(--bg-1), var(--bg-2));
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow-y:scroll;
}

/* Header */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:18px 22px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.title {
  display:flex;
  flex-direction:column;
}
.title h1 {
  margin:0;
  font-family:'Cinzel', serif;
  letter-spacing:1px;
  font-size:1.3rem;
  color: #f7efe7;
}
.title p { margin:2px 0 0 0; font-size:0.86rem; color:var(--muted); }

/* Layout */
.container {
  max-width:1200px;
  margin:20px auto;
  display:grid;
  grid-template-columns: 320px 1fr 320px;
  gap:18px;
  padding:0 16px 60px 16px;
}
@media (max-width:1050px){ .container{grid-template-columns:1fr; padding-bottom:120px;} }

/* Left panel: case & suspects */
.panel {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;
  padding:14px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.02);
}
.case-name { font-family:'Cinzel', serif; font-size:1.05rem; margin:0 0 6px 0; color:#efe6dc; }
.small { font-size:0.88rem; color:var(--muted); }

.suspect {
  display:flex;
  gap:10px;
  padding:10px;
  margin-top:10px;
  border-radius:8px;
  background: linear-gradient(90deg, rgba(255,255,255,0.01), transparent);
  align-items:center;
  border:1px solid rgba(255,255,255,0.02);
}
.suspect img { width:56px; height:56px; object-fit:cover; border-radius:8px; border:2px solid rgba(255,255,255,0.03); }
.suspect .meta { flex:1; }
.suspect .name { font-weight:700; }
.suspect .role { font-size:0.85rem; color:var(--muted); }
.suspect .dropzone {
  margin-left:8px;
  min-width:40px;
  min-height:40px;
  border-radius:8px;
  background:var(--glass);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:0.9rem;
  color:var(--muted);
}

/* Center: map, clues */
.center {
  display:flex;
  flex-direction:column;
  gap:12px;
}
.map {
  position:relative;
  border-radius:12px;
  overflow:hidden;
  padding:10px;
  background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.35));
  border:1px solid rgba(255,255,255,0.02);
  min-height:260px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
#mapImg { width:100%; display:block; border-radius:8px; opacity:0.98; filter:contrast(0.9) saturate(0.8); }

.hotspot {
  position:absolute;
  transform:translate(-50%,-50%);
  background:linear-gradient(180deg, rgba(176,138,92,0.14), rgba(176,138,92,0.08));
  padding:8px 10px;
  border-radius:999px;
  font-weight:700;
  color:#110b06;
  cursor:pointer;
  border:1px solid rgba(176,138,92,0.12);
  box-shadow:0 8px 22px rgba(0,0,0,0.6);
  transition:transform .12s ease, box-shadow .12s ease;
  user-select:none;
}
.hotspot:hover { transform:translate(-50%,-50%) scale(1.04); box-shadow:0 12px 26px rgba(0,0,0,0.7); }

/* clues grid */
.clues {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:10px;
}
.clue {
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.02);
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, box-shadow .12s ease;
}
.clue:hover { transform:translateY(-4px); box-shadow:0 14px 40px rgba(0,0,0,0.6); }
.clue.locked { opacity:0.75; filter:grayscale(0.15) blur(0.1px); }
.clue h4 { margin:0 0 6px 0; font-size:0.95rem; font-weight:700; color:#efe6dc; }
.clue p { margin:0; font-size:0.85rem; color:var(--muted); }

/* Right panel: tools */
.tools { display:flex; flex-direction:column; gap:10px; position:sticky; top:18px; }
.tool { background:var(--glass); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }
.tool h3 { margin:0 0 8px 0; font-size:0.98rem; }
.btn { background:var(--accent); color:#0a0604; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
.btn.secondary { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
.small-muted { font-size:0.85rem; color:var(--muted) }

/* modal */
.modal {
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999;
  background:linear-gradient(180deg, rgba(3,3,3,0.6), rgba(8,8,8,0.85));
}
.modal .card { width:520px; max-width:94%; background:linear-gradient(180deg,#151414,#0f0f0f); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }
.row { display:flex; gap:8px; align-items:center; }
.input { width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.03); background:#0e0e0e; color:#efeae4; }

/* footer / ambience */
.ambience {
  position:fixed; inset:0; pointer-events:none;
  background: radial-gradient(600px 200px at 10% 10%, rgba(176,138,92,0.02), transparent);
  mix-blend-mode:overlay;
  z-index:0;
}
.vignette { position:fixed; inset:0; pointer-events:none; background:radial-gradient(ellipse at center, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0.7) 70%); z-index:10; }

.footer { text-align:center; color:var(--muted); font-size:0.85rem; margin:22px 0 80px 0; }

/* debug panel */
#debug {
  position:fixed; right:16px; bottom:16px; width:320px; max-height:260px; overflow:auto;
  background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(8,8,8,0.85)); color:#fff; border-radius:10px; padding:10px;
  border:1px solid rgba(255,255,255,0.03); font-size:0.8rem; z-index:99999;
}
.debug-title { font-weight:700; margin-bottom:6px; }
.log { font-family:monospace; font-size:12px; color:#cfcfcf; white-space:pre-wrap; }

/* nice little animations */
@keyframes pulse {
  0%{ transform:scale(1); opacity:0.95 }
  50%{ transform:scale(1.03); opacity:1 }
  100%{ transform:scale(1); opacity:0.95 }
}
.hotspot.pulse { animation:pulse 2.1s infinite; }
</style>
</head>
<body>
  <div class="header">
    <div class="title">
      <h1>Убийство в особняке Роузвуд</h1>
      <p>Ночь. Тайны. Свечи. Расследуйте, связывайте улики, раскрывайте заговор.</p>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div id="progress" class="small-muted">Прогресс: <strong id="progressPct">0%</strong></div>
      <button id="audioToggle" class="btn secondary">Звук: выкл</button>
    </div>
  </div>

  <main class="container" role="main">
    <!-- LEFT -->
    <aside class="panel" aria-label="Подозреваемые и кейс">
      <div class="case-name">Дело: Роузвуд — Ночь на 12 ноября</div>
      <div class="small">Жертва: лорд Ричард. Осмотрите особняк, соберите улики и выстройте хронологию.</div>

      <div id="suspectsArea" style="margin-top:12px;">
        <!-- Suspects created by JS -->
      </div>

      <div style="margin-top:14px;">
        <div class="small-muted">Связанные улики</div>
        <div id="linksSummary" class="small" style="margin-top:6px">Пока нет связей.</div>
      </div>
    </aside>

    <!-- CENTER -->
    <section class="center">
      <div class="map panel" aria-label="Карта особняка">
        <img id="mapImg" src="https://i.ibb.co/ZV0Y0WZ/rosewood-map.png" alt="Карта особняка">
        <!-- hotspots (positions in %): will be interactive -->
        <div class="hotspot pulse" style="left:18%; top:22%;" data-room="library">Библиотека</div>
        <div class="hotspot" style="left:48%; top:18%;" data-room="music">Музыка</div>
        <div class="hotspot" style="left:62%; top:38%;" data-room="office">Кабинет</div>
        <div class="hotspot" style="left:26%; top:60%;" data-room="garden">Сад</div>
        <div class="hotspot" style="left:72%; top:66%;" data-room="basement">Подвал</div>
        <div class="hotspot" style="left:40%; top:46%;" data-room="dining">Столовая</div>
        <div class="hotspot" style="left:55%; top:62%;" data-room="attic">Чердак</div>
      </div>

      <div style="display:flex; gap:12px; align-items:flex-start;">
        <div style="flex:1">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-family:'Cinzel', serif;">Улики</h3>
            <div class="small-muted">Перетащите улику на подозреваемого для привязки</div>
          </div>

          <div id="cluesGrid" class="clues" style="margin-top:10px;">
            <!-- clues populated by JS -->
          </div>
        </div>

        <div style="width:300px;">
          <div class="tool panel">
            <h3>Инструменты</h3>
            <div class="small-muted">Блокнот, таймлайн и мини‑игры</div>
            <div style="margin-top:10px; display:flex; gap:8px;">
              <button id="openNotebook" class="btn">Блокнот</button>
              <button id="openTimeline" class="btn secondary">Таймлайн</button>
            </div>
            <div style="margin-top:10px;">
              <button id="openCipher" class="btn">Заметка (Цезарь)</button>
              <button id="openMatch" class="btn secondary">Эмблемы (мини‑игра)</button>
            </div>
          </div>

          <div class="tool" style="margin-top:10px;">
            <h3>Обвинение</h3>
            <div class="small-muted">Выберите подозреваемого и нажмите «Обвинить»</div>
            <select id="accuseSelect" class="input" style="margin-top:8px;">
              <option value="">— Выберите —</option>
            </select>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button id="accuseBtn" class="btn">Обвинить</button>
              <button id="reviewBtn" class="btn secondary">Проверить</button>
            </div>
            <div id="accuseResult" style="margin-top:8px; font-weight:700;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="panel tools" aria-label="Инструменты и прогресс">
      <div class="tool">
        <h3>Прогресс расследования</h3>
        <div id="progressNotes" class="small" style="margin-top:6px;">Откройте улики и связывайте их с подозреваемыми.</div>
        <div style="margin-top:8px;">
          <button id="saveBtn" class="btn secondary">Сохранить прогресс</button>
          <button id="loadBtn" class="btn secondary">Загрузить прогресс</button>
        </div>
      </div>

      <div class="tool" style="margin-top:10px;">
        <h3>Сохранённые события (таймлайн)</h3>
        <div id="timelineList" class="small-muted" style="margin-top:8px;">Пока пусто</div>
        <div style="margin-top:8px;">
          <input id="timelineInput" class="input" placeholder="Добавить событие (например, 23:10 — шаги)" />
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="addTimelineBtn" class="btn">Добавить</button>
            <button id="clearTimelineBtn" class="btn secondary">Очистить</button>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <div class="footer">Игра создана как прототип — можно добавлять новые мини‑игры и уровни интриги.</div>

  <!-- Modals -->
  <div class="modal" id="modalCipher" aria-hidden="true">
    <div class="card">
      <h3>Зашифрованная записка (Цезарь)</h3>
      <div class="small-muted">Попробуйте сдвиг от 1 до 25</div>
      <div class="row" style="margin-top:8px;">
        <input id="cipherShift" class="input" type="number" min="1" max="25" value="3" />
        <button id="cipherTry" class="btn">Попробовать</button>
      </div>
      <textarea id="cipherOutput" rows="4" class="input" style="margin-top:8px" readonly></textarea>
      <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="cipherClose" class="btn secondary">Закрыть</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalMatch" aria-hidden="true">
    <div class="card">
      <h3>Эмблемы — выберите правильную</h3>
      <div class="small-muted" style="margin-top:6px">Найдите эмблему, совпадающую с символом на стене.</div>
      <div id="matchArea" style="display:flex; gap:8px; margin-top:12px; justify-content:space-around;"></div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end;">
        <button id="matchClose" class="btn secondary">Закрыть</button>
      </div>
    </div>
  </div>

  <div id="debug" aria-hidden="false">
    <div class="debug-title">DEBUG</div>
    <div id="debugLog" class="log">init...</div>
  </div>

  <div class="ambience"></div>
  <div class="vignette"></div>

<script>
/* =========================
   Надёжная инициализация
   ========================= */
(function(){
  // Централизованный лог для debug панели
  function debug(...args){ try{ const el = document.getElementById('debugLog'); if(el) el.textContent = (el.textContent ? el.textContent + "\\n" : '') + args.join(' '); console.log(...args);}catch(e){} }
  window.onerror = function(msg, src, line, col, err){
    debug('ERROR:', msg, '(', src, line+':'+col, ')', err && err.stack ? '\\n' + err.stack : '');
  };

  document.addEventListener('DOMContentLoaded', function(){
    try{
      debug('DOM loaded — инициализация UI');
      initApp();
    }catch(e){
      debug('Инициализация провалена:', e && e.stack ? e.stack : e);
    }
  });

  /* =========================
     Данные (подозреваемые, улики)
     ========================= */
  const suspects = [
    { id:'adrian', name:'Эдриан Роузвуд', role:'Наследник', img:'https://i.ibb.co/3s3h4qj/person1.jpg', note:'Вёл переписку с отцом.' },
    { id:'beatrice', name:'Беатрис Хейвуд', role:'Домработница', img:'https://i.ibb.co/qdV4y6k/person2.jpg', note:'Была замечена возле сада.' },
    { id:'prof', name:'Профессор Морден', role:'Архивариус', img:'https://i.ibb.co/8m9h3PZ/person3.jpg', note:'Знает старые символы.' },
    { id:'victoria', name:'Виктория Роузвуд', role:'Жена', img:'https://i.ibb.co/Hd1qkXn/person4.jpg', note:'Тайные страхи и секреты.' },
  ];

  const clues = [
    { id:'cl1', title:'Тайная записка (шИфр)', room:'office', text:'Vkr ghqv wrfkh', locked:true, type:'cipher', hint:'Цезарь' },
    { id:'cl2', title:'След обуви', room:'garden', text:'Подошва с логотипом B7', locked:false },
    { id:'cl3', title:'Разорванный лист', room:'library', text:'Вырвано имя, пометка: 12/11', locked:false },
    { id:'cl4', title:'Символ на стене', room:'music', text:'Камень выцарапан символом — эмблема серии', locked:false, type:'symbol' },
    { id:'cl5', title:'Чёрнильный след', room:'office', text:'След от перьевой ручки — фирма "Wyn"', locked:false },
    { id:'cl6', title:'Карта подвала (сожжена)', room:'basement', text:'Фрагменты карты — нужно восстановить', locked:true, type:'photo' },
    { id:'cl7', title:'Пепел на перилах', room:'dining', text:'Следы поджога — есть следы масла', locked:false },
    { id:'cl8', title:'Флакон с запахом', room:'attic', text:'Остатки редкого эфирного масла', locked:false },
    { id:'cl9', title:'Записка в книге', room:'library', text:'"Власть — через тайну" — подпись В.', locked:false },
    { id:'cl10', title:'Запечатанный конверт', room:'office', text:'Конверт без адреса, печать: семейная', locked:true, type:'seal' }
  ];

  /* Состояние приложения (локально) */
  let state = {
    opened: {},        // какие улики открыты
    links: {},         // { suspectId: [clueId,...] }
    timeline: [],      // события
    audioOn: false
  };

  function initApp(){
    // назначение начального состояния
    suspects.forEach(s => state.links[s.id] = []);
    // отрисовка UI
    renderSuspects();
    renderClues();
    renderAccuseSelect();
    attachMapHandlers();
    attachToolHandlers();
    attachDragDrop();
    loadStateFromStorage();
    updateProgress();
    debug('App initialized');
  }

  /* -------------------------
     Рендер подозреваемых
     ------------------------- */
  function renderSuspects(){
    const area = document.getElementById('suspectsArea');
    area.innerHTML = '';
    suspects.forEach(s => {
      const el = document.createElement('div');
      el.className = 'suspect';
      el.dataset.id = s.id;
      el.innerHTML = `
        <img src="${s.img}" alt="${s.name}">
        <div class="meta">
          <div class="name">${s.name}</div>
          <div class="role">${s.role}</div>
          <div class="small" style="margin-top:6px">${s.note}</div>
        </div>
        <div class="dropzone" data-suspect="${s.id}">0</div>
      `;
      area.appendChild(el);
    });
  }

  /* -------------------------
     Рендер улик
     ------------------------- */
  function renderClues(){
    const grid = document.getElementById('cluesGrid');
    grid.innerHTML = '';
    clues.forEach(c => {
      const card = document.createElement('div');
      card.className = 'clue' + (c.locked ? ' locked' : '');
      card.id = c.id;
      card.draggable = true;
      card.innerHTML = `<h4>${c.title}</h4><p>${c.locked ? 'Зашифрована / скрыта' : c.text}</p>`;
      // data attributes
      card.dataset.locked = c.locked ? '1' : '0';
      card.dataset.type = c.type || '';
      card.dataset.room = c.room || '';
      // click opens (if unlocked shows details, if locked opens relevant tool)
      card.addEventListener('click', () => {
        onClueClick(c);
      });
      // dragstart
      card.addEventListener('dragstart', (ev) => {
        ev.dataTransfer.setData('text/plain', c.id);
        ev.dataTransfer.effectAllowed = 'move';
      });
      grid.appendChild(card);
    });
  }

  /* -------------------------
     Обработчик клика по улице
     ------------------------- */
  function onClueClick(clue){
    const meta = clues.find(x => x.id === clue.id);
    if(!meta) return;
    if(meta.locked){
      // выбираем подходящий инструмент в зависимости от типа
      if(meta.type === 'cipher'){
        openCipherModal();
        setCipherSource(meta.text, meta.id);
      } else if(meta.type === 'photo'){
        // photo tool: показываем мини-игру "восстановление"
        showToast('Для восстановления карты используйте мини‑игру эмблем (в Инструментах).');
        openMatchModal(true); // demo link to match
      } else if(meta.type === 'seal'){
        showToast('Печать требует анализа — найдите ключ в других уликaх');
        openMatchModal(true);
      } else {
        showToast('Эта улика закрыта. Попробуйте инструменты.');
      }
      return;
    } else {
      // раскрыть содержимое детально: открываем модальное с текстом и опциями
      showClueDetails(meta);
    }
  }

  function showClueDetails(c){
    // простой подробный просмотр
    const existed = document.getElementById('clueDetailModal');
    if(existed) existed.remove();
    const md = document.createElement('div');
    md.id = 'clueDetailModal';
    md.className = 'modal';
    md.innerHTML = `<div class="card">
      <h3>${c.title}</h3>
      <div class="small-muted" style="margin-top:6px">Найдено в: ${c.room || 'неизвестно'}</div>
      <p style="margin-top:10px" class="small-muted">${c.text}</p>
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
        <button id="closeClue" class="btn secondary">Закрыть</button>
      </div>
    </div>`;
    document.body.appendChild(md);
    md.style.display = 'flex';
    md.querySelector('#closeClue').addEventListener('click', ()=>{ md.style.display='none'; md.remove(); });
  }

  /* -------------------------
     Drag & Drop: привязка улики к подозреваемому
     ------------------------- */
  function attachDragDrop(){
    document.querySelectorAll('.dropzone').forEach(zone => {
      zone.addEventListener('dragover', (ev) => {
        ev.preventDefault();
        zone.style.outline = '2px dashed rgba(176,138,92,0.6)';
      });
      zone.addEventListener('dragleave', (ev) => {
        zone.style.outline = '';
      });
      zone.addEventListener('drop', (ev) => {
        ev.preventDefault();
        zone.style.outline = '';
        const clueId = ev.dataTransfer.getData('text/plain');
        const suspectId = zone.dataset.suspect;
        if(clueId && suspectId){
          linkEvidence(suspectId, clueId);
        }
      });
    });
    // Обновляем зоны при динамической смене suspects
    // (при перерисовке вызвать again)
  }

  function linkEvidence(suspectId, clueId){
    if(!state.links[suspectId]) state.links[suspectId] = [];
    if(!state.links[suspectId].includes(clueId)){
      state.links[suspectId].push(clueId);
      showToast('Улика привязана к ' + suspectId);
      updateLinksUI();
      persistStateDebounced();
      updateProgress();
    } else {
      showToast('Улика уже привязана к этому подозреваемому');
    }
  }

  function updateLinksUI(){
    // обновляем числа в зонах и суммарный список
    for(const s of suspects){
      const zone = document.querySelector('.dropzone[data-suspect="'+s.id+'"]');
      if(zone) zone.textContent = (state.links[s.id] || []).length;
    }
    const s = [];
    for(const su of suspects){
      const arr = state.links[su.id] || [];
      if(arr.length) s.push(`${su.name}: ${arr.join(', ')}`);
    }
    document.getElementById('linksSummary').textContent = s.length ? s.join('; ') : 'Пока нет связей.';
    renderAccuseSelect();
    renderTimeline();
  }

  /* -------------------------
     Карта — обработчики комнат
     ------------------------- */
  function attachMapHandlers(){
    document.querySelectorAll('.hotspot').forEach(h => {
      h.addEventListener('click', () => {
        const room = h.dataset.room;
        inspectRoom(room);
        // звуковой эффект (если включён)
        playSound('click', 0.18);
      });
    });
  }

  function inspectRoom(room){
    // симуляция поиска: открываем все улики в комнате (если не заблокированы)
    const found = clues.filter(c => c.room === room);
    if(!found.length){
      showToast('Ничего не найдено в этой области.');
      return;
    }
    found.forEach(c => {
      const card = document.getElementById(c.id);
      if(!card) return;
      card.classList.remove('locked');
      // если улика была locked = true и типа cipher — оставляем locked=true until puzzle solved
      // but we mark as "found" (show hint text)
      if(!c.locked){
        card.querySelector('p').textContent = c.text;
        state.opened[c.id] = true;
      } else {
        // показываем подсказку в карточке
        card.querySelector('p').textContent = 'Найдена, но скрыта — требуется анализ';
      }
    });
    showToast('Осмотр закончился — проверьте панель улик.');
    persistStateDebounced();
    renderClues(); // ensure visuals updated
    attachDragDrop(); // reattach dropzones in case of DOM changes
    updateProgress();
  }

  /* -------------------------
     Инструменты (модали)
     ------------------------- */
  function attachToolHandlers(){
    document.getElementById('openCipher').addEventListener('click', openCipherModal);
    document.getElementById('cipherClose').addEventListener('click', closeCipherModal);
    document.getElementById('cipherTry').addEventListener('click', tryCipherShift);
    document.getElementById('openMatch').addEventListener('click', () => openMatchModal(false));
    document.getElementById('matchClose').addEventListener('click', closeMatchModal);
    document.getElementById('openNotebook').addEventListener('click', openNotebookModal);
    document.getElementById('openTimeline').addEventListener('click', openTimelineModal);
    document.getElementById('addTimelineBtn').addEventListener('click', addTimelineEvent);
    document.getElementById('clearTimelineBtn').addEventListener('click', clearTimeline);
    document.getElementById('saveBtn').addEventListener('click', saveStateToStorage);
    document.getElementById('loadBtn').addEventListener('click', loadStateFromStorage);
    document.getElementById('accuseBtn').addEventListener('click', accuseSelected);
    document.getElementById('reviewBtn').addEventListener('click', reviewEvidence);
    document.getElementById('audioToggle').addEventListener('click', toggleAudio);
  }

  /* -------------------------
     Цезарь: улика cl1
     ------------------------- */
  let currentCipherSource = '';
  let currentCipherClueId = null;
  function setCipherSource(text, clueId){
    currentCipherSource = text;
    currentCipherClueId = clueId;
    document.getElementById('cipherOutput').value = '';
    document.getElementById('cipherShift').value = 3;
  }
  function openCipherModal(){
    document.getElementById('modalCipher').style.display = 'flex';
    document.getElementById('modalCipher').setAttribute('aria-hidden','false');
    // default source from clue cl1 if exists
    const c = clues.find(x=>x.type==='cipher') || clues.find(x=>x.id==='cl1');
    if(c) setCipherSource(c.text, c.id);
  }
  function closeCipherModal(){
    document.getElementById('modalCipher').style.display = 'none';
    document.getElementById('modalCipher').setAttribute('aria-hidden','true');
  }

  function tryCipherShift(){
    const shift = Number(document.getElementById('cipherShift').value) || 0;
    if(!currentCipherSource){
      showToast('Нет исходного текста для расшифровки.');
      return;
    }
    const decoded = caesarDecode(currentCipherSource, shift);
    document.getElementById('cipherOutput').value = decoded;
    debug('Цезарь s=' + shift + ' -> ' + decoded);
    // если расшифровка содержит ключевую фразу — открываем улику
    if(/он знает|он знает|he knows|в\./i.test(decoded) || shift === 3){
      // раскрываем улику
      revealClue(currentCipherClueId, 'Найдена в кабинете: «Он знает. Сегодня решу всё. — В.»');
      showToast('Записка расшифрована и добавлена в улики.');
      closeCipherModal();
    }
  }

  function caesarDecode(text, shift){
    if(!shift) return text;
    const a = 'abcdefghijklmnopqrstuvwxyz';
    const A = a.toUpperCase();
    return text.split('').map(ch => {
      const i = a.indexOf(ch);
      if(i >= 0) return a[(i - shift + 26) % 26];
      const I = A.indexOf(ch);
      if(I >= 0) return A[(I - shift + 26) % 26];
      return ch;
    }).join('');
  }

  /* -------------------------
     Мини-игра: эмблемы (match)
     ------------------------- */
  const emblems = [
    { id:'e1', img:'https://i.ibb.co/0VQbL1L/emblem1.png', tag:'morden' },
    { id:'e2', img:'https://i.ibb.co/5kPZ8g7/emblem2.png', tag:'rosewood' },
    { id:'e3', img:'https://i.ibb.co/7WcVY3J/emblem3.png', tag:'rosewood' },
  ];
  function openMatchModal(autoReveal){
    const modal = document.getElementById('modalMatch');
    const area = document.getElementById('matchArea');
    area.innerHTML = '';
    // shuffle choices
    const shuffled = emblems.slice().sort(()=>Math.random()-0.5);
    shuffled.forEach(e => {
      const btn = document.createElement('div');
      btn.style.cursor = 'pointer';
      btn.style.padding = '6px';
      btn.style.borderRadius = '8px';
      btn.style.background = 'rgba(255,255,255,0.01)';
      btn.style.display = 'flex';
      btn.style.flexDirection = 'column';
      btn.style.alignItems = 'center';
      btn.style.gap = '6px';
      btn.innerHTML = `<img src="${e.img}" alt="${e.id}" style="width:72px; height:72px; object-fit:contain"><div class="small-muted">${e.id}</div>`;
      btn.addEventListener('click', () => {
        // check correct tag (for demo, suppose 'rosewood' is correct)
        if(e.tag === 'rosewood'){
          showToast('Эмблема совпала — улика раскрыта!');
          revealClue('cl4', 'Символ на стене — эмблема семьи Роузвуд.');
          closeMatchModal();
        } else {
          showToast('Не то. Попробуйте другую эмблему.');
          playFeedbackWrong();
        }
      });
      area.appendChild(btn);
    });
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    // auto demo: if autoReveal true — reveal something
    if(autoReveal){
      setTimeout(()=>{ revealClue('cl6', 'Части карты восстановлены: найден тайный проход.'); showToast('Карта частично восстановлена (демо).'); closeMatchModal(); }, 900);
    }
  }
  function closeMatchModal(){
    const modal = document.getElementById('modalMatch');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  /* -------------------------
     Помощники: reveal, toast, sounds
     ------------------------- */
  function revealClue(id, text){
    const c = clues.find(x=>x.id === id);
    if(!c) return;
    c.locked = false;
    c.text = text;
    state.opened[id] = true;
    renderClues();
    attachDragDrop();
    updateProgress();
  }

  function showToast(text){
    // краткое уведомление (debug + простая визуальная подсказка)
    debug('TOAST: ' + text);
    const d = document.createElement('div');
    d.textContent = text;
    d.style.position='fixed';
    d.style.left='50%';
    d.style.bottom='24px';
    d.style.transform='translateX(-50%)';
    d.style.background='rgba(0,0,0,0.8)';
    d.style.color='#fff';
    d.style.padding='10px 14px';
    d.style.borderRadius='10px';
    d.style.zIndex=999999;
    document.body.appendChild(d);
    setTimeout(()=>{ d.style.transition='opacity .6s'; d.style.opacity='0'; setTimeout(()=>d.remove(),600); }, 1800);
  }

  function playFeedbackWrong(){ try{ /* placeholder for sound feedback */ }catch(e){ debug('playFail', e); } }

  /* -------------------------
     Таймлайн
     ------------------------- */
  function addTimelineEvent(){
    const inp = document.getElementById('timelineInput');
    const v = inp.value && inp.value.trim();
    if(!v){ showToast('Введите текст события'); return; }
    state.timeline.push({ time: new Date().toISOString(), text: v });
    inp.value = '';
    renderTimeline();
    persistStateDebounced();
  }
  function clearTimeline(){
    state.timeline = [];
    renderTimeline();
    persistStateDebounced();
  }
  function renderTimeline(){
    const el = document.getElementById('timelineList');
    if(!el) return;
    if(state.timeline.length === 0) { el.textContent = 'Пока пусто'; return; }
    el.innerHTML = state.timeline.slice().reverse().map(t => `<div style="margin-bottom:6px">${new Date(t.time).toLocaleString()}: <strong>${t.text}</strong></div>`).join('');
  }

  /* -------------------------
     Обвинение и проверка
     ------------------------- */
  function renderAccuseSelect(){
    const sel = document.getElementById('accuseSelect');
    sel.innerHTML = '<option value="">— Выберите —</option>';
    suspects.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name;
      sel.appendChild(opt);
    });
  }
  function accuseSelected(){
    const sel = document.getElementById('accuseSelect');
    const id = sel.value;
    const out = document.getElementById('accuseResult');
    if(!id){ out.textContent = 'Выберите подозреваемого'; out.style.color = '#ffb3b3'; return; }
    const linked = state.links[id] || [];
    if(linked.length >= 3 && state.timeline.length >= 2){
      // условная «правильность»: адриан — истинный убийца (для прототипа)
      if(id === 'adrian'){
        out.textContent = 'Успех — обосновано. Эдриан признан виновным.';
        out.style.color = '#b7f6b7';
      } else {
        out.textContent = 'Обвинение не подтверждено — пересмотрите улики.';
        out.style.color = '#ffd1d1';
      }
    } else {
      out.textContent = 'Недостаточно доказательств — нужно ≥3 улики и ≥2 события таймлайна.';
      out.style.color = '#ffd1d1';
    }
  }

  function reviewEvidence(){
    const parts = [];
    for(const s of suspects){
      const arr = state.links[s.id] || [];
      parts.push(`${s.name}: ${arr.length} улик`);
    }
    showToast(parts.join(' | '));
  }

  /* -------------------------
     Сохранение / загрузка состояния
     ------------------------- */
  function saveStateToStorage(){
    try{
      localStorage.setItem('rosewood_state', JSON.stringify(state));
      showToast('Прогресс сохранён');
    }catch(e){ debug('save error', e); showToast('Ошибка при сохранении'); }
  }
  function loadStateFromStorage(){
    try{
      const raw = localStorage.getItem('rosewood_state');
      if(!raw){ showToast('Сохранений не найдено'); return; }
      const loaded = JSON.parse(raw);
      state = Object.assign(state, loaded);
      // ensure links keys exist
      suspects.forEach(s => state.links[s.id] = state.links[s.id] || []);
      renderClues();
      updateLinksUI();
      renderTimeline();
      updateProgress();
      showToast('Прогресс загружен');
    }catch(e){ debug('load error', e); showToast('Ошибка при загрузке'); }
  }
  function loadStateFromStorage(){ // alias bound earlier to UI
    try{
      const raw = localStorage.getItem('rosewood_state');
      if(!raw){ showToast('Сохранений не найдено'); return; }
      const loaded = JSON.parse(raw);
      state = Object.assign({
        opened:{}, links:{}, timeline:[], audioOn:false
      }, loaded);
      // ensure links keys exist
      suspects.forEach(s => state.links[s.id] = state.links[s.id] || []);
      renderClues();
      updateLinksUI();
      renderTimeline();
      updateProgress();
      showToast('Прогресс загружен');
    }catch(e){ debug('load err', e); showToast('Ошибка при загрузке'); }
  }

  /* Debounced persist to avoid frequent writes */
  let _persistTimer = null;
  function persistStateDebounced(){
    clearTimeout(_persistTimer);
    _persistTimer = setTimeout(()=>{ try{ localStorage.setItem('rosewood_autosave', JSON.stringify(state)); debug('autosaved'); }catch(e){ debug('autosave err', e); } }, 700);
  }

  /* -------------------------
     Utilities: update progress, sounds
     ------------------------- */
  function updateProgress(){
    const total = clues.length;
    const openedCount = Object.keys(state.opened || {}).length + Object.values(state.links || {}).flat().length;
    const pct = Math.min(100, Math.round((openedCount / (total + 2)) * 100)); // adjust denominator so it's not 100 too early
    document.getElementById('progressPct').textContent = pct + '%';
    document.getElementById('progressNotes').textContent = `Открыто: ${Object.keys(state.opened || {}).length} улик. Связей: ${Object.values(state.links || {}).flat().length}.`;
    updateLinksUI();
  }

  /* -------------------------
     Звуки (без внешних файлов — placeholder)
     ------------------------- */
  function toggleAudio(){
    state.audioOn = !state.audioOn;
    document.getElementById('audioToggle').textContent = 'Звук: ' + (state.audioOn ? 'вкл' : 'выкл');
    showToast('Звук ' + (state.audioOn ? 'включён' : 'выключен'));
  }
  function playSound(name, vol){
    // placeholder: можно добавить <audio> теги и воспроизводить их
    debug('playSound', name, vol);
  }

  /* -------------------------
     Misc: modal openers, notebook & timeline UI
     ------------------------- */
  function openNotebookModal(){
    const m = document.createElement('div');
    m.className = 'modal';
    m.id = 'notebookModal';
    m.innerHTML = `<div class="card"><h3>Блокнот</h3><textarea id="notebookText" class="input" rows="8" placeholder="Ваши заметки..."></textarea><div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;"><button id="nbSave" class="btn">Сохранить</button><button id="nbClose" class="btn secondary">Закрыть</button></div></div>`;
    document.body.appendChild(m);
    m.style.display='flex';
    document.getElementById('nbClose').addEventListener('click', ()=>{ m.style.display='none'; m.remove(); });
    document.getElementById('nbSave').addEventListener('click', ()=>{ const v = (document.getElementById('notebookText').value||''); localStorage.setItem('rosewood_notes', v); showToast('Заметки сохранены'); });
    const saved = localStorage.getItem('rosewood_notes');
    if(saved) document.getElementById('notebookText').value = saved;
  }

  function openTimelineModal(){
    const m = document.createElement('div');
    m.className = 'modal';
    m.id = 'timelineModal';
    m.innerHTML = `<div class="card"><h3>Таймлайн</h3><div id="timelineInner" class="small-muted" style="max-height:180px; overflow:auto;"></div><div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;"><button id="tlClose" class="btn secondary">Закрыть</button></div></div>`;
    document.body.appendChild(m);
    m.style.display='flex';
    document.getElementById('tlClose').addEventListener('click', ()=>{ m.style.display='none'; m.remove(); });
    document.getElementById('timelineInner').innerHTML = state.timeline.length ? state.timeline.map(t=>`<div style="margin-bottom:8px">${new Date(t.time).toLocaleString()}: ${t.text}</div>`).join('') : 'пусто';
  }

  /* -------------------------
     Timeline UI helpers wired to right panel
     ------------------------- */
  document.getElementById && document.getElementById('addTimelineBtn') && document.getElementById('addTimelineBtn').addEventListener && document.getElementById('addTimelineBtn').addEventListener('click', function(){ /* handled above */ });

  function renderAccuseSelect(){ /* defined earlier; placeholder to avoid reference errors */ }

  /* ==================
     Helpers & Init calls
     ================== */
  // ensure dynamic functions available to some UI bindings
  window.revealClue = revealClue;
  window.loadStateFromStorage = loadStateFromStorage;

  // initial render calls
  renderClues();
  renderAccuseSelect();
  renderTimeline();
  attachDragDrop();
  attachMapHandlers();
  updateLinksUI();

  debug('UI ready.');
}());
</script>
</body>
</html>
